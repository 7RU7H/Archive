# Malware Analysis

Malware dervied from the contraction of Malicious and Software and combination to refer to software that has malicious intent. Analysis generally is dischomised by temporality: static as the malware is does not run, but is read/parsed by analysists and tooling; dynamic as the malware is executed and obsaerved for its behaviour. Futhermore analysis can occur on workflow of using [[Reverse-Engineering-Tools]] like disassemblers, debuggers, etc like regular software to understand how it works.

Malware Analysis is used by all sides:

-   **Security Operations** teams analyze malware to write detections for malicious activity in their networks.
-   **Incident Response** teams analyze malware to determine what damage has been done to an environment to remediate and revert that damage.
-   **Threat Hunt** teams analyze malware to identify IOCs, which they use to hunt for malware in a network.
-   **Malware Researchers** in security product vendor teams analyze malware to add detections for them in their security products.
-   **Threat Research** teams in OS Vendors like Microsoft and Google analyze malware to discover the vulnerabilities exploited and add more security features to the OS/applications.
-   **Malware Writers** to improve there own malware use modern malware analysis tools and techniques to bypass 
-   **Threat Emulators and Red Teams** to replicate functionality without destructive outcomes to demonstrate emulation of the threat APTs tactics and techniques without the destructive results.  

Generally if you are performing Blue/Purple team operation use want community information of the sample: [VirusTotal](https://www.virustotal.com/) tracks AV vendors and Malware sampling.


## Environments

FLARE VM: - Windows 7/10 VM plus [FLARE GitHub page](https://github.com/mandiant/flare-vm) or from the [Mandiant blog](https://www.mandiant.com/resources/blog/flare-vm-update)
REMnux -  [GitHub](https://github.com/REMnux) or the [website](https://remnux.org/) for distribution

## Methodology

**Malware can dangerous!**

- Where possible have separate dedicated machines for Static and Dynamic Analysis. 
- Do not connect the to a network or internet, create a [[Fake-System-And-Network-Infrastructure-For-Malware-Analysis]]
 
- Create documentation as you analyze

## Static Analysis

#### What is the file hash and what Online Malware Analysis communities say?

```bash
md5sum
shasum -a <algorhythm>
```

#### Import hashes of Windows Malware?

`imphash` - [Mandiant Imphash blog](https://www.mandiant.com/resources/blog/tracking-malware-import-hashing), is hash of function calls/ libraries that potential malware imports.

#### Is it identifiable as Malware by using Fuzzy Hashed

A Fuzzy hash is a Context Triggered Piecewise Hash (CTPH). This hash is calculated by dividing a file into pieces and calculating the hashes of the different pieces. This method creates multiple inputs with similar sequences of bytes, even though the whole file might be different.

- Use [SSDEEP](https://ssdeep-project.github.io/ssdeep/index.html), it can calculate hashes of similiar files

#### What Strings are used?

`Strings`

#### What is the composition of binary?

Linux:
```bash
readelf
```

[[Malware-Analysis-PE-Headers]] for Window Portable Executable

#### What calls to kernel are made?  

Consider reading Windows API resources for Malware Analysis at [MalAPI](https://malapi.io/) or [MSDN](https://docs.microsoft.com/en-us/search/?scope=Desktop&terms=queryperformancecounter).

#### What signatures are detected?

- [[Yara]] and community [Yara Rules](https://github.com/Yara-Rules/rules)
- [Virustotal](https://www.virustotal.com/gui/home/upload)
- [Capa](https://github.com/mandiant/capa)

[MITRE ATT&CK external](https://attack.mitre.org/) or [(locally)](MITRE-ATT&CK]]) and [Malware Behavior Catalog (MBC)](https://github.com/MBCProject/mbc-markdown)

Using a Disassembler to analyse the suspicious file with executing or partial execution. Try:
- [[Radare2-Commands]] and [[Radare2-Cheatsheet]]
- [[Ghidra-Cheatsheet]]
- [[IDA]]

Debuggers
- [[VS-Code]], ILspy, dnSpy
- [[Immunity-Debugger-Helpsheet]]
- [[EDB]]
- [[GDB]]

[Detect it easy](https://github.com/horsicq/Detect-It-Easy) is file analysis program providing file information, architecture, significant headers, packer used, strings. It utilizes an open architecture of signatures, using Javascript-like scripting language.

[CAPA](https://github.com/mandiant/capa) is The FLARE team's open-source tool to identify capabilities in executable files.
- MBC Objective and Behaviour
- Provides [[MITRE-ATT&CK]]1 tactics and techniques identification

```powershell
udp -d # unpack upx packed binary
```

## Dynamic Analysis

Excuting the suspicious file and using Analytical tools to observe it interaction with infected system.

[[Sysinternals-Procmon]]

## Sandboxes

Sandboxes allow Malware Analysts to perform Dynamic Analysis that is more representive of the actual execution chain of a piece of malware by creating of safe and containize or virtualised environment for the malware to operate in to then monitor it. Sandboxs within network meaning that any unsafe or suspicious file run simulatively without causing harm before it is run on a production system.'

Types if Sandboxes include Firewalls, Mail Servers and Workstations they are run in paralell by segemented from the actual network. These are replicas of elements of a network that malware targets. For example a Sandbox Mail Server that opens phishing emails containing susupicious links or files or command injection. 

#### Sandbox Product list:

Note these were listed by THM, will try to add more if they are maintained 

- [Cuckoo's sandbox](https://cuckoosandbox.org/) *is the most widely known sandbox in the malware analysis community"*
	- [Online Cuckoo Sandbox](https://cuckoo.cert.ee/)
- [CAPE Sandbox](https://github.com/kevoreilly/CAPEv2) - more advanced version of Cuckoo's sandbox supporting memory dumps, debugging and unpacking of packed malware.
	- [Online CAPE Sandbox](https://www.capesandbox.com/)
-   Palo Alto Wildfire ([Firewall](https://www.paloaltonetworks.co.uk/products/secure-the-network/wildfire))
-   Proofpoint TAP ([Email Sandbox](https://www.proofpoint.com/uk/products/advanced-threat-protection/targeted-attack-protection))
-   Falcon Sandbox ([EDR/Workstation](https://www.crowdstrike.co.uk/products/threat-intelligence/falcon-sandbox-malware-analysis/))
-   MimeCast ([Email Sandbox](https://www.mimecast.com/))
-   VirusTotal ([Sample Submission Site](https://www.virustotal.com/))
-   Any.Run ([Sample Submission Site](https://any.run/))
-   Antiscan.me ([Sample Submission Site](https://antiscan.me/))
-   Joe Sandbox ([Sample Submission Site](https://www.joesandbox.com/))

More Online Sandboxs:
-   [Any.run](https://any.run/)
-   [Intezer](https://analyze.intezer.com/)
-   [Hybrid Analysis](https://hybrid-analysis.com/)

See the article: [[Sandbox-Evasion]] for more on evasive techniques.

## Threat Tracking 

**AlienVault Open Threat Exchange (OTX)** - An open-source threat tracking system. Create pulses based on your malware analysis work and check out the work of others. [Link](https://otx.alienvault.com/dashboard/new)


## PE Header Analysis

The PE File Header contains the metadata about a Portable Executable file - [[Malware-Analysis-PE-Headers]] for more details, but brief
- Import/Exports
- Sections 
	- .text - CPU instrutions
	- .data - global data
	- .rsrc - reouces used by the PE file 

Tools for PE analysis
`pecheck` 

## Anti-Analysis techniques

[[Malware-Techiques-Packing]] 
[[Malware-Techiques-Obfuscation]]


## References

[Sandbox Evasion THM Room](https://tryhackme.com/room/sandboxevasion)[Malware Behavior Catalog (MBC)](https://github.com/MBCProject/mbc-markdown)
[Volalitility THM Room](https://tryhackme.com/room/bpvolatility)
[Intro to Malware Analysis THM](https://tryhackme.com/room/intromalwareanalysis)
[Basic Static Analysis THM room](https://tryhackme.com/room/staticanalysis1)
[Microsoft Documentation about Strings](https://docs.microsoft.com/en-us/sysinternals/downloads/strings)
[Mandiant Imphash blog](https://www.mandiant.com/resources/blog/tracking-malware-import-hashing)[Malware Behavior Catalog (MBC)](https://github.com/MBCProject/mbc-markdown)
