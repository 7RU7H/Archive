# Malware Analysis

Malware dervied from the contraction of Malicious and Software and combination to refer to software that has malicious intent. Analysis generally is dischomised by temporality: static as the malware is does not run, but is read/parsed by analysists and tooling; dynamic as the malware is executed and obsaerved for its behaviour. Futhermore analysis can occur on workflow of using [[Reverse-Engineering-Tools]] like disassemblers, debuggers, etc like regular software to understand how it works.

Malware Analysis is used by all sides:

-   **Security Operations** teams analyze malware to write detections for malicious activity in their networks.
-   **Incident Response** teams analyze malware to determine what damage has been done to an environment to remediate and revert that damage.
-   **Threat Hunt** teams analyze malware to identify IOCs, which they use to hunt for malware in a network.
-   **Malware Researchers** in security product vendor teams analyze malware to add detections for them in their security products.
-   **Threat Research** teams in OS Vendors like Microsoft and Google analyze malware to discover the vulnerabilities exploited and add more security features to the OS/applications.
-   **Malware Writers** to improve there own malware use modern malware analysis tools and techniques to bypass 
-   **Threat Emulators and Red Teams** to replicate functionality without destructive outcomes to demonstrate emulation of the threat APTs tactics and techniques without the destructive results.  

Generally if you are performing Blue/Purple team operation use want community information of the sample: [VirusTotal](https://www.virustotal.com/) tracks AV vendors and Malware sampling.


## Static Analysis

Using a Disassembler to analyse the suspicious file with executing or partial execution. Try:
- [[Radare2-Commands]] and [[Radare2-Cheatsheet]]
- [[Ghidra-Cheatsheet]]
- [[IDA]]

Debuggers
- [[VS-Code]], ILspy, dnSpy
- [[Immunity-Debugger-Helpsheet]]
- [[EDB]]
- [[GDB]]

```

```

[Detect it easy](https://github.com/horsicq/Detect-It-Easy) is file analysis program providing file information, architecture, significant headers, packer used, strings. It utilizes an open architecture of signatures, using Javascript-like scripting language.

[CAPA](https://github.com/mandiant/capa) is The FLARE team's open-source tool to identify capabilities in executable files.
- MBC Objective and Behaviour
- Provides [[MITRE-ATT&CK]] tactics and techniques identification

```powershell
udp -d # unpack upx packed binary
```

## Dynamic Analysis

Excuting the suspicious file and using Analytical tools to observe it interaction with infected system.

[[Sysinternals-Procmon]]

## Sandboxes

Sandboxes allow Malware Analysts to perform Dynamic Analysis that is more representive of the actual execution chain of a piece of malware by creating of safe and containize or virtualised environment for the malware to operate in to then monitor it. Sandboxs within network meaning that any unsafe or suspicious file run simulatively without causing harm before it is run on a production system.'

Types if Sandboxes include Firewalls, Mail Servers and Workstations they are run in paralell by segemented from the actual network. These are replicas of elements of a network that malware targets. For example a Sandbox Mail Server that opens phishing emails containing susupicious links or files or command injection. 

#### Sandbox Product list:

Note these were listed by THM, will try to add more if they are maintained 

- [Cuckoo's sandbox](https://cuckoosandbox.org/) *is the most widely known sandbox in the malware analysis community"*
	- [Online Cuckoo Sandbox](https://cuckoo.cert.ee/)
- [CAPE Sandbox](https://github.com/kevoreilly/CAPEv2) - more advanced version of Cuckoo's sandbox supporting memory dumps, debugging and unpacking of packed malware.
	- [Online CAPE Sandbox](https://www.capesandbox.com/)
-   Palo Alto Wildfire ([Firewall](https://www.paloaltonetworks.co.uk/products/secure-the-network/wildfire))
-   Proofpoint TAP ([Email Sandbox](https://www.proofpoint.com/uk/products/advanced-threat-protection/targeted-attack-protection))
-   Falcon Sandbox ([EDR/Workstation](https://www.crowdstrike.co.uk/products/threat-intelligence/falcon-sandbox-malware-analysis/))
-   MimeCast ([Email Sandbox](https://www.mimecast.com/))
-   VirusTotal ([Sample Submission Site](https://www.virustotal.com/))
-   Any.Run ([Sample Submission Site](https://any.run/))
-   Antiscan.me ([Sample Submission Site](https://antiscan.me/))
-   Joe Sandbox ([Sample Submission Site](https://www.joesandbox.com/))

More Online Sandboxs:
-   [Any.run](https://any.run/)
-   [Intezer](https://analyze.intezer.com/)
-   [Hybrid Analysis](https://hybrid-analysis.com/)

See the article: [[Sandbox-Evasion]] for more on evasive techniques.

## Threat Tracking 

**AlienVault Open Threat Exchange (OTX)** - An open-source threat tracking system. Create pulses based on your malware analysis work and check out the work of others.Â [Link](https://otx.alienvault.com/dashboard/new)


## PE Header Analysis

The PE File Header contains the metadata about a Portable Executable file - [[Malware-Analysis-PE-Headers]] for more details, but brief
- Import/Exports
- Sections 
	- .text - CPU instrutions
	- .data - global data
	- .rsrc - reouces used by the PE file 

Tools for PE analysis
`pecheck` 

## Anti-Analysis techniques

[[Malware-Techiques-Packing]] 
[[Malware-Techiques-Obfuscation]]


## References

[Sandbox Evasion THM Room](https://tryhackme.com/room/sandboxevasion)
[Volalitility THM Room](https://tryhackme.com/room/bpvolatility)
[Intro to Malware Analysis THM](https://tryhackme.com/room/intromalwareanalysis)