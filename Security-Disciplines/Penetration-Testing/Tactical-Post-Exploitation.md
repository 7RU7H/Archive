# Tactical Post Exploitation

[This, over-decade old talk from Derby Con](https://www.youtube.com/watch?v=gNUhK6G8EQ4), was an awesome talk. Very ahead of its time to the point were it seems pretty timeless. It is [Tactical Post Exploitation - by Carlos Perez](https://www.youtube.com/watch?v=gNUhK6G8EQ4), to briefly summarise it is a guide to better post-exploitation by being tactical and demonstrating depth of understanding about practical and *tactical* Penetration Testing, Real World APT objectives and TTPs before the concept was formalised existed. It is the oldest talk were it expresses disdain for boasting about get Domain Admin or just getting it. Attackers sometimes don't and getting is just measure of focus of personal motives and not emulative of actualities about breaches. It also admonishes the practicalities of excessive interaction with target systems, the noise and the cleanup. It seems very ahead of its time.


## What is Post Exploitation

Actions taken after access to a system - RoE dependent, client restrictions:
- Gather info - not touching the valuable stuff - managing collected info
	- Prior to sessions - Plan what type of info you need to collect
- Leverage Credentials 
- Persist on network - Not being sabotaged by in house team

Some, go too crazy - there is no patch for stupidity
- Joke: *"I want a full disk image of a target box* amount of information is insane and noisy
- But also you need to go further than I got 100 shells and 100 more from a persistence on each - I gathered everything.

In doing so - you made all the noise possible to make. Also you maybe in a honey-pot.

Be humble. 

Locard Exchange Principle: *"With contact between two items, there will be an exchange"*

Every action you take will always leave a trace. Even when the action is to cover or delete the trace of another action. 

## Plan

- Bad planning will lead to a Sale guys offering pitch to client, but you have 30 hours  for pentest, 8 hours for report and its a black box pentest.

Understand the business - go to the meeting loads of information in that meeting. 

Mistakes happen in when you are lacking in sleep because you over working to catch up when good planning could have helped with your health and getting on the boxes.

Have a contact sheet!

- Clear and RoE
	- Some production servers handle very expensive real world business - ask why?
	- Worth getting a figure on how much just to make sure you do not break the important machines.


OODA Loop - John Boyd
- Observer
- Orient 
- Decide
- Act 

 Gather information that will let you know the purpose and relations:
- `netstat`, `arp`, sessions shares will provide relation info with other hosts and services
- applications, recent documents, browser history, recent applications - what happens on the host
- Decide WHICH of the many hosts you need to do persistence on - no need for 200 shells - more cleanup.

## Challenges

Too Much Information - Management is difficult.

Targets behind a NAT Firewall, the IP you mioght be logging is the NAT device

Legality of information collected - Each country has there only data protection laws
- Get companies policy
- Act on behalf of customer to be covered by their policy

Prioritization of targets

## Know your Opponent

IT is underappreciated, they will make your life hell - they do not get paid enough and are mad from the weird situation inside companies
- They will check for noise
- They will check low hanging fruit
	- Processes, Connections, EventLog may dump memory
- They will see if notepad.exe is connecting to internet


##  Gathering the Right Info

Windows 
- Some commands are not always there
- Not all old Windows record data in the same format
- Registry key case and format changes in different versions
- Eventlogs vary per role and the EventID and code vary in older versions - pre-Vista

Windows Registry is a Gold mine - No flags raised (always not true for later versions) with all the information. 

Microsoft provides lots of defaults that maybe in cirrculation

Beware of Architecture - 32 or 64 bit - less important in 2020s
- Registry Key information varies in listing of information!
- Select the correct system key `HKEY_LOCAL_MACHINE\SYSTEM\Select` - `Current` will display the current control set

`HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer`
- Last command enter thru the run dislog box
- Recent open dialog box entries
- Save As Dialog Box entires
- Recent Document list by extension
- Recent executables ran
Recent Executables  `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\CIDSizeMRU`
Recent Documents opened and saved by Extension `HKCU\SOftware\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\OpenSavePidlMRU`
Recent Documents
`HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs`
Recent Run entries
`HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU`


Windows Event Log - Harvest it
- Find what they are looking for
- Find out if they are sending the information somewhere (deomnstrates the level of expertises), also the level of possible counter measures on the network - Azure is does this by default.

If `Wecsvc` is  running - run `wecutil` with `es` Enumerate subscription and `gs` enumerated configuration.

Info on file location name and configuration is in:
`HKLM\SYSTEM\CurrentControlSet\Services`
- Beware of the capitalisation of `EVENTLOGS`, `Eventlog` or `eventlog` by OS version.

Post Vista requires permissions and logging of deleting logs logs another log.

`event_manager` in meterpreter script.
`search -e iehistory -f` (Internet history) or `mapi`(outlook and Windows mail)  meterpreter  

## OS X

OS X is very simple - it is still not really Unix  
OS X user are apparently are easier to phish
OS X don't have AV.
OS X saves all information about settings in `Plist` - python has a `plistlib` for parsing these files.. - use `usr/bin/defaults`
If PList is binary format convert with `plutil -convert xml1 $filename` - not really xml -  Apple is special.

```bash
# Get all system preferences and configuration
system_profiler 
# Password POlicy
pwpolicy -gethashtypes -u $user
# Recent applications
defaults read com.apple.recentitems RecentApplication | grep Name
# Recent Remote Host
defaults read com.applerecentitems Host | grep URL
# Lion and SnowLeopard keep a per app recent document list in:
# People like downloading apps, but only use a few.
~/Library/Preferences/<app domain>.LSSharedFileList.plist
# Find files 
# Often files are in b64 and blobs, mdfind uses spotlight function to  
mdfind <blob> 
mdls # list files
# limited to specific directory
mdfind -onlyin ~/Desktop Meta *
# Query for specific metadata parameters  
# || && != ==
mdfind "kMDItemContentType == 'com.microsoft.word.doc' || kMDItemContentType == 'com.adobe.pdf'"
# Use Keyword
kind:<keyword>
# Date Ranges:
Date:this week
# Snow Leopard Hashes
# If we enable smb sharing it will then save the Salted SHA1 as SMB-NT and LANMAN for that password!
# Dump user information including Shadowhashes on Lion:
dscl localhost -read /Search/Users/$username
# Both both Lion and Snowleopard it will display password hint, some user put apssword in the password hint.
# Screenshots - require admin
screenscapture 
# text content of a clipboard 
pbpaste
pwpolicy --get-effective-policy
# secure deletion of files:
srm 
```

System Profiler data types list:
```bash
system_profiler SPSoftwareDataType # OS info
system_profiler SPNetworkDataType
system_profiler SPBluetoothDataType
system_profiler SPEthernetDataType
system_profiler SPPrintersDataType
system_profiler SPUSBDataType
system_profiler SPAirPortDataType
system_profiler SPFirewallDataType
system_profiler SPNetworkLocationDataType
system_profiler SPApplicationDataType
system_profiler SPDeveloperToolsDataType
system_profiler SPLogsDataType
system_profiler SPPrefPaneDataType 
system_profiler SPStartupItemDataType
```


## Meterpreter

```ruby
# lists meterpreter console commands given a resource file
post/multi/gather/run_console_rc_file
# list of shell commands 
post/multi/gather/multiple_command
# WMIC commands can be run 
post/multi/gather/wmic_comand
```


## References

[Tactical Post Exploitation - by Carlos Perez](https://www.youtube.com/watch?v=gNUhK6G8EQ4)