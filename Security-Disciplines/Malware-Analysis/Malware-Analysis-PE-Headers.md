# Malware Analysis PE Headers

[Portable Executable (PE) File](https://en.wikipedia.org/wiki/Portable_Executable)  format is a [file format](https://en.wikipedia.org/wiki/File_format "File format") for [executables](https://en.wikipedia.org/wiki/Executable "Executable"), [object code](https://en.wikipedia.org/wiki/Object_file "Object file"), [DLLs](https://en.wikipedia.org/wiki/Dynamic-link_library "Dynamic-link library") and others used in 32-bit and 64-bit versions of [Windows](https://en.wikipedia.org/wiki/Microsoft_Windows "Microsoft Windows") [operating systems](https://en.wikipedia.org/wiki/Operating_system). It has the extension `.exe` and is a Common Object File Format (COFF) data structure consists of Windows PE files, DLLs, shared objects in Linux, and ELF files.

[pe-tree](https://github.com/blackberry/pe_tree) is a Python module for viewing Portable Executable (PE) filesin a tree-view using [pefile](https://github.com/erocarrera/pefile) and [PyQt5](https://pypi.org/project/PyQt5/). It can also be used with IDA Pro and Rekall to dump in-memory PE files and reconstruct imports. Beware the time it takes to run `pe-tree` on a file.

Headers are of the data type [STRUCT](https://docs.microsoft.com/en-us/cpp/cpp/struct-cpp?view=msvc-170), like:
```c
struct rectangle {
  int width;
  int height;
};
```
The documentation for Windows headers can be found on [MSDN Window Headers](https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_nt_headers32)

## Headers

Important  Meta Information about a Section to consider:
-   _VirtualAddress:_  indicates this section's Relative Virtual Address (RVA) in the memory.
-   _VirtualSize:_  indicates the section's size once loaded into the memory.
-   _SizeOfRawData:_  represents the section size as stored on the disk before the PE file is loaded in memory.
-   _Characteristics:_  the permissions that the section 


IMAGE_DOS_HEADER consists of the first 64 bytes of the PE file and for Windows, the MZ characters denote the initials of [Mark Zbikowski](https://en.wikipedia.org/wiki/Mark_Zbikowski), one of the Microsoft architects who created the MS-DOS file format and are an identifier of the Portable Executable format. This header will contain important default information such as endianess, address of the beginning of the header, address of IMAGE_NT_HEADERS- `e_lfanew`, minimum and maxium allocation width.

DOS STUB detail whether it can be run in DOS mode or not with the message: `!This program cannot be run in DOS mode`

IMAGE_NT_HEADERS in [Microsoft Documentation](https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_nt_headers32)

NT_HEADERS
-   Signature - first 4 bytes denoting the start of the NT_HEADER
-   FILE_HEADER 
	-   Machine: type of architecture for which the PE file is written for.
	-   NumberOfSections: the number of sections the PE file has
	-   TimeDateStamp:  the time and date of compilation. 
	-   PointerToSymbolTable: COFF file headers
	-   NumberOfSymbols: COFF file headers .
	-   SizeOfOptionalHeader:  The size of the optional header. 
	-   Characteristics:  characteristics of a PE file
		- Information from compilation - stripped information
- OPTIONAL_HEADER
	-   Magic: idicates whether it is 32-bit (0x010B) or 64-bit (0x020B) application. 
	-   AddressOfEntryPoint: This is the address from where Windows will begin execution - Important!.
	-   BaseOfCode: address of the code section relative to ImageBase.
	-   BaseOfData: address of data section relative to ImageBase.
	-   ImageBase: The ImageBase is the preferred loading address of the PE file in memory. 
	-   Subsystem: This represents the Subsystem required to run the image. See [Microsoft Documentation Complete for Subsystem listing](https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_optional_header32).
	-   DataDirectory: The DataDirectory is a structure that contains import and export information of the PE file (called Import Address Table and Export Address Table).

IMAGE_SECTION_HEADER
-   _.text:_ generallu contains executable code for the application - characteristics for this section include CODE, EXECUTE and READ
-   _.data:_ contains initialized data of the application - it has READ/WRITE permissions but doesn't have EXECUTE permissions.
-   ._rdata/.idata:_ contains the import information of the PE file
-   .ndata: The .ndata section contains uninitialized data.
-   _.reloc:_ This section contains relocation information of the PE file.
-   _.rsrc:_ The resource section contains icons, images, or other resources required for the application UI.
- IMAGE_IMPORT_DESCRIPTOR - Contains imports information - IMPORTANT look at what the PE file is loading!

## Evidence of Packed Executable Files

- high entropy
- smaller size than a legitimate binary of the same name 
- sections having execution or strange set of (for a section) permissions
- unconventional or empty section names 
- import information - generally look for functions malware writers would use for:
	- getting processes, memory addresses to potentially inject or hijack or hollow, etc



Use [pecheck](https://github.com/DidierStevens/DidierStevensSuite/blob/master/pecheck.py), consider [Didier Steven's Blog on pecheck](https://blog.didierstevens.com/2020/03/27/carving-pe-files-with-pecheck-py/) 

## References

[THM Dissecting PE Headers Room](https://tryhackme.com/room/dissectingpeheaders)
[Wikipedia Portable Executable (PE) Files](https://en.wikipedia.org/wiki/Portable_Executable) 
[Wikipedia Mark Zbikowski](https://en.wikipedia.org/wiki/Mark_Zbikowski)
[Microsoft Documentation for IMAGE_NT_HEADERS](https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_nt_headers32)
[MSDN Window Headers](https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_nt_headers32)
[Microsoft Documentation Complete subsystem listing](https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_optional_header32)
[Didier Steven's Blog on pecheck](https://blog.didierstevens.com/2020/03/27/carving-pe-files-with-pecheck-py/) 
