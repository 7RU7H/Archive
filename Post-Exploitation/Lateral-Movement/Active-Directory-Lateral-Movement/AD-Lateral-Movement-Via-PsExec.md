# Active Directory Lateral Movement Via PsExec


#### SysInternals Psexec

[[Sysinternals]] to move laterally. **Beware** - `PsExec.exe` ([[Sysinternals-Psexec]])  writes `psexecsvc.exe` to `C;\Windows` of a remote machine to create and spawn service then run `$cmd` as a child process of `psexecsvc.exe`. 
```powershell
# $user MUST be a part of the Administrators lcoal group
# ADMIN$ share must be avalilable 
# File and Printer sharing must be ON!
.\PsExec64.exe -i  \\$ComputerName -u $domain\$user -p '$password' $cmd
```

Enable `ADMIN$` share 
```powershell
# With net commands
net share ADMIN$ 
# Remove share
net share ADMIN$ /delete


# With the registry - Requires Reboot 
REG ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
# pwsh registery interaction
New-ItemProperty -Name AutoShareWks -Path HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters -Type DWORD -Value 0
# Reboot Reboot!
shutdown /r /t 0
```

`Netsh` to control File and Printer Sharing - [elevenforum](https://www.elevenforum.com/t/turn-on-or-off-file-and-printer-sharing-in-windows-11.4579/)
```
netsh advfirewall firewall set rule group="File and Printer Sharing" new enable=Yes

netsh advfirewall firewall set rule group="File and Printer Sharing" new enable=No
```

In an Administrative PowerShell session - [elevenforum](https://www.elevenforum.com/t/turn-on-or-off-file-and-printer-sharing-in-windows-11.4579/)
```powershell
# Turn on File and Printer Sharing
# 
# Apply to all network profiles
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled True -Profile Any​
# Apply to "Domain" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled True -Profile Domain
# Apply to "Private" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled True -Profile Private
# Apply to "Public" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled True -Profile Public
# Turn off File and Printer Sharing
# 
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled False -Profile Any​
# Apply to "Domain" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled False -Profile Domain
# Apply to "Private" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled False -Profile Private
# Apply to "Public" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled False -Profile Public
```

## References

[elevenforum](https://www.elevenforum.com/t/turn-on-or-off-file-and-printer-sharing-in-windows-11.4579/)