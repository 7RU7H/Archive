
[NahamCon x Red Team Village](https://www.twitch.tv/videos/1847826441) 

Tunnelling exists to help deal with capability of IPv address usage across the internet and intranets. IPv6 was first drafted in 1998 and to ease the trinsition from IPv4 to IPv6 tunnelling allow disparate segments that needed IPv6 to connect and route traffic when the Internet backbone did not support IPv6.

- Network Segmentation - An architectural approach that divides a network, because:
	- Control between networks based on polices
	- Improves monitoring
	- Boots performance
	- Localises technical issues
	- Enhances security

For defensive operations network segmentation can limit the adversaries reach.

- Tunnelling is used legitimately and illegitimately to:
	- Protect Traffic with encryption
	- Encapsulate Traffic
	- Route data across disparate network segments or protocols


Techniques
- Tunnelling: Moving packets from one network to another
- Pivoting: Moving traffic in a network by using an entry point
- Port Forwarding: Pivoting traffic from local listener to remote port
- Reverse Port forwarding: Pivoting from a remote listener to a local system
- Dynamic Port Forwarding: A socket on the local machine that acts as a SOCKS proxy server
- Redirection: Traffic manipulation technique that is used to route traffic in a specific way


Tools

General Tools
- ssh
- netcat
- foxyproxy
- RPIVOT
- SSHuttle
- OpenSSL
- socat
Nix Tools
- Proxychains
- cURL
- wget
- iptables
Windows Tools
- plink
- Proxfier
- CNTLM
- YARP
- Chisel


Local Port forwarding allows you to forward a port on the local machine to a port on the remote machine - connect to a remote service on a internal network
```bash
ssh -L [local_ip:][local_port]:[target]:[target_port] [user]@[ssh_server]
```

Reverse/Remote Port Forwarding allows you to forward a port on a remote machine to a port on the local machine - give access to a internal service on to a external box
```bash
ssh -R [remote_ip:][remote_port]:[target]:[target_port] [user]@[ssh_server]
```

Dynamic Port Forwarding allows you to create a socket on the local machine to act as a SOCKS proxy to dynamically forward traffic to a dynamic port on the destination machine - tunnel web browser traffic through a SSH server
```bash
ssh -D [local_ip:][local_port] [user]@[ssh_server]

```

Proxychains
```bash
ssh -D [socks_port] [user]@[ssh_server]
# edit /etc/proxychains4.conf 
socks4 127.0.0.1 [socks_port]
proxychains4 $cmd
# curl through the osck proxy
curl -x "http://127.0.0.1:[socks_port]" http://threatsims.com
```

SSHuttle to tunnel all traffic through network 
```bash
# set target subnet to 0.0.0.0/0 or 0/0 to forward all traffic
# use --dns to proxy DNS queries through the server
sshuttle -r [user]@[ssh_server] [target_subnet] -vv
```

OpenSSL - for cryptographic tasks
```bash
# Generate RSA key
openssl genrsa -out $filename.key 1024
# Generate certificate
openssl req -new -key $filename.key -x509 -days 3653 -out $filename.crt
# generate PEM
chmod 600 $filename.key $filename.pem
```

Redirection at scale with Iptables
```bash
# Enable port forwarding in the kernel
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
iptables -t nat -A PREROUTING -i $interface -p tcp --dport $portA -j REDIRET --to-port $portB
# Redirect from host to another host
iptables  -t nat -A PREROUTING -p tcp -s $srcHostAddress --sport 12345:123456 -d $dstHostAddress -dport 22 1
```

Socat
```bash
# Redirect all Port A connections locally to port B
socat TCP4-LISTEN:$portB,reuseaddr,fork TCP4-LISTEN:$portA,resuseaddr
# Port to remote IP and port
socat TCP-LISTEN:$listenerPort,fork TCP:$redirectIP:$remotePort &

# Socat SSL Tunnel
# Generate Certs
filename=server
openssl genrsa -out $filename.key 1024
openssl req -new -key $filename.key -x509 -days 3653 -out $filename.crt
cat $filename.key $filename.crt > $filename.pem
chmod 600 $filename.key $filename.pem
# On target
socat OPENSSL-LISTEN:443,reuseaddr,certserver.pem,cafile=client.crt EXEC:/bin/sh
# On local machine 
socat STDIO OPENSSL-CONNNECT:localhost:433,cert=client.pem,cafile=server.crt
```

Portforwarding with `netsh`
```powershell
netsh interface portproxy add v4 v4tov4 listenaddress=$localAddress listenport=$listenPort connectAddress=$dstAddress connectionPort=$dstPort
```


## References

[NahamCon x Red Team Village](https://www.twitch.tv/videos/1847826441) 