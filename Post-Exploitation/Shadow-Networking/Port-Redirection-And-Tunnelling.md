# Port Redirection And Tunnelling

This article is about Port Forwarding, and Traffic encapsulation, if you require combining these techniques with [[Proxies]] follow the link. These techniques are tools to manipulate the directional flow of targeted traffic. This is useful in restrictive network environments and similar to the NFS mounting done after [[NFS-Recon]] it has similar quality of being (mind-melting). Hosts can be self referential and ports can be reused; combining a set of firewall rules that will allow traffic from specific port things can get complicated.

## Authorial Note on definitions and terminological uses

Firstly this topic is widely discussed sometimes erroneously and interchangeably with proxying and pivoting with terms used in legitimate system administration and in the shadow system administration, which confused me as I was learning this. Beware tools like [[Chisel]] have a `-reverse` flag for the server to listen and accept connections, but a `R:address:port..` for the client to reverse traffic.

The syntactic structure of these terms follow an `X` then `Object Verb` with `X` for explanation here to denote either Local, Remote/Reverse or Dynamic being descriptors to the type of service and the location that service to run from a source and interacting with a destination. The term Port Redirection from Offensive Security is used as terminological parent to describe a family network configurations that share commonality of exposing a port (IP in the case of IP forwarding for aiding in etymological classification) to another machine outside of network boundary.

- Redirection is used as directionality can be of type (I have currently found to this date):
	- Forwarding - to expose to another 
		- Exist due to an arbitrary boundary implement such that a network administrator decides to expose a port, hostname or IP over Forwarding of those addresses for inbound or outbound traffic management
	- [Bending](https://www.youtube.com/watch?v=d6qtr-rYxXw) - redirecting to another (this is what professional call this, but Redirecting make more sense)
		- Done to manage traffic to a specific destination from one entry point (and through multiple intermediaries if required) to an endpoint 
- Reverse entails remote application requesting configuration of your local network device, although is used interchangeably.

To breakdown concept-by-concept I will use the following as placeholders:
X = Service at a network location - Local, Remote/Reverse, Dynamic
Y = Port, IP (Yes this is an article about Port redirection, but IP forwarding exists)
Z = Forwarding, Bending

Local Y Z- serves (opens connection) from your box to a target
Remote/Reverse Y Z  - serves (opens connection) from the target to your box
Dynamic Y Z-  serves a SOCKS proxy 

Proxy - an intermediary between two points  
Pivot - an term use to relay traffic (from both direction) through points in a network between two endpoints
Tunnel - encapsulating traffic, use a protocol to have another traffic stream inside itself.

## If Root or System...

Dropping Binaries sometimes bad for stealth. If you are already `root` or `NT SYSTEM`, you can allow for forwarding with:

#### Linux
Linux: ` echo 1 > /proc/sys/net/ipv4/conf/$INTERFACE/forwarding` 

With `iptables`
```bash
iptables -t nat -A PREROUTING -p tcp -d 127.0.0.1 --dport 4141 -j DNAT --to-destination <destination_ip>:<destination_port>
iptables -t nat -A POSTROUTING -j MASQUERADE
```

#### Windows
Windows has multiple variations:

`netsh` 
```powershell
netsh interface ipv4 show interfaces
netsh interface ipv4 set interface $INTERFACE_INDEX forwarding=enabled
netsh interface ipv4 show interfaces $INTERFACE_INDEX
```

Beware UAC!  `portproxy` subcontext of the `netsh interface` command requires administrative privileges`
```powershell
netsh interface portproxy add v4tov4 listenport=1337 listenaddress=$ipToReachFromAttackingMachine connectport=22 connectaddress=$targetInteralIPaddress
# Display the port forward
netstat -anp TCP | find "2222"
netsh interface portproxy show all
# Create a firewall rule to allow inbound traffic
netsh advfirewall firewall add rule name="port_forward_ssh_2222" protocol=TCP dir=in localip=$ipToReachFromAttackingMachine localport=1337 action=allow

# Clean up
# Clean up Firewall rule
netsh advfirewall firewall delete rule name="port_forward_ssh_2222"
# Clean up netsh portproxy
netsh interface portproxy del v4tov4 listenport=2222 listenaddress=$ipToReachFromAttackingMachine
```

`reg`
```powershell
req query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces
reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces\$INTERFACE_KEY" /v IPEnableRouter /t REG_DWORD /d 1 /f
```

`PowerShell`
```powershell
Get-NetIPInterface
Set-NetIPInterface -InterfaceIndex $INTERFACE_INDEX -Forwarding Enabled
Get-NetIPInterface -InterfaceIndex
```

## Security Considerations At Both Ends

It may be suitable to create a specific user without access to any console on your machine. 

```bash
useradd tunneluser -m -d /home/tunneluser -s /bin/true
passwd tunneluser
```

Firewalls maybe present and require configuration, turning off(very noisey) or just enumerating - either with simple port scan or just using your brain to make assumption that the specific traffic and traffic type to and from specific ports is expected  
```powershell
# Add a firewall rule 
netsh advfirewall firewall add rule name="Open Port 80" dir=in action=allow protocol=TCP localport=80
# More additions incoming at some point
```

## Traffic encapsulation

[Tunneling (Protocol)](https://en.wikipedia.org/wiki/Tunneling_protocol), encapsulating traffic within a different protocol to carry the original traffic inside another protocol(which is not prohibited) over a once incompatible delivery network. By exploitation of encapsulation it allows for private network communications to be sent across a public network.

## Port Forwarding

[Port forwarding](https://en.wikipedia.org/wiki/Port_forwarding), is a method to direct your traffic from one IP address and selected port forwarding it to another address and port. More specifically utilising NAT (see [[Network-Address-Translation-Defined]] to redirect a communication request from one `address` and `port` to another while the packets are traversing a network gateway, such a router or firewall. There are three types:
1. Local port forwarding - local computer to another server bypassing local infrastructure `ssh -L <local port>`
2. Remote port forwarding - enables server side applications to access client side, connecting to a remote network service located at the tunnel's client side.
3. Dynamic port forwarding - traversal of a firewall or NAT through firewall pin holes, configuring SOCKs or other [[Proxies]] to direct traffic..

The client machine on the network behind the firewall is not routed such it does not have access to the internet. Beware an actual  Internet-disconnected internal network may not have a working external DNS.

```goat
				  {Internet}
				  	  ^
					  |
______				  |										 ______
[[  ]] ---------> [FIREWALL] <-----/NO ROUTE TO INTERNET-----[[  ]] 
/===/														 /===/
   
Attacker													 Client
```

The firewall rules for examplification means only allow all traffic recieved from port 80 remotely, thus by port forwarding using port 80.
```goat
 	___________{Internet}_____LOCAL_PORT_FORWARDING_____________
   |				  ^											|
   |				  |											|
  START 		      |											|
______				  |										 ______
[[  ]] ---------> [FIREWALL] <-----/NO ROUTE TO INTERNET-----[[  ]] 
/===/														 /===/
Attacker													 Client
```
We can use netcat to verify and validate connectivity:
```bash
nc -nvv $Client-IP $firewall-happy-port
```
Then use tool of choice to port forward! See Tools section of this article.

## SSH 

[SSH](https://www.ssh.com/academy/ssh/protocol) is encrypted and bi-directional, which equates to secure and can handle transference. `ssh` local port forwarding allows us to tunnel a local port to a remote server using `ssh` as a transport protocol. `ssh` Local port forwarding allows one to pivot into another internally connected network that is not exposed via the same exploit chain that allowed you the breach the network in the first place. Without transferring your tools to the compromised client, you just tunnel your traffic through the compromised client. Consider:
- [[SSH-Cheatsheet]]
- [[SSH-Redirection-And-Tunnelling]]

## HTTPTunnel-ing through deep packet inspection

Deep packet content  inspection devices exist and may only allow specific protocols. `httptunnel` uses a client/server model to  encapsulate the traffic within HTTP requests. Similarly for TLS encryption [Stunnel](https://www.stunnel.org/) *is a proxy designed to add TLS encryption functionality to existing clients and servers without any changes in the programs' code.*

```goat			
	__(htc_client)_{__HTTPTunnel_}__
	^		  	{              }	|
	|			{		      }		|
______			 {		    }		|
[[  ]] ---------> {Internet}		(htc client/server)
/===/				  ^				|
Attacker			  |				|
				  	  |				|https://www.youtube.com/watch?v=d6qtr-rYxXw
		   _______[FIREWALL]		|
		  | 						|
		  |		____________________|
		  |		|	
		  |		(hts server)
		  |		|   _____________Local_Port_Forward____________
		  |		V  |										   |
______	  |	   ______					  			  ______   |
[[  ]]<------->[[  ]]-----Not routed to firewall----->[[  ]]<---						
/===/		   /===/						 		  [[  ]]	
Client		  Client						  		  Server										 
```

Attacker `htc --forward-port 8080 $tunnel_server_ip:$tunnel_server_port`
Client `hts --forward-port localhost:8888 $tunnel_server_port` + `ssh -L 0.0.0.0:8888:$distination_ip$:destrination_port $client_user@127.0.0.1`

## Tools

#### Rinetd

[Rinetd](https://github.com/samhocevar/rinetd) - github version linked as his personal website has a certificate issues..

#### Chisel

[Chisel](https://github.com/jpillora/chisel) *[[Chisel]] is a fast TCP/UDP tunnel, transported over HTTP, secured via SSH. Single executable including both client and server. Written in Go (golang). Chisel is mainly useful for passing through firewalls, though it can also be used to provide a secure endpoint into your network.*

![demo](Images/chisel-picture-github.png)

#### HTTPTunnel 

Kali supported
```bash
sudo apt install httptunnel
```

#### PLINK.exe

[PLINK](https://the.earth.li/~sgtatham/putty/0.53b/htmldoc/Chapter7.html) is a Windows based tool to perform port forwarding

```powershell
# plink.exe
# Plink: command-line connection utility
# Release 0.70
# Usage: plink [options] [user@]host [command]
#        ("host" can also be a PuTTY saved session name)
# Options:
#   -V        print version information and exit
#   -pgpfp    print PGP key fingerprints and exit
#   -v        show verbose messages
#   -load sessname  Load settings from saved session
#   -ssh -telnet -rlogin -raw -serial
#             force use of a particular protocol
#   -P port   connect to specified port
#   -l user   connect with specified username# Port Redirection And Tunneling
#             Forward local port to remote address
#   -R [listen-IP:]listen-port:host:port
#             Forward remote port to local address
#   -X -x     enable / disable X11 forwarding
#   -A -a     enable / disable agent forwarding
#   -t -T     enable / disable pty allocation
  
C:\Users\Hacker\Tools> plink.exe -ssh -l $attacker_user -pw $attacker_passwordd -R $remote_ip:$remote_port:127.0.0.1:$target_port $remote_ip # remote being connecting back to a user on that $remote_ip

# Pipe it through to prevent interaction from windows host, so cmds from attacker host proxy through
cmd.exe /c echo y | plink.exe <options>https://www.youtube.com/watch?v=d6qtr-rYxXw
```

## Socat 

See [[Socat]] for more uses, although robust and can encrypt traffic the disadvantages of using socat is that we need to transfer it to the pivot host.
```bash
# A = Attacker, B = Pivot host, C = Server

# ssh tunnel with socat
socat TCP4-LISTEN:$port,reuseaddr,fork TCP4:domain.com:ssh
# Port Redirection And Tunneling
#             Forward local port to remote address
#   -R [listen-IP:]listen-port:host:port
#             Forward remote port to local address
#   -X -x     enable / disable X11 forwarding
#   -A -a     enable / disable agent forwarding
#   -t -T     enable / disable pty allocation
  
C:\Users\Hacker\Tools> plink.exe -ssh -l $attacker_user -pw $attacker_passwordd -R $remote_ip:$remote_port:127.0.0.1:$target_port $remote_ip # remote being connecting back to a user on that $remote_ip

# Pipe it through to prevent interaction from windows host, so cmds from attacker host proxy through
cmd.exe /c echo y | plink.exe <options>https://www.youtube.com/watch?v=d6qtr-rYxXw
```
​
## With SYSTEM level Windows Access..

With SYSTEM level Windows access we can use `netsh`. First `IP Helper service` is running and it must have IPv6 support enabled for interface to work.
```powershell
# Configure firewall to allow traffic
netsh advfirewall firewall add rule name="forward_port_rule" protocol=TCP dir=in localip=$local_ip localport=$local_port action=allow
# Connect back
netsh interface portproxy add v4tov4 listenport=$port listenaddress=$IP connectport=$local_port connectaddress=$connect_address
```
You can then use sbmclient, see [[SMB-Recon-Cheatsheet]], and mount to the share to exfilitrate data.
```bash
# Set correct protocol in smb.conf
sudo /etc/init.d/smbd restart
# List shares, port forward generates an timeout error
smbclient -L $target_address --port=$firewall_happy_port_from_above --user=Administrator
# Mount into shares to interact
sudo mkdir /mnt/$local_share
sudo mount -t cifs -o port=$firewall_happy_port_from_above //$target_address/$remote_share -o username=Administrator,password=$password /mnt/$local_share
````

## Reference

[Tunneling(Protocol) Wiki](https://en.wikipedia.org/wiki/Tunneling_protocol)
[Port forwarding Wiki](https://en.wikipedia.org/wiki/Port_forwarding)
[SSH has an academy](https://www.ssh.com/academy/ssh/protocol)
[PLINK](https://the.earth.li/~sgtatham/putty/0.53b/htmldoc/Chapter7.html)
[Chisel](https://github.com/jpillora/chisel)
[Rinetd](https://github.com/samhocevar/rinetd) - Note: github version linked as his personal website has a certificate issues..
[Stunnel](https://www.stunnel.org/)
[SANS using-the-ssh-konami-code-ssh-control-sequences](https://www.sans.org/blog/using-the-ssh-konami-code-ssh-control-sequences/)
[iredteam](https://www.ired.team/offensive-security/lateral-movement/ssh-tunnelling-port-forwarding)
[John Hammond Port Bending Explained](https://www.youtube.com/watch?v=d6qtr-rYxXw)
[HacksTricks](https://book.hacktricks.xyz/generic-methodologies-and-resources/tunneling-and-port-forwarding)