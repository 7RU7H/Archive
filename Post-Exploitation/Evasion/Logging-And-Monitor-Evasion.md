# Logging And Monitor Evasion

Locard Exchange Principle: *"With contact between two items, there will be an exchange"*

## Introduction

General monitoring solution process:
- Host Device -> Event Collector/Forwarder -> Data Indexer -> ( SIEM Server [[SIEM-Solutions]] )

Primary objective in evasion of logging and monitoring is to control logs before they are forwarded or collected. 

[[ETW]] (**E**vent **T**racing for **W**indows) uses standardised [[XML]] format for logging and events to be utilised locally or forwarded to a central server or indexer. 

Destructive techniques - Log Smashing - interfere with the environmental integrity (normalised chain of forwarding data to monitoring solution) as no logs would be forwarded to be analysed. The diagram below shows the event tracing model with questions and general thought to highlight: *what can we do or should not do and temporal pressure?!*

![](mseetwlogevasiondeface.png)

Log Tampering and Log Smashing can be tracked with the following Event IDs - [[OPSEC-101]] minus 102

|**Event ID**|**Purpose**|
|---|---|
|1102|Logs when the Windows Security audit log was cleared|
|104|Logs when the log file was cleared|
|1100|Logs when the Windows Event Log service was shut down|

The objective then becomes retaining the environmental integrity, but utilise or modify published methods which mostly target a component of [[ETW]] to control the tracing process; tabled below: 

|**Component**|**Purpose**|
|---|---|
|Controllers|Build and configure sessions|
|Providers|Generate events|
|Consumers|Interpret events|

Techniques in relation to the [[ETW]] component they are attacking tabled below:

|**Component**|**Techniques**|
|---|---|
|Provider|PSEtwLogProvider Modification, Group Policy Takeover, Log Pipeline Abuse, Type Creation|
|Controller|Patching EtwEventWrite, Runtime Tracing Tampering,|
|Consumers|Log Smashing, Log Tampering|

#### Missing Events

There are legitimate reasons for missing events

[Microsoft Documentation on ETW - Missing Events](https://learn.microsoft.com/en-us/windows/win32/etw/about-event-tracing#missing-events): 
*Perfmon, System Diagnostics, and other system tools may report on missing events in the Event Log and indicate that the settings for Event Tracing for Windows (ETW) may not be optimal. Events can be lost for a number of reasons:*
- *The total event size is greater than 64K. This includes the ETW header plus the data or payload. A user has no control over these missing events since the event size is configured by the application.*
- *The ETW buffer size is smaller than the total event size. A user has no control over these missing events since the event size is configured by the application logging the events.*
- *For real-time logging, the real-time consumer is not consuming events fast enough or is not present altogether and then the backing file is filling up. This can result if the Event Log service is stopped and started when events are being logged. A user has no control over these missing events.*
- *When logging to a file, the disk is too slow to keep up with the logging rate.*



## References

[THM Evading Logging and Monitoring](https://tryhackme.com/room/monitoringevasion)
[Microsoft Documentation on ETW - Missing Events](https://learn.microsoft.com/en-us/windows/win32/etw/about-event-tracing#missing-events)