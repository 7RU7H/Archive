# Bypassing Antivirus: With Understanding Comes Ease - Jeff McJunkin - WWHF Deadwood 2020 Virtual


[Bypassing Antivirus: With Understanding Comes Ease | Jeff McJunkin | WWHF Deadwood 2020 Virtual](https://www.youtube.com/watch?v=UO3PjJIiBIE)


The job of a penetration tester is to emulate real-world, realistic adversaries to compromise the client and explain the business risks of the technical findings. Those pesky real-world adversaries bypass AV all the time, even with essentially the same malware, over and over.

How do they do it? Simple. By understanding what traps AV is setting, you can step around, jump over, or disable those traps before sauntering to your destination unhindered. I can't help with your saunter, but I can help you understand and bypass AV using arbitrary payloads (whether Cobalt Strike, Metasploit, Covenant, Mystic, SILENTTRINITY, or whichever) in many ways, all in less than an hour.

Jeff McJunkin is the founder of Rogue Valley Information Security, a consulting firm specializing in penetration testing and red team engagements. Jeff has a long background in systems and network administration that he leveraged into web and network penetration testing, especially involving Active Directory. He has taught dozens of classes in network penetration testing for the SANS Institute and is the author of the "Metasploit Kung Fu for Enterprise Pen Testing" course. He specializes in not only finding end-to-end realistic attack scenarios for clients, but also in helping technical staff as well as senior leadership in understanding the attack, its ramifications, detective controls, and assisting in safe remediation. Jeff has competed in many security competitions and has won many of them, along with designing and presenting several iterations of the SANS Core NetWars Tournaments to thousands of attendees.

1. Static Detecitons
2. Hooking APIs calls and searching for bad strings/patterns
	- AMSI
	- Userland hooks
	- Kernel-level

This is approach is prone to false positives

3. Dynamic detection (behavioural analytics during brief emulation)

#### AI

Next-Gen AI is just samples with conditions - you can stack the deck i.e recursiveyl strings over Jeff's entire steam video library the AI statistically detirmines it as a legitimate

#### AMSI

Move away from AV/EDR that do not support AMSI . Check [Whoamsi github page for vendor that support AMSI](https://github.com/subat0mik/whoamsi).

#### Fundemental Limitations of AV

AV is bots fighting bots - Humans can adapt

- AV isn't tracking everything 
	- Each API call interception adds latency - financial incentives matter more
		- Emulation maximum time varies
	- AV intercepts for that .exe running from disk	
		- DLL loading, writing to other processes's memory, creating new threads, extracting com processed content, checking for debugger, etc

- AV companies have financial incentive to minimise false positive, but:
	A) accepting false negatives
	B) brittle signatures

#### Red vs Blue example

https://github.com/NavyTitanium/Fake-Sandbox-Artifacts
https://winternl.com/fuzzing-the-windows-api-for-av-evasion

Malware detects fake environment and then display different behaviour - Malware Analystic make fake real machines to pretend not to be a sandbox.

#### Relationship between False Positives and False Negatives

![](relationship-between-false-positives-and-false-negatives-JM-WWHF-Talk.png)

![](relationship-between-false-positives-and-false-negatives-definitions-JM-WWHF-Talk.png)

#### Disadvantages for Security Professionals

1. Talk about bypass methods
2. Use public tools
3. Upload to [[VirusTotal]]


#### Methods of Bypassing AntiVirus

*In general, avoid fair fights (both against AV and in life)* 

1. Use non-malicious software in malicious ways - [[Windows-Living-Off-The-Land]]
	- [[PSExec]] from Microsoft 
	- No mimikatz - use Task Manager to dump LSASS 
	- Exfiltrate [[Windows-Registry]] and extract hashes elsewhere instead of hashdump
	- No meterpreter - use [[RDP]], mRemote-NG, TeamViewer

*Make an unfair fight*

2. Choices and techniques
	- Run in PowerShell version 2 - does not support AMSI even on Window 10
	- Use API calls that are not intercepted
	- "Unhook" API calls so AV does not have visibility
		- [NtRaiseHardError](https://github.com/NtRaiseHardError/Antimalware-Research)
	- Detect AV sandbox environments and run them differently
		- [anticuckoo](https://github.com/therealdreg/anticuckoo)
		- [fuzzing-the-windows-api-for-av-evasion](https://winternl.com/fuzzing-the-windows-api-for-av-evasion/)
	- Encrypt payload and decrypt only at runtime ([Hyperion](), bypasses static signatures and emulation)
	- Add extra strings from legitimate software 
	- Add extra data to go above certain thresholds - add description that make the file huge

*Stack odds in your favour*

3. Replicate machine with AV, update AV signature and disconnect network adaptor - use snapshots, alway revert regardless


#### Application Control

Verified AppLocker bypasses for Default Rules
```powershell
installutil.exe
msbuild.exe
mshta.exe
presentationhosts.exe
regasm.exe
regsvcs.exe
```

#### A Better Approach with AV

- Rely on detection in depth and rapid response, not solely preventive controls
- Plug AV alerts into monitoring feeds for SOC
- React quickly to AV alerts including root cause analysis
- Do not pick products based on the Gartner Magic Quadrant, but factor it into your own evaluation
- Spend effort on application control ass with EDR and AV as additional layers

#### AV has its own attack surface

- Highly privileged
- Often not sandbox
- Evaluates untrusted inputs code
- Often not logged
- Sometimes has poor software protections

#### Closing Statement

1. Lowering the time to detect and respond to an attackers
2. Making it take longer for an attacker to accomplish their goals

## References

[Bypassing Antivirus: With Understanding Comes Ease | Jeff McJunkin | WWHF Deadwood 2020 Virtual](https://www.youtube.com/watch?v=UO3PjJIiBIE)
