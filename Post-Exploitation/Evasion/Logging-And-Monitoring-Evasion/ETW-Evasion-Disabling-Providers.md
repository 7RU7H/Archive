# ETW Evasion Disabling Providers


Instead of [[ETW-Evasion-Group-Policy-Takeover]], disabling Providers to [[Event-Tracing-for-Windows]] can limit the visibility of components you require while still making the environment seem untampered.

## PowerShell GPO Provider Disabling

Introduced in PowerShell v4 and then improved in PowerShell v5, ETW providers monitor PowerShell usage, including 
- `script block logging`  - records the pipeline execution details of PowerShell
- `module logging` - records block of code as they are executed therefore it captures the complete activity and full content of the script

[[Windows-Events-To-Monitor]]:

|**Event ID**|**Purpose**|
|---|---|
|4103|Logs command invocation|
|4104|Logs script block execution|


List EventLog cmdlets
```powershell
Get-Command -Noun EventLog
```

List current providers (requires Administrator PowerShell)
```powershell
Get-ETWTraceProvide
```

Unregister PowerShell Provider
```powershell
$PSHOME\RegisterManifest.ps1 -Unregister
```

Decrypt protected event logging messages
```powershell 
Get-WinEvent Microsoft-Windows-PowerShell/Operational |
  Where-Object Id -eq 4104 | Unprotect-CmsMessage
```

Enable PowerShell Script block logging in the GUI with:
- Group Policy:
	- `Search -> Run -> gpedit.msc
	- `Administrative Templates -> Windows Components -> Windows PowerShell`. 
	- `Turn on PowerShell Script Block Logging`
- Registry:
```powershell
function Enable-PSScriptBlockLogging
{
    $basePath = 'HKLM:\Software\Policies\Microsoft\Windows' +
      '\PowerShell\ScriptBlockLogging'
    if(-not (Test-Path $basePath))
    {
        $null = New-Item $basePath -Force
    }
    Set-ItemProperty $basePath -Name EnableScriptBlockLogging -Value "1"
}
```

When Script Block Logging is enabled, PowerShell logs the following events to the `PowerShellCore/Operational` log:
 
|Field|Value|
|---|---|
|EventId|`4104` / `0x1008`|
|Channel|`Operational`|
|Level|`Verbose`|
|Opcode|`Create`|
|Task|`CommandStart`|
|Keyword|`Runspace`|


Use PowerShell to view logs
```powershell
Get-WinEvent -LogName “Microsoft-Windows-Powershell/Operational” | select -first 20 | Out-Gridview
```

[[Event-Viewer]] can be found: 
- `Appilication and Sevices Logs > Microsoft > Windows > Powershell > Operational`


## References

[THM Evading Logging and Monitoring](https://tryhackme.com/room/monitoringevasion)
[Microsoft DevBlogs - Use PowerShell to Find ETW Providers](https://devblogs.microsoft.com/scripting/powertip-use-powershell-to-find-etw-providers/)
[Microsoft Documentation - PowerShell Logging](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows?view=powershell-7.3)
[Medime - Ammad Ali - PowerShell Logging: Module Logging vs Script Block Logging](https://medium.com/@ammadb/powershell-logging-module-logging-vs-script-block-logging-7aa74bf66261)