# Logging And Monitoring Evasion

Locard Exchange Principle: *"With contact between two items, there will be an exchange"*

## Introduction

[[ETW]] (**E**vent **T**racing for **W**indows) is a Windows OS logging mechanism for troubleshooting and diagnostics that uses standardised [[XML]] format for logging and events to be utilised locally or forwarded to a central server or indexer. 


General monitoring solution process:
- Host Device -> Event Collector/Forwarder -> Data Indexer -> ( SIEM Server [[SIEM-Solutions]] )

Primary objective in evasion of logging and monitoring is to control logs before they are forwarded or collected. Log Tampering and Log Smashing can be tracked with the following Event IDs - [[OPSEC]] minus 102.

|**Event ID**|**Purpose**|
|---|---|
|1102|Logs when the Windows Security audit log was cleared|
|104|Logs when the log file was cleared|
|1100|Logs when the Windows Event Log service was shut down|

The objective then becomes retaining the environmental integrity, but utilise or modify published methods which mostly target a component of [[ETW]] to control the tracing process; tabled below: 

|**Component**|**Purpose**|
|---|---|
|Controllers|Build and configure sessions|
|Providers|Generate events|
|Consumers|Interpret events|

Techniques in relation to the [[ETW]] component they are attacking tabled below:

|**Component**|**Techniques**|
|---|---|
|Provider|PSEtwLogProvider Modification, Group Policy Takeover, Log Pipeline Abuse, Type Creation|
|Controller|Patching EtwEventWrite, Runtime Tracing Tampering,|
|Consumers|Log Smashing, Log Tampering|

Logman.exe is a native Windows command-line utility, which is considered to be a `Controller`.
```powershell
# list all providers
logman query providers
# Interesting providers:
logman query providers Microsoft-Windows-Kernel-Process
logman query providers "{22FB2CD6-0E7B-422B-A0C7-2FAD1FD0E716}"
# Query which providers out current PowerShell console is registered with $pid 
logman query providers -pid $pid

# Create a tracing session
logman create trace spotless-tracing -ets
# Query our tracing session
logman query trace spotless-tracing -ets
# Use our tracing session to subscribe to events abouts process and images provided by the Microsoft-Windows-Kernel-Process provider
# Query to for values for keywords: 0x0000000000000010 -> 0x10 
logman query providers "{22FB2CD6-0E7B-422B-A0C7-2FAD1FD0E716}"
# Note value for target keyword 0x0000000000000010 WINEVENT_KEYPROCESS_PROCESS
# Becomes just: `0x10`
# Update our tracing session
logman update spotless-tracing -p Microsoft-Windows-Kernel-Process 0x10 -ets
# Query get event type of the provider registered and being listened to.
logman query spotless-tracing -ets
# Remove a provider from our tracing session
logman update trace spotless-tracing --p Microsoft-Windows-Kernel-Process 0x10 -ets
# Kill the entire tracing session
logman stop spotless-tracing -ets
```

Tools:
- [ETWExplorer](https://github.com/zodiacon/EtwExplorer) if a GUI application for  deep provider inspection
- [[Event-Viewer]]
- Consume Events with [Pavel Yosifovich's SimpleKernelConsumer](https://github.com/zodiacon/DotNextSP2019/blob/master/SimpleKernelConsumer/Program.cs) - requires the tracing package

#### Missing Events

There are legitimate reasons for missing events

[Microsoft Documentation on ETW - Missing Events](https://learn.microsoft.com/en-us/windows/win32/etw/about-event-tracing#missing-events): 
*Perfmon, System Diagnostics, and other system tools may report on missing events in the Event Log and indicate that the settings for Event Tracing for Windows (ETW) may not be optimal. Events can be lost for a number of reasons:*
- *The total event size is greater than 64K. This includes the ETW header plus the data or payload. A user has no control over these missing events since the event size is configured by the application.*
- *The ETW buffer size is smaller than the total event size. A user has no control over these missing events since the event size is configured by the application logging the events.*
- *For real-time logging, the real-time consumer is not consuming events fast enough or is not present altogether and then the backing file is filling up. This can result if the Event Log service is stopped and started when events are being logged. A user has no control over these missing events.*
- *When logging to a file, the disk is too slow to keep up with the logging rate.*


Clear all [Event Logs](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/clear-eventlog?view=powershell-5.1#example-4-clear-all-logs-on-the-specified-computers-then-display-the-event-log-list)
```powershell
function clear-all-event-logs ($computerName="localhost")
{
   $logs = Get-EventLog -ComputerName $computername -List | ForEach-Object {$_.Log}
   $logs | ForEach-Object {Clear-EventLog -ComputerName $computername -LogName $_ }
   Get-EventLog -ComputerName $computername -list
}

clear-all-event-logs -ComputerName $computername
```

## Techniques

Destructive techniques - Log Smashing - interfere with the environmental integrity (normalised chain of forwarding data to monitoring solution) as no logs would be forwarded to be analysed. The diagram below shows the event tracing model with questions and general thought to highlight: *what can we do or should not do and temporal pressure?!*

![](mseetwlogevasiondeface.png)

[[ETW-Evasion-PowerShell-Reflection]]
[[ETW-Evasion-Patching-Tracing-Functions]]
[[ETW-Evasion-Disabling-Providers]]
[[ETW-Evasion-Group-Policy-Takeover]]
[[ETW-Evasion-Abusing-Log-Pipeline]]



## References

[THM Evading Logging and Monitoring Room](https://tryhackme.com/room/monitoringevasion)
[Microsoft Documentation on ETW - Missing Events](https://learn.microsoft.com/en-us/windows/win32/etw/about-event-tracing#missing-events)
[iredteam ETW 101](https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/etw-event-tracing-for-windows-101)
[Microsoft Documentation Clear all Event Logs](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/clear-eventlog?view=powershell-5.1#example-4-clear-all-logs-on-the-specified-computers-then-display-the-event-log-list)