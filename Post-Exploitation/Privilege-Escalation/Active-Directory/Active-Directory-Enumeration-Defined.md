# Active Directory Enumeration

For exploitation see [[AD-Exploitation-Hub]] or general theory and definitions [[Active-Directory-Defined]]. For commands cheatsheet [[Active-Directory-Commands]] or for Privilege Escalation see [[Active-Directory-Privilege-Escalation]]. Once a [[Active-Directory-Footholding]] is established the objective is continuing the [[Lockhead-Martin-Cyber-Kill-Chain]] till escalating privileges to a Domain Controller or a Domain Admin group member. Information gathering about the domain is critical to meeting this objective. For the cheatsheet of commands see [[Active-Directory-Enumeration-Cheatsheet]]

## Enumerating Towards the Chain of Compromise
With net user/group look for custom groups and check nested groups and especially admin users. `net user` will only show user
```powershell
net user /domain # User account for \\DC*.*domain*.*tld
net user *admin* /domain # information about the admin
net group /domain # All groups in domain - DC is sometimes required
```

[[Useful_Powershell]] cmdlets for AD `Get-ADUser` are only installed by default on the DC with [RSAT](https://docs.microsoft.com/en-us/previous-versions/technet-magazine/gg413289(v=msdn.10)?redirectedfrom=MSDN), see [[Active-Directory-Privilege-Escalation]] and [[Useful_Powershell]] for more cmdlets and commands. They maybe installed on Windows 7-\* onwards, but require Administrative privileges to utilize. Regardless [[Basic_Powershell]] is a useful tool installed by default regardless for administrative scripting and automation. 

Currently Logged on users that are of important groups have credentials cached in memory that could be stolen and used to authenticate with them to perform [[Active-Directory-Lateral-Movement]] or for interacting with [Service principle names](https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names?redirectedfrom=MSDN) and [[Attacking-Kerberos]] or any other [[Active-Directory-Footholding]]. For more information on the mechanics of Kerberos  [[Active-Directory-Kerberos-Authentication-Defined]].

Reliable functions  `NetWkstaUserEnum`(requires Administrative privileges returns a list of active users on a workstation) and `NetSessionEnum`(does not, returns list of list of active user sessions on servers). Use `NetWkstaUserEnum` post-`NT SYSTEM Level`- Only useful for users the local administrator privileges over that are logged on. Use `NetSessionEnum` enumerate all active users' sessions. Similiarly and much more extensive enumeration with [Powerview](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1) can be utilised to great affect in information gathering. Link to: [[Powercat-Cheatsheet]].

[Service principle names](https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names?redirectedfrom=MSDN) as Applications are executed in the context of the operation system user and that user account defines that context, whereas service executed by system itself a [Service Account](https://docs.microsoft.com/en-us/windows/win32/services/service-user-accounts?redirectedfrom=MSDN).  Enumeration through these can lead to [[Attacking-Kerberos]] or [[Active-Directory-Footholding]]. Application use one of the predefined service accounts below to be lauched by the system.

Service Accounts | Privileges 
--- | ---
[LocalSystem](https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account?redirectedfrom=MSDN) | [[Windows-System-And-Service-Privileges]] 
[LocalService](https://docs.microsoft.com/en-us/windows/win32/services/localservice-account?redirectedfrom=MSDN) | [[Windows-System-And-Service-Privileges]]
[NetworkService](https://docs.microsoft.com/en-us/windows/win32/services/networkservice-account?redirectedfrom=MSDN) | [[Windows-System-And-Service-Privileges]]

Domain user account may be required to provide the service accounts more access to resource inside the domain. 

By enumerating all [SPN](https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names?redirectedfrom=MSDN)s in the domain we get: IP and ports running applications intergated on AD servers, without scanning the network.

## Microsoft Management Console
If you have access to RDP you can enumerate with Microsoft Management Console (MMC) with the [Remote Server Administration Tools](https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps) (RSAT) AD Snap-Ins,  see [[Windows-Remote-Server-Administration-Tools]]
for installation, configuration REQUIRED for futher enumeration and other details.

With the configure discussed in the local article we can use this tool like an Admin to view in Object Heirarchy to gather information

## CMD.exe
```powershell
net user /domain
net user <username> /domain
net group /domain
net group "<target group name>" /domain
net accounts /domain                        # Password policy
```

## Powershell
For basic powershell guide: [[Basic_Powershell]] and for more hackery [[Useful_Powershell]].

```powershell
Get-ADUser -Identitiy <username> -Server <domain> -Properties *
Get-ADUser -Filter 'Name -like "*wildcards-allowed"' -Server <domain> | Format-Table Name,SamAccountName -A
Get-ADGroup -Identity Administrators -Server <domain>
Get-ADGroupMember -Identity Adminstrators -Server <domain>
Get-ADDomain -Server <domain>

# Find  Deleted Objects!
$ChangeDate = New-Object DateTime(2022, 02, 28, 12, 00, 00)
Get-AdObject -Filter 'whenChanged -gt $ChangeDate' -includeDeletedObejects -Server <domain>
# Bad password Counts
Get-AdObject -Filter 'badPwdCount -gt 0' -Server <domain>

# Altering AD Objects
Set-ADAccountPassword -Identity <username> -Server <domain> -OldPassword (CovertTo-SecureString -AsPlainText "<old-password>" -Force) -NewPassword (CovertTo-SecureString -AsPlaintext "<new-paasword>" -Force)
```


## Active Directory Service Interfaces (ADSI)
- **DNS**
For more about [[DNS]], for enumeration for DNS see both 
[[DNS-Active-Recon]] and [[DNS-Recon-Passive]].
- **SMB**
[[SMB-Recon-Cheatsheet]] and [[RPCClient-Cheatsheet]]
- **LDAP**
[[LDAP-Recon]]

## SAM Account Type Attributes
[SAM-Account-Type](https://docs.microsoft.com/en-us/windows/win32/adschema/a-samaccounttype?redirectedfrom=MSDN)


## Bloodhound & Sharphound

Briefly before suggesting a link, Bloodhound was released in 2016 is one of the more powerful AD enumeration tools avaliable to red teamers. It was so good Microsoft integrated their own version of Bloodhound in its [Advanced Threat Protection solution.](https://www.microsoft.com/en-ph/dpa-trustcenter/privacy/advancedthreatprotection)

Bloodhound allows Attackers and Defenders to visualize an AD network in a graph format. [Graphs](https://en.wikipedia.org/wiki/Graph_(discrete_mathematics) are powerful datastructures that can store information in edges (the connecting links) and vertices(objects as sets of circles). This graph model through filtering the data to embedded metainformation that can suggest potential escalation paths.

Sharphound is the collection tool that enumerate the network and compress it in .zip file for exfiltration. See more at [[Bloodhound-Guide]].

**Beware the bugs! - Git clone bloodhound and sharphound**


## Credential Injection - Found Creds? Do...

Use runas.exe
```powershell
runas.exe /netonly /user:<domain>\<username> cmd.exe
```

IF internal DNS is configured automative through DHCP or VPN, using the IP for DNS server (usually a DC) of the target network
```powershell
$dnsip = "<DNS Server IP>"
$index = Get-NetAdapter -Name '<interface-name>' | Select-Object -ExpandProperty 'ifIndex'
Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip
```

**IP vs Hostnames**

Command  | Network Protocol | Authentication 
--- | --- | ---
`dir \\<DC IP>\SYSVOL` | IP | NTLM
`dir \\domain_name\SYSVOL` | DNS | Kerberos authentication


## Mitigations
- Use LogOn Events frequency over time to monitor for malicious activity - Find the SharpHound
- Signature Detection Rules for tools
- Monitor Command Prompt and Powershell usage if not used by organisation's employees. 


## References
[THM Enumerating AD room](https://tryhackme.com/room/adenumeration)
[Remote Server Administration Tools](https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps)[Advanced Threat Protection solution.](https://www.microsoft.com/en-ph/dpa-trustcenter/privacy/advancedthreatprotection)  
[Remote Server Administration Tools 2](https://docs.microsoft.com/en-us/previous-versions/technet-magazine/gg413289(v=msdn.10)?redirectedfrom=MSDN)
[SAM-Account-Type](https://docs.microsoft.com/en-us/windows/win32/adschema/a-samaccounttype?redirectedfrom=MSDN)
[Service principle names](https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names?redirectedfrom=MSDN)
[LocalSystem](https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account?redirectedfrom=MSDN)
[LocalService](https://docs.microsoft.com/en-us/windows/win32/services/localservice-account?redirectedfrom=MSDN)
[NetworkService](https://docs.microsoft.com/en-us/windows/win32/services/networkservice-account?redirectedfrom=MSDN)
[Service Accounts](https://docs.microsoft.com/en-us/windows/win32/services/service-user-accounts?redirectedfrom=MSDN)
[Graphs](https://en.wikipedia.org/wiki/Graph_(discrete_mathematics)