# NBSN SMB Spoofing And Capture

[Microsoft MS00-047](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2000/ms00-047): *"The NetBIOS Name Server (NBNS) protocol, part of the NetBIOS over TCP/IP (NBT) family of protocols, is implemented in Windows systems as the Windows Internet Name Service (WINS). By design, NBNS allows network peers to assist in managing name conflicts. Also by design, it is an unauthenticated protocol and therefore subject to spoofing. A malicious user could misuse the Name Conflict and Name Release mechanisms to cause another machine to conclude that its name was in conflict. Depending on the scenario, the machine would as a result either be unable to register a name on the network, or would relinquish a name it already had registered. The result in either case would be the same - the machine would not respond requests sent to the conflicted name anymore. If normal security practices have been followed, and port 137 UDP has been blocked at the firewall, external attacks would not be possible. A patch is available that changes the behavior of Windows systems in order to give administrators additional flexibility in managing their networks. The patch allows administrators to configure a machine to only accept a name conflict datagram in direct response to a name registration attempt, and to configure machines to reject all name release datagrams. This will reduce but not eliminate the threat of spoofing. Customers needing additional protection may wish to consider using IPSec in Windows 2000 to authenticate all sessions on ports 137-139."*

The majority of this page is a fixed, updated, source checked mirror in markdown of [GitHub - OlivierLaflamme/Cheatsheet-God Cheatsheet_SMBCapture.txt](https://github.com/OlivierLaflamme/Cheatsheet-God/blob/master/Cheatsheet_SMBCapture.txt)

SMB Capture with [[Metasploit]]
```ruby
msf > use auxiliary/server/capture/smb
msf auxiliary(smb) > set JOHNPWFILE /tmp/john_smb
msf auxiliary(smb) > run
```
HTTP NTML Capture  [[Metasploit]]
```ruby
msf auxiliary(smb) > use auxiliary/server/capture/http_ntlm
msf auxiliary(smb) > set JOHNPWFILE /tmp/john_http
msf auxiliary(smb) > set SRVPORT 80
msf auxiliary(smb) > set URIPATH /
msf auxiliary(smb) > run
```

Fix: `hxxp[://]www[.]leonteale[.]co[.]uk/netbios-nbns-spoofing/` - original now dead
- [Tenable, nessus -  MS00-047: NetBIOS Name Server Protocol Spoofing patch (269239) ](https://www.tenable.com/plugins/nessus/10482) 

Solution
The solution to this is to disable Netbios from broadcasting. The setting for this is in, what I hope, a very familiar place that you might not have really paid attention too before.
#### `netbios`
 
Netbios, according to Microsoft, is no longer needed as of Windows 2000. However, there are a few side effects. One of the unexpected consequences of disabling Netbios completely on your network is how this affects trusts between forests. Windows 2000 let you create an external (non-transitive) trust between a domain in one forest and a domain in a different forest so users in one forest could access resources in the trusting domain of the other forest. Windows Server 2003 takes this a step further by allowing you to create a new type of two-way transitive trusts called forest trusts that allow users in any domain of one forest access resources in any domain of the other forest. Amazingly, NetBIOS is actually still used in the trust creation process, even though Microsoft has officially “deprecated” NetBIOS in versions of Windows from 2000 on. So if you disable Netbios on your domain controllers, you won’t be able to establish a forest trust between two Windows Server 2003 forests. But Windows 2003 is pretty old, since as of writing we are generally on Windows 2012 now. So if you would like to disable Netbios on your servers yet will be effected by the side effect for Forest trusts then ideally you should upgrade and keep up with the times anyway. alternatively, you can get away with, at the very least, disabling Netbios on your workstations. See below for step by step instructions on disabling Netbios on workstations:

Windows XP, Windows Server 2003, and Windows 2000
1. On the desktop, right-click My Network Places, and then click Properties.
1. Right-click Local Area Connection, and then click Properties
1. In the Components checked are used by this connection list, double-click Internet Protocol (TCP/IP), click Advanced, and then click the WINS tab.Note In Windows XP and in Windows Server 2003, you must double-click Internet Protocol (TCP/IP) in the This connection uses the following items list.
1. Click Use NetBIOS setting from the DHCP server, and then click OK three times.
 
For Windows Vista
1. On the desktop, right-click Network, and then click Properties.
1. Under Tasks, click Manage network connections.
1. Right-click Local Area Connection, and then click Properties
1. In the This connection uses the following items list, double-click Internet Protocol Version 4 (TCP/IPv4), click Advanced, and then click the WINS tab.
1. Click Use NetBIOS setting from the DHCP server, and then click OK three times.
 
  For Windows 7
1. Click Start, and then click Control Panel.
1. Under Network and Internet, click View network status and tasks.
1. Click Change adapter settings.
1. Right-click Local Area Connection, and then click Properties.
1. In the This connection uses the following items list, double-click Internet Protocol Version 4 (TCP/IPv4), click Advanced, and then click the WINS tab.
1. Click Use NetBIOS setting from the DHCP server, and then click OK three times.


## References

[Microsoft MS00-047](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2000/ms00-047)
[Tenable, nessus -  MS00-047: NetBIOS Name Server Protocol Spoofing patch (269239) ](https://www.tenable.com/plugins/nessus/10482)
[GitHub - OlivierLaflamme/Cheatsheet-God Cheatsheet_SMBCapture.txt](https://github.com/OlivierLaflamme/Cheatsheet-God/blob/master/Cheatsheet_SMBCapture.txt)