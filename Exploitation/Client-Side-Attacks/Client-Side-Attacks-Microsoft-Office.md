
# Client Side Attacks Microsoft Office

Microsoft Office client side attacks are often successful as it is difficult to differentiate malicious content from benign, leveraging regular user innocence in regarding the *joke* horror of [[Useful-Visual-Basic]] scripts, and VBA is native Windows and living off the land strategy uses the current environment against itself. 

Email providers and spam filter solutions often filter out all Microsoft Office documents by default. 

Most anti-phishing training programs stress the danger of enabling macros in an emailed Office document.

[[Pretexts]]

Office Documents from email or download link will be tagged with Mark of the Web and open in Protected View (disabling editing and modification, blocking macro execution). GUI button `Enable Editing` disables Protected View.

Mark of the Web is [part of the NTFS file metadata](https://nolongerset.com/mark-of-the-web-details/)

Microsoft Publisher lacks a Protected View


[Microsoft from Office from 2021 onwards and back to 2013 block macros by default](https://learn.microsoft.com/en-us/deployoffice/security/internet-macros-blocked) affecting Access, Excel, PowerPoint, Visio, and Word. Previously the application would check [VBA Macro Notification Settings](https://learn.microsoft.com/en-us/deployoffice/security/internet-macros-blocked#vba-macro-notification-settings) policy was enabled and how it was configured. How Office determines whether to run macro in a file from the internet:
1. *A user opens an Office file containing macros obtained from the internet. For example, an email attachment. The file has Mark of the Web (MOTW).*
2. *If the file is from a Trusted Location, the file is opened with the macros enabled. If the file isn't from a Trusted Location, the evaluation continues.*    
3. *If the macros are digitally signed and the matching Trusted Publisher certificate is installed on the device, the file is opened with the macros enabled. If not, then the evaluation continues.*
4. *Policies are checked to see if macros are allowed or blocked. If the policies are set to Not Configured, the evaluation continues to Step 6.*
5. Either 
	 - *(a) If macros are blocked by policy, the macros are blocked.  
	- *(b) If the macros are enabled by policy, the macros are enabled.
6. *If the user had previously opened the file, before this change in default behavior, and had selected **Enable content** from the Trust Bar, then the macros are enabled because the file is considered trusted.*
7. *This step is where the change to the default behavior of Office takes effect. With this change, macros in files from the internet are blocked and users will see the **Security Risk** banner when they open the file.*

Consider reading [New security hardening policies for Trusted Documents](https://techcommunity.microsoft.com/t5/office-365-blog/new-security-hardening-policies-for-trusted-documents/ba-p/3023465).

[User Execution: Malicious File - T1204](https://attack.mitre.org/techniques/T1204/002/)

## Making Macros

The Microsoft Word `macro` may be one the oldest and best-known client-side software attack vectors. `macros` allow users to accomplishs task progromatically, from filling out spreadsheets to instatiating templates with contents. Organisations use `macro`s to link documents with external content and manage dynamic content. To create a macro go to `View -> Macros -> Create`. For more on VBA scripting see [[Useful-Visual-Basic]]
- Visual Basic for Applications(VBA) - has full access: 
	- [ActiveX objects](https://learn.microsoft.com/en-us/previous-versions/windows/desktop/automat/activex-objects)
	- [Windows Script Host](https://learn.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/windows-scripting/at5ydy31(v=vs.84))

Older attack vectors like including [Dynamic Data Exchange (DDE)](https://learn.microsoft.com/en-us/windows/win32/dataxchg/about-dynamic-data-exchange?redirectedfrom=MSDN) and various [Object Linking and Embedding (OLE)](https://en.wikipedia.org/wiki/Object_Linking_and_Embedding) methods are not viable  

File Types
	- `doc` can save macros `docx` cannot without attaching a containing template as it can't embed or save the macro in the document, but can run macros.1
	- `.docm` file type for embedded macro

VBA - `Sub` [procedure](https://learn.microsoft.com/en-us/office/vba/Language/Concepts/Getting-Started/calling-sub-and-function-procedures) is similiar to a function in VBA, but cannot return values therefore cannot be used in expressions  


## Object Linking and Embedding 

Abuses of [Dynamic Data Exchange](https://docs.microsoft.com/en-us/windows/win32/dataxchg/about-dynamic-data-exchange?redirectedfrom=MSDN) (DDE) can execute arbitray application from within Office Documents, patched since 12/2017. However Object Linking and Embedding (OLE) document-embedding feature can abused to embed a batch file. Batch files were replaced by VBscript and Powershell, but  still functional in Windows 10. To accomplish this: `Insert -> Object -> Create from File -> Browser to .bat file -> Ok`, we be more stealthy by Changing the icon like the teenage hack you are with ticking the `Display as Icon` and `Change Icon...`  to select a specific icon. We can also enter a caption in the `Change Icon` popup. Users will see the Captioned name not the actual name. They will be prompted with a security warning as to whether to `Run` or `Cancel`. 

## Evading Protected View

To bypass restriction on documents entering a network through email or download link an attacker would also have to bypass protected view to accomplish any of the above. [Protected View](https://support.microsoft.com/en-us/topic/what-is-protected-view-d6f09ac7-e6b9-4495-8e43-2bbcdbcb6653) disables: All editing and modifications ni the document and block the execution of macros or embedded objects. A victim can press Enable Editing to exit, but [[Social-Engineering]] maybe required. Instead of Word use Publisher, which allows for embedded objects, but without Protected View. Although [Office App Policies can be  set to prevent this too so hide your csharp and hide golang](https://docs.microsoft.com/en-us/mem/intune/apps/app-office-policies) and Publisher is less frequently installed.

## Bypasses

Obfuscated File Formats: 7zip, ISO, IMG [T1038](https://attack.mitre.org/techniques/T1036) and or [T1036](https://attack.mitre.org/techniques/T1036/)

## References

[ActiveX objects](https://learn.microsoft.com/en-us/previous-versions/windows/desktop/automat/activex-objects)
[Windows Script Host](https://learn.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/windows-scripting/at5ydy31(v=vs.84))
[Dynamic Data Exchange](https://docs.microsoft.com/en-us/windows/win32/dataxchg/about-dynamic-data-exchange?redirectedfrom=MSDN)
[Polices for Office Apps](https://docs.microsoft.com/en-us/mem/intune/apps/app-office-policies)
[Protected View](https://support.microsoft.com/en-us/topic/what-is-protected-view-d6f09ac7-e6b9-4495-8e43-2bbcdbcb6653)
[Microsoft from Office from 2021 onwards and back to 2013 block macros by default](https://learn.microsoft.com/en-us/deployoffice/security/internet-macros-blocked) 
[VBA Macro Notification Settings](https://learn.microsoft.com/en-us/deployoffice/security/internet-macros-blocked#vba-macro-notification-settings) 
[New security hardening policies for Trusted Documents](https://techcommunity.microsoft.com/t5/office-365-blog/new-security-hardening-policies-for-trusted-documents/ba-p/3023465)
[User Execution: Malicious File - T1204](https://attack.mitre.org/techniques/T1204/002/)
[Dynamic Data Exchange (DDE)](https://learn.microsoft.com/en-us/windows/win32/dataxchg/about-dynamic-data-exchange?redirectedfrom=MSDN)
[Object Linking and Embedding (OLE)](https://en.wikipedia.org/wiki/Object_Linking_and_Embedding) 
[procedure](https://learn.microsoft.com/en-us/office/vba/Language/Concepts/Getting-Started/calling-sub-and-function-procedures) 