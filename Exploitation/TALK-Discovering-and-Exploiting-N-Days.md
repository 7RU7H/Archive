# Discovering and Exploiting N-Days w/ Corey Ham

[YouTube - Discovering and Exploiting N-Days w/ Corey Ham](https://www.youtube.com/watch?v=YxEEEOh6pc0) description: *"Friends don't let friends get exploited with old malware. In this free one-hour Black Hills Information Security (BHIS) webcast, Corey Ham will share his knowledge and experience gained from leading the continuous penetration testing (CPT) team at BHIS. He'll talk about what N-days are, why they matter, and then outline a process to discover and exploit N-days against a corporate target. Defenders, learn from the attackers. Red Teamers, learn from your peers."*

Slides are available [https://cham423.notion.site - Slides](https://cham423.notion.site/Discovering-and-Exploiting-N-Days-90cf191871eb4bc295cbcb7241c1bae2)

- N-Days are known vulnerabilities
- N-Days have varying impact and difficulty to remediate
- N-Days as reason for a breach are rare source of breaches in 2023, according to Verizon DBIR. Why?
	1. Everyone is getting better at vulnerability management 
	2. N-Days are resource intensive for attackers 
	3. There are easier ways in... [[Passwords]] and [[Phishing]]

Just because N-Days are uncommon does not mean they are low impact!

#### Finding N-Days

- High Level
	- Have a vulnerability management team\*
	- Know you environment, do regular recon
	- Listen to your vendors\*
	- Scan yourself regularly with a variety of tools
	- Follow the news, manually validate where possible (not covered in this talk)
- Doing it live
	- Scope - [Uber hackerone scope is a good example](https://hackerone.com/uber?type=team)
		- Prove *impact* by demonstration
		- Rules are great for Pentesting
		- Do not break anything
	- Initial Recon
		- Primary Domain
	- Grabbing Scope - see below for commands
	- Caveats
		- **Be very careful with targeting cloud IPs directly (i.e. AWS, GCP, Azure) — These change ownership constantly.**
			- IP ownership changes; hostnames do not change constantly

Recon tools Corey likes:
- [https://ip-netblocks.whoisxmlapi.com/overview](https://ip-netblocks.whoisxmlapi.com/overview) 
- [Subfinder](https://github.com/projectdiscovery/subfinder)​
- [Sublist3r](https://github.com/aboul3la/Sublist3r)​
- [https://github.com/lanmaster53/recon-ng](https://github.com/lanmaster53/recon-ng)
- [https://github.com/owasp-amass/amass](https://github.com/owasp-amass/amass)
- [https://aadinternals.com/aadinternals/#get-aadinttenantdomains](https://aadinternals.com/aadinternals/#get-aadinttenantdomains)
- [https://drs.whoisxmlapi.com/](https://drs.whoisxmlapi.com/)

Grabbing scope with `curl` ([[Curl-Cheatsheet]]), `jq` ([[JQ]]) and stdutils
```bash
# Downloading Domains JSON
curl https://appsec-analysis.uber.com/public/bugbounty/ListDomains\?offset\=0\&limit\=10000 -o all-domains.json
# ​Parsing Domains JSON
jq -r '.Domains.[].Name' all-domains.json | sort -u > domains-list.txt
# ​Downloading IPs JSON
curl https://appsec-analysis.uber.com/public/bugbounty/ListIPs\?offset\=0\&limit\=10000 -o all-ips.json
# Parsing IPs JSON
jq -r '.Addresses.[].IP' all-ips.json | sort -u > ip-list.txt
# Combining Files
cat ip-list.txt domains-list.txt > uber-attack-surface-2024-01-31.txt
```

#### [[Shodan]]

- Ask CISA for a pentest, and this is probably what you’re getting. A Shodan Pentest
- Shodan is also Quiet; You could theoretically do a fully passive pentest with Shodan.
- [Official Shodan examples](https://www.shodan.io/search/examples) is a cheatsheet in itself
- Shodan has limited ability to find vulnerabilities
	- If Shodan can find something you need to do something about!
	- If [[Shodan]] can find something, you need to improve your recon.
- Beware Scope - Shodan does not manage scope...
	- Check input
	- Query Shodan
	- Validate findings 
	- Check scope

Shodan important specifics: 
- Shodan search terms are wildcards by default (i.e. `http.title:apache` will match anything with "apache" in it, case insensitive)
	- If you don’t specify a field to search, Shodan searches all fields. 
	- This means it’s prone to false positives - There will be many strings that contain the domain in unrelated HTML content, for example.
- The org search operator is based on WHOIS organisation name. These are often different from how companies refer to themselves, or are outdated. 

SSL CN Search 
```bash
ssl.cert.subject.cn:*.$domain.com
```

Exporting Results from Shodan with CLI
```bash
# Add API Key
shodan init <api_key>
# Download Data (SSL CN Query)
shodan download --limit -1 uber-ssl-2024-01-31 "ssl.cert.subject.cn:*.uber.com"
# Download Data (Org Query)
shodan download --limit -1 uber-org-2024-01-31 'org:"Uber Technologies"'
# Download Data (Generic Query)
# Unfortunately, Shodan does not bulk search built-in (as of January 2024). However, we can use command-line scripting to do our own bulk searches.

for i in $(cat ip-list.txt); do shodan download shodan-out/$i $i; done
# Frustratingly, the Shodan CLI will create gzip archives with empty files. We can remove these after the batch finishes:
gunzip *.gz
rm -f -- *(.L0)
# ​List IPs
shodan parse uber-ssl-2024-01-31.json.gz --fields ip_str,hostnames
# Convert to CSV
shodan convert uber-ssl-2024-01-31.json.gz csv
# Look for a Specific CVE
shodan parse -f vulns:CVE-2023-44487 uber-ssl-2024-01-31.json.gz --fields ip_str,hostnames
```

Shodan Caveats
- The list of supported CVEs is relatively small compared to other scanners.
- Shodan’s data generally updates once a week.
- Some organizations might have countermeasures in place to prevent them from being scanned by Shodan.

#### [[Nuclei]]

Important Notes about default Behaviour
- Don’t discount the unknown severity:
	- API keys and credentials are often reported in this category.
- [[HTTPX]]
	- HTTP-based templates need HTTP input, meaning a URL. 
	- Nuclei will attempt to find these by default, by running [httpx](https://github.com/projectdiscovery/httpx)
	- By default, httpx will only check the DEFAULT ports for http/https, 80 and 443.​
- Burp has a nuclei template generator add-on: [https://github.com/portswigger/nuclei-template-generator](https://github.com/portswigger/nuclei-template-generator)

#### Exploiting N-Days

- [[Nuclei]] 
- Manual hunting 
- Exploitation is vulnerability dependent
	- Most modern exploits will require long chains of components.
#### Sources

[https://www.verizon.com/business/resources/reports/dbir/2023/summary-of-findings/](https://www.verizon.com/business/resources/reports/dbir/2023/summary-of-findings/)
[https://news.apache.org/foundation/entry/media-alert-the-apache-software](https://news.apache.org/foundation/entry/media-alert-the-apache-software)
[https://en.wikipedia.org/wiki/EternalBlue](https://en.wikipedia.org/wiki/EternalBlue)
[https://techcrunch.com/2022/12/06/rackspace-blames-ransomware-attack-for-ongoing-exchange-outage/](https://techcrunch.com/2022/12/06/rackspace-blames-ransomware-attack-for-ongoing-exchange-outage/)
[https://www.dragos.com/wp-content/uploads/CrashOverride-01.pdf](https://www.dragos.com/wp-content/uploads/CrashOverride-01.pdf)
[https://www.cisa.gov/news-events/ics-alerts/ics-alert-14-281-01e](https://www.cisa.gov/news-events/ics-alerts/ics-alert-14-281-01e)
## References

[Official Shodan examples](https://www.shodan.io/search/examples) 
[https://cham423.notion.site - Slides](https://cham423.notion.site/Discovering-and-Exploiting-N-Days-90cf191871eb4bc295cbcb7241c1bae2)
[YouTube - Discovering and Exploiting N-Days w/ Corey Ham](https://www.youtube.com/watch?v=YxEEEOh6pc0)
[Uber hackerone scope is a good example](https://hackerone.com/uber?type=team)