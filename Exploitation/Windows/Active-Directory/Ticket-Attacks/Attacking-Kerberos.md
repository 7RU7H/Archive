# Attacking Kerberos


For enumeration see [[Active-Directory-Enumeration-Defined]] or general theory and definitions [[Active-Directory]]. For commands cheatsheet [[Active-Directory-Commands]] or for Privilege Escalation see [[Active-Directory-Privilege-Escalation]].

Be aware Kerberos Tickets are Timestamped, is your KDC and your machine temporally synced? Linux option install `ntpdate` and sync to the DC.
```bash
sudo apt install ntpdate
sudo ntpdate $dc_ip
```

## Tools
[[Kerbrute-Cheatsheet]]
[[Impacket-Cheatsheet]]
[[Crackmapexec-Cheatsheet]]
[[Mimikatz-Cheatsheet]]
[[Rubeus-Cheatsheet]]

## Attack Privilege Requirements

Attack |  Requirements | Uses
--- | --- | ---
Kerbrute Enumeration | No domain access required | Enumeration of SPN, Users
Pass the Ticket | Access as a user to the domain required | Use to Pivot
Kerberoasting | Access as any user required | Use to escalate and pivot
AS-REP Roasting | Access as any user required | Use to pivot
[[Golden-Tickets]] | Full domain compromise (domain admin) required | Persistence and Forest pivoting 
[[Silver-Tickets]] | Service hash required | Persistence and Escalation
Skeleton Key | Full domain compromise (domain admin) required | Persistence - But makes DC vulnerable

## Misconfigurations to look for:

- Service Accounts that are Domain Admins
- Non existent SPN hardware, but SPN exists
- *"Deleted"* Machine accounts that can be revived

## Service Account Attacks

To attack a targeted Service with request service ticket from the DC - no checks are performed on whether the user that has request that ticket has any permissions to access the service hosted by the service principal name ; it is **only checked attempting to connect to the service**.

The request service ticket can be extracted from local memory and saved. [[PowerShell]] `KerberosRequestorSecurityToken` can be used to request the service ticket.
```powershell
TargetServicePrincipleName=''
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $TargetServicePrincipleName
```
Instead of tools like [[Mimikatz-Cheatsheet]] you can use the builtin `klist` command can be used to display all cached Kerberos tickets of a current user an example of [[Active-Directory-Credential-Caching]]. This service ticket is encrypted using the SPN's password hash. We need to request the ticket and decrypt it using Kerberoasting. We do not need Administrative privileges.

## Attacks 

- [[Golden-Tickets]]
- [[Silver-Tickets]]
- [[Diamond-Tickets]]
- [[Sapphire-Tickets]]
- [[Pass-The-Key]]
- [[Pass-The-Ticket]]
- Kerberoasting
- [[ASREP-Roasting]]
 

[[Impacket-Cheatsheet]] - `GetUserSPN`

The ST from the TGS-REP is encrypted using the service account's password, this allows for offline cracking of the service password:
- All we need is tickets
- KDC do not verify our permission to access the service  so we can request all the tickets
Tickets to think about
- Accessible - Request tickets for services behind firewalls for [[Active-Directory-Lateral-Movement]].
- Available - Offline or powered off
- Exist\* Removed from service (if the SPN exists, but physical does not you can!)

[[PowerSploit-Helpsheet]] - `Invoke-Mimikatz`, then use [[John-The-Ripper-Cheatsheet]] or  [[Hashcat-Cheatsheet]] - Then you has [[Silver-Tickets]]

[Hashcat modes](https://hashcat.net/wiki/doku.php?id=example_hashes)

John The Ripper Formats:
```c
krb4, krb5, krb5asrep, krb5pa-sha1, krb5tgs,krb5-17, krb5-18, krb5-3, krb5pa-md5,
```

## Mitigations

Monitoring is key
- APT are in systems for longer the 6 months.
- Rotating Passwords
	- SPNs
	- KRBTGT
- Patterns of odd or large ticket amount requests
- Missing TGS-REQs

## References

[THM Room Exploiting AD](https://tryhackme.com/room/exploitingad)
[Wikipedia](https://en.wikipedia.org/wiki/Kerberos_(protocol))
[THM Room Attacking Kerberos](https://tryhackme.com/room/attackingkerberos)
