# Sapphire Tickets

Sapphire Tickets are like Diamond Tickets, but ticket is not forged and instead is based on a legitimate ticket obtained after a request - all that is different is how the PAC is modified:
- Diamond modifies the legitimate PAC
- Sapphire *the PAC of another powerful user is obtained through an [S4U2self+u2u trick](https://www.thehacker.recipes/a-d/movement/kerberos#s4u2self-+-u2u)* (Service for a User user your are request the ticket on behalf of called "principal", then User to User Authentication (one user is a server and the other a client))
	- Replacing the PAC in the legitimate ticket 

*As of September 11th, 2023,  this feature is in a pull request ([#1411](https://github.com/SecureAuthCorp/impacket/pull/1411)) awaiting to be merged. 

1. The `user-id` both the nthash and aeskey must be supplied. 
2. The `-user-id` argument will be used to build the "Requestor" PAC structure, which could be needed in up-to-date environments (see warning at the bottom of this page).

*The arguments used to customize the PAC will be ignored (`-groups`, `-extra-sid`,`-duration`), the required domain SID (`-domain-sid`) as well as the username supplied in the positional argument (`baduser` in this case). All these information will be kept as-is from the PAC obtained beforehand using the [S4U2self+2u](https://www.thehacker.recipes/a-d/movement/kerberos) trick* `(Service for a User user your are request the ticket on behalf of called "principal", then User to User Authentication (one user is a server and the other a client))`. 

[[Impacket-Cheatsheet]] 
```bash
ticketer.py -request -impersonate 'domainadmin' \
-domain 'DOMAIN.FQDN' -user 'domain_user' -password 'password' \
-nthash 'krbtgt NT hash' -aesKey 'krbtgt AES key' \
-user-id '1115' -domain-sid 'S-1-5-21-...' \
'baduser'
```

In 2021, Microsoft issued a patch ([kb5008380](https://support.microsoft.com/en-gb/topic/kb5008380-authentication-updates-cve-2021-42287-9dafac11-e0d0-4cb8-959a-143bd0201041)) - explained in this [blogpost](https://blog.netwrix.com/2022/01/10/pacrequestorenforcement-and-kerberos-authentication/) When the patch entered its enforcement phase (Oct. 11th 2022), it made the Sapphire Ticket attack harder to conduct.
- Rubeus patch [#1391](https://github.com/fortra/impacket/pull/1391) and [#1545](https://github.com/fortra/impacket/pull/1545) 
- Impacket patches [#105](https://github.com/GhostPack/Rubeus/pull/105)
*However, since the Sapphire Ticket technique relies on a S4U2self + U2U service ticket* `(Service for a User user your are request the ticket on behalf of called "principal", then User to User Authentication (one user is a server and the other a client))` *request to obtain a privileged user's PAC, the PAC doesn't feature the two new "Requestor" and "Attributes" structures. This is probably because the two new structures are only included in TGT's PACs and not service tickets PACs. When using the Sapphire Ticket technique to forge a TGT, if the two structures are missing from the forget ticket, a `KDC_ERR_TGT_REVOKED` error will be raised in environments that have the patch installed.*

## References

[The Hacker Recipes - Sapphire tickets](https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/sapphire) 
