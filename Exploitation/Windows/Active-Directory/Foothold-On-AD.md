# Foothold on Active Directory

## NTLM Authenticated Services
New Technology LAN Manager(NTLM) is a family of authentication protocols used to authenticate identities of users in the context of Active Directory network. Services use Windows' challenge-response protocol  called netNTLM. Allowing  services exposable to the internet authenicating on behalf of a client not client directly authenicating to Domain Controller

- **Bruteforce**
Hydra, Medusa, Brutespray 

## LDAP Bind Credentials
Lightweight Directory Access Protocol (LDAP) is a vendor-neutral application protocol for accessing and maintaining distributed directory information services over IP.  In the context of Active Directory it used as authentication where an application directly verifies the user's credentials. LDAP authenication is used in AD contexts to integrate third-party applications with AD.

#### LDAP Authentication

1. User requests `Service Use` with AD credentials
1. Service performs `LDAP Bind Request` to DC with AD credentials of user 
1. DC provide `Bind Response`
1. Service requests `User Search`
1. DC  responds with `User search` result
1. `LDAP Bind` request with user request with AD credentials of user 
1. DC sends `Bind Response`

- **Internet Exposed LDAP = Same attacks as NTML**

- **LDAP Pass-Back**

Requires access to device configuration.
Alter LDAP configuration IP or hostname of LDAP server to a rogue server, forcing device to attempt LDAP authenication to our rogue device, which can be then intercepted.

```bash
nc -lvp 389
```
If response contains `supportedCapabilities` then the service is trying negotiate the LDAP authenication method details.

- **LDAP server setup**
[Debian based](https://wiki.debian.org/LDAP/OpenLDAPSetup)
[Arch based](https://wiki.archlinux.org/title/OpenLDAP)

Patch rogue LDAP server with `olcSaslSecProps.ldif` 

```
#olcSaslSecProps.ldif 
dn: cn=config 
replace: olcSaslSecProps 
olcSaslSecProps: noanonymous,minssf=0,passcred
```

Then execute LDAP authenication passing the rogue server as arguments to which the service will attempt to communicate, capture with `tcpdump`.

```bash
sudo tcpdump -SX -i $interface tcp port 389
```

##  Authentication Relays
Server Message Block(SMB) protocol allows client-server communication and is used AD networks various utilities and administration. Previous versions have numerous vulnerabilities and exploits, some setting run legacy systems that do not support newer versions of SMB.

- **Intercepting NetNTLM Challenge**


Use `responder` to poison the responses during NetNTLM authentication tricking the client to communicate with responder not the server. On a real LAN, Responder will attempt to poison any  Link-Local Multicast Name Resolution (LLMNR),  NetBIOS Name Servier (NBT-NS), and Web Proxy Auto-Discovery (WPAD) requests that are detected.

- **SMB Relay Man in the Middle Attack**

1. Attacker runs responder
```bash
sudo responder -I $interface
```
2. User sends `NTLM Negotiate`
3. Attacker incepts and forwards NTLM Authenication 
4. Server responds with NTLM Challange encrypted with User's hash
5. Attackers forwards the NTLM challange to user
6. User send challenge response
7. Attacker forwards challenge response
8. Server grants access
9. Attacker sends Access Denied error to user
10. Attacker accesses server resources


##  Microsoft Deployment Toolkit
## Configuration Files

## References
[THM AD Basics Room](https://tryhackme.com/room/activedirectorybasics)
[THM Breaching AD Room](https://tryhackme.com/room/breachingad)
[NTML Microsfot Documentation](https://docs.microsoft.com/en-us/windows-server/security/kerberos/ntlm-overview)
[LDAP Wiki](https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol)
[WPAD Wiki](https://en.wikipedia.org/wiki/Web_Proxy_Auto-Discovery_Protocol)
[SMB Wiki](https://en.wikipedia.org/wiki/Server_Message_Block)
[network encyclopedia](https://networkencyclopedia.com/netbios-name-server-nbns/)
[hacktricks](https://book.hacktricks.xyz/generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks)
[mdsec](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/)
[truesec](https://www.truesec.com/hub/blog/mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-adv210003-kb5005413-petitpotam)
[r3d-buck3t](https://medium.com/r3d-buck3t/pwning-printers-with-ldap-pass-back-attack-a0d8fa495210)