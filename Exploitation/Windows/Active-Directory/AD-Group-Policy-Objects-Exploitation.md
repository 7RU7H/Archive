
AD GPOs are virtual collection of policy settings stored in SYSVOL directory that to be replicated to domain-joined machines. Each GPO has a unique name: `GUID`. Each Machine has a Local Policy Configuration theese notable include:

-   Application configuration for services such as the Firewall, Anti-Virus, and Applocker.  
-   Local Group membership such as the Administrator or Remote Desktop Users groups.
-   Startup configuration such as scripts that should be executed.
-   Security and protocol settings such as SMBv1 support.
-   The change password setting that can contain an actual  password `CPassword=`
-    Lock an account after a certain number of incorrect passwords are entered.
-   Block unidentified users on remote computers from connecting to a network share.
-   Give all business users a standard set of bookmarks so they can easily reach your helpdesk or access other important resources.
-   Restrict access to certain folders.
-   Install the same software on all of your domain controllers (DCs).
-   Disable the command prompt on usersâ€™ machines.
-   Ensure Windows updates are applied promptly.
-   Disable use of the NTLM v1 authentication protocol (which is weaker than Kerberos).

Group Policy Management (GPM) define policies directly on to the AD structure. Domain-joined computers would then pull all policies from SYSVOL periodically and apply the relevant ones. By default, policies are replicated every 15 minutes through the gpupdate application.

## GPO Exploitation

Consider [[Neo4j-And-Bloodhound-Guide]] for mapping the network

Add account that can control both `Local Adminstrators` and `Remote Desktop Users` groups. That account can RDP or SMBExec, which are safer for lateral movement.
```powershell
runas /netonly /user:$domain\$ad_username cmd.exe
# verify correct credentials with:
dir \\$domain\sysvol
# In new cmd prmompt
mmc
```
Add Group Policy Management Snap-in:  `Click File -> Add/Remove Snap-in; Select the Group Policy Management snap-in  -> click Add -> click Ok`. Then navigate to the GPO that our user has permission to modify. `Servers -> Management Servers -> Management Server Pushes -> Right Click GPO and select Edit`, which will open a new Group Policy Management. Then
1.  `Expand Computer Configuration & Policies & Windows Settings & Security Settings`
1. `Right Click Restricted Groups -> select Add Group
1.  `Click Browse -> enter "Your Group Name Goes here" &  click Check Names
1.  `Click Okay x 2`.
Leave the first filter (Members of this group) blank and for the second filter (This group is a member of)add both the Administrators and Remote Desktop Users groups. The wait for a maximum of 15 minutes for the GPO to be applied


Credential Harvesting the SYSVOL
```bash
grep -r SYSVOL/ -e "cpassword"
```

https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/privileged-accounts-and-token-privileges#gpo-delegation

https://www.trustedsec.com/blog/weaponizing-group-policy-objects-access/

https://www.cyberark.com/resources/threat-research-blog/group-policies-going-rogue
https://blog.quest.com/how-hackers-exploit-group-policy-objects-gpos-to-attack-your-active-directory/

## References

[blog.quest](https://blog.quest.com/how-hackers-exploit-group-policy-objects-gpos-to-attack-your-active-directory/)
[THM Exploiting AD Room](https://tryhackme.com/room/exploitingad)
[iredteam](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/privileged-accounts-and-token-privileges#gpo-delegation)