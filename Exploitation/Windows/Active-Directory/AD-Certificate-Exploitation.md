# AD Certificate Exploitation

This a detailed article on Active Directory Certificate Exploitation most derived from resource that reference, but also the [SpectreOps Whitepaper](https://posts.specterops.io/certified-pre-owned-d95910965cd2) that demonstrated a proof to exploit misconfigured certificate template for [[Active-Directory-Lateral-Movement]] and [[Active-Directory-Privilege-Escalation]]. 

AD Certificate Services (CS) Microsoft's Public Key Infrastructure (PKI) implementation. Trust in external  or internal organisations is grant by AD, which cane used a as CA to prove and delegate trust. AD CS is a privileged function usually run by selected DCs, but large organisation use templating of certificates to make create and distribute certificates easier to manage. As Administrators of AD CS can create several templates that can then allow any user with the relevant permissions to request a certificate. These template have parameters that can be abused.

Terminology:

Acronym | Definition
--- | --- 
PKI |  Public Key Infrastructure is a system that manages certificates and public key encryption
AD CS | Active Directory Certificate Services is Microsoft's PKI implementation which usually runs on domain controllers
CA | Certificate Authority is a PKI that issues certificates
Certificate Template | a collection of settings and policies that defines how and when a certificate may be issued by a CA
CSR | Certificate Signing Request is a message sent to a CA to request a signed certificate
EKU |  Extended/Enhanced Key Usage are object identifiers that define how a generated certificate may be us

AD CS capabilities:
- Encrypts file systems
- Creates and verifies digital signatures
- Verifies user authenication


## Enumerating Vuilnerable Certificate Templates

```powershell
certutil -v -template > cert_templates.txt
```

BEWARE VULNERABLITY != condition for PrivEsc, Human intervention from admins and domain controllers
YOU WANT TO FIND ALL THREE:
foreach Template[X] find toxic parametre: ##

       ONE PARAMETRE THAT HAS THE FOLLOWING:


1. Relevent Permissions

A template where we have the relevant permissions to request the certificate or where we have an account with those permissions.
This template, our user has either Allow Enroll or Allow Full Control # Probably never find the latter
Template permissions are MOSTLY assigned by GROUP 
```powershell
net user <username> /domain
```
Look for these groups:
Domain Users - This means in most cases that any authenticated users can request the certificate
Domain Computers - This means that the machine account of a domain-joined host can request the certificate. If we have admin rights over any machine, we can request the certificate on behalf of the machine account

2. Client Authentication
A template that allows client authentication, meaning we can use it for Kerberos authentication
Review EKU properties of the template to find the words Client Authentication

3. Client Specifies Subject Alternative Name (SAN)
A template that allows us to alter the subject alternative name (SAN)
Usually a url that we then encrypt, 
```powershell
findstr "CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT" 
```
If  CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT = 1 we can specify the SAN ourselves


# TODO scripting 
!! Line numbers /N
```powershell
find cert_template.txt "Allow Enroll"
# find cert_template.txt "Allow Full Control"
find cert_template.txt "Client Authentication"
find cert_template.txt "CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT"
```
put line numbers in an array, compare shortest with the others
if arrEnroll[i] is in a range of (+10 or -10) of arrAuth[j]