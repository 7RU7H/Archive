# AD Certificate Exploitation

This a detailed article on Active Directory Certificate Exploitation most derived from resource that reference, but also the [SpectreOps Whitepaper](https://posts.specterops.io/certified-pre-owned-d95910965cd2) that demonstrated a proof to exploit misconfigured certificate template for [[Active-Directory-Lateral-Movement]] and [[Active-Directory-Privilege-Escalation]]. 

AD Certificate Services (CS) Microsoft's Public Key Infrastructure (PKI) implementation. Trust in external  or internal organisations is grant by AD, which cane used a as CA to prove and delegate trust. AD CS is a privileged function usually run by selected DCs, but large organisation use templating of certificates to make create and distribute certificates easier to manage. As Administrators of AD CS can create several templates that can then allow any user with the relevant permissions to request a certificate. These template have parameters that can be abused.

Terminology:

Acronym | Definition
--- | --- 
PKI |  Public Key Infrastructure is a system that manages certificates and public key encryption
AD CS | Active Directory Certificate Services is Microsoft's PKI implementation which usually runs on domain controllers
CA | Certificate Authority is a PKI that issues certificates
Certificate Template | a collection of settings and policies that defines how and when a certificate may be issued by a CA
CSR | Certificate Signing Request is a message sent to a CA to request a signed certificate
EKU |  Extended/Enhanced Key Usage are object identifiers that define how a generated certificate may be us

AD CS capabilities:
- Encrypts file systems
- Creates and verifies digital signatures
- Verifies user authenication

## Enumerating and Exploiting Cert Publishers

From [spectreops.io](https://posts.specterops.io/certified-pre-owned-d95910965cd2): *"AD CS is Microsoft’s PKI implementation that provides everything from encrypting file systems, to digital signatures, to user authentication (a large focus of our research), and more. While AD CS is not installed by default for Active Directory environments, from our experience in enterprise environments it is widely deployed, and the security ramifications of misconfigured certificate service instances are enormous."*

From Unix-base attacker machine:
See [[Crackmapexec-Cheatsheet]] and [[Impacket-Cheatsheet]]
```bash
rpc net group members "Cert Publishers" -U "DOMAIN"/"User"%"Password" -S "DomainController"
# Enumeration Tools
crackmapexec ldap 'domaincontroller' -d 'domain' -u 'user' -p 'password' -M adcs
go-windapsearch -m custom --filter '(objectCategory=pKIEnrollmentService)' --base 'CN=Configuration,DC=domain,DC=local' --attrs dn,dnshostname --dc 'domaincontroller' -d 'domain.local' -u 'user' -p 'password'
ntlmrelayx -t "ldap://domaincontroller" --dump-adcs
#

```
[go-windapsearch](https://github.com/ropnop/go-windapsearch)
[Certipy](https://github.com/ly4k/Certipy)

```powershell
net group "Cert Publishers" /domain

# Exploit
Certify.exe cas
```
[Certify C# Tool](https://github.com/GhostPack/Certify)



## Enumerating and Exploiting Vulnerable Certificate Templates

From [spectreop.io](https://posts.specterops.io/certified-pre-owned-d95910965cd2):*"AD CS Enterprise CAs issue certificates with settings defined by AD objects known as certificate templates. These templates are collections of enrollment policies and predefined certificate settings and contain things like “How long is this certificate valid for?”,“What is the certificate used for?”, “How is the subject specified?”, “Who is allowed to request a certificate?”, and a myriad of other settings...There is a specific set of settings for certificate templates that makes them extremely vulnerable. As in regular-domain-user-to-domain-admin vulnerable."*

From [Oliver Lyak's Twitter](https://twitter.com/ly4k_):
![](vulnerable-configurations-foresc1-esc2-esc3.png)

```powershell
certutil -v -template > cert_templates.txt
```

BEWARE VULNERABLITY != condition for PrivEsc, Human intervention from admins and domain controllers, you want to find all three: for each Template\[X\] find toxic parametre: ##

1. Relevent Permissions

A template where we have the relevant permissions to request the certificate or where we have an account with those permissions. Either Allow Enroll or Allow Full Control, probably will never find the latter
Template permissions are mostly assigned by group.
```powershell
net user <username> /domain
```

Look for these groups:
-  Domain Users 
- Domain Computers 
- Review all certificate permissions, lateral movement direction of an account that is potential compromisable in the future .

2. Client Authentication
A template that allows client authentication, meaning we can use it for [Kerberos authentication]([[Active-Directory-Kerberos-Authenication-Defined]])
Review EKU properties of the template to find the words Client Authentication

3. Client Specifies Subject Alternative Name (SAN)
A template that allows us to alter the subject alternative name (SAN)
Usually a url that we then encrypt, 
```powershell
findstr "CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT" 
```
If  CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT = 1 we can specify the SAN ourselves


# TODO scripting 
!! Line numbers /N
```powershell
find cert_template.txt "Allow Enroll"
# find cert_template.txt "Allow Full Control"
find cert_template.txt "Client Authentication"
find cert_template.txt "CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT"
```
put line numbers in an array, compare shortest with the others
if arrEnroll[i] is in a range of (+10 or -10) of arrAuth[j]

####  Impersonation Attacks via Certificates 
[[Rubeus-Cheatsheet]]


## References

[THM AD Certificate Templates Room](https://tryhackme.com/room/adcertificatetemplates)
[thehacker.recipes AD-CS](https://www.thehacker.recipes/ad/movement/ad-cs)
[thehacker.recipes Certificate Templates](https://www.thehacker.recipes/ad/movement/ad-cs/certificate-templates)
[spectreops.io certificate pre-owned](https://posts.specterops.io/certified-pre-owned-d95910965cd2)
[Oliver Lyak's Twitter](https://twitter.com/ly4k_)