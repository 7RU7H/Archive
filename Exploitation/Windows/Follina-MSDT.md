# Follina MSDT

[Official Microsoft Guidance for CVE-2022-30190](https://msrc.microsoft.com/blog/2022/05/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/) describes Follina (place in Italy where it was discovered) MSDT (Microsoft Support Diagnostic Tool) as *"A remote code execution vulnerability exists when MSDT is called using the URL protocol from a calling application such as Word. An attacker who successfully exploits this vulnerability can run arbitrary code with the privileges of the calling application. The attacker can then install programs, view, change, or delete data, or create new accounts in the context allowed by the user’s rights."*

[Microsoft](https://docs.microsoft.com/en-us/troubleshoot/sql/general/answers-questions-msdt) states that *"the Microsoft Support Diagnostic Tool (MSDT) collects information to send to Microsoft Support. They will then analyze this information and use it to determine the resolution to any problems that you may be experiencing on your computer”*

The original exploit that has been [discovered in the wild - VirusTotal](https://www.virustotal.com/gui/file/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784/detection)

Microsoft has already [released a patch](https://www.bleepingcomputer.com/news/security/microsoft-patches-actively-exploited-follina-windows-zero-day/) that blocks PowerShell injection.

[Technet article: How to Run Microsoft Support Diagnostic Tool](https://social.technet.microsoft.com/wiki/contents/articles/30458.windows-10-ctp-how-to-run-microsoft-support-diagnostic-tool.aspx)
- Requires Passkey from Microsoft Support 
- Can run without internet
- `Search -> MSDT`

- Full timeline, early details regarding the vulnerability, and “Follina” namesake courtesy of [Kevin Beaumont](https://twitter.com/GossiTheDog) and adapted from [the THM room](https://tryhackme.com/room/follinamsdt)
	- August 1st 2020  - [Benjamin Altpeter's bachelor thesis](https://benjamin-altpeter.de/doc/thesis-electron.pdf) is published detailing how to use MSDT to execute code
	- March 10th 2021 -   researchers report to Microsoft how to use Microsoft Office URIs to execute code using Microsoft Teams as an example. Microsoft fail to issue a CVE or inform customers, but stealth patched it in Microsoft Teams in August 2021. They did not patch MSDT in Windows or the vector in Microsoft Office ([Reference - positive.security blog](https://positive.security/blog/ms-officecmd-rce))
	- April 12th 2022  - [first report](https://twitter.com/CrazymanArmy/status/1531117401181671430?s=20&t=7xvbwh1HXx2sgPh_ms7IzA) to Microsoft MSRC of exploitation in wild via MSDT, by leader of Shadowchasing1, an APT hunting group. This document is an in the wild, real world exploit targeting Russia, themed as a Russian job interview
	- April 21st 2022  - Microsoft MSRC closed the ticket saying not a security related issue (for the record, msdt executing with macros disabled is an issue)
	- May 27th 2022  - Security vendor Nao [tweet](https://twitter.com/nao_sec/status/1530196847679401984) a document uploaded from Belarus, which is also an in the wild attack.
	- May 29th 2022  - Kevin Beaumont identified this was a zero day publicly as it still works against Office 365 Semi Annual channel, and ‘on prem’ Office versions and EDR products are failing to detect
	- May 31st 2022  - Microsoft classify this a zero day in Microsoft Defender Vulnerability Management
	- June 14th 2022  - a fix for this vulnerability, [CVE-2022–30190](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-30190), is available in June 2022’s Patch Tuesday

Combination of both:
1) Specific .docx files contain OLE (originally abbreviates to Object Linking and Embedding) Object references, and sometimes, they take the form of HTML files hosted elsewhere
	- `word/_rels/document.xml.rels` file has an XML tag `<Relationship>` with an attribute `Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/oleObject"` that describes an external oleObject reference - this modified to attack controlled URL and payload
	- Setting the `TargetMode` value to `"External"`
	- `word/document.xml` file `Mo:OLEObject...>` XML tag value changed to `"Link"` and the Key-Value pair attribute `
	  `UpdateMode="OnCall"`
1) MS-MSDT allows for code execution.
MS-MSDT HTLM scheme can be used to execute Powershell code and the .docx file can used to load it via an Office product's external reference capability

[Github: John Hammond - codebase to generate an msdt-follina payload](https://github.com/JohnHammond/msdt-follina)

## References

[Technet article: How to Run Microsoft Support Diagnostic Tool](https://social.technet.microsoft.com/wiki/contents/articles/30458.windows-10-ctp-how-to-run-microsoft-support-diagnostic-tool.aspx)
[Official Microsoft Guidance for CVE-2022-30190](https://msrc.microsoft.com/blog/2022/05/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/)
[THM Follina MSDT Room](https://tryhackme.com/room/follinamsdt)
[Positive.security blog - ms office cmd rce](https://positive.security/blog/ms-officecmd-rce)
[Benjamin Altpeter's bachelor thesis](https://benjamin-altpeter.de/doc/thesis-electron.pdf) 
[The original exploit discovered in the wild - VirusTotal](https://www.virustotal.com/gui/file/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784/detection)
[Rapid Response: Microsoft Office RCE - “Follina” MSDT Attack (huntress.com)](https://www.huntress.com/blog/microsoft-office-remote-code-execution-follina-msdt-bug)
[Github: John Hammond - codebase to generate an msdt-follina payload](https://github.com/JohnHammond/msdt-follina)
[Follina — a Microsoft Office code execution vulnerability | by Kevin Beaumont | May, 2022 | DoublePulsar](https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e)