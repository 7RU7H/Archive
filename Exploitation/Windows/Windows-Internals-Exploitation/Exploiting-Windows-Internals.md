# Exploiting Windows Internals

Windows internals are core to how the Windows operating system functions and can be used to hide and execute code, evade detections, and chain with other techniques or exploits. The term Windows internals can encapsulate any component found on the back-end of the Windows operating system. This can include processes ([[Windows-Processes]], file formats, COM (**C**omponent **O**bject **M**odel), task scheduling, I/O System, etc. This article focuses on the abusing and exploiting processes and their components, DLLs ([[Dynamic-Link-Libraries]]), and the PE (Portable Executable, see [[Windows-PortableExecFormat]]) format.

## Abusing Processes

Process injection is commonly used as an overarching term to describe injecting malicious code into a process through legitimate functionality or components, consider reviewing [[Windows-Processes]] article description related to Windows Process. For regular [[Windows-Shellcode-Injection]] enjoy the article whereas a [[Remote-Process-Memory-Injection]] is also avaliable.

Archive Articles | **Mitre Att&ck Injection Typology Links**  | **Function**
--- | --- | ---
[[Windows-Process-Hollowing]] | [Process Hollowing](https://attack.mitre.org/techniques/T1055/012/) | Inject code into a suspended and “hollowed” target process  
[[Windows-Thread-Hijacking]] | [Thread Execution Hijacking](https://attack.mitre.org/techniques/T1055/003/)  | Inject code into a suspended target thread  
[[DLL-Injection]] | [Dynamic-link Library Injection](https://attack.mitre.org/techniques/T1055/001/)  | Inject a DLL into process memory  
[[Windows-Process-Hollowing]] and  [[Windows-PortableExecFormat]] | [Portable Executable Injection](https://attack.mitre.org/techniques/T1055/002/)  | Self-inject a PE image pointing to a malicious function into a target process


## Memory Execution Alternatives


Context dependent it maybe required to alter method of shellcode execution, due to try to evade Endpoint detection and response (EDR) tools monitoring threads.The above table references article links internally use `CreateThread` and `CreateRemoteThread`  for primary execution function calls. 

#### void-star function pointer

1. Create a function pointer `(void(*)()` 
2. Cast the allocate memory pointer or shellcode into the function pointer `(<function poinnter goes here>))addressPointer)`
3. Invoke the function poiunter to execute the shellcode `();`

```c
((void(*)())addressPointer)();
```

**Reminder:** Can not be used on a remote process!

#### Asynchronous Procedure Calls:

[Asynchronous Procedure Calls](https://docs.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls) are anlternative to thread execution by queuing a APC function to a thread through `QueueUserAPC` resulting in software interrupt and executing the function next time it scheduled. AaPC function thread must be in a "alertable state", which requires the thread to be waiting for a callback, like `WaitForSingleObject` or `Sleep`  then `VirtualAllocEx` and `WriteProcessMemory` to allocate and write into the process memory.

```c
QueueUserAPC(
	(PAPCFUNC)addressPointer, // APC function pointer to allocated memory defined by winnt
	pinfo.hThread, // Handle to thread from PROCESS_INFORMATION structure
	(ULONG_PTR)NULL
	);
ResumeThread(
	pinfo.hThread // Handle to thread from PROCESS_INFORMATION structure
);
WaitForSingleObject(
	pinfo.hThread, // Handle to thread from PROCESS_INFORMATION structure
	INFINITE // Wait infinitely until alerted
);
```


#### Section Manipulation
Obtaining a PE dump, commonly with a DLL or other malicious file fed to `xxd`;use mathematics to move through the hex data to perform techniques like: RVA entry point parsing, section mapping, and relocation table parsing. See [[Malware-Section-Manipulation]] for more.


## References

[THM Abusing Window Internals](https://tryhackme.com/room/abusingwindowsinternals)
[Asynchronous Procedure Calls Documentation](https://docs.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls)
