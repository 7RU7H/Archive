# SQL Truncation Attacks



SQL truncation attack exploits how SQL handles input when it is longer than the field it is writing to. When you are creating a text field in an SQL database, you also define the maximum length of the field, but because SQL truncates the maximum width plus one including the  ` ` whitespace or url encoded as: `+`. That if we can enumerate the administration email address we may be able to create another administrator account, but:
1. Do we fulfil requirements:
	 - Is the site using SQL to store usernames (or equivalents) and passwords?
	 - Can we register a new user? - Web Privilege Escalation 
- Enumerating existing usernames with SQL truncation attacks:
	- Test for existing users:  `SELECT * from users WHERE email = {input_email};`, if 0 rows no email in the database.
- SQL Truncation for Web Privilege Escalation:
	- Send a known account identifier, plus enough spaces to expand beyond the maximum characters, then a non-whitespace character.
		- SQL backend will:
			- Run the first query and return 0 - because it cannot match as field size has been exceeded 
			- Run the second query, but because it’s there is an `INSERT` statement, it truncates the field at the max length (insert the size of your target here). It then removes whitespace from the end, resulting in adding another row that has the duplicate key field.
	- ***If*** the site validates login attempt by searching for `SELECT * from users where username = {user} and password = {password}` and then checks that the number of results is 1, then the malicious duplicate entry will allow login. 
	- [0xDF - HTB SPOILER!](https://0xdf.gitlab.io/2020/07/11/htb-book.html) *"It’s better practice to pull the rows with the matching username, and then make sure there’s exactly one row, and that the passwords match (and of course, also store passwords as hashes and not plaintext)."*

 Incrementally add users till we enumerate the exact size of text field
```php
// + EQUALS whitespace character!!!
name=0xdf&email=admin%40hackthebox.htb+.&password=0xdf
// . is in position 21! It will get dropped and we register as admin user!
name=0xdf&email=admin%40hackthebox.htb++++++.&password=0xdf
```


## References

[Medium - r3d-buck3t: bypass-authentication-with-sql-truncation-attack](https://medium.com/r3d-buck3t/bypass-authentication-with-sql-truncation-attack-25a0c33ab87f)
[0xDF - HTB SPOILER!](https://0xdf.gitlab.io/2020/07/11/htb-book.html) 