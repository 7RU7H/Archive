# Pwnkit - CVE-2021-4034

[NVD](https://nvd.nist.gov/vuln/detail/CVE-2021-4034) *"A local privilege escalation vulnerability was found on polkit's pkexec utility. The pkexec application is a setuid tool designed to allow unprivileged users to run commands as privileged users according predefined policies. The current version of pkexec doesn't handle the calling parameters count correctly and ends trying to execute environment variables as commands. An attacker can leverage this by crafting environment variables in such a way it'll induce pkexec to execute arbitrary code. When successfully executed the attack can cause a local privilege escalation given unprivileged users administrative rights on the target machine."

This exploit was a go to quick [[Linux-Privilege-Escalation]] in 2021-2022. 

[HTB Academy](https://academy.hackthebox.com/) *"In the `pkexec` tool, the memory corruption vulnerability with the identifier [CVE-2021-4034](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034) was found, also known as [Pwnkit](https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034) and also leads to privilege escalation."*

Polkit works with two groups of files.
1. actions/policies (`/usr/share/polkit-1/actions`)
2. rules (`/usr/share/polkit-1/rules.d`

Polkit also has `local authority` rules which can be used to set or remove additional permissions for users and groups. Custom rules can be placed in the directory :
- `/etc/polkit-1/localauthority/50-local.d` with the file extension `.pkla`.

PolKit also comes with three additional programs:
- `pkexec` - runs a program with the rights of another user or with root rights
- `pkaction` - can be used to display actions
- `pkcheck` - this can be used to check if a process is authorised for a specific action

[GitHub - arthepsy's CVE-2021-4034 PoC](https://github.com/arthepsy/CVE-2021-4034)
```bash
git clone https://github.com/arthepsy/CVE-2021-4034.git
cd CVE-2021-4034
gcc cve-2021-4034-poc.c -o poc
```
And for boxes without `gcc` for whatever reason there is [joeammond's - CVE-2021-4034 Python3 Variant for boxes without gcc](https://raw.githubusercontent.com/joeammond/CVE-2021-4034/main/CVE-2021-4034.py)

## References

[NVD.nist](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
[https://academy.hackthebox.com/](https://academy.hackthebox.com/)
[https://cve.mitre.org - CVE-2021-4034](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034)
[(https://blog.qualys.com - Pwnkit](https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034) 
[GitHub - arthepsy's CVE-2021-4034 PoC](https://github.com/arthepsy/CVE-2021-4034)
[joeammond's - CVE-2021-4034 Python3 Variant for boxes without gcc](https://raw.githubusercontent.com/joeammond/CVE-2021-4034/main/CVE-2021-4034.py)
