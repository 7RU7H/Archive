# Zero Logon - CVE-2020-1472

On September 14, [Secura released a whitepaper for CVE-2020-1472](https://github.com/SecuraBV/CVE-2020-1472), that allowed an attacker to go from Zero to Domain Admin in approximately one minute.

Zero Logon is a purely statistics based Attack abuses a feature within MS-NRPC (Microsoft NetLogon Remote Protocol) is a critical authentication component of Active Directory that handles authentication for User and Machine accounts. Microsoft chose to use AES-CFB8 for a function called ComputeNetlogonCredential, but they hard coded the Initialization Vector to use all zeros instead of a random string. 

The [Secura PoC](https://github.com/SecuraBV/CVE-2020-1472)  tries to:
1. connect to a target computer to establish to bind and a session with NRPC over TCP/IP to then communicate with DC. 
1. It emulates flags used by Windows 10 Client (using AES-CFB8) with the Sign and Seal bit disabled
1. client creates a NetrServerReqChallenge containing the following information required by the [Microsoft Documentation](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/5ad9db9f-7441-4ce5-8c7b-7b771e243d32). I recieves `PNETLOGON_CREDENTIAL ServerChallenge` as a response.
1. Use Machine account as they do not have lockout policies with 16 bytes `\x00` Ciphertext to attempt to Abuse Zero Logon
1. Succesfull exploitation will result in recieving the `ServerCredential` and `AccountRID`

The [THM Zero Logon Room](https://tryhackme.com/room/zer0logon) suggest as of the Secure Poc to use [NetrServerPasswordSet2](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81), which very similar [hNetServerAuthenticate3](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/3a9ed16f-8014-45ae-80af-c0ecb06e2db9), [nrpc.py](https://github.com/SecureAuthCorp/impacket/blob/master/impacket/dcerpc/v5/nrpc.py) from [[Impacket-Cheatsheet]] to aid in create a netrServerPasswordSet2 Request. This will change the machine account password.
```python
newPassRequest = nrpc.NetrServerPasswordSet2()
newPassRequest['PrimaryName'] = dc_handle + '\x00'
newPassRequest['AccountName'] = target_computer + '$\x00'
newPassRequest['SecureChannelType'] = nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel
auth = nrpc.NETLOGON_AUTHENTICATOR()
auth['Credential'] = b'\x00' * 8
auth['Timestamp'] = 0
newPassRequest['Authenticator'] = auth
newPassRequest['ComputerName'] = target_computer + '\x00'
newPassRequest['ClearNewPassword'] =Â  b'\x00' * 516
rpc_con.request(newPassRequest)
```

## References

[THM Zero Logon Room](https://tryhackme.com/room/zer0logon)
[Secura PoC](https://github.com/SecuraBV/CVE-2020-1472)