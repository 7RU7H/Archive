# Command and Control Frameworks

For a table of alot of C2 see [[C2-Matrix]] or its [source](https://docs.google.com/spreadsheets/d/1b4mUxa6cDQuTV2BPC6aA-GR4zGZi0ooPYtBe4IgPsSc/edit#gid=0)

# C2 Structure:

## C2 Server 
A server that handles then multitude of agents to call back and helps manage connections.
Also provides a medium for operator.

## Agents / Payloads 
A program generated by the C2 framework that call back to the C2.
Most C2 implement alias command or batch commands to make things easier for the operator.
Configurability is important.
A Beacons is the process of a C2 agent calling back to the listener running on a C2 Server

Application running to wait for callbakc over specific ports/protocols

# Obfuscating Agent Callbacks

Sleep timer
Jitter - add variation to the sleep timer 
Sample python code being:
```
import random
sleep = 60
jitter = random.randint(-30,30)
sleep = sleep + jitter
```

# Payload Types

## Stageless payload beacon immediately
1. The Victim downloads and executes the Dropper
2. The beaconing to the C2 Server begins

## Staged payloads require callback to the C2 server for additional components of the C2 agent, refered to a Dropper.
1. The Victim downloads and executes the Dropper
2. The Dropper calls back to the C2 Server for Stage 2
3. The C2 Server sends Stage 2 back to the Victim Workstation
4. Stage 2 is loaded into memory on the Victim Workstation 
5. C2 Beaconing Initializes, and the Red Teamer/Threat Actors can engage with the Victim on the C2 Server.

# Payload Formats

PowerShell Scripts (Which may contain C# Code and may be compiled and executed with the Add-Type commandlet)
HTA Files
JScript Files
Visual Basic Application/Scripts
Microsoft Office Documents

# Modules

Add ability to make agents and C2 server more flexible, depending on the C2 framework.

Cobalt strike has aggressor scripts: writing in the Agressior Scripting Language
PowerShell Empire has support multiple lanaguage
Metasploit's Modules are written in Ruby, although and many aren't

## Post Exploitation modules
Modules that deal with anything after the initial point of compromise.
Sharphound.ps1

## Pivoting Modules
Make it easier to access restricted network segments within the C2 Framework
With Administrative Access, an SMB Beacon can enable a machine to act as a proxy via SMB protocol:
1. The Victims call back to an SMB named pipe on another Victim in a non-restricted network segment.
2. The Victim in the non-restricted network segment calls back to the C2 Server over a standard beacon.
3. The C2 Server then sends commands back to the Victim in the non-restricted network segment.
4. The Victim in the non-restricted network segment then forwards the C2 instructions to the hosts in the restricted segment.

# Setup
For more advance setups additions see [[Improving-Existing-C2-Setups]]
## Domain Fronting
Utilising a known host to (for example Cloudflare):
1. The C2 Operator has a domain that proxies all requests through Cloudflare. 
2. The Victim beacons out to the C2 Domain.
3. Cloudflare proxies the request, then looks at the Host header and relays the traffic to the correct server.
4. The C2 Server then responds to Cloudflare with the C2 Commands.
5. The Victim then receives the command from Cloudflare.

## C2 Profiles
This technique goes by several names by several different products, "NGINX Reverse Proxy", "Apache Mod_Proxy/Mod_Rewrite",  "Malleable HTTP C2 Profiles", etc...
They all similarly prozy features to allkow user to contorl specific elements of incoming HTTP request:
1. The Victim beacons out to the C2 Server with a custom header in the HTTP request, while a SOC Analyst has a normal HTTP Request
2. The requests are proxied through Cloudflare
3. The C2 Server receives the request and looks for the custom header, and then evaluates how to respond based on the C2 Profile.
4. The C2 Server responds to the client and responds to the Analyst/Compromised device.

# Common C2 Frameworks

## Metasploit

The [[Metasploit]] Framework, developed and maintained by Rapid7, is one of the most popular Exploitation and Post Exploitation frameworks (C2) that is publicly available and is installed on most penetration testing distributions.

## Armitage - Metasploit extension

[[Armitage]] is an extension of the Metasploit Framework - it adds a Graphical user interface and is written in Java, and is incredibly similar to Cobalt Strike. This is because they were both developed by Raphael Mudge. Armitage offers an easy way to enumerate and visualize all of your targets. Aside from looking a lot like Cobalt Strike, it even offers some unique features. One of the most popular can be found in the “Attacks” menu; This feature is known as the Hail Mary attack, which attempts to run all exploits for the services running on a specific workstation. Armitage really is “Fast and Easy Hacking”.
```
git clone https://gitlab.com/kalilinux/packages/armitage.git && cd armitage
bash package.sh
cd ./release/unix/ && ls -la # verify
systemctl start postgresql && systemctl status postgresql # prepare environment
msfdb --use-defaults delete # Delete and initialise Metasploit database
msfdb --use-defaults init 
```
Start and connect to Armitage:
```
cd /opt/armitage/release/unix && ./teamserver YourIP P@ssw0rd123
```

## Powershell Empire/Starkiller

Powershell [[Empire]] and Starkiller is another incredibly popular C2 originally created by Harmjoy, Sixdub, and Enigma0x3 from Veris Group. Currently, the project has been discontinued and has been picked up by the BC Security team (Cx01N, Hubbl3, and _Vinnybod). Empire features agents written in various languages compatible with multiple platforms, making it an incredibly versatile C2.

## Covenant 

Covenant by Ryan Cobb is the last free C2 Framework we will be covering - By far, it is one of the most unique C2 Frameworks being written in C#. Unlike Metasploit/Armitage, It’s primarily used for post-exploitation and lateral movement with HTTP, HTTPS, and SMB listeners with highly customizable agents.

## Sliver

Sliver by Bishop Fox is an advanced, highly customizable multi-user, CLI-based C2 framework. Sliver is written in Go, which makes reverse engineering the C2 "implants" incredibly difficult. It supports various protocols for C2 communications like WireGuard, mTLS, HTTP(S), DNS, and much more. Additionally, it supports BOF files for additional functionality, DNS Canary Domains for masking C2 communications, automatic Let's Encrypt certificate generation for HTTPS beacons, and much more.  

# Paid C2 Frameworks:

## Cobalt Strike

Cobalt Strike by Help Systems (Formerly created by Raphael Mudge) is arguably one of the most famous Command and Control frameworks next to Metasploit. Much like Artimage, it is written in Java and designed to be as flexible as possible. For more information, see Cobalt Strike’s Video Training Page. It offers additional insight into both Red Team Operations and the Framework by Raphael Mudge himself.

## Brute Ratel

Brute Ratel by Chetan Nayak or Paranoid Ninja is a Command and Control framework marketed as a “Customizable Command and Control Center” or “C4” framework that provides a true adversary simulation-like experience with being a unique C2 framework. For more information about the Framework, the author has provided a Video Training Page that demonstrates many of the capabilities within the framework.

Check out:
https://howto.thec2matrix.com/


# C2 Operation Basics

## Accessing and managing C2 infrastructure

### C2 management interface should not be directly accessible 
For OPSEC and it's easy to fingerprint C2 servers:  
For example, in versions prior to 3.13, Cobalt Strike C2 servers were able to be identified by an extra space (\x20) at the end of the HTTP Response

### SSH port forwarding
Setup a local port forward to forward our local port to the remote Teamserver server
````
ssh -L 55553:127.0.0.1:55553 root@192.168.0.44
```
As a reminder, Armitage does not support listening on a loopback interface (127.0.0.1-127.255.255.255), so this is general C2 server admin advice. You will find this advice more centric to C2 servers like Covenant, Empire, and many others.

### Firewalls 
Use a firewall and its rules in front of C2 servers that must listen on a public interface so only intended users ca access it.
If you are hosting Cloud infrastructure, you can set up a Security Group or use a host-based firewall solution like UFW or IPTables.

## Listeners

### Listener Types

Stardard Listeners are communicated directly over raw TCP or UDP socket

HTTP/HTTPS Listeners often front a webserver and use Domain Fronting or Malleable C2 profiles to mask C2 server
HTTPS communication is less likely to be blocked by an NGFW

DNS Listeners popular use case for exfiltration stage where additional infrastructure is normally required
Domain name purchased and registered, and NS server configured. For Metasploit for C2 DNS operations, to bypass network proxies see:
https://2017.zeronights.org/wp-content/uploads/materials/ZN17_SintsovAndreyanov_MeterpreterReverseDNS.pdf 

SMB listeners communicate with named SMB pipes used for dealing with restricted networks, more flexibble pivoting with multiple devices and only one to reaching bhack out over a more common protocol like HTTP/HTTPS, metasploit has support for Named Pipes.


