# Azure-Administration Log Analytics

Log Analytics an Azure Portal Tool to **edit and run log queries** with data in Azure Monitor Logs -  Log Analytics use [KQL](https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/) - Kusto Query Language. Data collection is done by Azure Monitor - [[Azure-Administration-Azure-Monitor]]. Logs are time-stamped information about changes made to resources, depending on Log source of either data type of metrics or logs.

![](azuremonitorcollectionforlogs.png)

**Application data**: Data that relates to your custom application code.
- **Operating system data**: 
	- Data from the Windows or Linux virtual machines that host your application.
- **Azure resource data**: 
	- Data that relates to the operations of an Azure resource, such as a web app or a load balancer.
- **Azure subscription data**: 
	- Data that relates to your subscription. It includes data about Azure health and availability.
- **Azure tenant data**: 
	- Data about your Azure organisation-level services, such as Azure Active Directory.

Log Analytics workspace is a unique environment for Azure monitor Log Data; each has its own data repository and configuration, data sources and solutions are configured to store their data in a workspace.

#### Azure Log Levels

|Level|Included categories|
|---|---|
|**Disabled**|None|
|**Error**|Error, Critical|
|**Warning**|Warning, Error, Critical|
|**Information**|Info, Warning, Error, Critical|
|**Verbose**|Trace, Debug, Info, Warning, Error, Critical (all categories)|

#### Diagnostic Logging

|Type|Platform|Location|Description|
|---|---|---|---|
|Application logging|Windows, Linux|App Service file system and/or Azure Storage blobs|Logs messages generated by your application code. The messages are generated by the web framework you choose, or from your application code directly using the standard logging pattern of your language. Each message is assigned one of the following categories: **Critical**, **Error**, **Warning**, **Info**, **Debug**, and **Trace**.|
|Web server logging|Windows|App Service file system or Azure Storage blobs|Raw HTTP request data in the W3C extended log file format. Each log message includes data like the HTTP method, resource URI, client IP, client port, user agent, response code, and so on.|
|Detailed error logging|Windows|App Service file system|Copies of the _.html_ error pages that would have been sent to the client browser. For security reasons, detailed error pages shouldn't be sent to clients in production, but App Service can save the error page each time an application error occurs that has HTTP code 400 or greater.|
|Failed request tracing|Windows|App Service file system|Detailed tracing information on failed requests, including a trace of the IIS components used to process the request and the time taken in each component. One folder is generated for each failed request, which contains the XML log file, and the XSL stylesheet to view the log file with.|
|Deployment logging|Windows, Linux|App Service file system|Helps determine why a deployment failed. Deployment logging happens automatically and there are no configurable settings for deployment logging.|


#### Deploying Log Analytics

Azure Log Analytics Access Control
![](azureloganalyticsaccesscontrol.png)

Access mode - either
- `Resource-context`: view logs for resources in all tables you have access to - queries scope to all data in all tables
- `Workspace-context`: access to all logs in a workspace - queries scope to resource
Access control mode 
- `Require workspace permissions`: all data in any table where permission are defined 
- ` Use resource or workspace permissions`: granular RBAC
Table level RBAC - requires Azure custom roles to either grant or deny access to specific tables, either  `Workspace-context` or  `Resource-context`

Azure Monitor Logs is based on Azure Data Explorer, and log queries are written using the same KQL
- KQL used in:
	- Log Analytics
	- Log Alert Rules
	- Workbooks
	- Azure Dashboards
	- Logic Apps
	- PowerShell
	- Azure Monitor Logs API

- Kusto is based on relational database management systems and supports entities such as databases, tables and columns
- Kusto queries are read-only requests
	- Some query operators include:
		- Calculated columns, searching and filtering on rows, group by-aggregates, join functions
- Kusto queries execute in context of some Kusto database that is attached to a Kusto cluster
- Kusto is generally composed of the following entities:
	- Clusters - are entities that hold databases
	- Databases - are named entities that allow reuse of Kusto queries or query parts
	- Tables  - are named entities that hold data
	- Columns - columns are named entities that have a scalar data type
	- Stored Functions - are named  entities that allow reuse of Kusto queries or query parts 
	- External tables are entities that have a scalar data stored outside Kusto database
- You can and more:
	- Search and sort by value, time, property state, and more
	- Join data from multiple tables
	- Aggregate large sets of data
	- Perform intricate operations with minimal code
- Groups of series of tables are called a schema 

Scenarios:
- Assess update requirement and time-to-complete
- Track Changes and identity access issues
- Security 

The following illustration highlights how KQL queries use the dedicated table data for your monitored services and resources.
![1080](azurekglqueries.png)

Correctly designing a Log Analytics workspace deployment is important. Log Analytics workspaces are containers where Azure Monitor data is collected, aggregated, and analysed.
- Access mode
	- workspace-context: access to all log in workspace where the permission is assigned 
	- resource-context: provides access to view logs for resources in all tables you have access to
- Access control mode
	- how permissions work for any given Log Analytics workspace
		- Require workspace permissions - no granular RBAC
		- Use resource or workspace permissions - granular RBAC
- Table-level RBAC - Very granular RBAC at the table level

Azure Monitor data tiers:
![](azuremonitoringtier.png)

Tiering of Log data mapping:
![](azurelogeventtiering.png)

#### KGL Log queries 
- Schema 
- Filter
- Explorer

```sql
// Syntax
// Count by Rows:
$Table | count 

// Count by Column:
$Table 
| count

// Control Commands 
.create table Logs (Level:string, Text:string)


// Queries - I will use row queries for space, unless it is required
$table | count
$table | top 3 by event severity duration
$table | where StartTime between (datetime(2007-11-01) .. datetime(2007-12-01))
$table | where $Column == "Something" 

// Top most security events by time generated
SecurityEvents 
	| take 10 by TimeGenerated

// In the last 24 hours records of "Clicked Schedule Button"
AppEvents 
    | where TimeGenerated > ago(24h)
    | where Name == "Clicked Schedule Button"

// Heartbeat data source reports the health of all computers that report to LA Workspace
Heartbeat | summarize arg_max(TimeGenerated, *) by ComputerIP

// Aggregate content by specifications using using summarize 
$table | summarize count(), avg(severity) by $column, $column

// Create a Column Chart from $event 
$table | where isnotempty($event) | summarize event_count=count() by $event | top 10 by event_count | render columnchart

// Chat CPU usage trends by computer
InsightsMetrics
| where TimeGenerated > ago(1h)
| where Origin == "vm.azm.ms"
| where Namespace == "Processor"
| where Name == "UtilizationPercentage"
summarize avg(Val) by bin(TimeGenerated, 5m), Computer
render timechart
```

## References

[FreeCodeCamp.org - AZ 104 Course](https://www.youtube.com/watch?v=10PbGbTUSAg)
[KQL](https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/) 
[Azure Monitor Metrics](https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/data-platform-metrics)
[Azure Monitor Logs](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/data-platform-logs)
[Supported regions for linked Log Analytics workspace | Microsoft Learn](https://learn.microsoft.com/en-us/azure/automation/how-to/region-mappings)
[Microsoft Technical Documentation](https://learn.microsoft.com/en-us/docs/)
[Microsoft Learn](https://learn.microsoft.com/en-us/)
[John Savill](https://www.youtube.com/@NTFAQGuy) 