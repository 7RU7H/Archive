# C2 Design


C2 have the same qualities of [[Application-Security-For-The-Paranoid]]


Moloch considers core principles to be Shannon's Maxim:
> "One ought to design systems under the assumption that the enemy will immediately gain full familiarity with them" - Claude Shannon

This entails: we only care about the worst case.


Source: [YouTube - The Sliver C2 Framework - Moloch](https://www.youtube.com/watch?v=tkjMZuZ_8nw)
![](programlanguages-adv-disadv-moloch-sliver-talk.png)
- Learning curve for Rust should be in the Disadvantages
- Loose typing for Python, Ruby and JavaScript is commented as being in both as project scales
- Rust does its own security problems, it is not magically.
- Productivity is important, if you cannot ship it is not useful

BIS 2022: 
- Stage 0: optional
- Stage 1: C/Rust
- Stage 2: Go
- Server: Go

Protocols
![](c2-protocols-moloch.png)
- In sophisticated network typical there is no direct TCP egress/ingress for your beacon and the only way is through a HTTP proxy; mTLS and WireGuard are off the table
- DNS is not universally implement the same. 

Solution: Make your own protocol that is encapsulated in normal *Alice from HR's network*  traffic.

![](c2-serialization-formats-moloch.png)


CTI Fingerprinting Servers
- Any application specific in a response it is easy to fingerprint
- JARM
- Response headers

Cryptographic Solutions - Requires single round trip:
- OPAQUE - [[Merlin]] uses this; OPAQUE requires sort of three-way handshake for key negotiation 
- Pre-Shared RSA
- RSA EKE

Sliver uses:
- Only respond to cryptographically attributable traffic
- mTLS / WireGuard
- Generic JARM for mTLS
- HTTP/S & DNS Servers
	- TOTP "hello" with NaCl Box
	- ChaCha20Poly1305
	- Replay detection - Has security implication for the server!
	- Randomized JARM/X.509
## References

[YouTube - The Sliver C2 Framework - Moloch](https://www.youtube.com/watch?v=tkjMZuZ_8nw)